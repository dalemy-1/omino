<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>简易登记系统 v6.4.2-next5</title>
<style>

:root{
  --bg:#f4f6f9; --card:#fff; --muted:#6b7280; --text
function shortReviewType(val){
  const s = String(val||"");
  // 仅用于展示：前 4 个中文（或4个字符）
  return s.length>4 ? s.slice(0,4) : s;
}:#111827;
  --border:#e5e7eb; --primary:#2563eb; --primary2:#1d4ed8;
  --good:#16a34a; --danger:#ef4444; --warn:#f59e0b; --soft:#f9fafb;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:1500px;margin:0 auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
.header .title{font-size:20px;font-weight:800}
.header .desc{color:var(--muted);font-size:12px;margin-top:4px;max-width:1120px;line-height:1.55}
.top-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#111827;cursor:pointer;font-weight:800;font-size:13px}
.tab.active{background:#e8f0ff;border-color:#c7d2fe;color:#1d4ed8}
h3{margin:0 0 10px}
h4{margin:0 0 8px}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
textarea{min-height:90px;resize:vertical}
.grid{display:grid;gap:10px}
/*
  Use minmax(0,1fr) to avoid layout blow-ups when a select option
  has long text (e.g. "待结算（仅已回评/免评）").
*/
.grid > *{min-width:0}
.grid.cols-2{grid-template-columns:minmax(0,1fr) minmax(0,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
.grid.cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}
.cols-6{grid-template-columns:repeat(6,minmax(0,1fr))}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* FIX: prevent long select text (e.g. 佣金待结算）撑破 flex 行导致页面错乱 */
.row > div{min-width:0 !important;}
.row select, .row input, .row textarea{min-width:0; max-width:100%;}
.row select{
  display:block;
  width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--soft);cursor:pointer;font-weight:800;font-size:13px}
.btn.sm{padding:6px 10px;font-size:12px;border-radius:10px}

.btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
.btn.primary:hover{background:var(--primary2)}
.btn.good{background:var(--good);border-color:var(--good);color:#fff}
.btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.btn:disabled{opacity:.5;cursor:not-allowed}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:1100px}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle;white-space:nowrap}
th{background:var(--soft);color:var(--muted);font-weight:900}
td.small{color:var(--muted);font-size:12px}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:900}
.badge.done{background:#dcfce7;color:#166534}
.badge.pending{background:#fee2e2;color:#991b1b}
.badge.waived{background:#e0f2fe;color:#0369a1}
.badge.settled{background:#ede9fe;color:#5b21b6}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .box{flex:1;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
.kpi .box .v{font-size:18px;font-weight:900;margin-top:4px}
.help{color:var(--muted);font-size:12px;line-height:1.5}
.mini{font-size:12px;color:var(--muted)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
.tags{display:flex;gap:8px;flex-wrap:wrap}
.tag{display:inline-flex;align-items:center;gap:8px;background:#e0f2fe;color:#0369a1;border:1px solid #bae6fd;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;cursor:pointer}
.tag .x{font-weight:900}
details summary{cursor:pointer;font-weight:900;color:#1f2937}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal .box{background:#fff;border-radius:14px;max-width:1200px;width:100%;max-height:92vh;overflow:auto;border:1px solid var(--border);box-shadow:0 10px 25px rgba(0,0,0,.18)}
.modal .box .hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:2}
.modal .box .bd{padding:14px}
.modal .box .ft{display:flex;justify-content:flex-end;gap:10px;padding:12px 14px;border-top:1px solid var(--border);position:sticky;bottom:0;background:#fff}
.pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
.pager .left,.pager .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:900;font-size:12px;color:var(--muted)}
@media(max-width:980px){
  .grid.cols-4,.grid.cols-5{grid-template-columns:1fr 1fr}
  table{min-width:1100px}
}

  /* 搜索+下拉并排：卖家/产品 */
  .searchWrap{display:flex; gap:8px; align-items:center;}
  .searchWrap input:not([type="checkbox"]){width:150px;}input[type="checkbox"]{width:auto;height:auto;}
  .searchWrap select{flex:1; min-width:220px;}
  .searchWrap.searchWrap--seller select{max-width:260px;}
  .searchWrap.searchWrap--product select{max-width:520px;}


/* --- Settlement modal sticky header --- */
#modalSettle .table-wrap{max-height:55vh; overflow:auto;}
#modalSettle .table-wrap thead th{position:sticky; top:0; background:#fff; z-index:3;}


/* ===== Settlement Modal enhancements ===== */
#settleModal .table-wrap{max-height:55vh;overflow:auto;}
#settleModal thead th{position:sticky;top:0;background:#fff;z-index:3;box-shadow:0 1px 0 rgba(0,0,0,.06);}
#settleModal .settle-sticky{position:sticky;top:0;background:#fff;z-index:4;padding:10px 0;border-bottom:1px solid var(--border);margin-bottom:10px}
#settleModal .row.total-bottom{display:none;}
#settleModal .box{overflow:hidden;display:flex;flex-direction:column;}
#settleModal .box .bd{flex:1;overflow:hidden;display:flex;flex-direction:column;}
#settleModal .table-wrap{flex:1;max-height:none;}

/* Orders table: fit within container; allow horizontal scroll if needed */
.table-scroll{overflow:auto; border:1px solid var(--border); border-radius:12px; background:#fff;}
.orders-table{width:100%; min-width:1200px; table-layout:fixed; border-collapse:separate; border-spacing:0;}
.orders-table th,.orders-table td{white-space:nowrap;}
.orders-table input[type=checkbox]{width:14px;height:14px; vertical-align:middle;}
.orders-table th:first-child,.orders-table td:first-child{width:44px; text-align:center;}
.orders-table th:nth-child(2),.orders-table td:nth-child(2){width:64px;} /* 日期 */
.orders-table th:nth-child(3),.orders-table td:nth-child(3){width:210px;} /* 订单号 */
.orders-table th:nth-child(4),.orders-table td:nth-child(4){width:140px; max-width:140px;} /* 卖家 */
.orders-table th:nth-child(5),.orders-table td:nth-child(5){width:90px; max-width:90px;} /* 国家 */
.orders-table th:nth-child(6),.orders-table td:nth-child(6){width:140px; max-width:140px;} /* 产品 */
.orders-table th:nth-child(7),.orders-table td:nth-child(7){width:150px; max-width:150px;} /* ASIN */
.orders-table td:nth-child(4),.orders-table td:nth-child(5),.orders-table td:nth-child(6),.orders-table td:nth-child(7){overflow:hidden; text-overflow:ellipsis;}
.orders-table th:last-child,.orders-table td:last-child{width:170px;} /* 操作 */
.orders-table td:last-child .btn{padding:6px 10px; font-size:12px; border-radius:10px;}
/* compact order form spacing */
#tab-orders details summary{ cursor:pointer; }
.grid.order-compact{ gap:10px; }

/* === UI compact: actions column === */
td.action-col{white-space:nowrap}
td.action-col .btn{
  padding:6px 8px;
  font-size:12px;
  border-radius:9px;
}
td.action-col .btn + .btn{margin-left:6px}
td.action-col .btn.danger{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
/* make delete less eye-catching but still clear */
td.action-col .btn.danger:hover{background:#ffe4e6}


/* ===== Order page compact layout (v6.4.2) ===== */
#tab-orders details{padding:10px 12px;}
#tab-orders details>summary{margin:-10px -12px 10px -12px; padding:10px 12px;}
#tab-orders .grid{gap:8px;}
#tab-orders label{margin-bottom:4px;}
#tab-orders input, #tab-orders select{height:34px; padding:6px 10px;}
#tab-orders .row{gap:8px;}
/* keep the order form within 2 rows by hiding seldom-used fields */

#orderReviewType{min-width:0;width:100%;}

/* Batch parse layout (left: text+actions, right: options) */
.batch-layout{display:flex;gap:12px;align-items:stretch}
.batch-layout .batch-left{flex:1;min-width:360px;display:flex;flex-direction:column;gap:10px}
.batch-layout .batch-left textarea{min-height:150px}
.batch-layout .batch-actions{justify-content:flex-start}
.batch-layout .batch-actions .btn{min-width:110px}
.batch-layout .batch-opts{width:520px;max-width:48%}
.batch-opts-grid{align-items:end}
.batch-opts-grid input,.batch-opts-grid select{width:100%}
@media (max-width: 1000px){
  .batch-layout{flex-direction:column}
  .batch-layout .batch-opts{width:auto;max-width:none}
}
  .batch-right{width:auto;flex-direction:row;flex-wrap:wrap}
  .batch-right .btn{width:auto}
}

  .btncol{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;}
  .btncol .btn{min-width:92px;}


/* === Payout modal enhancements (v1+2) === */
#payoutPrecheckCard{margin-top:10px}
#payoutPrecheckList{max-height:160px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:8px; background:var(--soft)}
#payoutStickyBar{position:sticky; bottom:0; background:rgba(255,255,255,0.92); backdrop-filter:saturate(180%) blur(8px); border-top:1px solid var(--border); padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px; z-index:5}
#payoutStickyBar .right{font-weight:900; font-size:16px}


.modal-inner{background:#fff;border-radius:14px;box-shadow:0 18px 60px rgba(0,0,0,.25);width:100%;max-height:85vh;overflow:auto}

/* --- PATCH v6: ensure payout modals styled & clickable --- */
.modal-content{background:#fff;border-radius:14px;width:100%;max-height:90vh;overflow:auto;border:1px solid var(--border);box-shadow:0 10px 25px rgba(0,0,0,.18);}
.modal-header,.modal-hd{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border);}
.modal-title{font-weight:800;}
.modal-bd{padding:12px 14px;}
/* keep legacy .modal .box compatible */
.modal .box{width:100%;}


/* ===================== Payout (返款) modal UI fixes ===================== */
#payoutModal .modal-content{
  max-width:1100px;
  overflow:hidden;
  max-height:90vh;
  display:flex;
  flex-direction:column;
}
#payoutModal .modal-header{flex:0 0 auto;}
#payoutModal .modal-bd{flex:1 1 auto; overflow:hidden;}
#payoutModal .modal-footer{flex:0 0 auto;}
#payoutModal .table-scroll{max-height:58vh; overflow:auto;}
/* 在窄屏下避免表格被裁剪 */
#payoutModal table{min-width:980px;}

/* ===== Payout modal compact table (scoped) ===== */
#payoutModal .payout-modal-table{font-size:12px; line-height:1.25; table-layout:fixed;}
#payoutModal .payout-modal-table th, #payoutModal .payout-modal-table td{padding:6px 6px;}
#payoutModal .payout-modal-table th:nth-child(1), #payoutModal .payout-modal-table td:nth-child(1){width:150px;}
#payoutModal .payout-modal-table th:nth-child(2), #payoutModal .payout-modal-table td:nth-child(2){width:110px;}
#payoutModal .payout-modal-table th:nth-child(3), #payoutModal .payout-modal-table td:nth-child(3){width:90px;}
#payoutModal .payout-modal-table th:nth-child(4), #payoutModal .payout-modal-table td:nth-child(4){width:70px;}
#payoutModal .payout-modal-table th:nth-child(5), #payoutModal .payout-modal-table td:nth-child(5){width:50px;}
#payoutModal .payout-modal-table th:nth-child(6), #payoutModal .payout-modal-table td:nth-child(6){width:78px;}
#payoutModal .payout-modal-table th:nth-child(7), #payoutModal .payout-modal-table td:nth-child(7){width:70px;}
#payoutModal .payout-modal-table th:nth-child(8), #payoutModal .payout-modal-table td:nth-child(8){width:84px;}
#payoutModal .payout-modal-table th:nth-child(9), #payoutModal .payout-modal-table td:nth-child(9){width:54px;}
#payoutModal .payout-modal-table th:nth-child(10), #payoutModal .payout-modal-table td:nth-child(10){width:92px;}
#payoutModal .payout-modal-table th:nth-child(11), #payoutModal .payout-modal-table td:nth-child(11){width:80px;}
#payoutModal .payout-modal-table th:nth-child(12), #payoutModal .payout-modal-table td:nth-child(12){width:96px;}
#payoutModal .payout-modal-table td .mono{font-size:12px;}
#payoutModal .payout-modal-table th, #payoutModal .payout-modal-table td{padding:6px 8px; vertical-align:top;}
#payoutModal .payout-modal-table .wrap{white-space:normal; word-break:break-word;}
#payoutModal .payout-modal-table input{width:100%; font-size:12px; padding:6px 8px;}
#payoutModal .payout-modal-table th{position:sticky; top:0; background:#fff; z-index:2;}
#payoutModal .payout-modal-table-wrap{min-width:0; width:100%;}
#payoutModal .col-hide{display:none!important;}
#payoutModal td.copyable{user-select:all;}


/* --- payout modal density (only affects payout modal) --- */
#payoutModal .box{ max-width: 96vw; width:96vw; }
#payoutModal .modal-title{ font-size:14px; }
#payoutModal .card{ padding:10px !important; }
#payoutModal .payout-modal-table th,
#payoutModal .payout-modal-table td{ padding:6px 8px; font-size:12px; }
#payoutModal .payout-modal-table input{ height:28px; padding:4px 6px; font-size:12px; }
#payoutModal .payout-modal-table th{ position: sticky; top: 0; background: #fff; z-index: 2; }
#payoutModal .payout-modal-table td:nth-child(2),
#payoutModal .payout-modal-table td:nth-child(3){ max-width: 220px; }
#payoutModal .payout-modal-table td:nth-child(2),
#payoutModal .payout-modal-table td:nth-child(3){ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }


/* ===== Payout modal density tweaks (batch payout only) ===== */
#payoutModal .payout-modal-table th, 
#payoutModal .payout-modal-table td{ padding:6px 8px; font-size:12px; }
#payoutModal .payout-modal-table input{ height:28px; padding:4px 8px; font-size:12px; }
#payoutModal .payout-modal-table td.clip{ max-width:140px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
#payoutModal .payout-modal-table td.clip4{ max-width:64px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:center; }
.clip4l{ max-width:88px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left; }

#payoutModal #payoutStickyBar{ font-size:12px; }
#payoutModal .modal-footer{ display:flex; gap:10px; justify-content:flex-end; }
#payoutModal .payout-modal-table-wrap{ overflow:auto; }


/* ===== Payout Modal Density Tweaks ===== */
#payoutModal .modal-content{max-width:1280px}
#payoutModal table{table-layout:fixed;width:100%}
#payoutModal th,#payoutModal td{padding:6px 8px;font-size:12px;vertical-align:middle}
#payoutModal td input{height:28px;font-size:12px;padding:4px 6px}
#payoutModal .clip{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:1px}
#payoutModal th:nth-child(2), #payoutModal td:nth-child(2){width:220px} /* 产品 */
#payoutModal th:nth-child(3), #payoutModal td:nth-child(3){width:130px} /* 卖家 */
#payoutModal th:nth-child(4), #payoutModal td:nth-child(4){width:70px}  /* 回评 */
#payoutModal th:nth-child(5), #payoutModal td:nth-child(5){width:52px}  /* 国家 */
#payoutModal th:nth-child(6), #payoutModal td:nth-child(6){width:70px}  /* 金额 */
#payoutModal th:nth-child(7), #payoutModal td:nth-child(7){width:70px}  /* 折扣 */
#payoutModal th:nth-child(8), #payoutModal td:nth-child(8){width:92px}  /* 买手佣金原币 */
#payoutModal th:nth-child(9), #payoutModal td:nth-child(9){width:60px}  /* FX */
#payoutModal th:nth-child(10), #payoutModal td:nth-child(10){width:92px} /* 本金CNY */
#payoutModal th:nth-child(11), #payoutModal td:nth-child(11){width:92px} /* 佣金CNY */


/* payout sticky right column (batch payout modal) */
.payout-modal-table th.payout-sticky-right,
.payout-modal-table td.payout-sticky-right{
  position: sticky;
  right: 0;
  background: #fff;
  z-index: 3;
  box-shadow: -8px 0 10px rgba(0,0,0,0.04);
}
.payout-modal-table thead th.payout-sticky-right{ z-index: 4; }


/* payout modal compact columns */
.payout-modal-table{ table-layout:fixed; }
.payout-modal-table th, .payout-modal-table td{ padding:6px 6px; font-size:12px; }
.payout-modal-table td.clip, .payout-modal-table th.clip{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.payout-modal-table .clip4l{ max-width:72px; }
.payout-modal-table .clip4{ max-width:56px; }
.payout-modal-table input{ height:28px; padding:4px 6px; font-size:12px; }


/* === Payout modal density & width tweaks (payout-only) === */
#payoutModal .modal-content{max-width:1400px !important; width:96vw !important; padding-left:14px; padding-right:14px;}
#payoutModal .modal-header{padding-bottom:8px;}
#payoutModal .modal-content .card{margin-top:8px;}
#payoutModal table{table-layout:fixed;}
#payoutModal th,#payoutModal td{padding:6px 6px; font-size:12px; line-height:1.15;}
#payoutModal input[type="number"]{height:30px; padding:4px 8px; font-size:12px;}
#payoutModal .payout-col-prod,#payoutModal .payout-col-seller,#payoutModal .payout-col-review{max-width:72px; width:72px;}
#payoutModal .payout-col-prod .ellipsis,#payoutModal .payout-col-seller .ellipsis,#payoutModal .payout-col-review .ellipsis{display:block; max-width:72px;}


/* --- v9i UI: sticky top bar + compact header --- */
.topbar{position:fixed;top:0;left:0;right:0;z-index:9999;background:var(--bg);padding:8px 16px;border-bottom:1px solid var(--border);}
.header{align-items:center;margin-bottom:6px}
.header .title{font-size:18px}
.header .desc{display:none !important}
.top-actions .btn{padding:6px 10px;font-size:12px}
.card.navtabs{padding:8px 10px;margin-bottom:0;box-shadow:none}
.card.navtabs .tab{padding:6px 12px}


/* sticky topbar spacer */
:root{ --topbar-h: 88px; }
body{ padding-top: var(--topbar-h); }

/* payout selected tags bar (compact chips) */
#payoutSelectedTags{
  display:flex; flex-wrap:wrap; gap:6px;
  max-height: 128px; overflow:auto;
  padding:8px; border:1px solid var(--line); border-radius:12px;
  background:#fff;
}
#payoutSelectedTags:empty{ display:none; }



/* ===== v9m: sticky topbar safe offset ===== */
:root{ --topbar-h: 0px; }
body{ padding-top: var(--topbar-h); }

/* ===== v9m: 返款已勾选订单展示（避免只显示尾号） ===== */
#payoutSelectedTags{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
  max-height: 140px;
  overflow:auto;
  padding:6px 8px;
  border:1px dashed #d7dde6;
  border-radius:10px;
  background:#fafbfd;
}
#payoutSelectedTags .selTag{
  max-width:none !important;
  white-space:nowrap;
  overflow:visible;
  text-overflow:clip;
  direction:ltr;
  unicode-bidi:plaintext;
  font-variant-numeric: tabular-nums;
}
#payoutSelectedTags .selTag .x{
  margin-left:6px;
}

</style>
<style>
/* --- Settle drafts modal: ensure action buttons fully visible --- */
#settleDraftModal .modal-body{overflow-x:auto;}
#settleDraftModal table{width:100%; table-layout:fixed;}
#settleDraftModal th, #settleDraftModal td{overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
#settleDraftModal th:nth-child(1), #settleDraftModal td:nth-child(1){width:140px;}
#settleDraftModal th:nth-child(2), #settleDraftModal td:nth-child(2){width:140px;}
#settleDraftModal th:nth-child(3), #settleDraftModal td:nth-child(3){width:90px;}
#settleDraftModal th:nth-child(4), #settleDraftModal td:nth-child(4){width:70px; text-align:center;}
#settleDraftModal th:nth-child(5), #settleDraftModal td:nth-child(5){width:120px; text-align:right;}
#settleDraftModal th:nth-child(6), #settleDraftModal td:nth-child(6){width:190px;}
#settleDraftModal th:nth-child(7), #settleDraftModal td:nth-child(7){width:300px;}
#settleDraftModal td:nth-child(7){white-space:normal; overflow:visible;}
#settleDraftModal td:nth-child(7) .btn{padding:6px 10px; font-size:12px;}

/* payout sticky right column (batch payout modal) */
.payout-modal-table th.payout-sticky-right,
.payout-modal-table td.payout-sticky-right{
  position: sticky;
  right: 0;
  background: #fff;
  z-index: 3;
  box-shadow: -8px 0 10px rgba(0,0,0,0.04);
}
.payout-modal-table thead th.payout-sticky-right{ z-index: 4; }

</style>

<script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ===================== Cloud Backup (方案A) ===================== */
const CLOUD_CFG_KEY = "OPS_CLOUD_CFG_V1";

function getCloudCfg(){
  try{
    const o = JSON.parse(localStorage.getItem(CLOUD_CFG_KEY) || "null") || {};

    // ---- Fallback: read component keys written by other patches/overrides ----
    const first = (keys)=>{
      for(const k of keys){
        const v = (localStorage.getItem(k)||"").trim();
        if(v) return v;
      }
      return "";
    };

    const urlKeys = [
      "OPS_CLOUD_URL","OPS_SUPABASE_URL","SUPABASE_URL","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_PROJECT_URL","supabase_url","SUPABASE_URL_V2"
    ];
    const anonKeys = [
      "OPS_CLOUD_ANON_KEY","OPS_CLOUD_ANON","OPS_SUPABASE_ANON_KEY","SUPABASE_ANON_KEY","NEXT_PUBLIC_SUPABASE_ANON_KEY","SUPABASE_KEY","SUPABASE_ANON","anon"
    ];
    const appKeys = [
      "OPS_CLOUD_APP_KEY","OPS_CLOUD_APPKEY","OPS_CLOUD_APPKEY_V1","OPS_APP_KEY","OPS_SYNC_APP_KEY","OPS_SYNC_APPKEY","APP_KEY","app_key","appKey"
    ];

    // Normalize app_key/appKey
    const ak = String((o.app_key || o.appKey || o.appkey || o.app || "") || "").trim() || first(appKeys);
    if(ak){
      if(!o.app_key) o.app_key = ak;
      if(!o.appKey) o.appKey = ak;
    }

    // Fill url/anon if missing
    if(!o.url) o.url = first(urlKeys);
    if(!o.anon) o.anon = first(anonKeys);

    // Also accept legacy field names if present
    if(!o.url && (o.supabase_url||o.project_url)) o.url = (o.supabase_url||o.project_url);
    if(!o.anon && (o.anonKey||o.anon_key||o.key)) o.anon = (o.anonKey||o.anon_key||o.key);

    // Persist back if we successfully recovered missing fields
    if(o.url && o.anon && (o.app_key||o.appKey)){
      try{ localStorage.setItem(CLOUD_CFG_KEY, JSON.stringify(o)); }catch(_e){}
    }
    return o;
  }catch(e){
    return {};
  }
}


function setCloudCfg(cfg){
  try{
    const o = cfg || {};
    const ak = String((o.app_key || o.appKey || o.appkey || o.app || "") || "").trim();
    if(ak){
      o.app_key = ak;
      o.appKey = ak;
    }
    localStorage.setItem(CLOUD_CFG_KEY, JSON.stringify(o));
  }catch(e){}
}

function cloudPromptAndSave(){
  const cur = getCloudCfg();
  const url = prompt("请输入 Supabase Project URL（例如：https://xxxx.supabase.co）", cur.url || "");
  if(url === null) return;
  const anon = prompt("请输入 Supabase anon key（建议粘贴完整 key）", cur.anon || "");
  if(anon === null) return;
  const appKey = prompt("请输入 app_key（用于区分不同系统/不同数据集，例如：ops_v9）", cur.appKey || "ops_v9");
  if(appKey === null) return;
  const _ak = String(appKey||"").trim();
  const cfg = { url: String(url||"").trim(), anon: String(anon||"").trim(), appKey: _ak, app_key: _ak };
  setCloudCfg(cfg);
  if(typeof toast === "function") toast("已保存云端设置");
  else alert("已保存云端设置");
  return cfg;
}


function _scoreState(obj){
  if(!obj || typeof obj!=="object") return 0;
  const pick = (v)=>{
    if(Array.isArray(v)) return v.length;
    if(v && typeof v==="object") return Object.keys(v).length;
    return 0;
  };
  let s = 0;
  s += pick(obj.orders) + pick(obj.orderList) + pick(obj.orderRows) + pick(obj.order_items) + pick(obj.orderItems);
  s += pick(obj.sellers) + pick(obj.sellerList) + pick(obj.sellerRows) + pick(obj.seller_items) + pick(obj.sellerItems) + pick(obj.vendors);
  s += pick(obj.products) + pick(obj.productList) + pick(obj.productRows) + pick(obj.product_items) + pick(obj.productItems) + pick(obj.items);
  const b = obj.batches || obj.batchList || obj.settleBatches || obj.settlementBatches || obj.payoutBatches || obj.payout_batches;
  s += pick(b);
  return s;
}

function _getAppState(){
  // Choose the richest source among in-memory states and persisted snapshot
  const cand = [];
  try{
    if(typeof window!=="undefined"){
      if(window.state) cand.push({name:"window.state", obj:window.state});
      if(window.S) cand.push({name:"window.S", obj:window.S});
    }
  }catch(_e){}
  try{
    if(typeof state!=="undefined") cand.push({name:"state", obj:state});
  }catch(_e){}
  try{
    if(typeof S!=="undefined") cand.push({name:"S", obj:S});
  }catch(_e){}

  // localStorage snapshot
  try{
    const raw = localStorage.getItem("ops_rebuild_v6_4_2_state") || localStorage.getItem("ops_rebuild") || "";
    if(raw){
      const parsed = JSON.parse(raw);
      cand.push({name:"localStorage.ops_rebuild_v6_4_2_state", obj:parsed});
    }
  }catch(_e){}

  let best = null, bestScore = -1;
  for(const c of cand){
    const sc = _scoreState(c.obj);
    if(sc > bestScore){
      bestScore = sc;
      best = c;
    }
  }
  if(typeof window!=="undefined"){
    window.__CLOUD_STATE_SOURCE__ = best ? `${best.name} (score=${bestScore})` : "none";
  }
  return best ? best.obj : null;
}

function _buildCloudPayload(){
  const src = _getAppState();
  if(!src) return { sellers:[], products:[], orders:[], batches:[] };
  // Normalize into the expected payload keys (keep extra fields too)
  const p = JSON.parse(JSON.stringify(src));
  // Ensure arrays exist for counters
  p.sellers = Array.isArray(p.sellers) ? p.sellers : (Array.isArray(p.sellerList) ? p.sellerList : (p.sellers && typeof p.sellers==="object" ? Object.values(p.sellers) : []));
  p.products = Array.isArray(p.products) ? p.products : (Array.isArray(p.productList) ? p.productList : (p.products && typeof p.products==="object" ? Object.values(p.products) : []));
  p.orders = Array.isArray(p.orders) ? p.orders : (Array.isArray(p.orderList) ? p.orderList : (p.orders && typeof p.orders==="object" ? Object.values(p.orders) : []));
  // batches may be under different names
  const b = p.batches || p.batchList || p.settleBatches || p.settlementBatches || p.payoutBatches || p.payout_batches;
  p.batches = Array.isArray(b) ? b : (b && typeof b==="object" ? Object.values(b) : []);
  return p;
}

function getCloudCfgOrNull(){
  const cfg = getCloudCfg();
  const ak = String((cfg.appKey || cfg.app_key || "") || "").trim();
  if(!cfg || !cfg.url || !cfg.anon || !ak) return null;
  // 统一补齐字段，后续模块可直接使用
  cfg.appKey = ak;
  cfg.app_key = ak;
  return cfg;
}

// Ensure Supabase UMD SDK is available (robust for CDN blocked / slow networks)
async function ensureSupabaseSDK(){
  try{
    if(window.supabase && window.supabase.createClient) return true;
    if(window.__supabase_sdk_loading) return await window.__supabase_sdk_loading;

    const tryLoad = (src)=> new Promise((resolve)=>{
      try{
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.crossOrigin = "anonymous";
        s.onload = ()=> resolve(!!(window.supabase && window.supabase.createClient));
        s.onerror = ()=> resolve(false);
        document.head.appendChild(s);
      }catch(e){ resolve(false); }
    });

    window.__supabase_sdk_loading = (async ()=>{
      // Try multiple CDNs to avoid regional blocking
      const cdns = [
        "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js",
        "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/supabase/2.0.0/supabase.min.js"
      ];
      for(const src of cdns){
        const ok = await tryLoad(src);
        if(ok) return true;
      }
      return !!(window.supabase && window.supabase.createClient);
    })();

    return await window.__supabase_sdk_loading;
  }catch(e){ return false; }
}

function getCloudClientOrNull(opts){

  const o = opts || {};
  const quiet = !!o.quiet;
  const cfg = getCloudCfgOrNull();

  const forceReinit = !!o.forceReinit;

  // Ensure SDK is available (best-effort, quiet mode friendly)
  if(!(window.supabase && window.supabase.createClient)){
    // Avoid await here (function is sync); just kick off loader.
    if(typeof ensureSupabaseSDK==="function") ensureSupabaseSDK();
  }

  if(!cfg){
    // 避免自动推送/定时器导致 toast 刷屏
    if(!quiet){
      const now = Date.now();
      if(!window.__toast_cloud_cfg_missing_at || (now - window.__toast_cloud_cfg_missing_at) > 3000){
        window.__toast_cloud_cfg_missing_at = now;
        if(typeof toast === "function") toast("请先设置云端（Supabase）");
      }
    }
    return null;
  }
  if(!window.supabase || !window.supabase.createClient){
    if(!quiet){
      if(typeof toast === "function") toast("Supabase SDK 未加载");
      else alert("Supabase SDK 未加载");
    }
    return null;
  }
  try{
    const key = cfg.url + "|" + cfg.anon + "|" + cfg.app_key;
    if(!window.__cloud_client_cache) window.__cloud_client_cache = {};
    // 缓存统一返回 {client,cfg}，避免调用方解构时报 client/cfg 为 undefined
    if(!forceReinit && window.__cloud_client_cache[key]) return window.__cloud_client_cache[key];
    const client = window.supabase.createClient(cfg.url, cfg.anon, {
      auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
    });
    if(!client || typeof client.from!=="function"){ throw new Error("supabase_createClient_invalid"); }
    const wrap = { client, cfg };
    window.__cloud_client_cache[key] = wrap;
    return wrap;
  }catch(e){
    if(!quiet){
      console.error(e);
      if(typeof toast === "function") toast("云端初始化失败");
    }
    return null;
  }
}



async function _idbOpen(dbName, version){
  return new Promise((resolve,reject)=>{
    try{
      const req = indexedDB.open(dbName, version);
      req.onerror = ()=>reject(req.error);
      req.onsuccess = ()=>resolve(req.result);
      req.onupgradeneeded = ()=>{};
    }catch(e){ reject(e); }
  });
}
async function _idbGetAnyKv(dbName, storeName){
  const db = await _idbOpen(dbName);
  return new Promise((resolve,reject)=>{
    try{
      const tx = db.transaction([storeName],'readonly');
      const st = tx.objectStore(storeName);
      const out = { ok:true, items:[] };
      const req = st.openCursor();
      req.onerror = ()=>{ db.close(); reject(req.error); };
      req.onsuccess = (ev)=>{
        const cur = ev.target.result;
        if(cur){
          out.items.push({ key: cur.key, value: cur.value });
          cur.continue();
        }else{
          db.close();
          resolve(out);
        }
      };
    }catch(e){ try{db.close();}catch(_e){} reject(e); }
  });
}
function _pickSnapshotFromKvItems(items, preferKey){
  if(!items || !items.length) return { ok:false, reason:"kv empty" };

  // Prefer explicit key if provided
  const pref = preferKey ? String(preferKey) : null;
  if(pref){
    for(const it of items){
      if(String(it.key)===pref) return { ok:true, key:it.key, payload:it.value };
    }
  }

  // Backward-compat: prefer main_state_v1 if exists
  for(const it of items){
    if(String(it.key)==="main_state_v1") return { ok:true, key:it.key, payload:it.value };
  }

  // else choose the largest JSON size
  let best = null, bestSize = 0;
  for(const it of items){
    let s=0;
    try{ s = JSON.stringify(it.value||{}).length; }catch(e){ s=0; }
    if(!best || s>bestSize){ bestSize=s; best=it; }
  }
  return best ? { ok:true, key:best.key, payload:best.value } : { ok:false, reason:"no kv" };
}
function _normalizeSnapshot(payload){
  // Robustly unwrap kv-wrapped snapshots (common shapes: {key, value:{...}}, {value:{key,value:{...}}}, {state:{...}}, {data:{...}})
  let p = payload;
  // If payload is a JSON string, try to parse it (some historical pushes stored stringified JSON)
  if(typeof p==="string"){
    try{ p = JSON.parse(p); }catch(_e){}
  }

  for(let i=0;i<6;i++){
    if(!p || typeof p!=="object") break;

    // if p already looks like a snapshot
    const hasArr = (k)=>Array.isArray(p[k]);
    if(hasArr("sellers") || hasArr("products") || hasArr("orders") || hasArr("batches") ||
       hasArr("sellerList") || hasArr("productList") || hasArr("orderList") || hasArr("batchList")){
      return p;
    }

    // unwrap common wrappers
    if(p.value && typeof p.value==="object"){ p = p.value; continue; }
    if(p.state && typeof p.state==="object"){ p = p.state; continue; }
    if(p.data && typeof p.data==="object"){ p = p.data; continue; }

    // idb-keyval style: {key, value}
    if(p.key && p.value && typeof p.value==="object"){ p = p.value; continue; }

    break;
  }
  return p || null;
}
function _countSnapshot(p){
  p = _normalizeSnapshot(p);
  const getArr = (...keys)=>{
    for(const k of keys){
      const v = p && p[k];
      if(Array.isArray(v)) return v;
    }
    return [];
  };
  const sellers = getArr("sellers","sellerList","seller_items");
  const products = getArr("products","productList","product_items");
  const orders = getArr("orders","orderList","order_items");
  const batches = getArr("batches","settlementBatches","payoutBatches","batchList");
  return { sc:sellers.length, pc:products.length, oc:orders.length, bc:batches.length };
}

// -------------------------
// Plan A merge + hash helpers
// -------------------------
function simpleHash(str){
  // FNV-1a 32-bit
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
  }
  return String(h);
}
function _getIdFromItem(it){
  if(!it || typeof it!=="object") return null;
  return it.id || it.order_id || it.product_id || it.seller_id || it.batch_id || null;
}
function _getTs(it){
  if(!it || typeof it!=="object") return 0;
  const v = it.updatedAt || it.updated_at || it.modifiedAt || it.modified_at || it.createdAt || it.created_at || it.ts || it.time || 0;
  if(typeof v==="number") return v;
  const t = Date.parse(v);
  return isNaN(t) ? 0 : t;
}
function _mergeListById(localArr, cloudArr){
  const out = [];
  const map = new Map();
  const push = (it, src)=>{
    const id = _getIdFromItem(it);
    if(!id){
      out.push(it);
      return;
    }
    const prev = map.get(String(id));
    if(!prev){
      map.set(String(id), it);
      out.push(it);
      return;
    }
    const prevTs = _getTs(prev);
    const curTs = _getTs(it);
    if(curTs >= prevTs){
      // replace in out
      const idx = out.indexOf(prev);
      if(idx>=0) out[idx]=it;
      map.set(String(id), it);
    }
  };
  (cloudArr||[]).forEach(it=>push(it,"cloud"));
  (localArr||[]).forEach(it=>push(it,"local"));
  return out;
}
function mergeSnapshotsPlanA(localSnap, cloudSnap){
  const L = localSnap && typeof localSnap==="object" ? localSnap : {};
  const C = cloudSnap && typeof cloudSnap==="object" ? cloudSnap : {};
  // Start from cloud as base to preserve any extra fields.
  const merged = JSON.parse(JSON.stringify(C));

  const listKeys = [
    ["sellers","sellerList","seller_items"],
    ["products","productList","product_items"],
    ["orders","orderList","order_items"],
    ["batches","settlementBatches","payout_batches"]
  ];

  for(const keys of listKeys){
    const k = keys[0];
    const getArr = (obj)=>{
      for(const kk of keys){
        const v = obj && obj[kk];
        if(Array.isArray(v)) return { key: kk, arr: v };
      }
      return { key: null, arr: null };
    };
    const ca = getArr(C);
    const la = getArr(L);
    const cloudArr = ca.arr || [];
    const localArr = la.arr || [];
    if(cloudArr.length===0 && localArr.length===0) continue;

    const mergedArr = _mergeListById(localArr, cloudArr);
    // write to canonical key k for stability
    merged[k] = mergedArr;
    // also keep original key if existed in cloud to avoid breaking old UI
    if(ca.key && ca.key!==k) merged[ca.key] = mergedArr;
    if(la.key && la.key!==k) merged[la.key] = mergedArr;
  }

  // If local has newer "meta" version/time fields, keep them (best-effort)
  for(const mk of ["version","ver","schemaVersion","updatedAt","updated_at"]){
    if(L[mk] && !merged[mk]) merged[mk] = L[mk];
  }
  return merged;
}
function _mergeSnapshotsFallback(localSnap, cloudSnap){
  // simple union: cloud as base, list union by id
  return mergeSnapshotsPlanA(localSnap, cloudSnap);
}


async function getLocalSnapshotPreferIDB(){
  // Strategy:
  // 1) If in-memory snapshot has data -> use it
  // 2) Else scan known IndexedDB snapshot locations and pick the largest non-empty snapshot
  // NOTE: We intentionally do NOT trust localStorage for large datasets (15k+ orders).
  const mem = (typeof state!=="undefined" && state) ? state : (typeof S!=="undefined" && S ? S : null);
  if(mem){
    const cm = _countSnapshot(mem);
    if(cm.sc||cm.pc||cm.oc||cm.bc) return { ok:true, source:"mem", payload:mem, counts:cm };
  }



  // LocalStorage main snapshot (primary for this single-file app)
  // Key: ops_rebuild_v6_4_2_state
  try{
    const raw = localStorage.getItem("ops_rebuild_v6_4_2_state");
    if(raw){
      const parsed = JSON.parse(raw);
      const cl = _countSnapshot(parsed||{});
      if(cl.sc||cl.pc||cl.oc||cl.bc){
        return { ok:true, source:"ls:ops_rebuild_v6_4_2_state", payload:parsed, counts:cl };
      }
      // If it's empty, do not early return; continue to IDB scan.
    }
  }catch(e){
    // ignore parse errors
  }

  const candidates = [
    { db:"ops_v642_main", store:"kv", preferKey:"main_state_v1" },
    { db:"ops_rebuild_v6_4_2_db", store:"kv", preferKey:"main_state_v1" },
    { db:"ops_v642_settle_drafts", store:"kv", preferKey:null },
  ];

  let best = null;

  for(const cand of candidates){
    try{
      const res = await _idbGetAnyKv(cand.db, cand.store);
      const picked = _pickSnapshotFromKvItems(res.items, cand.preferKey);
      if(!picked.ok) continue;

      const p = _normalizeSnapshot(picked.payload);
      const c = _countSnapshot(p);
      const size = (()=>{ try{return JSON.stringify(p||{}).length;}catch(e){return 0;} })();

      // require at least one array count OR non-trivial size
      const nonEmpty = (c.sc||c.pc||c.oc||c.bc||size>5000);
      if(!nonEmpty) continue;

      if(!best || size > best.size){
        best = { source:`idb:${cand.db}/${cand.store}/${String(picked.key)}`, payload:p, counts:c, size };
      }
    }catch(_e){}
  }

  if(best) return { ok:true, ...best };

  return { ok:true, source:"mem(empty)", payload: mem || {}, counts:_countSnapshot(mem||{}) };
}

async function cloudStatus(){
  const sb = getCloudClientOrNull();
  if(!sb) return;
  const cfg = getCloudCfgOrNull();

  const forceReinit = !!o.forceReinit;

  // Ensure SDK is available (best-effort, quiet mode friendly)
  if(!(window.supabase && window.supabase.createClient)){
    // Avoid await here (function is sync); just kick off loader.
    if(typeof ensureSupabaseSDK==="function") ensureSupabaseSDK();
  }

  if(!cfg || !cfg.url || !cfg.anon || !cfg.appKey){
    toast("请先设置云端（Supabase URL / anon key / app_key）","warn");
    return;
  }
  const { client } = sb;
  try{
    const { data, error } = await client.from("ops_cloud_snapshots_v1").select("app_key,hash,updated_at,created_at,payload").eq("app_key", cfg.appKey).maybeSingle();
    if(error) throw error;
    if(!data){
      alert("云端暂无快照（app_key=" + cfg.appKey + "）。");
      return;
    }
    const payload = data.payload || {};
    const c = _countSnapshot(payload);
    const size = (()=>{ try{return JSON.stringify(payload).length;}catch(e){return 0;} })();
    const msg =
      "云端快照状态\n\n" +
      "app_key: " + data.app_key + "\n" +
      "hash: " + data.hash + "\n" +
      "updated_at: " + data.updated_at + "\n" +
      "created_at: " + data.created_at + "\n\n" +
      "内容统计：卖家" + c.sc + " 产品" + c.pc + " 订单" + c.oc + " 批次" + c.bc + "\n" +
      "payload 大小：" + size + " chars";
    alert(msg);
  }catch(e){
    toast("云端状态失败：" + (e && e.message ? e.message : String(e)),"err");
  }
}

async function cloudPush(opts){
  const sb = getCloudClientOrNull();
  if(!sb){ cloudPromptAndSave(); return { ok:false, reason:"no_client" }; }
  const { client, cfg } = sb;

  const force = !!(opts && opts.force);

  try{
    const local = await getLocalSnapshotPreferIDB();
    if(!local.ok){
      alert("无法获取本地数据快照：\n" + (local.reason||"unknown"));
      return { ok:false, reason:"no_local_snapshot" };
    }
    const finalPayload = local.payload || {};
    const counts = local.counts || _countSnapshot(finalPayload);
    const sc = counts.sc||0, pc = counts.pc||0, oc = counts.oc||0, bc = counts.bc||0;

    // Plan A safety gate: block "empty local" unless forced
    if(!force && sc===0 && pc===0 && oc===0 && bc===0){
      const ok = confirm(
        "安全保护：当前本地数据为 0（卖家/产品/订单/批次均为空）。\n\n"
        + "数据来源：" + local.source + "\n\n"
        + "为避免误覆盖云端，本次推送已被拦截。\n\n"
        + "如你确认这是正确的空库初始化，请按住 Shift 再点击“云端推送”进行强制推送。"
      );
      if(!ok) return { ok:false, reason:"blocked_empty_local" };
      // 用户点了确认，但仍不强制；这里保持拦截，防止误操作
      return { ok:false, reason:"blocked_empty_local" };
    }

    // Step 1: pull cloud snapshot (best-effort)
    let cloud = null;
    try{
      const { data: row, error: e } = await client.from("ops_cloud_snapshots_v1")
        .select("app_key,hash,payload,counts,updated_at,created_at")
        .eq("app_key", cfg.appKey).maybeSingle();
      if(e) throw e;
      cloud = row || null;
    }catch(_e){ cloud = null; }

    // Step 2: merge (Plan A: union by id; prefer newer updatedAt)
    const localSnap = finalPayload || {};
    const cloudSnap = (cloud && cloud.payload) ? cloud.payload : null;

    const merged = (cloudSnap && typeof mergeSnapshotsPlanA==="function")
      ? mergeSnapshotsPlanA(localSnap, cloudSnap)
      : (cloudSnap ? _mergeSnapshotsFallback(localSnap, cloudSnap) : localSnap);

    const mergedCounts = _countSnapshot(merged);
    const mergedHash = (typeof simpleHash==="function") ? simpleHash(JSON.stringify(merged)) : Date.now();

    // If we have cloud hash and merged has same hash, skip push
    if(cloud && cloud.hash && String(cloud.hash)===String(mergedHash)){
      console.log(`[PUSH] 无需推送：合并后 hash 未变化（hash=${mergedHash}）`);
      return { ok:true, skipped:true, hash: mergedHash, counts: mergedCounts, local_source: local.source };
    }

    // Step 3: upsert merged snapshot
    const nowIso = new Date().toISOString();
    const row = {
      app_key: cfg.appKey,
      hash: mergedHash,
      payload: merged,
      counts: mergedCounts,
      updated_at: nowIso
    };

    const { error } = await client.from("ops_cloud_snapshots_v1").upsert(row, { onConflict: "app_key" });
    if(error) throw error;

    console.log(`[PUSH] 推送成功：卖家${mergedCounts.sc} 产品${mergedCounts.pc} 订单${mergedCounts.oc} 批次${mergedCounts.bc}（hash=${mergedHash}，local_src=${local.source}）`);
    toast(`云端推送成功：卖家${mergedCounts.sc} 产品${mergedCounts.pc} 订单${mergedCounts.oc} 批次${mergedCounts.bc}`,"ok");
    return { ok:true, hash: mergedHash, counts: mergedCounts, local_source: local.source };
  }catch(e){
    console.error(e);
    const msg = (e && (e.message||e.details||e.hint)) ? (e.message||e.details||e.hint) : String(e);
    toast("云端推送失败：" + msg,"err");
    alert("云端推送失败：\n" + msg);
    return { ok:false, reason:"push_failed", error: msg };
  }
}

async function cloudPull(){
  const sb = getCloudClientOrNull();
  if(!sb){ cloudPromptAndSave(); return; }
  const { client, cfg } = sb;

  if(!confirm("从云端拉取会覆盖本地当前数据。\n\n建议：先点「导出 JSON」本地存一份备份。\n\n确定要继续吗？")) return;

  try{
    toast("云端拉取中…");

    const { data, error } = await client
      .from("ops_cloud_snapshots_v1")
      .select("payload,hash,updated_at,created_at,app_key")
      .eq("app_key", cfg.appKey)
      .maybeSingle();

    if(error) throw error;

    if(!data || data.payload == null){
      alert("云端没有可用快照（app_key=" + cfg.appKey + "）。");
      return;
    }

    // payload 可能是 JSON 字符串或对象
    let payload = data.payload;
    if(typeof payload === "string"){
      try{ payload = JSON.parse(payload); }catch(_e){}
    }

    // Apply into app state (this app uses S as the live state)
    if(typeof S !== "undefined"){
      S = payload;
      window.state = S;
    }else{
      window.state = payload;
    }

    // 关键：拉取后重置一些 UI 过滤/选择，避免“数据已恢复但被筛选为空”
    try{
      UI.selected && UI.selected.clear && UI.selected.clear();
      UI.payoutSelected && UI.payoutSelected.clear && UI.payoutSelected.clear();
      if(typeof payoutResetView==="function") payoutResetView();
      if($("filterSeller")) $("filterSeller").value = "ALL";
      if($("orderSearch")) $("orderSearch").value = "";
      if($("filterPrincipal")) $("filterPrincipal").value = "ALL";
      if($("filterCommission")) $("filterCommission").value = "ALL";
      UI.page = 1;
      UI.tab = "dashboard";
    }catch(_e){}

    // 重新计算序号/索引，持久化并刷新 UI
    try{ if(typeof restorePayoutSnapshot==="function") restorePayoutSnapshot(S); }catch(_e){}
    try{ if(typeof computeSeq==="function") computeSeq(); }catch(_e){}
    try{ if(typeof saveNow==="function") saveNow(); else if(typeof save==="function") save(); }catch(_e){}
    try{ if(typeof renderAll==="function") renderAll(); }catch(_e){}

    const sc = (S && S.sellers && S.sellers.length) || 0;
    const pc = (S && S.products && S.products.length) || 0;
    const oc = (S && S.orders && S.orders.length) || 0;
    const bc = (S && S.batches && S.batches.length) || 0;

    toast(`云端拉取完成：卖家${sc} 产品${pc} 订单${oc} 批次${bc}（hash=${String(data.hash||"").slice(0,8)}…）`);
  }catch(e){
    console.error(e);
    alert("云端拉取失败：\n" + (e && e.message ? e.message : String(e)));
  }
}

// bind buttons after load
window.addEventListener("load", ()=>{
  const byId = (id)=>document.getElementById(id);
  const bCfg = byId("btnCloudCfg");
  const bPush = byId("btnCloudPush");
  const bPull = byId("btnCloudPull");
  const bStatus = byId("btnCloudStatus");
  if(bCfg) bCfg.onclick = ()=>cloudPromptAndSave();
  if(bPush) bPush.onclick = ()=>cloudPushFixed();
  if(bPull) bPull.onclick = ()=>cloudPull();
  if(bStatus) bStatus.onclick = ()=>cloudStatusFixed();
});
/* ===================== End Cloud Backup ===================== */

</script>

<!-- Supabase UMD (Cloud Backup) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

</head>
<body>
<script>
// DOM helpers (no jQuery)
window.$ = window.$ || function(sel, root){ return (root||document).querySelector(sel); };
window.$$ = window.$$ || function(sel, root){ return Array.from((root||document).querySelectorAll(sel)); };

// Global DOM helpers (avoid dependency on jQuery)
window.$ = window.$ || function(sel, root){
  root = root || document;
  if (!sel) return null;
  // pass-through
  if (sel === window || sel === document) return sel;
  if (sel instanceof Element) return sel;
  if (typeof sel !== 'string') return null;
  var s = sel.trim();
  if (!s) return null;
  try {
    // Treat CSS selector-like strings as querySelector.
    if (s[0] === '#' || s[0] === '.' || s[0] === '[' || s.includes(' ') || s.includes('>') || s.includes(':')) {
      return (root.querySelector ? root.querySelector(s) : document.querySelector(s));
    }
    // Prefer id lookup for plain tokens.
    if (root.getElementById) return root.getElementById(s);
    return document.getElementById(s) || (root.querySelector ? root.querySelector('#'+s) : null);
  } catch (e) {
    return null;
  }
};
window.$$ = window.$$ || function(sel, root){
  root = root || document;
  if (!sel) return [];
  try { return Array.from((root.querySelectorAll ? root.querySelectorAll(sel) : document.querySelectorAll(sel))); }
  catch(e){ return []; }
};
window.$$$ = window.$$$ || function(sel, root){
  // alias for $$
  return window.$$(sel, root);
};
</script>

<div class="wrap">
  <div class="topbar">
<div class="header">
    <div>
      <div class="title">简易登记系统 v6.4.2（重构稳定版）</div>
      <div class="desc">
        目标：修复 v6.4.0 中「批量解析/产品关联/结算乘汇率/回评默认/本佣一起/批次CSV导出」等失效点。<br/>
        规则：结算本金 = (金额 - 折扣) × FX；佣金 = 按“回评登记弹窗”的已回评类型（自动跟随产品/无产品默认文字评）。
      </div>
    </div>
    <div class="top-actions">
      <button class="btn" id="btnExport">导出 JSON</button>
      <button class="btn" id="btnImport">导入 JSON</button>
      <button class="btn" id="btnCloudCfg" title="配置 Supabase 云端备份">云端设置</button>
      <button class="btn" id="btnCloudPush" title="把当前数据备份到云端">云端推送</button>
      <button class="btn" id="btnCloudPull" title="从云端恢复并覆盖本地">云端拉取</button>
      <button class="btn" id="btnCloudStatus" title="查看云端快照状态">云端状态</button>
      <button class="btn" id="btnSyncMainState" title="把当前订单表格数据写入主快照，用于云端推送/拉取与导出一致">同步主数据</button>
      <button class="btn" id="btnLoadSample">加载示例数据</button>
      <button class="btn danger" id="btnReset">清空数据</button>
      <button class="btn danger" id="btnHardReset" title="清理本域名下所有 IndexedDB + localStorage（包含旧系统残留），用于从零开始">彻底重置</button>
      <input type="file" id="importFile" accept="application/json" style="display:none"/>
    </div>
  </div>

  <div class="tabs card navtabs">
    <button class="tab active" data-tab="dashboard">看板</button>
    <button class="tab" data-tab="sellers">卖家</button>
    <button class="tab" data-tab="products">产品</button>
    <button class="tab" data-tab="orders">订单</button>
    <button class="tab" data-tab="payout">返款</button>
  </div>
</div>


  <section id="tab-dashboard" class="card">
    <h3>看板</h3>
    <div class="kpi">
      <div class="box"><div class="mini">卖家数</div><div class="v" id="kpiSellers">0</div></div>
      <div class="box"><div class="mini">产品数</div><div class="v" id="kpiProducts">0</div></div>
      <div class="box"><div class="mini">订单数</div><div class="v" id="kpiOrders">0</div></div>
      <div class="box"><div class="mini">待结算本金</div><div class="v" id="kpiP">0</div></div>
      <div class="box"><div class="mini">待结算佣金（已回评/免评）</div><div class="v" id="kpiC">0</div></div>
    </div>
    <hr/>
  </section>

  <section id="tab-sellers" class="card" style="display:none">
    <h3>卖家（8 国 FX + 佣金 CNY）</h3>
    <div class="help">FX 为“原币→CNY”。佣金固定人民币 CNY（按回评类型）。</div>
    
    <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="btn" id="btnExportSellersCsv" type="button">导出卖家 CSV</button>
      <button class="btn" id="btnExportSellersJson" type="button">导出卖家 JSON</button>
      <button class="btn primary" id="btnImportSellers" type="button">导入卖家（CSV / XLSX / JSON）</button>
      <input id="fileImportSellers" type="file" accept=".csv,.xlsx,.json" style="display:none"/>
      <span class="help" style="margin-left:auto">导入规则：按 seller_id 合并（存在则更新，不存在则新增）。</span>
    </div>

    <hr/>
    <div class="grid cols-4">
      <div><label>Seller ID *</label><input id="sellerId" placeholder="例如：S001" class="mono"/></div>
      <div><label>卖家名称 *</label><input id="sellerName" placeholder="例如：欧美测评"/></div>
      <div><label>联系人（可选）</label><input id="sellerContact" placeholder="WhatsApp/Telegram/Email"/></div>
      <div><label>备注（可选）</label><input id="sellerRemark" placeholder="备注"/></div>
    </div>
    <hr/>
    <h4>FX（原币→CNY）</h4>
    <div class="grid cols-4" id="sellerFxGrid"></div>
    <hr/>
    <h4>佣金（CNY）</h4>
    <div class="grid cols-3" id="sellerCommissionGrid"></div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnSaveSeller">保存卖家</button>
      <button class="btn" id="btnCancelSellerEdit" style="display:none">取消编辑</button>
      <span class="mini" id="sellerEditHint"></span>
    </div>

    <hr/>
    <div class="row">
      <input id="sellerSearch" placeholder="搜索 Seller ID / 名称" style="max-width:340px"/>
    </div>
    
    <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
      <div class="mini" id="sellerPagerInfoTop">共 0 条</div>
      <div class="row" style="gap:6px;align-items:center">
        <button class="btn" id="sellerPrevTop" type="button">上一页</button>
        <span class="mini" id="sellerPagerPageTop">第 1 / 1 页</span>
        <button class="btn" id="sellerNextTop" type="button">下一页</button>
      </div>
    </div>
<div class="table-wrap" style="margin-top:10px">
      <table>
        <thead>
          <tr><th>ID</th><th>名称</th><th>联系人</th><th>备注</th><th>FX 摘要</th><th>佣金摘要</th><th class="right">操作</th></tr>
        </thead>
        <tbody id="sellerRows"></tbody>
      </table>
      </div>
      <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
        <div class="mini" id="sellerPagerInfo">共 0 条</div>
        <div class="row" style="gap:6px;align-items:center">
          <button class="btn" id="sellerPrev" type="button">上一页</button>
          <span class="mini" id="sellerPagerPage">第 1 / 1 页</span>
          <button class="btn" id="sellerNext" type="button">下一页</button>
        </div>
      </div>
    </div>
  </section>

  <section id="tab-products" class="card" style="display:none">
    <h3>产品（ASIN / Market / 折扣 / 回评类型）</h3>
    <div class="help">产品的 Market/回评类型/折扣会在“新建订单/批量解析/粘贴选单关联产品”时作为默认值。</div>
    
    <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="btn" id="btnExportProductsCsv" type="button">导出产品 CSV</button>
      <button class="btn" id="btnExportProductsJson" type="button">导出产品 JSON</button>
      <button class="btn primary" id="btnImportProducts" type="button">导入产品（CSV / XLSX / JSON）</button>
      <input id="fileImportProducts" type="file" accept=".csv,.xlsx,.json" style="display:none"/>
      <span class="help" style="margin-left:auto">导入规则：按 (market + asin) 合并；ASIN 自动大写。</span>
    </div>

    <hr/>
    <div class="grid cols-5">
      <div><label>产品名称 *</label><input id="productName" placeholder="例如：美国车载充电器"/></div>
      <div><label>ASIN *</label><input id="productAsin" placeholder="例如：B0XXXXXXX" class="mono"/></div>
      <div><label>Market *</label><select id="productMarket"></select></div>
      <div><label>卖家 *</label><select id="productSeller"></select></div>
      <div><label>回评类型 *</label><select id="productReviewType"></select></div>
    </div>
    <div class="grid cols-4" style="margin-top:10px">
      <div><label>折扣（原币）</label><input id="productDiscount" placeholder="例如：1.5" type="number" step="0.01"/></div>
      <div><label>买手佣金（原币）</label><input id="productBuyerCommission" placeholder="例如：2.00" type="number" step="0.01"/></div>
      <div><label>备注（可选）</label><input id="productRemark" placeholder="备注"/></div>
      <div><label>卖家配置预览（自动）</label><input id="productPreview" disabled/></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnSaveProduct">保存产品</button>
      <button class="btn" id="btnCancelProductEdit" style="display:none">取消编辑</button>
      <span class="mini" id="productEditHint"></span>
    </div>

    <hr/>
    <div class="row">
      <input id="productSearch" placeholder="搜索 产品名 / ASIN / Seller / Market" style="max-width:420px"/>
    </div>
    
    <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
      <div class="mini" id="productPagerInfoTop">共 0 条</div>
      <div class="row" style="gap:6px;align-items:center">
        <button class="btn" id="productPrevTop" type="button">上一页</button>
        <span class="mini" id="productPagerPageTop">第 1 / 1 页</span>
        <button class="btn" id="productNextTop" type="button">下一页</button>
      </div>
    </div>
<div class="table-wrap" style="margin-top:10px">
      <table>
        <thead>
          <tr><th>产品名</th><th>ASIN</th><th>Market</th><th>币种</th><th>Seller</th><th>回评类型</th><th>折扣（原币）</th><th class="right">操作</th></tr>
        </thead>
        <tbody id="productRows"></tbody>
      </table>
    </div>
      <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
        <div class="mini" id="productPagerInfo">共 0 条</div>
        <div class="row" style="gap:6px;align-items:center">
          <button class="btn" id="productPrev" type="button">上一页</button>
          <span class="mini" id="productPagerPage">第 1 / 1 页</span>
          <button class="btn" id="productNext" type="button">下一页</button>
        </div>
      </div>
  </section>

  <section id="tab-orders" class="card" style="display:none">
    <h3>订单（登记 / 批量解析 / 产品关联 / 结算 / 回评 / 批次导出）</h3>

    <details open>
      <summary>新建/编辑订单（必选：卖家；可选：产品）</summary>
      <div style="margin-top:10px" class="help">
        选择产品后：自动填充 Market / 回评类型 / 折扣 / ASIN；并同步卖家为该产品卖家（如不同）。
      </div>
      <hr/>
            <div class="grid" style="grid-template-columns: 1.25fr 1.5fr 1.05fr 0.75fr 0.75fr; gap:10px">
        <div><label>选择产品（可选）</label>
<select id="orderProduct"></select></div>
        <div><label>订单号 Order ID *</label><input id="orderId" class="mono" placeholder="例如：111-3149968-9279463"/></div>
        <div><label>卖家 *（必选）</label>
<select id="orderSeller"></select></div>
        <div><label>回评类型（默认跟随产品）</label><select id="orderReviewType"></select></div>
        <div><label>折扣（原币）</label><input id="orderDiscount" placeholder="留空=用产品折扣" type="number" step="0.01"/></div>
      </div>
      <div class="grid" style="margin-top:10px; grid-template-columns: 0.7fr 1fr 0.75fr 0.75fr 1.2fr; gap:10px">
  <div><label>国家/Market *</label><select id="orderMarket"></select></div>
  <div><label>订单金额（原币）*</label><input id="orderAmount" placeholder="例如 15.99" type="number" step="0.01"/></div>
  <div><label>ASIN（自动/可改）</label><input id="orderAsin" class="mono" placeholder="可留空"/></div>
  <div><label>买手佣金（原币）</label><input id="orderBuyerCommission" placeholder="留空=用产品买手佣金" type="number" step="0.01"/></div>
  <div><label>产品名/备注（可选）</label><input id="orderNote" placeholder="备注"/></div>
</div>
<div style="display:none">
  <label>下单日期 *</label><input type="date" id="orderDate"/>
  <label>币种（自动）</label><input id="orderCurrency" disabled/>
  <label>汇率覆写（可选）</label><input id="orderFxOverride" placeholder="留空=用卖家默认FX" type="number" step="0.0001"/>
</div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnSaveOrder">保存订单</button>
        <button class="btn" id="btnCancelOrderEdit" style="display:none">取消编辑</button>
        <span class="mini" id="orderEditHint"></span>
      </div>
    </details>

    <hr/>

    <details open>
      <summary>批量解析登记订单（每行一单，可选产品套用）</summary>
      <div class="help" style="margin-top:10px">
        每行示例：<span class="mono">111-3149968-9279463美国儿童防水罩免评15.99</span>（订单号在前，价格在末尾）。<br/>
        若选择“套用产品”：Market/折扣/回评类型/ASIN 全部按产品；否则按文本识别（识别失败用默认 Market）。
      </div>
      <hr/>
      <div class="batch-layout">
        <div class="batch-left">
          <textarea id="batchText" placeholder="粘贴多行..."></textarea>
          <div class="row batch-actions">
            <button class="btn primary" id="btnBatchParse">解析并提交</button>
            <button class="btn" id="btnBatchPreview">仅预览</button>
          </div>
          <div class="mini" id="batchHint"></div>
        </div>

        <div class="batch-right batch-opts">
          <div class="grid cols-2 batch-opts-grid">
<div>
              <label>卖家 *（必选）</label>
              <select id="batchSeller"></select>
            </div>
<div>
              <label>套用产品（可选）</label>
              <select id="batchProduct"></select>
            </div>

            <div>
              <label>默认日期</label>
              <input type="date" id="batchDate"/>
            </div>
            <div>
              <label>默认 Market（识别失败用）</label>
              <select id="batchMarket"></select>
            </div>
          </div>
        </div>
      </div>
    </details>

    <hr/>

    <details open>
      <summary>订单列表（筛选 + 粘贴选单关联产品 + 多选结算）</summary>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div class="tags" id="selectedTags"></div>
        <div class="mini" id="selectedCount"></div>
      </div>

      <div class="grid cols-2" style="margin-top:12px">
        <div class="card" style="background:#f8fafc">
          <h4 style="margin:0 0 8px">粘贴订单号：自动勾选（每行一单）</h4>
          <textarea id="pasteSelectBox" rows="3" placeholder="111-3149968-9279463&#10;112-7138336-3094648"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="btnParseSelect">解析并勾选</button>
            <button class="btn" id="btnClearSelected">清空勾选</button>
          </div>
          <div class="mini" id="pasteSelectHint"></div>
        </div>

        <div class="card" style="background:#f8fafc">
          <h4 style="margin:0 0 8px">粘贴订单号：关联产品（并勾选）</h4>
<div class="grid cols-2" style="margin-top:8px">
            <div><label>选择产品 *</label><select id="linkProduct"></select></div>
            <div><label>操作</label>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <button class="btn primary" id="btnLinkProduct">解析+关联+勾选</button>
                <button class="btn good" id="btnBatchReviewDone">批量标记已回评</button>
              </div></div>
          </div>
          <textarea id="pasteLinkBox" rows="2" placeholder="111-3149968-9279463&#10;112-7138336-3094648"></textarea>
<div class="mini" id="pasteLinkHint"></div>
        </div>
      </div>


      <div class="grid cols-5" style="align-items:end;margin-top:12px">
        <div><label>搜索订单号/产品/ASIN（输入前 19 位自动勾选）</label>
          <input id="filterSearch" placeholder="例如：112-7138336-3094648" style="max-width:320px"/>
        </div>
        <div><label>卖家筛选</label><select id="filterSeller"></select></div>
        <div><label>本金状态</label>
          <select id="filterPrincipal">
            <option value="ALL">全部</option>
            <option value="UNSETTLED">待结算</option>
            <option value="SETTLED">已结算</option>
          </select>
        </div>
        <div><label>佣金状态</label>
          <select id="filterCommission">
            <option value="ALL">全部</option>
            <option value="UNSETTLED">待结算</option>
            <option value="SETTLED">已结算</option>
          </select>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="btnResetFilters">重置</button>
          <button class="btn primary" id="btnSettlePrincipal" disabled>结算本金</button>
          <button class="btn good" id="btnSettleCommission" disabled>结算佣金</button>
          <button class="btn" id="btnSettleBoth" disabled>本佣一起</button>
        </div>
      </div>


      <div class="row" style="margin-top:10px;justify-content:flex-end;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnSettleDrafts">收款草稿箱</button>
        <button class="btn" id="btnExportOrdersCsv">导出订单 CSV（按当前筛选）</button>
      </div>

      <div class="pager" style="margin-top:10px">
        <div class="left">
          <span class="pill" id="pagerInfo">共 0 单</span>
          <span class="pill" id="pagerPage">第 1 / 1 页</span>
          <button class="btn" id="btnPrevPage">上一页</button>
          <button class="btn" id="btnNextPage">下一页</button>
        </div>
        <div class="right">
          <label class="mini">每页</label>
          <select id="pageSize" style="width:120px">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
          </select>
          <label class="mini">跳转页</label>
          <input id="gotoPage" style="width:120px" placeholder="例如 3"/>
          <button class="btn" id="btnGoto">跳转</button>
        </div>
      </div>
    </details>

    <div class="table-wrap" style="margin-top:10px">
      <div class="table-scroll"><table class="orders-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="chkAll"/></th>
            <th>日期</th><th>订单号</th><th>卖家</th><th>国家</th><th>产品</th><th>ASIN</th>
            <th>回评</th><th>回评类型</th>
            <th class="right">金额</th><th class="right">折扣</th><th class="right">本金(CNY)</th><th>本金状态</th>
            <th class="right">佣金(CNY)</th><th>佣金状态</th>
            <th class="right action-col">操作</th>
          </tr>
        </thead>
        <tbody id="orderRows"></tbody>
      </table></div>
    </div>

    
    <hr/>
    <div class="row" style="justify-content:space-between;align-items:center;margin-top:10px">
      <h4 style="margin:0">批次列表（可导出 CSV / 删除回滚）</h4>
      <button class="btn sm" id="batchToggle">展开</button>
    </div>
    <div id="batchBox" style="display:none">
      <div class="help">提示：用于“收款/结算”批次管理；导出CSV用于对账；删除回滚会撤销该批次对订单的回写。</div>
      <div class="table-wrap">

      <table>
        <thead>
          <tr><th>批次ID</th><th>类型</th><th>日期</th><th>卖家</th><th>订单数</th><th class="right">合计(CNY)</th><th>FX 摘要</th><th class="right">操作</th></tr>
        </thead>
        <tbody id="batchRows"></tbody>
      </table>
    </div>
      </div>
</section>

  <section id="tab-payout" class="card" style="display:none">
    <h3>返款（打款给买手）</h3>
    <div class="help">
      规则：返款合计(CNY) = (金额(原币) - 折扣(原币) + 买手佣金(原币)) × FX + 佣金(CNY)。<br/>
      当前阶段：仅要求回评状态 = DONE 可返款；返款截图/链接后续前端对接再补。
    </div>

    <div class="card" style="padding:10px; margin-top:8px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:700">返款默认设置（用于弹窗默认值）</div>
        <button class="btn sm" id="payoutCfgToggle">展开</button>
      </div>
      <div id="payoutCfgBox" style="margin-top:10px;display:none">
        <div class="grid cols-6">
          <div><label>USD→CNY</label><input id="payoutFxUsd" type="number" step="0.0001" placeholder="例如 7.30"/></div>
          <div><label>GBP→CNY</label><input id="payoutFxGbp" type="number" step="0.0001" placeholder="例如 9.80"/></div>
          <div><label>EUR→CNY</label><input id="payoutFxEur" type="number" step="0.0001" placeholder="例如 8.50"/></div>
          <div><label>CAD→CNY</label><input id="payoutFxCad" type="number" step="0.0001" placeholder="例如 5.30"/></div>
          <div><label>JPY→CNY</label><input id="payoutFxJpy" type="number" step="0.000001" placeholder="例如 0.053"/></div>
          <div><label>佣金(CNY)默认</label><input id="payoutCommDefault" type="number" step="0.01" placeholder="留空=按卖家回评类型佣金"/></div>
        </div>
        <div class="row" style="gap:10px;margin-top:10px;flex-wrap:wrap">
          <button class="btn" id="payoutCfgSave">保存为默认</button>
          <button class="btn" id="payoutCfgReset">恢复默认</button>
          <span class="help" id="payoutCfgHint"></span>
        </div>
      </div>
    </div>

    <hr/>

    <div class="grid cols-4">
      <div>
        <label>搜索（订单号/ASIN/产品名）</label>
        <input id="payoutSearch" class="inp" placeholder="输入前 19 位可快速匹配" />
      </div>
      <div>
        <label>卖家筛选</label>
        <div style="display:flex; gap:10px; align-items:center; margin-top:0; flex-wrap:nowrap;">
          <input id="payoutSellerSearch" class="inp" placeholder="搜索卖家…" style="flex:1; margin:0; min-width:160px;"/>
          <select id="payoutSellerFilter" style="min-width:160px;"><option value="">全部卖家</option></select>
        </div>
      </div>
      <div>
        <label>返款状态</label>
        <select id="payoutStatusFilter">
          <option value="payout_pending">已回评待打款</option>
          <option value="paid">已返款</option>
          <option value="">全部</option>
        </select>
        <div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
          <button class="btn sm" id="payoutQuickPending">只看待返款</button>
          <button class="btn sm" id="payoutQuickAll">显示全部</button>
        </div>
      </div>
      <div>
        <label>Market</label>
        <select id="payoutMarketFilter">
          <option value="">全部</option>
          <option value="US">US</option><option value="UK">UK</option><option value="DE">DE</option><option value="FR">FR</option>
          <option value="IT">IT</option><option value="ES">ES</option><option value="CA">CA</option><option value="JP">JP</option>
        </select>
      </div>
    </div>

    <div class="row" style="gap:10px; margin-top:10px; flex-wrap:wrap">
      <button class="btn" id="payoutSelectAll">全选本页</button>
      <button class="btn" id="payoutClearSel">清空选择</button>
      <button class="btn" id="payoutResetView">重置</button>
      <button class="btn primary" id="payoutOpenModal">返款（生成批次并标记已返款）</button>
      <span class="help" id="payoutSelHint"></span>

<div style="margin-top:8px"><div id="payoutSelectedTags"></div></div>
    </div>

    <div class="card" style="padding:12px;margin-top:10px">
      <div style="font-weight:700;margin-bottom:8px">粘贴订单号：自动勾选（每行一单）</div>
      <textarea id="payoutPaste" rows="4" class="mono" placeholder="每行一个订单号，或包含订单号的整行文本"></textarea>
      <div class="row" style="gap:10px;margin-top:8px;flex-wrap:wrap">
        <button class="btn" id="payoutParseSelect">解析并勾选</button>
        <button class="btn" id="payoutParseMarkDone">解析并批量标记回评 DONE</button>
        <span class="help" id="payoutPasteHint"></span>
      </div>
    </div>

    <div class="table-scroll" style="margin-top:10px">
      <table class="table" id="payoutTable">
        <thead>
          <tr>
            <th style="width:42px"></th>
            <th>订单号</th>
            <th>产品名称</th>
            <th>回评类型</th>
            <th>Market</th>
            <th>币种</th>
            <th>金额(原币)</th>
            <th>折扣(原币)</th>
            <th>佣金(CNY)</th>
            <th>返款状态</th>
            <th>回评</th>
          
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="payoutRows"></tbody>
      </table>
    </div>

    <div class="pager" style="margin-top:10px">
      <button class="btn sm" id="payoutPrev">上一页</button>
      <button class="btn sm" id="payoutNext">下一页</button>
      <span class="help" id="payoutPageInfo"></span>
    </div>

    <hr/>
    <h4>返款批次列表</h4>
    <div class="help">支持导出 CSV、删除回滚（会把本批次订单返款状态回滚为“待打款”）。</div>
    <div class="row" style="justify-content:space-between;align-items:center;margin-top:10px">
      <div style="font-weight:700">返款批次列表</div>
      <button class="btn sm" id="payoutBatchToggle">展开</button>
    </div>
    <div id="payoutBatchBox" style="display:none">
      <div class="row" style="justify-content:space-between;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap">
        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
          <input class="input sm" id="payoutBatchSearch" placeholder="搜索批次ID（支持模糊）" style="min-width:240px"/>
          <button class="btn sm" id="payoutBatchClearSearch">清空</button>
        </div>
        <div class="help">提示：可按批次ID过滤；支持复制ID与查看明细。</div>
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
        <button class="btn sm" id="payoutBatchPrev">上一页</button>
        <span class="help" id="payoutBatchPageInfo">第 1/1 页</span>
        <button class="btn sm" id="payoutBatchNext">下一页</button>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table class="table">

        <thead>
          <tr>
            <th>批次ID</th><th>日期</th><th>方式</th><th>订单数</th><th>合计(CNY)</th><th>操作</th>
          </tr>
        </thead>
        <tbody id="payoutBatchRows"></tbody>
      </table>
    </div>
  </section>

  <!-- 返款批次明细弹窗 -->
  <div class="modal" id="payoutBatchDetailModal" style="display:none">
    <div class="modal-content" style="max-width:96vw; width:96vw; max-width:1200px">
      <div class="modal-header">
        <div>
          <div class="modal-title">返款批次明细</div>
          <div class="help" id="payoutBatchDetailMeta"></div>
        </div>
        <button class="btn sm" id="payoutBatchDetailClose">关闭</button>
      </div>

      <div class="card" style="padding:10px; margin-top:8px">
        <div class="row" style="justify-content:flex-end;gap:18px;flex-wrap:wrap">
          <div><b>本金：</b><span class="mono" id="payoutBatchDetailPrincipal">0.00</span></div>
          <div><b>佣金：</b><span class="mono" id="payoutBatchDetailCommission">0.00</span></div>
          <div><b>总计：</b><span class="mono" id="payoutBatchDetailTotal">0.00</span> <span class="muted">CNY</span></div>
        </div>
      </div>

      <div class="card" style="padding:10px; margin-top:8px">
        <div style="overflow:auto;max-height:65vh">
          <table class="table">
            <thead>
              <tr>
                <th>订单号</th><th>产品名称</th><th>ASIN</th><th>卖家</th><th>Market</th><th>币种</th>
                <th class="right">金额</th><th class="right">折扣</th><th class="right">买手佣金(原币)</th>
                <th class="right">FX</th><th class="right">本金(CNY)</th><th class="right">佣金(CNY)</th><th class="right">本佣(CNY)</th>
              </tr>
            </thead>
            <tbody id="payoutBatchDetailRows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <!-- 返款弹窗（布局参考收款结算） -->
  <div class="modal" id="payoutModal" style="display:none">
    <div class="modal-content" style="max-width:96vw; width:96vw; max-width:1400px">
      <div class="modal-header">
        <div>
          <div class="modal-title">批量返款（确认后生成批次并标记已返款）</div>
          <div class="help">合计 = 本金本次返款(CNY) + 佣金本次返款(CNY)。本次 FX 可改，仅影响本批次。</div>
        </div>
        <button class="btn sm" id="payoutModalClose">关闭</button>
      </div>

      <div class="card" style="padding:10px; margin-top:8px" id="payoutModalTop">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:700">批次信息与 FX</div>
          <button class="btn sm" id="payoutModalTopToggle">隐藏</button>
        </div>
        <div id="payoutModalTopBox" style="margin-top:10px">
          <div class="grid cols-4">
            <div><label>批次ID *</label><input id="payoutBatchId" class="mono" placeholder="例如 PB20260105-001"/></div>
            <div><label>结算日期 *</label><input id="payoutBatchDate" type="date"/></div>
            <div><label>方式（可选）</label><input id="payoutBatchMethod" placeholder="支付宝/微信/银行/USDT..."/></div>
            <div><label>备注（可选）</label><input id="payoutBatchNote" placeholder="备注"/></div>
          </div>
          <hr/>
          <div style="font-weight:700;margin-bottom:6px">本批次 FX（可改，仅影响本批次）</div>
          <div class="grid cols-5">
            <div><label>USD→CNY</label><input id="payoutBatchFxUsd" type="number" step="0.0001"/></div>
            <div><label>EUR→CNY</label><input id="payoutBatchFxEur" type="number" step="0.0001"/></div>
            <div><label>GBP→CNY</label><input id="payoutBatchFxGbp" type="number" step="0.0001"/></div>
            <div><label>CAD→CNY</label><input id="payoutBatchFxCad" type="number" step="0.0001"/></div>
            <div><label>JPY→CNY</label><input id="payoutBatchFxJpy" type="number" step="0.000001"/></div>
          </div>
          <div class="help" style="margin-top:6px">提示：可在表内修改金额/折扣/买手佣金(原币)/佣金(CNY)；点击下方确认返款将回写订单。</div>
        </div>
      </div>


      <div class="card" id="payoutPrecheckCard" style="padding:12px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:800">预检（必须通过才能确认返款）</div>
          <div class="mini" id="payoutPrecheckSummary">—</div>
        </div>
        <div class="help" style="margin-top:6px">会检查：FX缺失/金额异常/非DONE/已返款等。存在问题会标红，并禁止确认。</div>
        <div id="payoutPrecheckList" class="mono" style="margin-top:8px"></div>
      </div>

      <div id="payoutStickyBar">
        <div class="mini" id="payoutStickyHint">提示：可在表内修改金额/折扣/买手佣金(原币)/佣金(CNY)。</div>
        <div class="right">本金：<span id="payoutModalTotalPrincipal">0.00</span>　佣金：<span id="payoutModalTotalComm">0.00</span>　总计：<span id="payoutModalTotal">0.00</span> CNY</div>
      </div>

      <div class="table-scroll" style="margin-top:8px">
        <div class="payout-modal-table-wrap"><table class="table payout-modal-table">
          <thead>
            <tr>
              <th style="width:160px">订单号（点复制）</th>
              <th style="min-width:180px">产品名称</th>
              <th style="min-width:140px">卖家</th>
              <th style="width:90px">回评类型</th>
              <th style="width:70px">国家</th>
              <th style="width:90px">金额</th>
              <th style="width:90px">折扣</th>
              <th style="width:110px">买手佣金(原币)</th>
              <th style="width:80px">FX</th>
              <th style="width:120px">本金(CNY)</th>
                            <th style="width:130px">佣金(CNY)</th>
              <th class="payout-sticky-right" style="width:140px">本佣(CNY)</th>
              <th class="col-hide">_principalOrig</th>
              <th class="col-hide">_principalCny</th>
            </tr>
</thead>
          <tbody id="payoutModalRows"></tbody>
        </table></div>
      </div>

      <div class="modal-footer">
        <button class="btn" id="payoutModalCancel">取消</button>
        <button class="btn" id="payoutModalExport">导出本批次 CSV</button>
        <button class="btn primary" id="payoutModalConfirm">确认返款</button>
      </div>
    </div>
  </div>


</div>

<!-- Settlement Modal -->
<div class="modal" id="settleModal">
  <div class="box">
    <div class="hd">
      <div>
        <div style="font-weight:900" id="settleTitle">批量结算</div>
        <div class="mini" id="settleSub">结算本金=(金额-折扣)×FX；佣金=按“回评登记”的已回评类型。</div>
      </div>
      <button class="btn" id="btnCloseSettle">关闭</button>
    </div>
    <div class="bd">
      <div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <div class="mini" style="font-weight:800">批次信息与FX</div>
        <button class="btn" id="btnToggleSettleMeta">展开</button>
      </div>
      <div id="settleMeta" style="display:none">
      <div class="grid cols-4">
        <div><label>批次ID *</label><input id="settleBatchId" class="mono" placeholder="例如 PB20260104-001"/></div>
        <div><label>结算日期 *</label><input type="date" id="settleBatchDate"/></div>
        <div><label>方式（可选）</label><input id="settleMethod" placeholder="支付宝/银行/USDT..."/></div>
        <div><label>备注（可选）</label><input id="settleNote" placeholder="备注"/></div>
      </div>

      <hr/>
      <h4>本批次 FX（可改，仅影响本批次）</h4>
      <div class="grid cols-5">
        <div><label>USD→CNY</label><input id="fx_usd" type="number" step="0.0001"/></div>
        <div><label>EUR→CNY</label><input id="fx_eur" type="number" step="0.0001"/></div>
        <div><label>GBP→CNY</label><input id="fx_gbp" type="number" step="0.0001"/></div>
        <div><label>CAD→CNY</label><input id="fx_cad" type="number" step="0.0001"/></div>
        <div><label>JPY→CNY</label><input id="fx_jpy" type="number" step="0.0001"/></div>
      </div>
<div class="hr"></div>
<div class="row between">
  <h4 class="sec-title" style="margin:0">本批次佣金（按回评类型，CNY，可改）</h4>
  <button class="btn btn-light" id="btnSettleSaveDefaults" type="button">保存为默认</button>
</div>
<div class="row fx-grid" style="margin-top:8px">
  <div class="field"><label>文字评价</label><input id="settleComm_TEXT" type="number" step="0.01" placeholder="例 30"></div>
  <div class="field"><label>图片评价</label><input id="settleComm_IMAGE" type="number" step="0.01" placeholder="例 30"></div>
  <div class="field"><label>视频评价</label><input id="settleComm_VIDEO" type="number" step="0.01" placeholder="例 30"></div>
  <div class="field"><label>免评</label><input id="settleComm_FREE" type="number" step="0.01" placeholder="例 30"></div>
  <div class="field"><label>免评feedback</label><input id="settleComm_FREE_FB" type="number" step="0.01" placeholder="例 30"></div>
  <div class="field"><label>免评rating</label><input id="settleComm_STAR" type="number" step="0.01" placeholder="例 30"></div>
  <div class="field"><label>无法上评</label><input id="settleComm_UNABLE" type="number" step="0.01" placeholder="例 30"></div>
</div>
<div id="settleCommBar" class="hint" style="margin-top:6px"></div>


      <hr/>
      </div>

      <div id="settleStickyBar" class="settle-sticky">
        <div class="mini">提示：可在表内修改“金额/折扣/买手佣金(原币)”；点击【保存原币修改】回写到订单列表。</div>
        <div class="row" style="gap:10px;justify-content:flex-end;flex-wrap:wrap">
          <div style="font-weight:900">合计：<span id="settleTotalTop">0.00</span> CNY</div>
          <button class="btn" id="btnSaveSettleEdits">保存原币修改</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>订单号</th><th>Market</th><th>产品</th><th>ASIN</th>
              <th class="right">金额(原币)</th><th class="right">折扣(原币)</th><th class="right">买手佣金(原币)</th><th class="right">FX</th>
              <th class="right">本金结算(CNY)</th>
              <th class="right">佣金本次结算(CNY)</th>
              <th class="right">=本佣(CNY)</th>
            </tr>
          </thead>
          <tbody id="settleRows"></tbody>
        </table>
      </div>

      <div class="row total-bottom" style="justify-content:space-between;margin-top:10px">
        <div class="mini">可逐单修改“本次结算金额(CNY)”。<br/>提示：若产品/订单回评为“免评”类，通常使用“本佣一起”进行结算更符合业务习惯。</div>
        <div style="font-weight:900">合计：<span id="settleTotal">0.00</span> CNY</div>
      </div>

      <hr/>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="btnExportSettleCsv">导出本批次 CSV</button>
      </div>
    </div>
    <div class="ft" style="gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnCancelSettle">取消</button>
      <button class="btn" id="btnSaveSettleDraft">保存为收款草稿</button>
      <button class="btn primary" id="btnConfirmSettle">确认结算</button>
    </div>
  </div>
</div>


<!-- Settle Drafts Modal -->
<div class="modal" id="settleDraftModal">
  <div class="box" style="max-width:1180px;width:min(1180px,96vw)">
    <div class="hd">
      <div>
        <div style="font-size:18px;font-weight:900">收款草稿箱</div>
        <div class="muted" style="margin-top:4px">用于保存“待收款/待结算”的批次草稿：包含所选订单 + FX + 批次信息 + 表内改过的金额/折扣/买手佣金。</div>
      </div>
      <button class="btn" id="btnCloseSettleDraftModal">关闭</button>
    </div>
    <div class="bd">
      <div style="display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:10px">
        <div class="muted">提示：恢复草稿会覆盖当前勾选，并打开结算窗口。</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn" id="btnExportSettleDraftListCSV">导出草稿列表CSV</button>
        <button class="btn" id="btnExportAllSettleDraftDetailsCSV">导出全部明细CSV</button>
        <button class="btn" id="btnImportSettleDraftJson">导入草稿 JSON</button>
          <button class="btn danger" id="btnClearSettleDrafts">清空草稿箱</button>
        </div>
      </div>

      <div class="card" style="padding:0;overflow:hidden">
        <table class="tbl" style="width:100%;min-width:980px;border-collapse:collapse;">
          <thead>
            <tr>
              <th style="width:160px">时间</th>
              <th>卖家</th>
              <th style="width:120px">模式</th>
              <th style="width:90px">订单数</th>
              <th style="width:140px;text-align:right">合计(CNY)</th>
              <th style="width:240px">批次ID</th>
              <th style="width:180px">操作</th>
            </tr>
          </thead>
          <tbody id="settleDraftTbody">
            <tr><td colspan="7" class="muted" style="padding:16px">暂无草稿</td></tr>
          </tbody>
        </table>
      </div>
      <input type="file" id="fileImportSettleDraft" accept="application/json" style="display:none"/>
    </div>
  </div>
</div>
<!-- Review Modal -->
<div class="modal" id="reviewModal">
  <div class="box" style="max-width:860px">
    <div class="hd">
      <div>
        <div style="font-weight:900">登记回评</div>
        <div class="mini">默认：已上评（DONE）；已回评类型：自动跟随产品（无产品默认文字评）。</div>
      </div>
      <button class="btn" id="btnCloseReview">关闭</button>
    </div>
    <div class="bd">
      <div class="grid cols-3">
        <div><label>订单号</label><input id="rv_order" disabled class="mono"/></div>
        <div><label>回评状态 *</label>
          <select id="rv_status">
            <option value="DONE">已上评（DONE）</option>
            <option value="PENDING">待上评（PENDING）</option>
            <option value="WAIVED">免评（WAIVED）</option>
          </select>
        </div>
        <div><label>回评日期（可选）</label><input type="date" id="rv_date"/></div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div><label>已回评类型（用于佣金）</label>
          <select id="rv_doneType"></select>
        </div>
        <div><label>截图/链接（可选）</label><input id="rv_link" placeholder="链接"/></div>
      </div>
      <div class="grid cols-1" style="margin-top:10px">
        <div><label>备注（可选）</label><input id="rv_note" placeholder="备注"/></div>
      </div>
    </div>
    <div class="ft">
      <button class="btn" id="btnCancelReview">取消</button>
      <button class="btn primary" id="btnSaveReview">确认</button>
    </div>
  </div>
</div>

<script>


// ---- HTML escape helper (global) ----
function escHtml(s){
  const t = String(s==null ? '' : s);
  return t.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function escAttr(s){
  return escHtml(s).replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
}


function num(v, d=0){
  const n = parseFloat(String(v).replace(/[,\s]/g,''));
  return Number.isFinite(n) ? n : d;
}

function round2(v){
  const n = num(v, 0);
  return Math.round((n + Number.EPSILON) * 100) / 100;
}

/* ===================== Constants ===================== */
const VERSION = "6.4.2";
const STORAGE_KEY = "ops_rebuild_v6_4_2_state";

const MARKETS = [
  {m:"US", c:"USD"}, {m:"UK", c:"GBP"}, {m:"DE", c:"EUR"}, {m:"FR", c:"EUR"},
  {m:"IT", c:"EUR"}, {m:"ES", c:"EUR"}, {m:"CA", c:"CAD"}, {m:"JP", c:"JPY"},
];
const REVIEW_TYPES = [
  {k:"TEXT",    n:"文字评价"},
  {k:"IMAGE",   n:"图片评价"},
  {k:"VIDEO",   n:"视频评价"},
  {k:"FREE",    n:"免评"},
  {k:"FREE_FB", n:"免评feedback"},
  {k:"STAR",    n:"免评rating"},
  {k:"UNABLE",  n:"无法上评"},
];
const FX_MARKETS = ["US","UK","DE","FR","IT","ES","CA","JP"];


/* ===================== Result / Notice Modal ===================== */

function showToast(message, kind){
  try{
    let host = document.getElementById('toastHost');
    if(!host){
      host = document.createElement('div');
      host.id = 'toastHost';
      host.style.position = 'fixed';
      host.style.top = '14px';
      host.style.right = '14px';
      host.style.zIndex = '99999';
      host.style.display = 'flex';
      host.style.flexDirection = 'column';
      host.style.gap = '10px';
      document.body.appendChild(host);
    }
    const t = document.createElement('div');
    t.className = 'toast';
    t.style.minWidth = '280px';
    t.style.maxWidth = '520px';
    t.style.padding = '10px 12px';
    t.style.borderRadius = '12px';
    t.style.background = '#111827';
    t.style.color = '#fff';
    t.style.boxShadow = '0 10px 25px rgba(0,0,0,.25)';
    t.style.fontSize = '13px';
    t.style.lineHeight = '1.5';
    t.style.opacity = '0';
    t.style.transform = 'translateY(-6px)';
    t.style.transition = 'all .18s ease';
    t.textContent = String(message||'');
    host.appendChild(t);
    requestAnimationFrame(()=>{ t.style.opacity='1'; t.style.transform='translateY(0)'; });
    setTimeout(()=>{
      t.style.opacity='0'; t.style.transform='translateY(-6px)';
      setTimeout(()=>t.remove(), 220);
    }, (kind==='error'?5200:3200));
  }catch(e){}
}

// 兼容：历史版本使用 toast(...)，这里统一映射到 showToast(...)
function toast(msg, type){
  try{ return showToast(msg, type||'info'); }catch(e){ try{ alert(String(msg)); }catch(_e){} }
}




// 捕获运行时错误，避免“按钮无反应但用户看不到原因”
window.addEventListener('error', (ev)=>{
  try{
    const msg = (ev && ev.message) ? ev.message : 'Unknown error';
    showToast('脚本错误：' + msg, 'error');
  }catch(e){}
});
function showNotice(title, message){
  // 显目弹窗（必须点“确定”关闭），避免提示被忽略
  const wrap = document.createElement('div');
  wrap.style.position = 'fixed';
  wrap.style.inset = '0';
  wrap.style.background = 'rgba(17,24,39,.62)';
  wrap.style.display = 'flex';
  wrap.style.alignItems = 'center';
  wrap.style.justifyContent = 'center';
  wrap.style.padding = '18px';
  wrap.style.zIndex = '100000';

  const safeTitle = (U && U.esc) ? U.esc(title||'提示') : String(title||'提示');
  const safeMsg = (U && U.esc) ? U.esc(message||'') : String(message||'');

  wrap.innerHTML = `
    <div style="width:min(760px,100%); background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 24px 70px rgba(0,0,0,.45); border:1px solid rgba(0,0,0,.06);">
      <div style="padding:14px 16px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;">
        <div style="font-weight:800; font-size:16px; color:#111827;">${safeTitle}</div>
      </div>
      <div style="padding:16px; font-size:14px; color:#111827; line-height:1.6; white-space:pre-wrap;">${safeMsg}</div>
      <div style="padding:14px 16px; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:10px;">
        <button id="__notice_ok" style="padding:10px 16px; border-radius:12px; border:1px solid #111827; background:#111827; color:#fff; font-weight:700; cursor:pointer;">确定</button>
      </div>
    </div>
  `;

  document.body.appendChild(wrap);
  function close(){ try{ document.removeEventListener('keydown', onKeyDown, true); }catch(_){}
    try{ wrap.remove(); }catch(_){}
  }
  function onKeyDown(e){
    const k = e.key;
    const code = e.keyCode || e.which;
    if(k==='Escape' || k==='Esc' || code===27){
      e.preventDefault();
      close();
    }
  }
  document.addEventListener('keydown', onKeyDown, true);
  wrap.addEventListener('click', (e)=>{ if(e.target===wrap){ close(); } });
  const ok = wrap.querySelector('#__notice_ok');
  ok && ok.addEventListener('click', close);
}
window.addEventListener('error', (e)=>{ try{ showNotice('脚本错误', String(e.message||e.error||e)); }catch(_){ alert('脚本错误：'+(e.message||'')); } });


function showResultModal(title, summaryText, failListText){
  const wrap = document.createElement('div');
  wrap.className = 'modal-backdrop';
  wrap.innerHTML = `
    <div class="modal" style="max-width:920px;">
      <div class="modal-header">
        <div class="modal-title">${U.esc(title||'结果')}</div>
        <button class="btn btn-sm" data-close>关闭</button>
      </div>
      <div class="modal-body">
        <div style="white-space:pre-wrap;line-height:1.6;margin-bottom:10px;">${U.esc(summaryText||'')}</div>
        <div class="grid" style="grid-template-columns:1fr;gap:10px;">
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin:6px 0;">
              <div class="muted">失败/重复清单（可复制）</div>
              <button class="btn btn-sm" id="btnCopyFailList">复制失败清单</button>
            </div>
            <textarea id="failListArea" rows="8" style="width:100%;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${U.esc(failListText||'')}</textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-close>知道了</button>
      </div>
    </div>`;
  document.body.appendChild(wrap);
  function close(){
    document.removeEventListener("keydown", onKeyDown, true);
 wrap.remove(); }
  function onKeyDown(e){ const k=e.key; const code=e.keyCode||e.which; if(k==='Escape'||k==='Esc'||code===27){ e.preventDefault(); close(); } }
  document.addEventListener("keydown", onKeyDown, true);
  wrap.addEventListener('click', (e)=>{ if(e.target===wrap || e.target.hasAttribute('data-close')) close(); });
  const btn = wrap.querySelector('#btnCopyFailList');
  btn.addEventListener('click', async ()=>{
    const ta = wrap.querySelector('#failListArea');
    ta.focus(); ta.select();
    let ok=false;
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(ta.value||"");
        ok=true;
      }
    }catch(e){}
    if(!ok){
      try{ ok=document.execCommand('copy'); }catch(e){}
    }
    showNotice('已复制', ok ? '失败清单已复制到剪贴板。' : '复制失败：请手动全选复制。');
  });
}


function showParseSummary({
  submitted=0,
  duplicated=0,
  bad=0,
  dupLines=[],
  badLines=[],
  okLines=[]
}){
  // 失败在上，成功在下；每行按字段展开
  const failText = [
    ...(badLines||[]).map(s => s ? `失败：${s}` : '').filter(Boolean),
    ...(dupLines||[]).map(s => s ? `重复跳过：${s}` : '').filter(Boolean),
  ].join('\n');

  const okText = (okLines||[]).join('\n');

  const wrap = document.createElement('div');
  wrap.style.position = 'fixed';
  wrap.style.inset = '0';
  wrap.style.background = 'rgba(17,24,39,.62)';
  wrap.style.display = 'flex';
  wrap.style.alignItems = 'center';
  wrap.style.justifyContent = 'center';
  wrap.style.padding = '18px';
  wrap.style.zIndex = '100000';

  function escHtml(s){
    const t = String(s==null?'':s);
    return t.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  wrap.innerHTML = `
    <div style="width:min(960px,100%); background:#fff; border-radius:16px; box-shadow:0 24px 70px rgba(0,0,0,.45); border:1px solid rgba(0,0,0,.06);">
      <div style="padding:14px 16px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:800; font-size:15px;">批量解析结果</div>
        <button class="btn" data-close>关闭</button>
      </div>
      <div style="padding:14px 16px;">
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;">
          <div style="border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#f8fafc;">
            <div class="muted" style="font-size:12px;">已提交</div>
            <div style="font-size:22px; font-weight:800;">${submitted}</div>
          </div>
          <div style="border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#f8fafc;">
            <div class="muted" style="font-size:12px;">重复跳过</div>
            <div style="font-size:22px; font-weight:800;">${duplicated}</div>
          </div>
          <div style="border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#f8fafc;">
            <div class="muted" style="font-size:12px;">失败</div>
            <div style="font-size:22px; font-weight:800;">${bad}</div>
          </div>
        </div>

        <div class="muted" style="margin-top:10px; font-size:12px;">
          上方为失败/重复，下方为成功（每行：订单号 产品名:xxx 订单金额:xxx 回评类型:xxx）。
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:700; margin:6px 0;">失败 / 重复（在上）</div>
          <textarea id="parseFailList" style="width:100%; height:150px; border:1px solid #e5e7eb; border-radius:12px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; white-space:pre; overflow:auto;"></textarea>
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:flex-end;">
            <button class="btn" data-copy-fail>复制失败清单</button>
          </div>
        </div>

        <div style="margin-top:14px;">
          <div style="font-weight:700; margin:6px 0;">成功（在下）</div>
          <textarea id="parseOkList" style="width:100%; height:150px; border:1px solid #e5e7eb; border-radius:12px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; white-space:pre; overflow:auto;"></textarea>
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:flex-end;">
            <button class="btn" data-copy-ok>复制成功清单</button>
            <button class="btn primary" data-close>确定</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(wrap);
  // Defer heavy textarea filling to avoid UI freeze
  setTimeout(() => {
    const taFail = wrap.querySelector('#parseFailList');
    const taOk = wrap.querySelector('#parseOkList');
    if (taFail) taFail.value = failText;
    if (taOk) taOk.value = okText;
  }, 0);


  async function doCopy(txt, sel){
    try{
      await navigator.clipboard.writeText(txt || '');
      const btn = wrap.querySelector(sel);
      if(btn){ const old = btn.textContent; btn.textContent='已复制'; setTimeout(()=>btn.textContent=old, 900); }
    }catch(e){
      const ta = wrap.querySelector(sel.includes('fail') ? '#parseFailList' : '#parseOkList');
      if(ta){ ta.focus(); ta.select(); }
    }
  }

  function close(){
    wrap.remove();
    document.removeEventListener('keydown', onKey, true);
  }

  function onKey(e){
    const k = e.key || '';
    if(k === 'Escape' || k === 'Esc' || e.keyCode === 27){
      e.preventDefault();
      close();
    }
  }
  document.addEventListener('keydown', onKey, true);

  wrap.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.matches && t.matches('[data-close]')) close();
    if(t && t.matches && t.matches('[data-copy-fail]')) doCopy(failText, '[data-copy-fail]');
    if(t && t.matches && t.matches('[data-copy-ok]')) doCopy(okText, '[data-copy-ok]');
  });
}
/* ===================== State ===================== */
let S = {
  sellers: [],     // {id,name,contact,remark, fx:{US..}, commission:{TEXT..}}
  products: [],    // {id,name,asin,market,sellerId,reviewType,discount,remark}
  orders: [],      // {id,orderId,date,sellerId,productId,market,currency,amount,discount,asin,note,reviewReq, review:{status,date,link,note,doneType}, principal:{settled,batchId,fx,amountCny}, commission:{settled,batchId,amountCny}}
  batches: [],     // {id,type(PRINCIPAL|COMMISSION|BOTH), date, method,note, fx:{usd,eur,gbp,cad,jpy}, sellerLabel, lines:[{orderId,market,amount,discount,fx,principalShould,principalSettle,commissionShould,commissionSettle}], total}
  seq: {seller:1, product:1, order:1, batch:1, payoutBatch:1}
};
// alias for legacy helpers (some modules still reference `state`)
const state = S;
window.state = S;


const UI = {
  tab:"orders",
  sellerEditId:null,
  productEditId:null,
  orderEditId:null,
  selected:new Set(), // selected orderId

  // orders pager
  page:1,
  pageSize:100,

  // sellers pager
  sellerPage:1,
  sellerPageSize:100,

  // products pager
  productPage:1,
  productPageSize:100,

  // payout pager
  payoutSelected:new Set(),
  payoutPage:1,
  payoutPageSize:100,
  payoutBatchPage:1,
  payoutBatchPageSize:10,

  settle:null, // {mode, orderIds[], fx, batchId, date, method, note, edits:{[orderId]:{p,c}} }
  reviewOrderId:null
};

// 兼容历史补丁：部分返款弹窗逻辑使用 state.*，这里将其指向 UI，确保单一状态源
state._payoutModal = state._payoutModal || {};
/* ===================== Helpers ===================== */
function $(id){ return document.getElementById(id); }
function setVal(id, v){ const el=$(id); if(el) el.value = (v===undefined||v===null) ? "" : String(v); }

function safeSet(id, v){ const el = $(id); if(el) el.value = (v ?? ""); }

function clearSearchInputForSelect(selectId){
  try{
    const sel = $(selectId);
    if(!sel) return;
    const wrap = sel.closest?.(".searchWrap");
    const inp = wrap?.querySelector?.("input");
    if(inp) inp.value="";
  }catch(e){}
}


/* ===================== Preview Modal (Editable) ===================== */
function showTablePreviewModal(cfg){
  const title = cfg.title || "预览";
  const subtitle = cfg.subtitle || "";
  const columns = cfg.columns || [];
  const rows = cfg.rows || [];
  const applyText = cfg.applyText || "确认执行";
  const onApply = cfg.onApply || null;

  const overlay = document.createElement("div");
  overlay.style.position="fixed";
  overlay.style.inset="0";
  overlay.style.background="rgba(17,24,39,.62)";
  overlay.style.display="flex";
  overlay.style.alignItems="center";
  overlay.style.justifyContent="center";
  overlay.style.padding="16px";
  overlay.style.zIndex="100000";

  const card = document.createElement("div");
  card.style.width="min(1200px, 96vw)";
  card.style.maxHeight="86vh";
  card.style.background="#fff";
  card.style.borderRadius="14px";
  card.style.boxShadow="0 22px 70px rgba(0,0,0,.25)";
  card.style.overflow="hidden";
  card.style.display="flex";
  card.style.flexDirection="column";

  const head = document.createElement("div");
  head.style.padding="14px 16px";
  head.style.borderBottom="1px solid #e5e7eb";
  head.innerHTML =
    '<div style="font-size:16px;font-weight:900;color:#111827;">' + U.esc(title) + '</div>' +
    (subtitle ? ('<div style="margin-top:4px;color:#6b7280;font-size:12px;white-space:pre-wrap;">' + U.esc(subtitle) + '</div>') : "");
  card.appendChild(head);

  const body = document.createElement("div");
  body.style.padding="12px";
  body.style.overflow="auto";
  body.style.flex="1";

  const table = document.createElement("table");
  table.style.width="100%";
  table.style.borderCollapse="separate";
  table.style.borderSpacing="0";
  table.style.fontSize="12px";
  table.style.tableLayout="fixed";

  const thead = document.createElement("thead");
  const trh = document.createElement("tr");

  const thInc = document.createElement("th");
  thInc.textContent="纳入";
  thInc.style.position="sticky"; thInc.style.top="0";
  thInc.style.background="#f9fafb";
  thInc.style.padding="10px 8px";
  thInc.style.borderBottom="1px solid #e5e7eb";
  thInc.style.width="58px";
  trh.appendChild(thInc);

  for(const col of columns){
    const th = document.createElement("th");
    th.textContent = col.label || col.key;
    th.style.position="sticky"; th.style.top="0";
    th.style.background="#f9fafb";
    th.style.padding="10px 8px";
    th.style.borderBottom="1px solid #e5e7eb";
    th.style.textAlign="left";
    th.style.width = col.width || "160px";
    trh.appendChild(th);
  }
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  const stateRows = rows.map((r, idx)=>({__idx:idx, __include:true, data: JSON.parse(JSON.stringify(r))}));

  function mkInput(col, v){
    const t = col.type || "text";
    if(t==="select"){
      const sel=document.createElement("select");
      sel.style.width="100%";
      sel.style.padding="8px 8px";
      sel.style.border="1px solid #e5e7eb";
      sel.style.borderRadius="10px";
      sel.style.background="#fff";
      const opts = (typeof col.options==="function") ? col.options() : (col.options||[]);
      for(const o of opts){
        const opt=document.createElement("option");
        opt.value=o.v; opt.textContent=o.t;
        sel.appendChild(opt);
      }
      sel.value = (v==null? "" : String(v));
      return sel;
    }
    const inp=document.createElement("input");
    inp.type = (t==="date") ? "date" : "text";
    inp.value = (v==null? "" : String(v));
    inp.placeholder = col.placeholder || "";
    inp.style.width="100%";
    inp.style.padding="8px 8px";
    inp.style.border="1px solid #e5e7eb";
    inp.style.borderRadius="10px";
    return inp;
  }

  stateRows.forEach((rowState, idx)=>{
    const tr=document.createElement("tr");
    tr.style.borderBottom="1px solid #f3f4f6";

    const tdInc=document.createElement("td");
    tdInc.style.padding="8px";
    tdInc.style.borderBottom="1px solid #f3f4f6";
    const ck=document.createElement("input");
    ck.type="checkbox"; ck.checked=true;
    ck.onchange=()=>{ rowState.__include = !!ck.checked; };
    tdInc.appendChild(ck);
    tr.appendChild(tdInc);

    for(const col of columns){
      const td=document.createElement("td");
      td.style.padding="8px";
      td.style.borderBottom="1px solid #f3f4f6";
      const el=mkInput(col, rowState.data[col.key]);
      el.oninput = ()=>{ rowState.data[col.key]=el.value; };
      td.appendChild(el);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  body.appendChild(table);
  card.appendChild(body);

  const foot=document.createElement("div");
  foot.style.padding="12px 16px";
  foot.style.borderTop="1px solid #e5e7eb";
  foot.style.display="flex";
  foot.style.justifyContent="space-between";
  foot.style.alignItems="center";
  foot.style.gap="10px";

  const left=document.createElement("div");
  left.style.fontSize="12px";
  left.style.color="#6b7280";
  left.textContent="提示：先核对/修改，再点击确认执行。可取消勾选不处理的行。";

  const right=document.createElement("div");
  right.style.display="flex";
  right.style.gap="10px";

  const btnCancel=document.createElement("button");
  btnCancel.className="btn";
  btnCancel.textContent="取消";
  btnCancel.onclick=()=>{ document.body.removeChild(overlay); };

  const btnApply=document.createElement("button");
  btnApply.className="btn primary";
  btnApply.textContent=applyText;
  btnApply.onclick=()=>{
    try{
      if(typeof onApply==="function"){
        const finalRows = stateRows.filter(r=>r.__include).map(r=>r.data);
        onApply(finalRows, ()=>{ try{ document.body.removeChild(overlay);}catch(e){} });
      }else{
        document.body.removeChild(overlay);
      }
    }catch(e){
      showNotice("脚本错误", (e&&e.message)?e.message:String(e));
    }
  };

  right.appendChild(btnCancel);
  right.appendChild(btnApply);
  foot.appendChild(left);
  foot.appendChild(right);
  card.appendChild(foot);

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}



function   normOrderId(s){
    s = (s==null?'':String(s)).trim();
    // 同时支持带横杠与纯数字匹配
    const digits = s.replace(/\D+/g,'');
    const hy = s.replace(/\s+/g,'');
    return { raw: hy, digits };
}
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

// ---- Perf helpers ----
function _safeCssEscape(s){
  try{ return (window.CSS && CSS.escape) ? CSS.escape(String(s)) : String(s).replace(/["\\]/g,'\\$&'); }
  catch(e){ return String(s).replace(/["\\]/g,'\\$&'); }
}
function debounce(fn, wait){
  let t=null;
  return function(...args){
    if(t) clearTimeout(t);
    t=setTimeout(()=>{ t=null; fn.apply(this,args); }, wait||200);
  };
}
function setOrderCheckbox(orderId, checked){
  const sel = 'input[data-oid="'+_safeCssEscape(orderId)+'"]';
  const el = document.querySelector(sel);
  if(el) el.checked = !!checked;
}

const U = {
  today(){ return new Date().toISOString().slice(0,10); },
  dateMD(d){ // YYYY-MM-DD -> MM-DD
    const s = String(d||'');
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    return m ? `${m[2]}-${m[3]}` : s;
  },
  id(prefix, n){ return prefix + String(n).padStart(4,"0"); },
  num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; },
  toNum(v){ return U.num(v); },
  money(v){ return U.num(v).toFixed(2); },
  esc(v){ const s=String(v??''); return s.replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); },
  escAttr(v){ return U.esc(v); },
  marketToCurrency(m){ return (MARKETS.find(x=>x.m===m)||{}).c || ""; },
  marketToFxKey(m){
    if(m==="US") return "usd";
    if(m==="UK") return "gbp";
    if(m==="CA") return "cad";
    if(m==="JP") return "jpy";
    return "eur"; // DE/FR/IT/ES
  },
  sellerById(id){ return S.sellers.find(x=>x.id===id) || null; },
  productById(id){ return S.products.find(x=>x.id===id) || null; },
  sellerName(id){ return (U.sellerById(id)||{}).name || ""; },
  productName(id){ return (U.productById(id)||{}).name || ""; },
  reviewName(k){ return (REVIEW_TYPES.find(x=>x.k===k)||{}).n || k; },
  badgeReview(status){
    if(status==="DONE") return '<span class="badge done">完成</span>';
    if(status==="WAIVED") return '<span class="badge waived">免评</span>';
    return '<span class="badge pending">等待</span>';
  },
  badgeSettle(ok, labelOk="已结算", labelNo="待结算"){
    return ok ? `<span class="badge settled">${labelOk}</span>` : `<span class="badge pending">${labelNo}</span>`;
  },
  csvEscape(v){
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  },
  download(filename, text, mime="text/plain"){
    const blob = new Blob([text], {type:mime+";charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  },
  extractOrderIds(text){
    if(!text) return [];
    const re = /\b\d{3}-\d{7}-\d{7}\b/g;
    const ids = [];
    String(text).split(/\r?\n/).map(x=>x.trim()).filter(Boolean).forEach(line=>{
      const ms = line.match(re);
      if(ms){ ms.forEach(m=>{ if(!ids.includes(m)) ids.push(m); }); }
      else{
        // 无匹配时：默认取前19个字符（允许纯数字/其它格式），保证可录入后再手动编辑
        const fb = line.slice(0,19);
        if(fb && !ids.includes(fb)) ids.push(fb);
      }
    });
    return ids;
  }

  ,orderKey:(sellerId,orderId,asin)=>`${(sellerId||'').trim()}::${(orderId||'').trim()}::${(asin||'').trim()}`
};

// money formatter helper used by payout UI (Fix6b)
function fmtMoney(v, d=2){
  const n = Number(v);
  return Number.isFinite(n) ? n.toFixed(d) : (0).toFixed(d);
}

/* ===================== Persistence ===================== */
function blankState(){
  return {sellers:[],products:[],orders:[],batches:[],payoutBatches:[],settings:{payoutFxDefault:{usd:0,eur:0,gbp:0,cad:0,jpy:0}, payoutCommDefault:null},seq:{seller:1,product:1,order:1,batch:1,payoutBatch:1}};
}

/* ===================== IndexedDB Main Store (Replace localStorage main state) ===================== */
const MAIN_DB_NAME = "ops_v642_main";
const MAIN_DB_VERSION = 1;
const MAIN_STORE = "kv";
const MAIN_STATE_KEY = "main_state_v1";


/* ===================== Payout Snapshot (localStorage fallback, payout-only) ===================== */
const PAYOUT_SNAPSHOT_KEY = "ops_v642_payout_snapshot_v1";

/**
 * 返款快照（localStorage 兜底）
 * 目的：即便 IndexedDB 在 file:// 场景不可用，也能记住“已返款”与返款批次列表。
 * 只保存返款相关的最小数据，避免 localStorage 配额风险。
 */
function persistPayoutSnapshot(){
  try{
    const orders = (S && Array.isArray(S.orders)) ? S.orders : [];
    const orderPayoutById = {};
    for(const o of orders){
      if(o && o.id && o.payout && o.payout.status){
        orderPayoutById[o.id] = o.payout;
      }
    }
    const payload = {
      v: 1,
      updatedAt: Date.now(),
      payoutBatches: (S && Array.isArray(S.payoutBatches)) ? S.payoutBatches : [],
      orderPayoutById
    };
    localStorage.setItem(PAYOUT_SNAPSHOT_KEY, JSON.stringify(payload));
  }catch(e){
    // ignore (quota / blocked)
  }
}

function restorePayoutSnapshot(state){
  try{
    const raw = localStorage.getItem(PAYOUT_SNAPSHOT_KEY);
    if(!raw) return;
    const snap = JSON.parse(raw);
    if(!snap || snap.v !== 1) return;

    // 1) 批次列表兜底：如果主库没有或为空，则用快照补上
    if(state && (!Array.isArray(state.payoutBatches) || state.payoutBatches.length===0) && Array.isArray(snap.payoutBatches)){
      state.payoutBatches = snap.payoutBatches;
    }

    // 2) 订单返款信息兜底：用 order.id 精确合并
    if(state && Array.isArray(state.orders) && snap.orderPayoutById){
      for(const o of state.orders){
        const p = snap.orderPayoutById[o.id];
        if(p && p.status){
          o.payout = p;
        }
      }
    }
  }catch(e){
    // ignore
  }
}


let __mainDbPromise = null;
function openMainDB(){
  if(__mainDbPromise) return __mainDbPromise;
  __mainDbPromise = new Promise((resolve, reject)=>{
    try{
      const req = indexedDB.open(MAIN_DB_NAME, MAIN_DB_VERSION);
      req.onupgradeneeded = (e)=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(MAIN_STORE)){
          db.createObjectStore(MAIN_STORE, { keyPath: "key" });
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error || new Error("IndexedDB open failed"));
    }catch(err){ reject(err); }
  });
  return __mainDbPromise;
}
async function idbGet(key){
  const db = await openMainDB();
  return await new Promise((resolve, reject)=>{
    const tx = db.transaction(MAIN_STORE, "readonly");
    const st = tx.objectStore(MAIN_STORE);
    const req = st.get(key);
    req.onsuccess = ()=> resolve(req.result ? req.result.value : undefined);
    req.onerror = ()=> reject(req.error || new Error("IndexedDB get failed"));
  });
}
async function idbSet(key, value){
  const db = await openMainDB();
  return await new Promise((resolve, reject)=>{
    const tx = db.transaction(MAIN_STORE, "readwrite");
    const st = tx.objectStore(MAIN_STORE);
    st.put({ key, value });
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error || new Error("IndexedDB set failed"));
    tx.onabort = ()=> reject(tx.error || new Error("IndexedDB set aborted"));
  });
}
async function idbDel(key){
  const db = await openMainDB();
  return await new Promise((resolve, reject)=>{
    const tx = db.transaction(MAIN_STORE, "readwrite");
    const st = tx.objectStore(MAIN_STORE);
    st.delete(key);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error || new Error("IndexedDB delete failed"));
  });
}
async function clearMainState(){
  try{ await idbDel(MAIN_STATE_KEY); }catch(e){}
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} // 清理旧主库（迁移后不再使用）
}

/* ---- Save queue: avoid too many IDB transactions ---- */
let __saveTimer = null;
let __saveInFlight = false;
let __savePending = false;

function _queueSave(){
  __savePending = true;
  if(__saveTimer) return;
  __saveTimer = setTimeout(async ()=>{
    __saveTimer = null;
    if(__saveInFlight) { __savePending = true; return; }
    __saveInFlight = true;
    try{
      // 只保存当前内存态（主库）
      await idbSet(MAIN_STATE_KEY, S);
      __savePending = false;
    }catch(e){
      console.error(e);
      // IndexedDB 失败时，尽量回退到 localStorage（最后兜底）
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(S)); }catch(_e){}
      alert("保存失败：IndexedDB 写入失败。\n\n建议：\n1) 关闭无痕模式；\n2) 检查浏览器是否禁止站点存储；\n3) 换 Chrome 正常模式重试。\n\n注意：已尝试回退保存到 localStorage，但容量仍可能不足。");
    }finally{
      __saveInFlight = false;
      if(__savePending) _queueSave();
    }
  }, 180);
}
function cleanupOldKeys(){
  try{
    const keep = STORAGE_KEY;
    const toRemove = [];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(!k || k===keep) continue;
      if(k.startsWith("ops_") || k.startsWith("OPS_") || k.includes("ops_v") || k.includes("ops_rebuild") || k.includes("settle_") || k.includes("draft_")){
        toRemove.push(k);
      }
    }
    toRemove.forEach(k=>{ try{ localStorage.removeItem(k);}catch(_e){} });
  }catch(_e){}
}
function _safeSetItem(key, value){
  try{ localStorage.setItem(key, value); return true; }
  catch(e){ 
    const msg = (e && e.name ? e.name : "") + " " + (e && e.message ? e.message : String(e));
    if(msg.includes("QuotaExceeded")) return false;
    throw e;
  }
}
function save(){
  // 关键：任何状态变更都应立即失效缓存/索引，否则返款/订单列表会继续使用旧过滤结果，表现为“必须刷新才更新”
  try{ S.__rev = (S.__rev||0) + 1; }catch(e){}
  try{ UI.__cache && (UI.__cache = {}); }catch(e){}
  try{ UI.__idx && (UI.__idx = {}); }catch(e){}
  _queueSave();
}
function saveNow(){
  // 性能：状态变更版本号（用于过滤结果/索引缓存失效）
  try{ S.__rev = (S.__rev||0) + 1; }catch(e){}
  try{ UI.__cache && (UI.__cache = {}); }catch(e){}
  try{ UI.__idx && (UI.__idx = {}); }catch(e){}

  // 主库：IndexedDB
  let p;
  try{ p = idbSet(MAIN_STATE_KEY, S); }catch(e){ p = Promise.resolve(); }
  // 兜底：localStorage（只保存返款最小快照）
  persistPayoutSnapshot();
  return p;
}

function computeSeq(){
  const max = {seller:0, product:0, order:0, batch:0, payoutBatch:0};
  (S.sellers||[]).forEach(x=>{ const m=String(x.id||"").match(/^S(\d+)$/); if(m) max.seller=Math.max(max.seller, Number(m[1])); });
  (S.products||[]).forEach(x=>{ const m=String(x.id||"").match(/^P(\d+)$/); if(m) max.product=Math.max(max.product, Number(m[1])); });
  (S.orders||[]).forEach(x=>{ const m=String(x.id||"").match(/^O(\d+)$/); if(m) max.order=Math.max(max.order, Number(m[1])); });
  (S.batches||[]).forEach(x=>{ const m=String(x.id||"").match(/^B(\d+)$/); if(m) max.batch=Math.max(max.batch, Number(m[1])); });
  (S.payoutBatches||[]).forEach(x=>{ const m=String(x.id||"").match(/^PB(\d+)$/); if(m) max.payoutBatch=Math.max(max.payoutBatch, Number(m[1])); });
  S.seq = {seller:max.seller+1, product:max.product+1, order:max.order+1, batch:max.batch+1, payoutBatch:max.payoutBatch+1};
}

function normalizeImported(obj){
  // 接受旧结构：兼容 v6.2/6.4 的 sellers/products/orders/batches
  const out = blankState();
  out.sellers = Array.isArray(obj.sellers) ? obj.sellers : (Array.isArray(obj.seller)? obj.seller: []);
  out.products = Array.isArray(obj.products) ? obj.products : (Array.isArray(obj.product)? obj.product: []);
  out.orders = Array.isArray(obj.orders) ? obj.orders : (Array.isArray(obj.order)? obj.order: []);
  // normalize orders: ensure sellerId/orderId exist, build key sellerId::orderId, allow same-seller duplicates via _1 suffix
  const _seen = new Set();
  out.orders = (out.orders||[]).map(o=>{
    const x = Object.assign({}, o);
    x.sellerId = (x.sellerId || x.seller || '').trim();
    x.orderId  = (x.orderId || x.order_id || x.id || '').trim();
    if(x.sellerId && x.orderId){
      const base = x.orderId;
      let k = U.orderKey(x.sellerId, x.orderId, x.asin);
      let idx = 0;
      while(_seen.has(k)){
        idx += 1;
        x.orderId = `${base}_${idx}`;
        k = U.orderKey(x.sellerId, x.orderId, x.asin);
      }
      _seen.add(k);
      x.key = k;
    } else {
      x.key = U.orderKey(x.sellerId, x.orderId, x.asin);
    }
    return x;
  });
  out.batches = Array.isArray(obj.batches) ? obj.batches : (Array.isArray(obj.batch)? obj.batch: []);
  out.payoutBatches = Array.isArray(obj.payoutBatches) ? obj.payoutBatches : (Array.isArray(obj.payout_batches)? obj.payout_batches : []);
  out.settings = (obj.settings && typeof obj.settings==="object") ? obj.settings : {};
  out.settings.payoutFxDefault = out.settings.payoutFxDefault || {usd:0,eur:0,gbp:0,cad:0,jpy:0};
  out.settings.payoutCommDefault = (out.settings.payoutCommDefault===0 || out.settings.payoutCommDefault) ? out.settings.payoutCommDefault : null;
  out.settings.payoutCommByType = (out.settings.payoutCommByType && typeof out.settings.payoutCommByType==='object') ? out.settings.payoutCommByType : {};
  out.settings.settleFxDefault = out.settings.settleFxDefault || {usd:0,eur:0,gbp:0,cad:0,jpy:0};
  out.settings.settleCommByType = (out.settings.settleCommByType && typeof out.settings.settleCommByType==='object') ? out.settings.settleCommByType : {};

  out.sellers = out.sellers.map(s=>{
    const fx = s.fx || s.fxs || {};
    const cm = s.commission || s.commissions || {};
    const fx2 = {};
    FX_MARKETS.forEach(m=> fx2[m] = U.num(fx[m]));
    // EUR markets sync (DE as master)
    if(fx2.DE){ fx2.FR=fx2.DE; fx2.IT=fx2.DE; fx2.ES=fx2.DE; }
    const cm2 = {};
    REVIEW_TYPES.forEach(t=> cm2[t.k] = U.num(cm[t.k] ?? cm[t.n] ?? cm[String(t.k)]));
    return { id:String(s.id||"").trim(), name:String(s.name||s.sellerName||"").trim(), contact:s.contact||"", remark:s.remark||"", fx:fx2, commission:cm2 };
  }).filter(s=>s.id && s.name);

  out.products = out.products.map(p=>{
    return {
      id:String(p.id||"").trim() || ("P"+Math.random().toString(16).slice(2,6)),
      name:String(p.name||p.productName||"").trim(),
      asin:String(p.asin||p.ASIN||"").trim(),
      market:String(p.market||p.Market||"").trim(),
      sellerId:String(p.sellerId||p.seller_id||"").trim(),
      reviewType:String(p.reviewType||p.review_type||"TEXT").trim(),
      discount:U.num(p.discount ?? p.sellerDiscount ?? 0),
      buyerCommission:U.num(p.buyerCommission ?? p.buyer_commission ?? 0),
      remark:p.remark||""
    };
  }).filter(p=>p.name);

  out.orders = out.orders.map(o=>{
    const market = String(o.market||o.Market||"").trim();
    const productId = (o.productId ?? o.product_id) ? String(o.productId ?? o.product_id).trim() : null;
    const review = o.review || {};
    const principal = o.principal || {};
    const commission = o.commission || {};
    return {
      id:String(o.id||"").trim() || ("O"+Math.random().toString(16).slice(2,6)),
      orderId:String(o.orderId||o.order_id||o.OrderID||"").trim().slice(0,19),
      date:String(o.date||o.orderDate||o.order_date||"").slice(0,10) || U.today(),
      sellerId:String(o.sellerId||o.seller_id||"").trim(),
      productId:productId || null,
      market:market || "US",
      currency:String(o.currency||"").trim() || U.marketToCurrency(market||"US"),
      amount:U.num(o.amount ?? o.orderAmount ?? o.price ?? 0),
      discount:U.num(o.discount ?? o.sellerDiscount ?? 0),
      asin:String(o.asin||o.ASIN||"").trim(),
      note:o.note||o.productName||"",
      reviewReq:String(o.reviewReq||o.reviewType||o.review_type||"TEXT").trim(), // 订单要求（跟随产品）
      fxOverride: (o.fxOverride==null || o.fxOverride==="") ? null : U.num(o.fxOverride),
      review:{
        status:String(review.status || o.reviewStatus || o.review_status || "PENDING").trim(),
        date:String(review.date || o.reviewDate || o.review_date || "").slice(0,10),
        link:review.link || o.reviewLink || "",
        note:review.note || o.reviewNote || "",
        doneType:String(review.doneType || o.reviewDoneType || "").trim() // 佣金用
      },
      principal:{
        settled:!!(principal.settled ?? o.principalSettled ?? o.principal_settled ?? false),
        batchId: principal.batchId || o.principalBatchId || "",
        fx: U.num(principal.fx ?? o.fxRate ?? 0),
        amountCny: U.num(principal.amountCny ?? o.principalCny ?? 0)
      },
      commission:{
        settled:!!(commission.settled ?? o.commissionSettled ?? o.commission_settled ?? false),
        batchId: commission.batchId || o.commissionBatchId || "",
        amountCny: U.num(commission.amountCny ?? o.commissionCny ?? 0)
      }
    };
  }).filter(o=>o.orderId && o.sellerId && o.market);

  out.batches = out.batches.map(b=>{
    const fx = b.fx || {};
    return {
      id:String(b.id||"").trim() || ("B"+Math.random().toString(16).slice(2,6)),
      batchId:String(b.batchId||b.id||"").trim(),
      type:String(b.type||"PRINCIPAL").trim(),
      date:String(b.date||"").slice(0,10) || U.today(),
      method:b.method||"",
      note:b.note||"",
      sellerLabel:b.sellerLabel || b.seller || "",
      fx:{
        usd:U.num(fx.usd ?? fx.USD ?? 0),
        eur:U.num(fx.eur ?? fx.EUR ?? 0),
        gbp:U.num(fx.gbp ?? fx.GBP ?? 0),
        cad:U.num(fx.cad ?? fx.CAD ?? 0),
        jpy:U.num(fx.jpy ?? fx.JPY ?? 0),
      },
      lines:Array.isArray(b.lines)? b.lines: [],
      total:U.num(b.total ?? b.totalCny ?? 0)
    };
  }).filter(b=>b.batchId);

  return out;
}
async function load(){
  // 1) 先读 IndexedDB 主库
  try{
    const v = await idbGet(MAIN_STATE_KEY);
    if(v){
      S = normalizeImported(v);
      try{ restorePayoutSnapshot(S); }catch(e){}
      computeSeq();
      return;
    }
  }catch(e){
    // 如果 IDB 故障，后面会尝试 localStorage 兜底
    console.warn("IDB load failed, fallback to localStorage:", e);
  }

  // 2) 迁移：若 localStorage 有旧数据，则导入到 IDB，并清掉旧 key
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const obj = normalizeImported(JSON.parse(raw));
      S = obj;
      computeSeq();
      try{ await idbSet(MAIN_STATE_KEY, S); }catch(_e){}
      try{ localStorage.removeItem(STORAGE_KEY); }catch(_e){}
      return;
    }
  }catch(e){}

  // 3) 全新空库
  S = blankState();
}

/* ===================== Business Logic ===================== */
function canSettleCommission(order){
  return order.review.status==="DONE" || order.review.status==="WAIVED";
}
function getSellerFxRate(sellerId, market){
  const s = U.sellerById(sellerId);
  if(!s) return 0;
  return U.num((s.fx||{})[market]);
}
function effectiveFx(order, batchFx){
  // 优先：订单 汇率覆写；否则：批次 FX（按币种）；否则：卖家默认 FX
  if(order.fxOverride!=null && order.fxOverride!=="") return U.num(order.fxOverride);
  const fxKey = U.marketToFxKey(order.market);
  const fromBatch = batchFx ? U.num(batchFx[fxKey]) : 0;
  if(fromBatch) return fromBatch;
  return getSellerFxRate(order.sellerId, order.market);
}
function principalOrig(order){
  // allow negative (亏损) when discount > amount
  return (U.num(order.amount) - U.num(order.discount));
}

function getRowTotalCNY(o){
  const principal = calcPrincipalCNY(o, getBatchFxMapForOrder(o));
  const comm = getCommissionCNY(o);
  return U.num(principal) + U.num(comm);
}
function commissionShould(order){
  // 佣金按“回评登记弹窗”的 doneType；如果为空：按产品/订单要求；如果无产品：文字评
  // 特例：无法上评（UNABLE）不收佣也不返佣
  try{
    const dt = String(order?.review?.doneType || "").trim();
    if(dt === "UNABLE" || dt === "无法上评") return 0;
  }catch(e){}
  const seller = U.sellerById(order.sellerId);
  if(!seller) return 0;
  let t = (order.review.doneType || "").trim();
  if(!t){
    const p = order.productId ? U.productById(order.productId) : null;
    t = (p?.reviewType || order.reviewReq || "TEXT").trim();
  }
  if(!REVIEW_TYPES.some(x=>x.k===t)) t="TEXT";
  return U.num((seller.commission||{})[t]);
}
function currentPrincipalCny(order){
  // 展示用：按卖家 FX 或订单覆写计算（不使用批次 FX）
  const fx = effectiveFx(order, null);
  return principalOrig(order) * U.num(fx);
}

/* ===================== Render Helpers ===================== */
function renderTabs(){
  document.querySelectorAll("[data-tab]").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.tab===UI.tab);
  });
  ["dashboard","sellers","products","orders","payout"].forEach(t=>{
    const el = $("tab-"+t);
    if(el) el.style.display = (t===UI.tab) ? "block" : "none";
  });
}
function setOptions(sel, opts, placeholder){
  if(!sel) return;
  const prevVal = sel.value;
  sel.innerHTML = "";
  if(placeholder!=null){
    const o=document.createElement("option");
    o.value=""; o.textContent=placeholder;
    sel.appendChild(o);
  }
  (opts||[]).forEach(x=>{
    const o=document.createElement("option");
    o.value=String(x.value ?? ""); o.textContent=String(x.label ?? "");
    sel.appendChild(o);
  });
  // try keep previous value if still exists
  if(prevVal && Array.from(sel.options).some(o=>o.value===prevVal)){
    sel.value = prevVal;
  }
  // notify searchable wrapper to refresh its cache after options are rebuilt
  try{
    sel.dispatchEvent(new CustomEvent("ops:options-updated", {bubbles:false}));
  }catch(e){}
}
function renderSelects(){
  const marketOpts = MARKETS.map(x=>({value:x.m, label:`${x.m} (${x.c})`}));
  setOptions($("productMarket"), marketOpts, "选择");
  setOptions($("orderMarket"), marketOpts, "选择");
  setOptions($("batchMarket"), marketOpts, "选择");

  const sellerOpts = S.sellers.map(s=>({value:s.id, label:`${s.name}（${s.id}）`}));
  setOptions($("productSeller"), sellerOpts, "选择卖家");
  setOptions($("orderSeller"), sellerOpts, "选择卖家");
  setOptions($("batchSeller"), sellerOpts, "选择卖家");
  setOptions($("filterSeller"), [{value:"ALL",label:"全部卖家"}, ...sellerOpts], null);

  const rtOpts = REVIEW_TYPES.map(x=>({value:x.k, label:x.n}));
  setOptions($("productReviewType"), rtOpts, "选择");
  setOptions($("orderReviewType"), [{value:"",label:"自动（跟随产品）"}, ...rtOpts], null);
  setOptions($("rv_doneType"), [{value:"",label:"自动（跟随产品）"}, ...rtOpts], null);

  const productOpts = S.products.map(p=>{
    const s = U.sellerName(p.sellerId);
    return {value:p.id, label:`${p.name} | ${p.market} | ${s} | ${p.asin}`};
  });
  setOptions($("orderProduct"), [{value:"",label:"不选产品（手动填）"}, ...productOpts], null);
  setOptions($("batchProduct"), [{value:"",label:"不套用产品"}, ...productOpts], null);
  setOptions($("linkProduct"), [{value:"",label:"选择产品"}, ...productOpts], null);
  // 新建订单默认不选卖家/不选产品（避免浏览器自动选中第 1 个真实选项）
  if(!UI.orderEditId){
    if($('orderSeller').value) $('orderSeller').value='';
    if($('orderProduct').value) $('orderProduct').value='';
  }
}

function renderSellerGrids(){
  const fxGrid = $("sellerFxGrid");
  fxGrid.innerHTML = "";
  FX_MARKETS.forEach(m=>{
    fxGrid.innerHTML += `<div><label>${m} FX（${U.marketToCurrency(m)}→CNY）</label><input id="seller_fx_${m}" type="number" step="0.0001" placeholder="例如 7.2"/></div>`;
  });
  // EUR markets: show DE as master
  const de = fxGrid.querySelector("#seller_fx_DE");
  if(de){
    const lab = de.closest("div").querySelector("label");
    if(lab) lab.textContent = "EUR FX（DE/FR/IT/ES 共用）";
    ["FR","IT","ES"].forEach(k=>{
      const inp = fxGrid.querySelector("#seller_fx_"+k);
      if(inp) inp.closest("div").style.display = "none";
    });
    de.addEventListener("input", ()=>{
      ["FR","IT","ES"].forEach(k=>{
        const inp = $("seller_fx_"+k);
        if(inp) inp.value = de.value;
      });
    });
  }

  const cmGrid = $("sellerCommissionGrid");
  cmGrid.innerHTML = "";
  REVIEW_TYPES.forEach(t=>{
    cmGrid.innerHTML += `<div><label>${t.n} 佣金(CNY)</label><input id="seller_cm_${t.k}" type="number" step="0.01" placeholder="例如 50"/></div>`;
  });
}
function renderKPI(){
  $("kpiSellers").textContent = S.sellers.length;
  $("kpiProducts").textContent = S.products.length;
  $("kpiOrders").textContent = S.orders.length;
  $("kpiP").textContent = S.orders.filter(o=>!o.principal.settled).length;
  $("kpiC").textContent = S.orders.filter(o=>!o.commission.settled && canSettleCommission(o)).length;
}
function updateProductPreview(){
  const sellerId = $("productSeller").value;
  if(!sellerId){ $("productPreview").value=""; return; }
  const s = U.sellerById(sellerId);
  if(!s){ $("productPreview").value=""; return; }
  $("productPreview").value = `FX: USD ${U.money(s.fx.US)} / EUR ${U.money(s.fx.DE)} / GBP ${U.money(s.fx.UK)} | 佣金: 文${U.money(s.commission.TEXT)} 免${U.money(s.commission.FREE)}`;
}
function renderSellers(){
  const q = ($("sellerSearch").value||"").trim().toLowerCase();

  const list = (S.sellers||[]).filter(s=>{
    if(!q) return true;
    return (s.id||"").toLowerCase().includes(q) || (s.name||"").toLowerCase().includes(q);
  });

  const total = list.length;
  UI.sellerPageSize = 100;
  const totalPages = Math.max(1, Math.ceil(total / UI.sellerPageSize));
  UI.sellerPage = Math.min(Math.max(1, UI.sellerPage), totalPages);

  const start = (UI.sellerPage-1)*UI.sellerPageSize;
  const pageList = list.slice(start, start+UI.sellerPageSize);

  const rows = pageList.map(s=>{
    const fxSummary = `USD ${U.money(s.fx.US)} | EUR ${U.money(s.fx.DE)} | GBP ${U.money(s.fx.UK)} | CAD ${U.money(s.fx.CA)} | JPY ${U.money(s.fx.JP)}`;
    const cmSummary = `文:${U.money(s.commission.TEXT)} 图:${U.money(s.commission.IMAGE)} 视:${U.money(s.commission.VIDEO)} 免:${U.money(s.commission.FREE)} FB:${U.money(s.commission.FREE_FB)} 点:${U.money(s.commission.STAR)}`;
    return `<tr>
      <td class="mono">${esc(s.id)}</td>
      <td>${esc(s.name)}</td>
      <td>${esc(s.contact||"")}</td>
      <td>${esc(s.remark||"")}</td>
      <td class="small">${esc(fxSummary)}</td>
      <td class="small">${esc(cmSummary)}</td>
      <td class="right">
        <button class="btn" onclick="Actions.editSeller('${esc(s.id)}')">编辑</button>
        <button class="btn danger" onclick="Actions.deleteSeller('${esc(s.id)}')">删除</button>
      </td>
    </tr>`;
  }).join("\n");

  $("sellerRows").innerHTML = rows || `<tr><td colspan="7" class="small">暂无卖家</td></tr>`;

  // pager
  const spInfo = $("sellerPagerInfo");
  const spPage = $("sellerPagerPage");
  const spPrev = $("sellerPrev");
  const spNext = $("sellerNext");
  const spInfoTop = $("sellerPagerInfoTop");
  const spPageTop = $("sellerPagerPageTop");
  const spPrevTop = $("sellerPrevTop");
  const spNextTop = $("sellerNextTop");
  if(spInfo){
    spInfo.textContent = `共 ${total} 条`;
    spPage.textContent = `第 ${UI.sellerPage} / ${totalPages} 页`;
    spPrev.disabled = UI.sellerPage<=1;
    spNext.disabled = UI.sellerPage>=totalPages;
  }
  if(spInfoTop){
    spInfoTop.textContent = `共 ${total} 条`;
    spPageTop.textContent = `第 ${UI.sellerPage} / ${totalPages} 页`;
    spPrevTop.disabled = UI.sellerPage<=1;
    spNextTop.disabled = UI.sellerPage>=totalPages;
  }
}
function renderProducts(){
  const q = ($("productSearch").value||"").trim().toLowerCase();

  const list = (S.products||[]).filter(p=>{
    if(!q) return true;
    const sname = U.sellerName(p.sellerId).toLowerCase();
    return (p.name||"").toLowerCase().includes(q) ||
           (p.asin||"").toLowerCase().includes(q) ||
           (p.market||"").toLowerCase().includes(q) ||
           sname.includes(q);
  });

  const total = list.length;
  UI.productPageSize = 100;
  const totalPages = Math.max(1, Math.ceil(total / UI.productPageSize));
  UI.productPage = Math.min(Math.max(1, UI.productPage), totalPages);

  const start = (UI.productPage-1)*UI.productPageSize;
  const pageList = list.slice(start, start+UI.productPageSize);

  const rows = pageList.map(p=>{
    return `<tr>
      <td>${esc(p.name)}</td>
      <td class="mono">${esc(p.asin||"")}</td>
      <td>${esc(p.market||"")}</td>
      <td>${esc(p.market?U.marketToCurrency(p.market):"")}</td>
      <td>${esc(U.sellerName(p.sellerId))}</td>
      <td>${esc(U.reviewName(p.reviewType))}</td>
      <td class="right">${esc(U.money(p.discount||0))}</td>
      <td class="right">
        <button class="btn" onclick="Actions.quickOrderFromProduct('${esc(p.id)}')">下单</button>
        <button class="btn" onclick="Actions.editProduct('${esc(p.id)}')">编辑</button>
        <button class="btn danger" onclick="Actions.deleteProduct('${esc(p.id)}')">删除</button>
      </td>
    </tr>`;
  }).join("\n");

  $("productRows").innerHTML = rows || `<tr><td colspan="8" class="small">暂无产品</td></tr>`;

  // pager
  const ppInfo = $("productPagerInfo");
  const ppPage = $("productPagerPage");
  const ppPrev = $("productPrev");
  const ppNext = $("productNext");
  const ppInfoTop = $("productPagerInfoTop");
  const ppPageTop = $("productPagerPageTop");
  const ppPrevTop = $("productPrevTop");
  const ppNextTop = $("productNextTop");
  if(ppInfo){
    ppInfo.textContent = `共 ${total} 条`;
    ppPage.textContent = `第 ${UI.productPage} / ${totalPages} 页`;
    ppPrev.disabled = UI.productPage<=1;
    ppNext.disabled = UI.productPage>=totalPages;
  }
  if(ppInfoTop){
    ppInfoTop.textContent = `共 ${total} 条`;
    ppPageTop.textContent = `第 ${UI.productPage} / ${totalPages} 页`;
    ppPrevTop.disabled = UI.productPage<=1;
    ppNextTop.disabled = UI.productPage>=totalPages;
  }
}
function filteredOrders(){
  UI.__cache = UI.__cache || {};
  const seller = $("filterSeller").value || "ALL";
  const ps = $("filterPrincipal").value || "ALL";
  const cs = $("filterCommission").value || "ALL";
  const qraw = ($("filterSearch").value||"").trim().toLowerCase();
  const rev = (S && S.__rev) ? S.__rev : 0;
  const sig = ["orders", rev, seller, ps, cs, qraw].join("|");
  if(UI.__cache.ordersSig === sig && Array.isArray(UI.__cache.ordersArr)) return UI.__cache.ordersArr;

  const arr = (S.orders||[]).filter(o=>{
    if(seller!=="ALL" && o.sellerId!==seller) return false;
    if(ps==="UNSETTLED" && o.principal.settled) return false;
    if(ps==="SETTLED" && !o.principal.settled) return false;
    if(cs==="UNSETTLED"){
      if(o.commission.settled) return false;
      if(!canSettleCommission(o)) return false;
    }
    if(cs==="SETTLED" && !o.commission.settled) return false;

    if(qraw){
      const hay = [o.orderId,o.note,o.asin,U.sellerName(o.sellerId||""),o.market, U.productName(o.productId||"")].join("\n").toLowerCase();
      if(!hay.includes(qraw)) return false;
    }
    return true;
  });

  UI.__cache.ordersSig = sig;
  UI.__cache.ordersArr = arr;
  return arr;
}
function updateSettleButtons(){
  const n = UI.selected.size;
  $("btnSettlePrincipal").disabled = n===0;
  $("btnSettleCommission").disabled = n===0;
  $("btnSettleBoth").disabled = n===0;
}
function buildSelectedTagEl(oid){
  const t = document.createElement("span");
  t.className = "tag";
  t.dataset.oid = oid;
  t.innerHTML = `<span class="mono">${esc(oid)}</span><span class="x">×</span>`;
  t.title = "点击取消选择";
  t.onclick = ()=>{ Actions.toggleSelect(oid); };
  return t;
}
function updateSelectedTag(oid, isSelected){
  const box = $("selectedTags");
  // orderId 仅包含数字/横线/下划线，直接用于属性选择器即可
  const exist = box.querySelector(`.tag[data-oid="${oid}"]`);
  if(isSelected){
    if(!exist) box.appendChild(buildSelectedTagEl(oid));
  } else {
    if(exist) exist.remove();
  }
}

// ---- PERF: orderId index & bulk selection helpers ----
let __orderIdIndex_cache = null;
let __orderIdIndex_cache_len = -1;
function getOrderIdIndex(){
  // Rebuild only if orders array size changed (good enough for this single-file app)
  if(!__orderIdIndex_cache || __orderIdIndex_cache_len !== (S.orders?.length||0)){
    const m = new Map();
    (S.orders||[]).forEach(o=>{
      const k = String(o.orderId||o.order_no||o.orderNo||o.order_id||"").trim();
      if(k) m.set(k, o);
    });
    __orderIdIndex_cache = m;
    __orderIdIndex_cache_len = (S.orders?.length||0);
  }
  return __orderIdIndex_cache;
}
function appendSelectedTagsBatch(oids){
  if(!oids || !oids.length) return;
  const box = $("selectedTags");
  const frag = document.createDocumentFragment();
  oids.forEach(oid=> frag.appendChild(buildSelectedTagEl(oid)));
  box.appendChild(frag);
}
function syncVisibleCheckboxesBatch(oids, checked){
  if(!oids || !oids.length) return;
  oids.forEach(oid=> updateOrderCheckbox(oid, checked));
}

// update a single order row checkbox without re-rendering the table
function updateOrderCheckbox(oid, checked){
  try{
    const esc = (window.CSS && CSS.escape) ? CSS.escape : (s)=>String(s).replace(/["\\]/g, "\\$&");
    const el = document.querySelector(`input[type="checkbox"][data-oid="${esc(oid)}"]`);
    if(el) el.checked = !!checked;
  }catch(e){
    // ignore: best-effort sync for visible rows
  }
}

// ---- /PERF helpers ----

function updateSelectionUI(){
  const n = UI.selected.size;
  $("selectedCount").textContent = n ? `已选择 ${n} 单` : "";
  updateSettleButtons();
}
function renderSelectedTags(){
  const box = $("selectedTags");
  box.innerHTML = "";
  Array.from(UI.selected).forEach(oid=> box.appendChild(buildSelectedTagEl(oid)) );
  updateSelectionUI();
}

// ---- FAST LOOKUP MAPS (v7 hotfix): provide missing helpers used by renderOrders / renderPayout
// NOTE: Keep logic minimal and side-effect free. These helpers return Map(id -> entity).
function getSellerById(){
  UI.__idx = UI.__idx || {};
  const rev = (S && S.__rev) ? S.__rev : 0;
  const kMap = "sellerMap";
  const kRev = "sellerRev";
  if(UI.__idx[kRev] === rev && UI.__idx[kMap]) return UI.__idx[kMap];
  const map = new Map();
  const arr = (S && S.sellers) ? S.sellers : [];
  for(let i=0;i<arr.length;i++){ const x = arr[i]; if(x && x.id) map.set(x.id, x); }
  UI.__idx[kRev] = rev;
  UI.__idx[kMap] = map;
  return map;
}
function getProductById(){
  UI.__idx = UI.__idx || {};
  const rev = (S && S.__rev) ? S.__rev : 0;
  const kMap = "productMap";
  const kRev = "productRev";
  if(UI.__idx[kRev] === rev && UI.__idx[kMap]) return UI.__idx[kMap];
  const map = new Map();
  const arr = (S && S.products) ? S.products : [];
  for(let i=0;i<arr.length;i++){ const x = arr[i]; if(x && x.id) map.set(x.id, x); }
  UI.__idx[kRev] = rev;
  UI.__idx[kMap] = map;
  return map;
}
// ---- END FAST LOOKUP MAPS


function renderOrders(){
  // 排序：新建订单优先（createdAt 降序），无 createdAt 则保持原顺序
  const list = filteredOrders().slice().sort((a,b)=>{
    const ta = (a.createdAt||0), tb = (b.createdAt||0);
    if(tb!==ta) return tb-ta;
    // 兜底：按内部自增 id 末尾数字降序（新更大）
    const na = Number(String(a.id||'').replace(/\D+/g,''))||0;
    const nb = Number(String(b.id||'').replace(/\D+/g,''))||0;
    return nb-na;
  });
  const total = list.length;

  UI.pageSize = Number($("pageSize").value || 100);
  const totalPages = Math.max(1, Math.ceil(total / UI.pageSize));
  UI.page = Math.min(Math.max(1, UI.page), totalPages);

  const start = (UI.page-1)*UI.pageSize;
  const pageList = list.slice(start, start+UI.pageSize);

  $("pagerInfo").textContent = `共 ${total} 单`;
  $("pagerPage").textContent = `第 ${UI.page} / ${totalPages} 页`;

  const sellerById = getSellerById();
  const productById = getProductById();
  const rows = pageList.map(o=>{
    const sellerName = U.sellerName(o.sellerId);
    const pName = o.productId ? U.productName(o.productId) : (o.note||"");
    const pCny = currentPrincipalCny(o);
    const cm = commissionShould(o);

    const pSett = U.badgeSettle(o.principal.settled);
    const cSett = o.commission.settled ? U.badgeSettle(true) :
      (canSettleCommission(o) ? U.badgeSettle(false) : `<span class="badge pending">未回评</span>`);

    return `<tr>
      <td><input type="checkbox" data-oid="${esc(o.orderId)}" ${UI.selected.has(o.orderId)?"checked":""} onchange="Actions.toggleSelect(\'${esc(o.orderId)}\')"/></td>
      <td>${esc(U.dateMD(o.date))}</td>
      <td class=\"mono\">${esc(o.orderId)}</td>
      <td>${esc(sellerName)}</td>
      <td>${esc(o.market)}</td>
      <td>${esc(pName)}</td>
      <td class="mono">${esc(o.asin||"")}</td>
      <td>${U.badgeReview(o.review.status)}</td>
      <td>${esc(U.reviewName(o.reviewReq||"TEXT"))}</td>
      <td class="right">${esc(U.money(o.amount||0))}</td>
      <td class="right">${esc(U.money(o.discount||0))}</td>
      <td class="right">${esc(U.money(pCny))}</td>
      <td>${pSett}</td>
      <td class="right">${esc(U.money(cm))}</td>
      <td>${cSett}</td>
      <td class=\"right action-col\">
        <button class=\"btn\" onclick=\"Actions.editOrder('${esc(o.id)}')">编辑</button>
        <button class="btn" onclick="Actions.openReview('${esc(o.id)}')">回评</button>
        <button class="btn danger" onclick="Actions.deleteOrder('${esc(o.id)}')">删除</button>
      </td>
    </tr>`;
  }).join("\n");
  $("orderRows").innerHTML = rows || `<tr><td colspan="16" class="small">暂无订单</td></tr>`;
  renderSelectedTags();
}

/* ===================== Export Orders CSV ===================== */
function exportOrdersCsv(){
  const list = filteredOrders();
  const headers = [
    "order_id","date","seller","market","product","asin",
    "amount","discount","principal_orig","fx_used","principal_cny_preview",
    "review_status","review_doneType","commission_cny_preview",
    "principal_settled","principal_batch","commission_settled","commission_batch","note"
  ];
  const rows = list.map(o=>{
    const fx = effectiveFx(o, null);
    const principalOrigV = principalOrig(o);
    const principalCny = principalOrigV * fx;
    const cm = commissionShould(o);
    return [
      o.orderId, o.date, U.sellerName(o.sellerId), o.market, U.productName(o.productId||"") || o.note || "",
      o.asin || "",
      U.money(o.amount||0), U.money(o.discount||0), U.money(principalOrigV),
      fx, U.money(principalCny),
      o.review.status, o.review.doneType || "", U.money(cm),
      o.principal.settled ? "YES":"NO", o.principal.batchId||"",
      o.commission.settled ? "YES":"NO", o.commission.batchId||"",
      o.note||""
    ].map(U.csvEscape);
  });
  const csv = [headers.map(U.csvEscape).join(","), ...rows.map(r=>r.join(","))].join("\n");
  U.download("orders_filtered_"+U.today()+".csv", csv, "text/csv");
}

/* ===================== Batches ===================== */
function buildBatchCSV(batch){
  const headers = ["订单号","Market","金额(原币)","折扣(原币)","本金(原币)","FX","本金应收(CNY)","本金本次结算(CNY)","佣金应付(CNY)","佣金本次结算(CNY)","批次ID","结算日期","类型"];
  const rows = (batch.lines||[]).map(l=>[
    l.orderId, l.market,
    U.money(l.amount), U.money(l.discount), U.money(l.principalOrig),
    l.fx, U.money(l.principalShould), U.money(l.principalSettle),
    U.money(l.commissionShould), U.money(l.commissionSettle),
    batch.batchId, batch.date, batch.type
  ].map(U.csvEscape).join(","));
  return [headers.map(U.csvEscape).join(","), ...rows].join("\n");
}
function renderBatches(){
  const rows = (S.batches||[]).map(b=>{
    const typeLabel = b.type==="PRINCIPAL" ? "本金" : b.type==="COMMISSION" ? "佣金" : "本佣";
    const fxSummary = `USD ${U.money(b.fx.usd)} | EUR ${U.money(b.fx.eur)} | GBP ${U.money(b.fx.gbp)} | CAD ${U.money(b.fx.cad)} | JPY ${U.money(b.fx.jpy)}`;
    return `<tr>
      <td class="mono">${esc(b.batchId)}</td>
      <td>${esc(typeLabel)}</td>
      <td>${esc(b.date)}</td>
      <td>${esc(b.sellerLabel || "（多卖家）")}</td>
      <td>${esc((b.lines||[]).length)}</td>
      <td class="right">${esc(U.money(b.total||0))}</td>
      <td class="small">${esc(fxSummary)}</td>
      <td class="right">
        <button class="btn" onclick="Actions.exportBatchCSV('${esc(b.id)}')">导出CSV</button>
        <button class="btn danger" onclick="Actions.deleteBatch('${esc(b.id)}')">删除回滚</button>
      </td>
    </tr>`;
  }).join("\n");
  $("batchRows").innerHTML = rows || `<tr><td colspan="8" class="small">暂无批次</td></tr>`;
}

/* ===================== Actions ===================== */

function resetOrderForm(){
  // 新建订单默认全空（产品/卖家都不默认选中）
  safeSet("orderId", "");
  safeSet("orderSeller", "");
  safeSet("orderProduct", "");
  safeSet("orderMarket", "");
  safeSet("orderCurrency", "");
  safeSet("orderAmount", "");
  safeSet("orderDiscount", "");
  safeSet("orderAsin", "");
  safeSet("orderFxOverride", "");
  // 回评类型：默认跟随产品；无产品则默认文字评（由产品选择逻辑处理）
  safeSet("orderReviewType", "auto");
  safeSet("orderNote", "");
  safeSet("orderDate", U.today());
  if($("orderBuyerCommission")) safeSet("orderBuyerCommission", "");

  // 清空并排搜索框（搜索框仅用于过滤）
  ["orderSellerId","orderProductId","batchSellerId","batchProductId","filterSeller"].forEach(id=>{
    const el = document.getElementById(id+"__search");
    if(el) el.value = "";
  });
}


const Actions = {
  /* ---- Seller ---- */
  editSeller(id){
    const s = U.sellerById(id); if(!s) return;
    UI.sellerEditId = id;
    $("sellerId").value = s.id;
    $("sellerId").disabled = true;
    $("sellerName").value = s.name;
    $("sellerContact").value = s.contact||"";
    $("sellerRemark").value = s.remark||"";
    FX_MARKETS.forEach(m=>{ $("seller_fx_"+m).value = (s.fx||{})[m] ?? ""; });
    REVIEW_TYPES.forEach(t=>{ $("seller_cm_"+t.k).value = (s.commission||{})[t.k] ?? ""; });
    $("btnCancelSellerEdit").style.display = "inline-block";
    $("sellerEditHint").textContent = "正在编辑：" + s.id;
  },
  cancelSellerEdit(){
    UI.sellerEditId = null;
    $("sellerId").disabled = false;
    $("sellerId").value="";
    $("sellerName").value="";
    $("sellerContact").value="";
    $("sellerRemark").value="";
    FX_MARKETS.forEach(m=>{ $("seller_fx_"+m).value=""; });
    REVIEW_TYPES.forEach(t=>{ $("seller_cm_"+t.k).value=""; });
    $("btnCancelSellerEdit").style.display="none";
    $("sellerEditHint").textContent="";
  },
  saveSeller(){
    const id = ($("sellerId").value||"").trim();
    const name = ($("sellerName").value||"").trim();
    if(!id || !name){ alert("请填写 Seller ID 和 卖家名称"); return; }
    const fx = {};
    FX_MARKETS.forEach(m=> fx[m] = U.num($("seller_fx_"+m).value));
    // EUR markets sync
    if(fx.DE){ fx.FR=fx.DE; fx.IT=fx.DE; fx.ES=fx.DE; }
    const commission = {};
    REVIEW_TYPES.forEach(t=> commission[t.k] = U.num($("seller_cm_"+t.k).value));
    const payload = {id,name,contact:$("sellerContact").value||"",remark:$("sellerRemark").value||"",fx,commission};

    if(UI.sellerEditId){
      const idx = S.sellers.findIndex(x=>x.id===UI.sellerEditId);
      if(idx>=0) S.sellers[idx] = payload;
    }else{
      if(S.sellers.some(x=>x.id===id)){ alert("Seller ID 已存在"); return; }
      S.sellers.push(payload);
    }
    save();
    Actions.cancelSellerEdit();
    refreshAfterSellerChange();
  },
  deleteSeller(id){
    if(S.products.some(p=>p.sellerId===id) || S.orders.some(o=>o.sellerId===id)){
      alert("该卖家已被产品/订单引用，不能删除。"); return;
    }
    if(!confirm("确定删除卖家 "+id+"？")) return;
    S.sellers = S.sellers.filter(x=>x.id!==id);
    save(); refreshAfterSellerChange();
  },

  /* ---- Product ---- */
  editProduct(id){
    const p = U.productById(id); if(!p) return;
    UI.productEditId = id;
    $("productName").value = p.name;
    $("productAsin").value = p.asin;
    $("productMarket").value = p.market;
    $("productSeller").value = p.sellerId;
    $("productReviewType").value = p.reviewType;
    $("productDiscount").value = p.discount ?? 0;
    $("productBuyerCommission").value = p.buyerCommission ?? 0;
    $("productRemark").value = p.remark||"";
    $("btnCancelProductEdit").style.display="inline-block";
    $("productEditHint").textContent="正在编辑："+p.id;
    updateProductPreview();
  },
  cancelProductEdit(){
    UI.productEditId=null;
    $("productName").value="";
    $("productAsin").value="";
    $("productMarket").value="";
    $("productSeller").value="";
    $("productReviewType").value="";
    $("productDiscount").value="";
    $("productBuyerCommission").value="";
    $("productRemark").value="";
    $("btnCancelProductEdit").style.display="none";
    $("productEditHint").textContent="";
    updateProductPreview();
  },
  saveProduct(){
    const name = ($("productName").value||"").trim();
    const asin = ($("productAsin").value||"").trim();
    const market = $("productMarket").value;
    const sellerId = $("productSeller").value;
    const reviewType = $("productReviewType").value;
    if(!name || !asin || !market || !sellerId || !reviewType){
      alert("请填写：产品名、ASIN、Market、卖家、回评类型"); return;
    }
    const discount = U.num($("productDiscount").value);
    const buyerCommission = U.num($("productBuyerCommission").value);
    const remark = $("productRemark").value||"";
    const payload = {id:UI.productEditId || U.id("P", S.seq.product++), name, asin, market, sellerId, reviewType, discount, buyerCommission, remark};

    if(UI.productEditId){
      const idx = S.products.findIndex(x=>x.id===UI.productEditId);
      if(idx>=0) S.products[idx]=payload;
    }else{
      S.products.push(payload);
    }
    save();
    Actions.cancelProductEdit();
    refreshAfterProductChange();
  },
  deleteProduct(id){
    if(S.orders.some(o=>o.productId===id)){ alert("该产品已被订单引用，不能删除。"); return; }
    if(!confirm("确定删除该产品？")) return;
    S.products = S.products.filter(x=>x.id!==id);
    save(); refreshAfterProductChange();
    },
  quickOrderFromProduct(pid){
    $("orderProduct").value = pid;
    applyProductToOrder();
    $("orderId").focus();
  },

  /* ---- Order ---- */
  toggleSelect(orderId){
    const was = UI.selected.has(orderId);
    const now = !was;
    if(was) UI.selected.delete(orderId);
    else UI.selected.add(orderId);
    // 不重渲染整表：只同步复选框与“已选择”标签/按钮状态（增量更新）
    setOrderCheckbox(orderId, now);
    updateSelectedTag(orderId, now);
    updateSelectionUI();
  },
  editOrder(id){
    const o = S.orders.find(x=>x.id===id); if(!o) return;
    UI.orderEditId = id;
    $("orderProduct").value = o.productId || "";
    $("orderDate").value = o.date || U.today();
    $("orderId").value = o.orderId || "";
    $("orderSeller").value = o.sellerId || "";
    $("orderMarket").value = o.market || "US";
    $("orderCurrency").value = U.marketToCurrency(o.market || "US");
    $("orderAmount").value = U.num(o.amount);
    $("orderDiscount").value = U.num(o.discount);
    $("orderAsin").value = o.asin || "";
    $("orderNote").value = o.note || "";
    $("orderReviewType").value = o.reviewReq || "";
    $("orderFxOverride").value = (o.fxOverride==null ? "" : o.fxOverride);
    $("btnCancelOrderEdit").style.display="inline-block";
    $("orderEditHint").textContent="正在编辑："+o.orderId;
  },
  cancelOrderEdit(){
    UI.orderEditId=null;
    $("orderProduct").value="";
    $("orderDate").value=U.today();
    $("orderId").value="";
    $("orderSeller").value="";
    $("orderReviewType").value="";
    $("orderMarket").value="";
    $("orderCurrency").value="";
    $("orderAmount").value="";
    $("orderDiscount").value="";
    $("orderBuyerCommission").value="";
    $("orderAsin").value="";
    $("orderNote").value="";
    $("orderFxOverride").value="";
    $("btnCancelOrderEdit").style.display="none";
    $("orderEditHint").textContent="";
  },
  saveOrder(){
    const rawOrderId = ($("orderId").value||"").trim();
    const orderId = rawOrderId ? rawOrderId.slice(0,19) : "";
    const sellerId = ($("orderSeller").value||"").trim();
    const productId = ($("orderProduct").value||"").trim() || null;

    if(!sellerId){ showNotice("提示","请选择卖家"); return; }
    if(!orderId){ showNotice("提示","请输入订单号（系统会按前 19 位作为订单号）"); return; }

    const asin = (($("orderAsin").value||"").trim() || "");
    // 规则（按你的最新要求）：
    // 只有在「同卖家 + 同订单号(19位) + 同 ASIN」同时成立时，才视为重复并禁止提交。
    // 只要三者任意一个不同，都允许提交（用于同订单号的不同产品/不同 ASIN 场景）。
    const dupExists = S.orders.some(o=>{
      if(UI.orderEditId && o.id===UI.orderEditId) return false;
      return o.sellerId===sellerId && (o.orderId||"")===orderId && ((o.asin||"")===asin);
    });
    if(dupExists){
      showNotice("重复跳过","已存在同卖家 + 同订单号 + 同 ASIN 的订单，已禁止重复提交。");
      return;
    }

    const payload = {
      orderId,
      key: U.orderKey(sellerId, orderId, asin),
      sellerId,
      productId,
      market: ($("orderMarket").value||"").trim(),
      currency: ($("orderCurrency").value||"").trim(),
      amount: U.toNum($("orderAmount").value),
      discount: U.toNum($("orderDiscount").value),
      buyerCommission: U.toNum($("orderBuyerCommission").value),
      asin,
      title: ($("orderNote").value||"").trim(),
      fx: U.toNum(($("orderFxOverride")?$("orderFxOverride").value:"")),
      reviewReq: (($("orderReviewType")?$("orderReviewType").value:"auto")||"auto").trim(),
      note: ($("orderNote").value||"").trim(),
      date: ($("orderDate").value||"").trim() || U.today(),
    };

    // sellerId::orderId 唯一键（同卖家同单号不允许；如确实重复请手动改订单号 _1）
    const keyExists = S.orders.some(o => o.key===payload.key && (!UI.orderEditId || o.id!==UI.orderEditId));
    if(keyExists){
      showNotice("重复订单","同卖家下该订单号已存在。若确实是重复订单，请手动把订单号改为“{订单号}_1”等后再提交。");
      return;
    }

    if(UI.orderEditId){
      const i = S.orders.findIndex(o=>o.id===UI.orderEditId);
      if(i>=0){
        const prev = S.orders[i];
        S.orders[i] = {
          ...prev,
          ...payload,
          // 保留已结算/回评信息
          principal: prev.principal || {settled:false,batchId:null,amountCny:0,settledAmountCny:0},
          commission: prev.commission || {settled:false,batchId:null,amountCny:0,settledAmountCny:0},
          review: prev.review || {status:"PENDING",doneType:null,date:"",link:"",note:""}
        };
      }
      UI.orderEditId = null;
      $("btnCancelOrderEdit").classList.add("hidden");
      showNotice("已保存","订单已更新成功。");
    }else{
      const id = U.id("O", S.seq.order++);
      S.orders.unshift({
        id,
        createdAt: Date.now(),
        ...payload,
        principal: { settled:false, batchId:null, amountCny:0, settledAmountCny:0 },
        commission:{ settled:false, batchId:null, amountCny:0, settledAmountCny:0 },
        review: { status:"PENDING", doneType:null, date:"", link:"", note:"" }
      });
      showNotice("已提交","订单已保存成功。");
      resetOrderForm();
    }

    saveNow();
      refreshAfterOrderChange();
  },
  deleteOrder(id){
    // safer delete: open confirmation modal
    openDeleteModal(id);
  },

  /* ---- Review ---- */
  openReview(id){
    const o = S.orders.find(x=>x.id===id); if(!o) return;
    UI.reviewOrderId = id;
    $("rv_order").value = o.orderId;
    const curRvStatus = o.review.status || "PENDING";
      $("rv_status").value = (curRvStatus === "PENDING" || curRvStatus === "") ? "DONE" : curRvStatus;
    $("rv_date").value = o.review.date || U.today();
    $("rv_link").value = o.review.link || "";
    $("rv_note").value = o.review.note || "";
    // doneType 默认：已有 doneType -> 用它；否则产品回评类型；否则文字评
    const p = o.productId ? U.productById(o.productId) : null;
    const auto = (p?.reviewType || o.reviewReq || "TEXT");
    $("rv_doneType").value = o.review.doneType || "" ; // allow auto
    $("rv_doneType").dataset.auto = auto; // stash
    $("reviewModal").style.display="flex";
  },
  closeReview(){ $("reviewModal").style.display="none"; UI.reviewOrderId=null; },
  saveReview(){
    const id = UI.reviewOrderId; if(!id) return;
    const o = S.orders.find(x=>x.id===id); if(!o) return;
    o.review.status = $("rv_status").value;
    o.review.date = $("rv_date").value || "";
    o.review.link = $("rv_link").value || "";
    o.review.note = $("rv_note").value || "";
    // 若选择为空，保持为空（自动），佣金计算时会自动回落到产品/订单要求
    o.review.doneType = $("rv_doneType").value || "";
    // 性能与排序：记录更新时间（用于返款列表按最新变更置顶）
    try{ o.updatedAt = Date.now(); if(!o.createdAt) o.createdAt = o.updatedAt; }catch(e){}
    // 如果状态变为 WAIVED，也允许结算佣金（按 doneType/产品规则）
    save();
    Actions.closeReview();
    refreshAfterReviewChange();
  },

  /* ---- Batch Export/Delete ---- */
  exportBatchCSV(batchInternalId){
    const b = S.batches.find(x=>x.id===batchInternalId); if(!b) return;
    const csv = buildBatchCSV(b);
    U.download(`${b.batchId}_${b.type}.csv`, csv, "text/csv");
  },
  deleteBatch(batchInternalId){
    const b = S.batches.find(x=>x.id===batchInternalId); if(!b) return;
    if(!confirm("删除批次会回滚订单结算状态，确定？")) return;

    (b.lines||[]).forEach(line=>{
      const o = S.orders.find(x=>x.orderId===line.orderId);
      if(!o) return;
      if(b.type==="PRINCIPAL" || b.type==="BOTH"){
        o.principal.settled=false; o.principal.batchId=""; o.principal.amountCny=0; o.principal.fx=0;
      }
      if(b.type==="COMMISSION" || b.type==="BOTH"){
        o.commission.settled=false; o.commission.batchId=""; o.commission.amountCny=0;
      }
    });
    S.batches = S.batches.filter(x=>x.id!==batchInternalId);
    save(); markDirty(["batches","orders","kpi","payout"]); scheduleRender();
  }
};

/* ===================== Product -> Order autofill ===================== */
function applyProductToOrder(){
  const pid = $("orderProduct").value;
  if(!pid){
    // next5: 选择“不选产品”时，立即清空自动填充字段
    setVal('orderMarket','');
    setVal('orderCurrency','');
    setVal('orderAsin','');
    setVal('orderSeller','');
    setVal('orderNote','');
    setVal('orderAmount','');
    setVal('orderDiscount','0');
    setVal('orderBuyerCommission','');
    // 回评类型默认文字评
    setVal('orderReviewType','文字评');
    return;
  }
  const p = U.productById(pid);
  if(!p) return;
  // seller sync
  $("orderSeller").value = p.sellerId;
  $("orderMarket").value = p.market;
  $("orderCurrency").value = U.marketToCurrency(p.market);
  // default fields
  $("orderDiscount").value = U.num(p.discount);
  $("orderAsin").value = p.asin || "";
  if(!$("orderNote").value) $("orderNote").value = p.name || "";
  // orderReviewType: allow user override; if empty, set
  if(!$("orderReviewType").value) $("orderReviewType").value = p.reviewType || "";
}


/* ===================== Batch Product Match ===================== */
// 从一行解析出的 title/market 中，尝试匹配产品库中的产品
// 规则：优先同 Market；用“包含关系 + 长度”做粗匹配；取最长命中（更精确）。
function matchProductFromText(title, market){
  const t0 = String(title||"").trim();
  if(!t0) return null;
  const t = t0.replace(/\s+/g,'').toLowerCase();
  const mk = String(market||"").trim();
  let best=null, bestScore=0;
  (S.products||[]).forEach(p=>{
    if(!p) return;
    if(mk && String(p.market||"").trim() && String(p.market||"").trim()!==mk) return;
    const pn0 = String(p.name||"").trim();
    if(!pn0) return;
    const pn = pn0.replace(/\s+/g,'').toLowerCase();
    // 命中：title 包含 产品名 或 产品名 包含 title
    const hit = (t.includes(pn) || pn.includes(t));
    if(!hit) return;
    const score = Math.min(pn.length, t.length); // 越长越好
    if(score>bestScore){
      bestScore=score; best=p;
    }
  });
  return best;
}


/* ===================== Batch Parse ===================== */
function detectMarketAndReviewType(text, fallbackMarket){
  const t = text || "";
  let market = fallbackMarket || "US";
  const rules = [
    {k:"美国", m:"US"},{k:"英国", m:"UK"},{k:"德国", m:"DE"},{k:"法国", m:"FR"},{k:"意大利", m:"IT"},{k:"西班牙", m:"ES"},{k:"加拿大", m:"CA"},{k:"日本", m:"JP"},
    {k:"US", m:"US"},{k:"UK", m:"UK"},{k:"DE", m:"DE"},{k:"FR", m:"FR"},{k:"IT", m:"IT"},{k:"ES", m:"ES"},{k:"CA", m:"CA"},{k:"JP", m:"JP"},
  ];
  for(const r of rules){ if(t.includes(r.k)){ market=r.m; break; } }

  let reviewType = "TEXT";
  const rtRules = [
    {k:"文字评", v:"TEXT"},
    {k:"图片评", v:"IMAGE"},
    {k:"视频评", v:"VIDEO"},
    {k:"免评FB", v:"FREE_FB"},
    {k:"免评点星", v:"STAR"},
    {k:"免评", v:"FREE"},
  ];
  for(const r of rtRules){ if(t.includes(r.k)){ reviewType=r.v; break; } }
  return {market, reviewType};
}
function parseLine(line){
  const raw = String(line||'').trim();
  if(!raw) return null;

  // 1) 订单号：默认取前 19 位；若前 19 位不是 Amazon 单号格式，仍按“纯单号”处理（价格=0，其它空）
  const head = raw.slice(0,19);
  const isAmazonOrderId = /^\d{3}-\d{7}-\d{7}$/.test(head);
  const orderId = isAmazonOrderId ? head : head; // 仍然保留前 19 位作为订单号

  const rest = raw.slice(19).trim();

  // 2) 价格：只在 rest 中识别，避免把“纯 19 位单号”误识别为金额
  //    规则：在 rest 里找第一个“独立数字(可带小数)”；若 rest 为空则 price=0
  let price = 0;
  if(rest){
    // 优先识别带小数的价格，其次整数；均要求前后不是数字，避免粘连
    const m = rest.match(/(^|[^\d])(\d+(?:\.\d{1,2})?)(?=$|[^\d])/);
    if(m){
      const v = parseFloat(m[2]);
      if(Number.isFinite(v)) price = v;
    }
  }

  // 3) 折扣价 / 买手佣金（买家佣金）：不会同时出现；识别失败则为 0
  let discount = 0;
  let buyerCommission = 0;

  // 折扣：折扣价10 / 折扣10 / review后“折扣价 3”
  const mDisc = raw.match(/折扣价\s*([0-9]+(?:\.[0-9]{1,2})?)/) || raw.match(/折扣\s*([0-9]+(?:\.[0-9]{1,2})?)/);
  if(mDisc){
    const v = parseFloat(mDisc[1]);
    if(Number.isFinite(v)) discount = v;
  }

  // 佣金：佣金30 / 买家佣金30 / 买手佣金30（额外给买家）
  const mComm = raw.match(/(?:买家佣金|买手佣金|佣金)\s*([0-9]+(?:\.[0-9]{1,2})?)/);
  if(mComm){
    const v = parseFloat(mComm[1]);
    if(Number.isFinite(v)) buyerCommission = v;
  }

  // 4) 回评要求：默认文字评；能识别则覆盖
  //    规则：图片/图评 => 图片评；视频 => 视频评；免评/FB/feedback/无法上评 => 免评 或 免评FB
  let reviewType = '文字评';
  const low = raw.toLowerCase();
  if(/免评点星/.test(raw)) reviewType = '免评点星';
  else if(/免评fb/.test(low) || /feedback/.test(low)) reviewType = '免评FB';
  else if(/无法上评/.test(raw) || /fb/.test(low)) reviewType = '免评'; // 你要求“无法上评FB”按免评计算
  else if(/免评/.test(raw)) reviewType = '免评';
  else if(/视频/.test(raw)) reviewType = '视频评';
  else if(/图评/.test(raw) || /图片/.test(raw)) reviewType = '图片评';
  // 其余默认文字评

  // 5) 产品名：取 rest 去掉金额、折扣/佣金等关键词后的前半段（尽量保留中文名）
  let title = rest;
  if(title){
    // 去掉括号后备注
    title = title.replace(/\(.*?\)/g,' ').trim();
    // 去掉折扣/佣金信息段
    title = title.replace(/折扣价\s*[0-9]+(?:\.[0-9]{1,2})?/g,' ');
    title = title.replace(/折扣\s*[0-9]+(?:\.[0-9]{1,2})?/g,' ');
    title = title.replace(/(?:买家佣金|买手佣金|佣金)\s*[0-9]+(?:\.[0-9]{1,2})?/g,' ');
    // 去掉回评关键词
    title = title.replace(/(?:文字评价|图片评价|视频评价|review\+feedback|review|feedback|免评点星|免评fb|免评)/ig,' ');
    // 去掉刚刚识别的价格数字（只去掉第一个匹配）
    title = title.replace(/(^|[^\d])(\d+(?:\.\d{1,2})?)(?=$|[^\d])/, '$1 ');
    title = title.replace(/\s+/g,' ').trim();
  }

  return { ok:true, orderId, title, amount: price, discount, buyerCommission, reviewReq: reviewType };
}


function batchHandle(commit){
  const sellerIdInput = $("batchSeller").value; // 允许为空：先解析，尽量从产品库自动推导卖家
  const productIdInput = $("batchProduct").value || null;
  const defaultDate = $("batchDate").value || U.today();
  const defaultMarket = $("batchMarket").value || "";
  const text = $("batchText").value || "";
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  let rows = [];
  let badLines = [];
  for(const line of lines){
    const p = parseLine(line);
    if(!p.ok){ badLines.push(line); continue; }
    // detect market/review type from Chinese note if present
    const det = detectMarketAndReviewType(p.title || "", defaultMarket);
    const market = (p.market || det.market || defaultMarket || "US");
    const currency = U.marketToCurrency(market);
    // 尝试从产品库匹配产品：
// 1) 若你在右侧选择了“套用产品”，直接用该产品；
// 2) 否则用解析出的 title + market 自动匹配产品；
// 3) 匹配成功：自动带入产品名、ASIN（无 ASIN 则用产品名）、默认卖家（产品的 sellerId）；
// 4) 匹配失败：ASIN 为空时自动用“产品名”作为 ASIN（降低重复误判）。
    let matchedProduct = null;
    if(productIdInput){
      matchedProduct = U.productById(productIdInput) || null;
    }else{
      matchedProduct = matchProductFromText(p.title || "", market);
    }

    let finalTitle = p.title || "";
    let finalAsin = "";
    let finalProductId = null;
    let finalSellerId = (sellerIdInput || "").trim();

    if(matchedProduct){
      finalProductId = matchedProduct.id || null;
      finalSellerId = (matchedProduct.sellerId || finalSellerId || "").trim();
      finalTitle = String(matchedProduct.name || finalTitle || "").trim();
      finalAsin = String(matchedProduct.asin || "").trim();
      if(!finalAsin) finalAsin = finalTitle || "";
    }else{
      finalAsin = String(p.asin || "").trim();
      if(!finalAsin) finalAsin = String(finalTitle||"").trim();
    }

    rows.push({
      orderId: (p.orderId||"").slice(0,19),
      title: finalTitle,
      amount: (p.amount==null? "" : String(p.amount)),
      market,
      currency,
      asin: finalAsin,
      sellerId: finalSellerId,     // 允许为空，后续再提示选择卖家
      productId: finalProductId,   // 允许为空
      reviewReq: (p.reviewReq || det.reviewType || "TEXT"),
      date: p.date || defaultDate,
      note: p.note || ""
    });
  }

  if(!rows.length){
    showNotice("提示", "未解析到可用行。\n失败 " + badLines.length + " 行。");
    return;
  }

  // 若存在未匹配产品的行，并且你也未选择卖家，则“解析并提交”需要先选卖家（否则无法确定 FX/佣金等）
  const missingSellerCnt = rows.filter(r=>!String(r.sellerId||"").trim()).length;
  if(commit && missingSellerCnt>0 && !String(sellerIdInput||"").trim()){
    showNotice("提示", `已完成解析，但有 ${missingSellerCnt} 行未能从产品库匹配到默认卖家。\n请先在右侧选择卖家（或先选择“套用产品”），再点击「解析并提交」。\n你也可以先点「仅预览」查看解析结果。`);
    return;
  }


  const subtitleLines = [];
  subtitleLines.push("解析成功：" + rows.length + " 行；失败：" + badLines.length + " 行。");
  if(badLines.length){
    const head = badLines.slice(0,8).join("\n- ");
    const more = badLines.length>8 ? ("\n… 还有 " + (badLines.length-8) + " 行") : "";
    subtitleLines.push("失败行（不会提交）：\n- " + head + more);
  }
  const subtitle = subtitleLines.join("\n\n");

  const markets = MARKETS.map(x=>({v:x.m, t:x.m}));
  const reviewOpts = ["文字评","图片评","视频评","免评","免评FB","免评点星"].map(v=>({v:v, t:v}));
  const rtMap = {"文字评":"TEXT","图片评":"IMAGE","视频评":"VIDEO","免评":"FREE","免评FB":"FREE_FB","免评点星":"STAR"};

  showTablePreviewModal({
    title: "批量解析预览（可修改后再提交）",
    subtitle,
    columns: [
      {key:"orderId", label:"订单号(19位)", width:"170px", type:"text"},
      {key:"title", label:"产品名/标题", width:"280px", type:"text"},
      {key:"amount", label:"订单金额", width:"120px", type:"text"},
      {key:"market", label:"Market", width:"110px", type:"select", options:()=>markets},
      {key:"asin", label:"ASIN", width:"160px", type:"text"},
      {key:"reviewReq", label:"回评要求", width:"140px", type:"select", options:()=>reviewOpts},
      {key:"date", label:"下单日期", width:"140px", type:"date"},
      {key:"note", label:"备注", width:"220px", type:"text"},
    ],
    rows,
    applyText: commit ? "确认提交登记" : "关闭",
    onApply: (finalRows, close)=>{
      if(!commit){ close(); return; }

      let submitted=0, duplicated=0, bad=0;
      const dupLines=[], okLines=[], bad2=[];
      for(const r of finalRows){
        const orderId = String(r.orderId||"").trim().slice(0,19);
        if(!orderId){ bad++; bad2.push("订单号为空"); continue; }

        const market = String(r.market||defaultMarket||"US").trim() || "US";
        const currency2 = U.marketToCurrency(market);
        const reviewLabel = String(r.reviewReq||"文字评").trim();
        const reviewType = rtMap[reviewLabel] || "TEXT";

        const asin = String(r.asin||"").trim();
        const sellerId = String(r.sellerId || sellerIdInput || "").trim();
        const productId = String(r.productId || productIdInput || "").trim() || null;

        if(!sellerId){ bad++; bad2.push(`${orderId}：未匹配到产品且未选择卖家`); continue; }

        // 重复判定：仅当同卖家 + 同订单号 + 同 ASIN 同时成立
        const dupExists = S.orders.some(o=>{
          return o.sellerId===sellerId && (o.orderId||"")===orderId && ((o.asin||"")===asin);
        });
        if(dupExists){ duplicated++; dupLines.push(orderId); continue; }

        const key = U.orderKey(sellerId, orderId, asin);

const seller = U.sellerById(sellerId);
        const fxKey = U.marketToFxKey(market);
        const fx = seller ? U.num(seller.fx?.[market] || seller.fx?.[fxKey] || 0) : 0;

        const amount = num(r.amount, 0);

        const o = {
          id: U.id("O", S.seq.order++),
          createdAt: new Date().toISOString(),
          orderId,
          key,
          sellerId,
          productId,
          market,
          currency: currency2,
          amount,
          discount: 0,
          buyerCommission: 0,
          asin,
          note: String(r.note||"") || String(r.title||""),
          date: r.date || defaultDate,
          fx: fx || 0,
          reviewReq: reviewType,
          principal: { settled:false, batchId:null, amountCny:0, settledAmountCny:0 },
          commission:{ settled:false, batchId:null, amountCny:0, settledAmountCny:0 },
          review:{ status:"PENDING", doneType:"", date:"", link:"", note:"" }
        };

        S.orders.unshift(o);
        submitted++;
        okLines.push(orderId);
      }

      saveNow();
      refreshAfterOrderChange();
      close();
      showParseSummary({submitted, duplicated, bad, dupLines, badLines: bad2, okLines});
    }
  });
  // 解析完成后，右侧“卖家/套用产品”重置为默认（避免下一次误套用）
  try{ $("batchSeller").value=""; }catch(e){}
  try{ $("batchProduct").value=""; }catch(e){}

}


/* ===================== Link Product to Orders (Paste IDs) ===================== */
function linkProductByPaste(){
  const pid = $("linkProduct").value;
  if(!pid){ alert("请先选择产品"); return; }
  const p = U.productById(pid);
  if(!p){ alert("产品不存在"); return; }

  const ids = U.extractOrderIds(($("pasteLinkBox").value||"").trim());
  if(!ids.length){ $("pasteLinkHint").textContent="未识别到订单号"; return; }

  const idx = getOrderIdIndex();

  const rows = ids.map(oid=>{
    const o = idx.get(oid);
    return { orderId: oid, found: o ? "已找到" : "未找到" };
  });

  showTablePreviewModal({
    title: "解析筛选/关联预览（确认后才执行）",
    subtitle: "共识别 " + ids.length + " 个订单号。你可以取消勾选某些行不处理；未找到的行不会执行关联。",
    columns: [
      {key:"orderId", label:"订单号", width:"190px", type:"text"},
      {key:"found", label:"匹配结果", width:"110px", type:"text"},
    ],
    rows,
    applyText: "确认执行关联并勾选",
    onApply: (finalRows, close)=>{
      const added = [];
      let hit=0, miss=0;
      finalRows.forEach(r=>{
        const oid = String(r.orderId||"").trim();
        if(!oid) return;
        const o = idx.get(oid);
        if(!o){ miss++; return; }
        // 关联产品并同步字段
        o.productId = p.id;
        o.sellerId = p.sellerId;
        o.market = p.market;
        o.currency = U.marketToCurrency(p.market);
        o.reviewReq = p.reviewType;
        o.discount = U.num(p.discount);
        o.asin = p.asin || o.asin;
        if(!o.note) o.note = p.name;

        if(!UI.selected.has(oid)){
          UI.selected.add(oid);
          added.push(oid);
        }
        hit++;
      });
      save();
      // perf: only refresh orders UI
      renderOrders();
      // batch update tags & checkboxes without a second full render
      appendSelectedTagsBatch(added);
      syncVisibleCheckboxesBatch(added, true);
      updateSelectionUI();

      close();
      $("pasteLinkHint").textContent = "识别 " + ids.length + " 个；命中并关联 " + hit + " 个；未找到 " + miss + " 个（已勾选命中订单）";
    }
  });
}



function batchMarkReviewDone(){
  const ids = U.extractOrderIds(($("pasteLinkBox").value||"").trim());
  if(!ids.length){ $("pasteLinkHint").textContent="未识别到订单号"; return; }

  const rows = ids.map(oid=>{
    const o = S.orders.find(x=>x.orderId===oid);
    let st = "未找到";
    if(o){
      st = (o.review && o.review.status==="DONE") ? "已是DONE" : "可标记";
    }
    return { orderId: oid, status: st };
  });

  showTablePreviewModal({
    title: "解析标记回评预览（确认后才执行）",
    subtitle: "共识别 " + ids.length + " 个订单号。可取消勾选不处理的行；未找到/已是DONE会自动跳过。",
    columns: [
      {key:"orderId", label:"订单号", width:"190px", type:"text"},
      {key:"status", label:"匹配状态", width:"120px", type:"text"},
    ],
    rows,
    applyText: "确认批量标记DONE",
    onApply: (finalRows, close)=>{
      let changed=0, skipped=0, missing=0;
      const dupLines=[], badLines=[], okLines=[];
      function fmt(o){ return (o.orderId||"") + " | " + (U.sellerName(o.sellerId)||"") + " | " + (o.market||""); }

      finalRows.forEach(r=>{
        const oid = String(r.orderId||"").trim();
        if(!oid) return;
        const o = S.orders.find(x=>x.orderId===oid);
        if(!o){ missing++; badLines.push("未找到："+oid); return; }
        if(o.review && o.review.status==="DONE"){
          skipped++; dupLines.push(fmt(o)); return;
        }
        if(!o.review) o.review = { status:"PENDING", doneType:"", date:"", link:"", note:"" };
        o.review.status = "DONE";
        o.review.date = o.review.date || U.today();
        changed++;
        okLines.push(fmt(o));
      });

      saveNow();
      refreshAfterOrderChange();
      close();
      showParseSummary({submitted: changed, duplicated: skipped, bad: missing, dupLines, badLines, okLines});
      $("pasteLinkHint").textContent = "批量标记完成：DONE " + changed + "；已是DONE跳过 " + skipped + "；未找到 " + missing;
    }
  });
}


function openSettle(mode){
  const ids = Array.from(UI.selected);
  if(!ids.length){ alert("请先勾选订单"); return; }

  // default mode: 如果全是免评产品，推荐 BOTH（但仍尊重用户点击的 mode）
  const batchIdPrefix = (mode==="PRINCIPAL" ? "PB" : mode==="COMMISSION" ? "CB" : "BB");
  const batchId = `${batchIdPrefix}${U.today().replaceAll("-","")}-${String(Math.floor(Math.random()*900)+100)}`;

  // prefill fx from first seller (if single), else zeros
  const sellerIds = Array.from(new Set(ids.map(oid=>S.orders.find(o=>o.orderId===oid)?.sellerId).filter(Boolean)));
  if(sellerIds.length>1){
    // 给出具体冲突订单，方便你快速取消勾选
    const groups = {};
    ids.forEach(oid=>{
      const o = S.orders.find(x=>x.orderId===oid);
      const sid = o?.sellerId || '';
      if(!groups[sid]) groups[sid] = [];
      groups[sid].push(oid);
    });
    const lines = Object.entries(groups).map(([sid, arr])=>{
      const name = (U.sellerById(sid)?.name) || sid || '(未知卖家)';
      const sample = arr.slice(0,6).join(', ') + (arr.length>6 ? ` ...(+${arr.length-6})` : '');
      return `- ${name}：${arr.length} 单（${sample}）`;
    });
    alert(`不同卖家的订单不能一起结算。\n\n当前勾选共 ${ids.length} 单，涉及 ${sellerIds.length} 个卖家：\n${lines.join('\n')}\n\n请只保留同一个卖家的订单再结算。`);
    return;
  }

  const singleSeller = sellerIds.length===1 ? U.sellerById(sellerIds[0]) : null;

  const fx = {
    usd: singleSeller ? U.num(singleSeller.fx.US) : 7.2,
    eur: singleSeller ? U.num(singleSeller.fx.DE) : 7.8,
    gbp: singleSeller ? U.num(singleSeller.fx.UK) : 9.1,
    cad: singleSeller ? U.num(singleSeller.fx.CA) : 5.3,
    jpy: singleSeller ? U.num(singleSeller.fx.JP) : 0.05,
  };

  
// 佣金默认：优先使用“已保存默认”，否则使用当前卖家佣金
const commMap = Object.assign({}, (S.settings && S.settings.settleCommByType) ? S.settings.settleCommByType : {});
if(Object.keys(commMap).length===0 && singleSeller && singleSeller.commission){
  REVIEW_TYPES.forEach(rt=>{ if(singleSeller.commission[rt.key]!==undefined) commMap[rt.key]=U.num(singleSeller.commission[rt.key]); });
}
UI.settle = {mode, orderIds:ids, fx, commMap, batchId, date:U.today(), method:"", note:"", edits:{}};
  ids.forEach(oid=>{ UI.settle.edits[oid] = {p:null, c:null, amount:null, discount:null, buyerCommission:null}; });

  $("settleTitle").textContent = (mode==="PRINCIPAL" ? "批量结算：本金" : mode==="COMMISSION" ? "批量结算：佣金" : "批量结算：本佣一起");
  $("settleBatchId").value = batchId;
  $("settleBatchDate").value = UI.settle.date;
  $("settleMethod").value = "";
  $("settleNote").value = "";
  $("fx_usd").value = fx.usd;
  $("fx_eur").value = fx.eur;
  $("fx_gbp").value = fx.gbp;
  $("fx_cad").value = fx.cad;
  $("fx_jpy").value = fx.jpy;

  bindSettleCommUI();

  // default collapse meta to give table more space
  if($("settleMeta")) $("settleMeta").style.display = "none";
  if($("btnToggleSettleMeta")) $("btnToggleSettleMeta").textContent = "展开";

  renderSettleRows();
  $("settleModal").style.display="flex";
}
function closeSettle(){ $("settleModal").style.display="none"; UI.settle=null; }
function syncSettleFxFromInputs(){
  if(!UI.settle) return;
  UI.settle.fx = {
    usd: U.num($("fx_usd").value),
    eur: U.num($("fx_eur").value),
    gbp: U.num($("fx_gbp").value),
    cad: U.num($("fx_cad").value),
    jpy: U.num($("fx_jpy").value),
  };
  renderSettleRows();
}
function renderSettleRows(){
  if(!UI.settle) return;
  UI.settle.batchId = ($("settleBatchId").value||"").trim() || UI.settle.batchId;
  UI.settle.date = $("settleBatchDate").value || UI.settle.date;
  UI.settle.method = ($("settleMethod").value||"").trim();
  UI.settle.note = ($("settleNote").value||"").trim();

  const mode = UI.settle.mode;
  let total = 0;
  const productById = new Map((S.products||[]).map(p=>[p.id,p]));

  const rows = UI.settle.orderIds.map(oid=>{
    const o = S.orders.find(x=>x.orderId===oid);
    if(!o) return "";
    const p = productById.get(o.productId);
    const pName = (p && p.name) ? p.name : (o.productName || o.product || "-");
    const pAsin = (p && p.asin) ? p.asin : (o.asin || "-");
    const fx = effectiveFx(o, UI.settle.fx);
    const editedAmt = (UI.settle.edits[oid] && UI.settle.edits[oid].amount!=null) ? U.num(UI.settle.edits[oid].amount) : null;
    const amount = editedAmt!=null ? editedAmt : U.num(o.amount);
    const editedDisc = (UI.settle.edits[oid] && UI.settle.edits[oid].discount!=null) ? U.num(UI.settle.edits[oid].discount) : null;
    const editedBC = (UI.settle.edits[oid] && UI.settle.edits[oid].buyerCommission!=null) ? U.num(UI.settle.edits[oid].buyerCommission) : null;
    const discount = editedDisc!=null ? editedDisc : U.num(o.discount);
    const buyerCommission = editedBC!=null ? editedBC : U.num(o.buyerCommission);
    const pOrig = Math.max(0, amount - discount + buyerCommission);
    const pShould = pOrig * fx;

    const cShould = commFromSettleMap(o);

    const pEditable = (mode!=="COMMISSION") && !o.principal.settled;
    const cEditable = (mode!=="PRINCIPAL") && !o.commission.settled && canSettleCommission(o);

    const pAuto = pEditable ? pShould : 0;
    const cAuto = cEditable ? cShould : 0;

    const pVal = (UI.settle.edits[oid].p==null ? pAuto : Math.max(0, U.num(UI.settle.edits[oid].p)));
    const cVal = (UI.settle.edits[oid].c==null ? cAuto : Math.max(0, U.num(UI.settle.edits[oid].c)));

    total += pVal + cVal;

    return `<tr>
      <td class="mono">${esc(o.orderId)}</td>
      <td>${esc(o.market)}</td>
      <td class="ellipsis" title="${esc(pName)}">${esc(pName)}</td>
      <td class="mono">${esc(pAsin)}</td>
      <td class="right"><input data-oid="${esc(oid)}" data-k="amount" type="number" step="0.01" value="${esc(U.money(amount))}" style="max-width:120px"/></td>
      <td class="right"><input data-oid="${esc(oid)}" data-k="discount" type="number" step="0.01" value="${esc(U.money(discount))}" style="max-width:110px"/></td>
      <td class="right"><input data-oid="${esc(oid)}" data-k="buyerCommission" type="number" step="0.01" value="${esc(U.money(buyerCommission))}" style="max-width:110px"/></td>
      <td class="right">${esc(fx)}</td>
      <td class="right">
        <input data-oid="${esc(oid)}" data-k="p" type="number" step="0.01" value="${U.money(pVal)}" ${pEditable?"":"disabled"} style="max-width:140px"/>
      </td>
      <td class="right">${esc(U.money(cShould))}</td>
      <td class="right">
        <input data-oid="${esc(oid)}" data-k="c" type="number" step="0.01" value="${U.money(cVal)}" ${cEditable?"":"disabled"} style="max-width:140px"/>
      </td>
      <td class="right mono">= ${esc(U.money(pVal + cVal))}</td>
    </tr>`;
  }).join("\n");

  $("settleRows").innerHTML = rows || `<tr><td colspan="10" class="small">无可结算订单</td></tr>`;
  $("settleTotal").textContent = U.money(total);
  if($("settleTotalTop")) $("settleTotalTop").textContent = U.money(total);

  renderSettleCommBar();

  // bind input listeners
  $("settleRows").querySelectorAll("input[data-oid]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const oid = inp.dataset.oid;
      const k = inp.dataset.k;
      if(!UI.settle || !UI.settle.edits[oid]) return;
      UI.settle.edits[oid][k] = inp.value==="" ? null : U.num(inp.value);
      renderSettleRows();
    }, {once:false});
  });

}
function applySettleAmountEditsToOrders(showMsg=true){
  if(!UI.settle) return;
  let changedAmt = 0, changedDisc = 0, changedBC = 0;

  UI.settle.orderIds.forEach(oid=>{
    const o = S.orders.find(x=>x.orderId===oid);
    if(!o) return;
    const ed = UI.settle.edits?.[oid];
    if(!ed) return;

    if(ed.amount!=null){
      const newAmt = U.num(ed.amount);
      if(U.num(o.amount)!==newAmt){
        o.amount = newAmt;
        changedAmt++;
      }
    }
    if(ed.discount!=null){
      const newDisc = U.num(ed.discount);
      if(U.num(o.discount)!==newDisc){
        o.discount = newDisc;
        changedDisc++;
      }
    }
    if(ed.buyerCommission!=null){
      const newBC = U.num(ed.buyerCommission);
      if(U.num(o.buyerCommission)!==newBC){
        o.buyerCommission = newBC;
        changedBC++;
      }
    }
  });

  const changed = changedAmt + changedDisc + changedBC;
  if(changed){
    save();
    renderOrders();
  }

  if(showMsg){
    if(changed){
      const parts = [];
      if(changedAmt) parts.push(`金额(原币) ${changedAmt} 条`);
      if(changedDisc) parts.push(`折扣(原币) ${changedDisc} 条`);
      if(changedBC) parts.push(`买手佣金(原币) ${changedBC} 条`);
      showNotice("已保存", `已回写：${parts.join("，")}。`);
    }else{
      showNotice("未修改", "没有检测到需要回写的变更。");
    }
  }
}

function exportCurrentSettleCsv(){

  if(!UI.settle){ alert("请先打开结算窗口"); return; }
  const batch = buildCurrentBatchObject(false);
  const csv = buildBatchCSV(batch);
  U.download(`settle_${batch.batchId}.csv`, csv, "text/csv");
}
function buildCurrentBatchObject(applyToOrders){
  const mode = UI.settle.mode;
  const batchId = ($("settleBatchId").value||"").trim() || UI.settle.batchId;
  const date = $("settleBatchDate").value || UI.settle.date;
  const method = ($("settleMethod").value||"").trim();
  const note = ($("settleNote").value||"").trim();
  const fx = {
    usd: U.num($("fx_usd").value),
    eur: U.num($("fx_eur").value),
    gbp: U.num($("fx_gbp").value),
    cad: U.num($("fx_cad").value),
    jpy: U.num($("fx_jpy").value),
  };

  const sellerIds = Array.from(new Set(UI.settle.orderIds.map(oid=>S.orders.find(o=>o.orderId===oid)?.sellerId).filter(Boolean)));
  const sellerLabel = sellerIds.length===1 ? U.sellerName(sellerIds[0]) : "（多卖家）";

  const lines = [];
  let total = 0;

  UI.settle.orderIds.forEach(oid=>{
    const o = S.orders.find(x=>x.orderId===oid);
    if(!o) return;

    const fxUsed = effectiveFx(o, fx);
    const amount = U.num(o.amount);
    const discount = U.num(o.discount);
    const buyerCommission = U.num(o.buyerCommission);
    const pOrig = Math.max(0, amount - discount + buyerCommission);
    const pShould = pOrig * fxUsed;
    const cShould = commFromSettleMap(o);

    const pEditable = (mode!=="COMMISSION") && !o.principal.settled;
    const cEditable = (mode!=="PRINCIPAL") && !o.commission.settled && canSettleCommission(o);

    const pAuto = pEditable ? pShould : 0;
    const cAuto = cEditable ? cShould : 0;

    const pVal = (UI.settle.edits[oid].p==null ? pAuto : Math.max(0, U.num(UI.settle.edits[oid].p)));
    const cVal = (UI.settle.edits[oid].c==null ? cAuto : Math.max(0, U.num(UI.settle.edits[oid].c)));

    total += pVal + cVal;

    if(applyToOrders){
      if(pVal>0){
        o.principal.settled = true;
        o.principal.batchId = batchId;
        o.principal.fx = fxUsed;
        o.principal.amountCny = pVal;
      }
      if(cVal>0){
        o.commission.settled = true;
        o.commission.batchId = batchId;
        o.commission.amountCny = cVal;
      }
    }

    lines.push({
      orderId:o.orderId, market:o.market,
      amount, discount, principalOrig:pOrig, fx:fxUsed,
      principalShould:pShould, principalSettle:pVal,
      commissionShould:cShould, commissionSettle:cVal
    });
  });

  return {
    id: U.id("B", S.seq.batch++),
    batchId,
    type: mode,
    date,
    method,
    note,
    sellerLabel,
    fx,
    lines,
    total
  };
}
async function confirmSettle(){
  if(!UI.settle) return;
  applySettleAmountEditsToOrders(false);
  const batch = buildCurrentBatchObject(true);

  // guard: if all zeros, do not create batch
  if((batch.lines||[]).every(l=>U.num(l.principalSettle)===0 && U.num(l.commissionSettle)===0)){
    alert("本批次没有可结算金额（可能已结算/未回评）。");
    return;
  }

  S.batches.unshift(batch);
  save();
  closeSettle();
  // 性能：避免全量重渲染
  renderKPI();
  renderOrders();
  renderBatches();
  renderPayout();

  // 如果是从【收款草稿箱】打开的草稿，结算完成后自动移出草稿箱
  if(window.__settleDraftOpenedId && window.__settleDrafts && typeof window.__settleDrafts.del === "function"){
    try{ await window.__settleDrafts.del(window.__settleDraftOpenedId); }catch(e){}
    window.__settleDraftOpenedId = null;
    try{ if(typeof window.__settleDrafts.refreshOpen === "function") window.__settleDrafts.refreshOpen(); }catch(e){}
  }

  alert("已结算并生成批次。可在批次列表导出 CSV。");
}

/* ===================== Sample Data ===================== */
function seedSample(){
  S = blankState();

  const sid = U.id("S", S.seq.seller++);
  S.sellers.push({
    id:sid, name:"欧美测评", contact:"", remark:"",
    fx:{US:7.2, UK:9.1, DE:7.8, FR:7.8, IT:7.8, ES:7.8, CA:5.3, JP:0.05},
    commission:{TEXT:50, IMAGE:70, VIDEO:100, FREE:20, FREE_FB:30, STAR:30}
  });

  const pidText = U.id("P", S.seq.product++);
  S.products.push({
    id:pidText, name:"美国车载充电器", asin:"B0FFL2X1F3", market:"US", sellerId:sid,
    reviewType:"TEXT", discount:0, remark:""
  });

  const pidFree = U.id("P", S.seq.product++);
  S.products.push({
    id:pidFree, name:"免评示例产品", asin:"B0G81FMNNN", market:"US", sellerId:sid,
    reviewType:"FREE", discount:1.00, remark:"免评产品：建议本佣一起结算"
  });

  S.orders.push({
    id:U.id("O", S.seq.order++),
    orderId:"111-3149968-9279463",
    date:U.today(),
    sellerId:sid,
    productId:pidFree,
    market:"US",
    currency:"USD",
    amount:19.99,
    discount:1.00,
    asin:"B0G81FMNNN",
    note:"免评示例产品",
    reviewReq:"FREE",
    fxOverride:null,
    review:{status:"PENDING", date:"", link:"", note:"", doneType:""},
    principal:{settled:false, batchId:"", fx:0, amountCny:0},
    commission:{settled:false, batchId:"", amountCny:0},
  });

  computeSeq();
  save();
}

/* ===================== Events ===================== */
function gotoPage(n){
  const total = filteredOrders().length;
  const totalPages = Math.max(1, Math.ceil(total / UI.pageSize));
  UI.page = Math.min(Math.max(1, n), totalPages);
  renderOrders();
}


/* ===================== Import / Export (Sellers / Products) ===================== */
/* 设计原则：最小侵入，不改业务核心；只做导入导出与校验。 */

function __dl(filename, content, mime){
  const blob = new Blob([content], {type: mime || "text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
function __escCsv(v){
  if(v===null || v===undefined) return "";
  const s = String(v);
  if(/[",\n\r]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
  return s;
}
function __toCsv(rows, headers){
  const head = headers.map(__escCsv).join(",");
  const body = rows.map(r=> headers.map(h=>__escCsv(r[h])).join(",")).join("\n");
  return head + "\n" + body;
}
function __parseCSV(text){
  // Minimal CSV parser (handles quotes). Returns array of objects.
  const rows = [];
  const lines = String(text||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
  if(!lines.length) return rows;
  const parseLine = (line)=>{
    const out=[]; let cur=""; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(inQ){
        if(ch==='"'){
          if(line[i+1]==='"'){ cur+='"'; i++; }
          else inQ=false;
        }else cur+=ch;
      }else{
        if(ch==='"') inQ=true;
        else if(ch===','){ out.push(cur); cur=""; }
        else cur+=ch;
      }
    }
    out.push(cur);
    return out;
  };
  const header = parseLine(lines[0]).map(x=>String(x||"").trim());
  for(let i=1;i<lines.length;i++){
    const line = lines[i];
    if(!line || !line.trim()) continue;
    const cols = parseLine(line);
    const obj = {};
    header.forEach((h,idx)=> obj[h] = cols[idx]!==undefined ? cols[idx] : "");
    rows.push(obj);
  }
  return rows;
}
function __normKey(k){
  return String(k||"").trim().toLowerCase().replace(/\s+/g,"").replace(/[_\-]/g,"");
}
function __getAny(row, keys){
  if(!row) return "";
  // build normalized lookup once
  const map = {};
  Object.keys(row).forEach(k=> map[__normKey(k)] = row[k]);
  for(const key of keys){
    const v = map[__normKey(key)];
    if(v!==undefined && v!==null && String(v).trim()!=="") return v;
  }
  return "";
}
function __readFileAsText(file){
  // Prefer ArrayBuffer + TextDecoder so we can fallback from UTF-8 to GBK when needed (CSV from Chinese Excel often uses GBK).
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const buf = r.result;
        if(!(buf instanceof ArrayBuffer)){
          res(String(buf||""));
          return;
        }
        const u8 = new Uint8Array(buf);
        const decUtf8 = new TextDecoder("utf-8", {fatal:false});
        let txt = decUtf8.decode(u8);
        // Heuristic: if UTF-8 decoding produces many replacement chars, try GBK.
        const bad = (txt.match(/�/g)||[]).length;
        if(bad>2){
          try{
            const decGbk = new TextDecoder("gbk", {fatal:false});
            const txt2 = decGbk.decode(u8);
            // Use GBK if it reduces replacement chars.
            const bad2 = (txt2.match(/�/g)||[]).length;
            if(bad2 < bad) txt = txt2;
          }catch(e){}
        }
        res(txt);
      }catch(e){
        // fallback
        res("");
      }
    };
    r.onerror = rej;
    r.readAsArrayBuffer(file);
  });
}
function __readFileAsArrayBuffer(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsArrayBuffer(file);
  });
}
async function __parseAnyTableFile(file){
  const name = (file.name||"").toLowerCase();
  if(name.endsWith(".json")){
    const txt = await __readFileAsText(file);
    const data = JSON.parse(txt);
    if(Array.isArray(data)) return data;
    if(data && Array.isArray(data.rows)) return data.rows;
    throw new Error("JSON 格式不正确：需要数组，或 {rows: [...]}");
  }
  if(name.endsWith(".csv")){
    const txt = await __readFileAsText(file);
    return __parseCSV(txt);
  }
  if(name.endsWith(".xlsx")){
    if(!window.XLSX) throw new Error("未加载 XLSX 解析库。请确保网络可访问（CDN）或改用 CSV 导入。");
    const buf = await __readFileAsArrayBuffer(file);
    const wb = XLSX.read(buf, {type:"array"});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    return XLSX.utils.sheet_to_json(ws, {defval:""});
  }
  throw new Error("不支持的文件类型，请选择 .csv / .xlsx / .json");
}

function __reviewTypeFromAny(v){
  const s = String(v||"").trim();
  if(!s) return "TEXT";
  const m = s.toLowerCase();
  // support both internal keys and CN names/raw strings
  if(["text","文字评","文字评价","文字"].includes(s) || m.includes("文字")) return "TEXT";
  if(["image","图片评","图片评价"].includes(s) || m.includes("图片") || m.includes("图文") || m.includes("top图文")) return "IMAGE";
  if(["video","视频评","视频评价"].includes(s) || m.includes("视频") || m.includes("top视频")) return "VIDEO";
  if(["free","免评"].includes(s) || m==="免评") return "FREE";
  if(["free_fb","免评fb","免评feedback"].includes(m) || m.includes("feedback")) return "FREE_FB";
  if(["star","免评点星","免评rating"].includes(m) || m.includes("点星") || m.includes("rating")) return "STAR";
  if(["unable","无法上评"].includes(s) || m.includes("无法上评")) return "UNABLE";
  // if already a key
  if(REVIEW_TYPES.some(t=>t.k===s)) return s;
  return "TEXT";
}

function reviewTypeLabelFromKey(k){
  const rt = REVIEW_TYPES.find(x=>x.key===k);
  return rt ? rt.label : (k||'');
}
function commFromSettleMap(order){
  const k = __reviewTypeFromAny(order.reviewType);
  const map = UI.settle && UI.settle.commMap ? UI.settle.commMap : null;
  if(map && Object.prototype.hasOwnProperty.call(map,k)){
    return num(map[k]);
  }
  return commissionShould(order);
}
function renderSettleCommBar(){
  if(!UI.settle) return;
  const el = $('#settleCommBar');
  if(!el) return;
  const sums = {};
  UI.settle.orderIds.forEach(orderId=>{
    const o = S.orders.find(x=>x.orderId===orderId);
    if(!o) return;
    const k = __reviewTypeFromAny(o.reviewType);
    const cShould = commFromSettleMap(o);
    const cEditable = (UI.settle.mode!=="PRINCIPAL") && !o.commission.settled && canSettleCommission(o);
    const cAuto = cEditable ? cShould : 0;
    const cVal = (UI.settle.edits[orderId].c==null ? cAuto : Math.max(0, num(UI.settle.edits[orderId].c)));
    sums[k] = (sums[k]||0) + cVal;
  });
  const parts = REVIEW_TYPES.map(rt=>{
    const v = sums[rt.key] || 0;
    if(!v) return '';
    return rt.label + ': ' + round2(v);
  }).filter(Boolean);
  el.textContent = parts.length ? ('本次结算佣金汇总：' + parts.join(' | ')) : '本次结算佣金汇总：0';
}
function bindSettleCommUI(){
  if(!UI.settle) return;
  REVIEW_TYPES.forEach(rt=>{
    const inp = $('#settleComm_'+rt.key);
    if(!inp) return;
    inp.value = (UI.settle.commMap && UI.settle.commMap[rt.key]!==undefined) ? UI.settle.commMap[rt.key] : '';
    inp.oninput = ()=>{
      UI.settle.commMap[rt.key] = num(inp.value);
      renderSettleRows();
    };
  });
  const btn = $('#btnSettleSaveDefaults');
  if(btn){
    btn.onclick = ()=>{
      S.settings = S.settings || {};
      S.settings.settleFxDefault = Object.assign({}, UI.settle.fx);
      S.settings.settleCommByType = Object.assign({}, UI.settle.commMap||{});
      save();
      toast('已保存为默认（FX + 佣金）');
    };
  }
}


const IO = {
  exportSellersCSV(){
    const rows = (S.sellers||[]).map(s=>{
      const fx = s.fx||{};
      const cm = s.commission||{};
      return {
        seller_id: s.id||"",
        seller_name: s.name||"",
        contact: s.contact||"",
        remark: s.remark||"",
        fx_usd: fx.US||"",
        fx_gbp: fx.UK||"",
        fx_eur: fx.DE||"",
        fx_cad: fx.CA||"",
        fx_jpy: fx.JP||"",
        commission_text: cm.TEXT??"",
        commission_image: cm.IMAGE??"",
        commission_video: cm.VIDEO??"",
        commission_free: cm.FREE??"",
        commission_freefb: cm.FREE_FB??"",
        commission_star: cm.STAR??"",
        commission_unable: cm.UNABLE??"",
      };
    });
    const headers = Object.keys(rows[0]||{seller_id:"",seller_name:""});
    __dl("sellers.csv", __toCsv(rows, headers), "text/csv;charset=utf-8");
  },
  exportSellersJSON(){
    __dl("sellers.json", JSON.stringify({rows:S.sellers||[]}, null, 2), "application/json;charset=utf-8");
  },
  async importSellers(file){
    const rows = await __parseAnyTableFile(file);
    const errors = [];
    let added=0, updated=0, skipped=0;

    rows.forEach((r, idx)=>{
      const id = String(__getAny(r, ["seller_id","sellerid","卖家id","id"])).trim();
      const name = String(__getAny(r, ["seller_name","sellername","卖家名称","name"])).trim();
      if(!id || !name){ skipped++; return; }

      // FX by currency -> map to markets
      const fx_usd = U.num(__getAny(r, ["fx_usd","FX_USD","usd","fxusd","汇率_usd","fx美元","fxusd原币"]));
      const fx_gbp = U.num(__getAny(r, ["fx_gbp","FX_GBP","gbp","fxgbp","汇率_gbp"]));
      const fx_eur = U.num(__getAny(r, ["fx_eur","FX_EUR","eur","fxeur","汇率_eur"]));
      const fx_cad = U.num(__getAny(r, ["fx_cad","FX_CAD","cad","fxcad","汇率_cad"]));
      const fx_jpy = U.num(__getAny(r, ["fx_jpy","FX_JPY","jpy","fxjpy","汇率_jpy"]));

      const fx = {US:fx_usd||0, UK:fx_gbp||0, DE:fx_eur||0, FR:fx_eur||0, IT:fx_eur||0, ES:fx_eur||0, CA:fx_cad||0, JP:fx_jpy||0};

      const commission = {};
      const cm_text  = U.num(__getAny(r, ["commission_text","佣金_文字评","佣金文字评","文字评佣金","文字佣金"]));
      const cm_image = U.num(__getAny(r, ["commission_image","佣金_图片评","佣金图片评","图片评佣金","图片佣金"]));
      const cm_video = U.num(__getAny(r, ["commission_video","佣金_视频评","佣金视频评","视频评佣金","视频佣金"]));
      const cm_free  = U.num(__getAny(r, ["commission_free","佣金_免评","佣金免评","免评佣金"]));
      const cm_freefb= U.num(__getAny(r, ["commission_freefb","commission_free_fb","佣金_免评fb","免评fb佣金","免评feedback佣金"]));
      const cm_star  = U.num(__getAny(r, ["commission_star","佣金_免评点星","免评点星佣金","免评rating佣金"]));
      const cm_unable= U.num(__getAny(r, ["commission_unable","佣金_无法上评","无法上评佣金"]));

      commission.TEXT = cm_text||0;
      commission.IMAGE = cm_image||0;
      commission.VIDEO = cm_video||0;
      commission.FREE = cm_free||0;
      commission.FREE_FB = cm_freefb||0;
      commission.STAR = cm_star||0;
      commission.UNABLE = cm_unable||0;

      const payload = {
        id, name,
        contact: String(__getAny(r, ["contact","联系人"])).trim(),
        remark: String(__getAny(r, ["remark","备注","note"])).trim(),
        fx, commission
      };

      const i = (S.sellers||[]).findIndex(x=>x.id===id);
      if(i>=0){ S.sellers[i]=payload; updated++; }
      else { (S.sellers||[]).push(payload); added++; }
    });

    save();
    refreshAfterSellerChange();
    alert(`卖家导入完成：新增 ${added}，更新 ${updated}，跳过 ${skipped}。`);
  },

  exportProductsCSV(){
    const rows = (S.products||[]).map(p=>{
      return {
        "产品ID": p.id||"",
        "国家": p.market||"",
        "ASIN": p.asin||"",
        "产品名称": p.name||"",
        "卖家ID": p.sellerId||"",
        "回评类型": U.reviewName(p.reviewType||""),
        "折扣": p.discount??"",
        "买手佣金": p.buyerCommission??"",
        "备注": p.remark||""
      };
    });
    const headers = ["产品ID","国家","ASIN","产品名称","卖家ID","回评类型","折扣","买手佣金","备注"];
    __dl("products.csv", __toCsv(rows, headers), "text/csv;charset=utf-8");
  },
  exportProductsJSON(){
    __dl("products.json", JSON.stringify({rows:S.products||[]}, null, 2), "application/json;charset=utf-8");
  },
  async importProducts(file){
    const rows = await __parseAnyTableFile(file);
    let added=0, skipped=0;

    // 允许 seller_id / market / asin 等为空（后续你可在列表里编辑补齐）
    // 但要求至少有产品名称，否则没有意义。
    const parsed = [];
    const dupLines = [];

    const normStr = (v)=> String(v??"").trim();
    const normAsin = (v)=>{
      const s = normStr(v).toUpperCase();
      if(!s || s==="NAN" || s==="NONE") return "";
      return s;
    };
    const normMarket = (v)=>{
      const s = normStr(v).toUpperCase();
      // 不强制限制；若不在 8 国内则留空（避免被跳过）
      if(!s) return "";
      if(!FX_MARKETS.includes(s)) return "";
      return s;
    };

    // 预扫：构造 payload + 检测重复（同 sellerId + 同 name + 同 asin）
    rows.forEach((r, idx)=>{
      const name = normStr(__getAny(r, ["name","产品名称","产品标题","title","标题","产品"]));
      if(!name){ skipped++; return; }

      const market = normMarket(__getAny(r, ["market","国家","Market","国家代码"]));
      const asin = normAsin(__getAny(r, ["asin","ASIN"]));
      const sellerId = normStr(__getAny(r, ["seller_id","sellerid","卖家id","卖家ID","卖家Id","seller","卖家"])) || "";

      const reviewType = __reviewTypeFromAny(__getAny(r, ["review_type","reviewtype","回评类型","留评需求","review_type_raw"]));
      const discount = U.num(__getAny(r, ["discount","卖家折扣","折扣"]));
      const buyerCommission = U.num(__getAny(r, ["buyer_commission","buyercommission","买手佣金","佣金"]));
      const remark = normStr(__getAny(r, ["remark","备注","note","关键词","keyword"])) || "";

      const payload = {
        id: U.id("P", S.seq.product++),
        name,
        asin,
        market,
        sellerId,
        reviewType,
        discount: isNaN(discount)?0:discount,
        buyerCommission: isNaN(buyerCommission)?0:buyerCommission,
        remark
      };

      // 重复检测：只做提醒，不做限制
      const isDup = (S.products||[]).some(p=>{
        return String(p.sellerId||"")===String(payload.sellerId||"")
          && String(p.name||"")===String(payload.name||"")
          && String(p.asin||"")===String(payload.asin||"");
      });

      if(isDup){
        dupLines.push(`第${idx+2}行：${payload.sellerId||"(空)"} | ${payload.name} | ${payload.asin||"(空)"}`);
      }

      parsed.push({payload, isDup, line: idx+2});
    });

    // 若存在重复，弹出确认：是否仍要添加这些重复行？
    let allowDup = true;
    if(dupLines.length){
      const preview = dupLines.slice(0,10).join("\n") + (dupLines.length>10 ? `
...（共 ${dupLines.length} 条）` : "");
      allowDup = confirm(`检测到产品列表里存在重复项（同卖家+同产品名+同ASIN）。

示例：
${preview}

是否仍确认添加这些重复产品？
（点“取消”将跳过这些重复行，仅导入非重复行）`);
    }

    parsed.forEach(item=>{
      if(item.isDup && !allowDup){ skipped++; return; }
      (S.products||[]).push(item.payload);
      added++;
    });

    save();
    refreshAfterProductChange();
    alert(`产品导入完成：新增 ${added}，跳过 ${skipped}。` + (dupLines.length? `

重复提醒：检测到 ${dupLines.length} 条重复（已按你的选择处理）。`:""));
  }
};

function bind(){
  document.querySelectorAll("[data-tab]").forEach(btn=>{
    btn.onclick = ()=>{ UI.tab = btn.dataset.tab; renderTabs();
      // 切换到返款页时强制刷新一次（避免回评更新后返款列表不同步）
      if(UI.tab==="payout"){ try{ markDirty(["payout"]); }catch(e){} try{ scheduleRender(); }catch(e){} }
    };
  });

  $("btnExport").onclick = ()=> U.download("ops_export_"+VERSION+".json", JSON.stringify(S,null,2), "application/json");
  $("btnImport").onclick = ()=> $("importFile").click();
  $("importFile").onchange = async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    try{
      const obj = JSON.parse(await f.text());
      S = normalizeImported(obj);
      computeSeq();
      save();
      UI.selected.clear();
      UI.page = 1;
      alert("导入成功");
      renderAll();
    }catch(err){
      alert("导入失败："+err.message);
    }finally{
      e.target.value="";
    }
  };

  $("btnLoadSample").onclick = ()=>{
    if(!confirm("加载示例数据会覆盖当前数据，确定？")) return;
    seedSample();
    UI.selected.clear();
    UI.page = 1;
    renderAll();
  };

  $("btnReset").onclick = ()=>{
    if(!confirm("确定清空所有数据？")) return;
    clearMainState().finally(()=>{
      S = blankState();
      save();
      UI.selected.clear();
      UI.page = 1;
      Actions.cancelSellerEdit();
      Actions.cancelProductEdit();
      Actions.cancelOrderEdit();
      renderAll();
      alert("已清空。");
    });
  };


$("btnHardReset").onclick = async ()=>{
  const ok1 = confirm("【彻底重置】将删除本页面所在域名/路径下的所有 IndexedDB 数据库，并清空 localStorage / sessionStorage。\n\n这会导致：\n- 订单/卖家/产品/批次数据全部清空\n- 草稿箱/云端设置等也会清空\n\n确定继续？");
  // (message moved to single-line string)
  // (message moved to single-line string)
  // (message moved to single-line string)
  // (message moved to single-line string)
  // (message moved to single-line string)
  // (message moved to single-line string)
  if(!ok1) return;
  const ok2 = confirm("最后确认一次：真的要从零开始（不可恢复）？");
  if(!ok2) return;

  const delDB = (name)=>new Promise((resolve)=>{
    try{
      const req = indexedDB.deleteDatabase(name);
      req.onsuccess = ()=>resolve({name, ok:true});
      req.onerror = ()=>resolve({name, ok:false, err:String(req.error||"delete error")});
      req.onblocked = ()=>resolve({name, ok:false, err:"blocked"});
    }catch(e){ resolve({name, ok:false, err:String(e)}); }
  });

  let names = [];
  try{
    if(indexedDB.databases){
      const dbs = await indexedDB.databases();
      names = (dbs||[]).map(d=>d && d.name).filter(Boolean);
    }
  }catch(e){ /* ignore */ }

  if(!names.length){
    // fallback：已知历史库名（账号系统/旧版本/草稿等）
    names = [
      "acc_act_db_v1","act_acc_v199",
      "act_account_sys_v1","act_account_sys_v3","act_account_sys_v4","act_account_sys_v5",
      "activity_account_system_db","activity_accounts_v1",
      "front_user_db_v1",
      "ops_rebuild_v6_4_2_db","ops_v642_main","ops_v642_settle_drafts","ops_v6_drafts_db"
    ];
  }

  // 先尝试关闭本系统可能打开的连接：不保证一定成功，但能降低 blocked
  try{ await clearMainState(); }catch(e){}

  const results = [];
  for(const n of Array.from(new Set(names))){
    results.push(await delDB(n));
  }

  try{ localStorage.clear(); }catch(e){}
  try{ sessionStorage.clear(); }catch(e){}

  const failed = results.filter(r=>!r.ok);
  if(failed.length){
    alert("彻底重置完成（部分库可能被占用未删除）：\n\n失败项：\n" + failed.map(f=>`${f.name}: ${f.err}`).join("\n") + "\n\n请关闭同域名下的其它标签页后刷新再点一次。");
  }else{
    alert("彻底重置完成：已清空所有本地数据。页面将刷新。");
  }
  location.reload();
};


  // seller
  $("btnSaveSeller").onclick = Actions.saveSeller;
  $("btnCancelSellerEdit").onclick = Actions.cancelSellerEdit;
  $("sellerSearch").oninput = ()=>{ UI.sellerPage=1; renderSellers(); };

  // product
  $("btnSaveProduct").onclick = Actions.saveProduct;
  $("btnCancelProductEdit").onclick = Actions.cancelProductEdit;
  $("productSearch").oninput = ()=>{ UI.productPage=1; renderProducts(); };

  // sellers pager
  $("sellerPrev").onclick = ()=>{ UI.sellerPage = Math.max(1, UI.sellerPage-1); renderSellers(); };
  $("sellerNext").onclick = ()=>{ UI.sellerPage = UI.sellerPage+1; renderSellers(); };
  if($("sellerPrevTop")) $("sellerPrevTop").onclick = $("sellerPrev").onclick;
  if($("sellerNextTop")) $("sellerNextTop").onclick = $("sellerNext").onclick;

  // products pager
  $("productPrev").onclick = ()=>{ UI.productPage = Math.max(1, UI.productPage-1); renderProducts(); };
  $("productNext").onclick = ()=>{ UI.productPage = UI.productPage+1; renderProducts(); };
  if($("productPrevTop")) $("productPrevTop").onclick = $("productPrev").onclick;
  if($("productNextTop")) $("productNextTop").onclick = $("productNext").onclick;

  $("productSeller").onchange = updateProductPreview;

  // sellers import/export
  $("btnExportSellersCsv").onclick = ()=>IO.exportSellersCSV();
  $("btnExportSellersJson").onclick = ()=>IO.exportSellersJSON();
  $("btnImportSellers").onclick = ()=>$("fileImportSellers").click();
  $("fileImportSellers").onchange = async (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    ev.target.value = "";
    if(!f) return;
    try{ await IO.importSellers(f); }
    catch(e){ alert("导入失败：" + (e?.message || e)); }
  };

  // products import/export
  $("btnExportProductsCsv").onclick = ()=>IO.exportProductsCSV();
  $("btnExportProductsJson").onclick = ()=>IO.exportProductsJSON();
  $("btnImportProducts").onclick = ()=>$("fileImportProducts").click();
  $("fileImportProducts").onchange = async (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    ev.target.value = "";
    if(!f) return;
    try{ await IO.importProducts(f); }
    catch(e){ alert("导入失败：" + (e?.message || e)); }
  };

  // order entry
  $("orderProduct").onchange = ()=>{ applyProductToOrder(); };
  $("orderMarket").onchange = ()=> $("orderCurrency").value = U.marketToCurrency($("orderMarket").value);
  $("btnSaveOrder").onclick = Actions.saveOrder;
  $("btnCancelOrderEdit").onclick = Actions.cancelOrderEdit;

  // batch parse
  $("btnBatchPreview").onclick = ()=>{ try{ batchHandle(false); }catch(e){ showNotice("脚本错误", (e&&e.message)?e.message:String(e)); } };
  $("btnBatchParse").onclick = ()=>{ try{ batchHandle(true); }catch(e){ showNotice("脚本错误", (e&&e.message)?e.message:String(e)); } };

  // filters
  ["filterSeller","filterPrincipal","filterCommission"].forEach(id=> $(id).onchange = ()=>{ UI.page=1; renderOrders(); });
  // 订单号/产品/ASIN 搜索（输入前 19 位自动勾选：做节流与范围缩小，避免大数据量卡顿）
  $("filterSearch").oninput = debounce((e)=>{
    const v = (e.target.value||"").slice(0,19);
    if(e.target.value!==v) e.target.value=v;
    const q = v.trim();
    // 只有当输入足够长时才做“自动勾选”，并且只在当前筛选范围内扫描
    if(q && q.length>=6){
      const list = filteredOrders();
      for(const o of list){
        if((o.orderId||"").startsWith(q)) UI.selected.add(o.orderId);
      }
      renderSelectedTags();
    }
    UI.page=1;
    renderOrders();
  }, 220);

  // 返款页：搜索（订单号/产品/ASIN）
  // 需求：输入/粘贴时立即只保留前 19 位（如 111-2222222-333333），并在当前返款筛选范围内自动勾选匹配订单。
  (async function(){

  // --- Cloud config bootstrap (Plan A) ---
  (function bootstrapCloudCfg(){
    try{
      const CFG_KEYS = ['OPS_CLOUD_CFG_V1','OPS_CLOUD_CFG','OPS_CLOUD_SUPABASE_CFG','OPS_SYNC_SUPABASE_CFG','SUPABASE_CLOUD_CFG_V1'];
      const URL_KEYS = ['OPS_CLOUD_URL','SUPABASE_URL','NEXT_PUBLIC_SUPABASE_URL','SUPABASE_PROJECT_URL'];
      const ANON_KEYS = ['OPS_CLOUD_ANON_KEY','OPS_CLOUD_ANON','SUPABASE_ANON_KEY','NEXT_PUBLIC_SUPABASE_ANON_KEY','SUPABASE_KEY','SUPABASE_ANON'];
      const APP_KEYS  = ['OPS_CLOUD_APPKEY','OPS_CLOUD_APP_KEY','OPS_APP_KEY','APP_KEY','OPS_SYNC_APPKEY','OPS_SYNC_APP_KEY'];
      const TABLE_KEYS = ['OPS_CLOUD_TABLE','OPS_SYNC_TABLE'];
      const CANON_KEYS = ['OPS_CLOUD_CANONICAL','OPS_SYNC_CANONICAL','OPS_CANONICAL'];
      const COL_KEYS   = ['OPS_CLOUD_COLUMN','OPS_SYNC_COLUMN','OPS_CLOUD_PAYLOAD_COLUMN'];

      function firstNonEmpty(keys){
        for(const k of keys){
          const v = (localStorage.getItem(k)||'').trim();
          if(v) return v;
        }
        return '';
      }
      function parseCfg(raw){
        if(!raw) return null;
        try{
          const o = JSON.parse(raw);
          if(!o || typeof o!=='object') return null;
          return o;
        }catch(_e){ return null; }
      }
      // 1) try read any existing cfg JSON
      let found = null;
      for(const k of CFG_KEYS){
        const o = parseCfg(localStorage.getItem(k));
        if(o && (o.url||o.supabase_url) && (o.anon||o.anon_key||o.key) && (o.app_key||o.appKey||o.app)){
          found = {k, o};
          break;
        }
      }

      const url  = (found && (found.o.url||found.o.supabase_url)) || firstNonEmpty(URL_KEYS);
      const anon = (found && (found.o.anon||found.o.anon_key||found.o.key)) || firstNonEmpty(ANON_KEYS);
      const appKey = (found && (found.o.app_key||found.o.appKey||found.o.app)) || firstNonEmpty(APP_KEYS) || 'dalemy';

      const table = (found && (found.o.table||found.o.table_name)) || firstNonEmpty(TABLE_KEYS) || 'ops_cloud_snapshots_v1';
      const canonical = (found && (found.o.canonical||found.o.snapshot_key)) || firstNonEmpty(CANON_KEYS) || 'ops_rebuild_v6_4_2_state';
      const column = (found && (found.o.column||found.o.payload_column)) || firstNonEmpty(COL_KEYS) || 'payload';

      if(url && anon && appKey){
        const normalized = {
          v: 1,
          url,
          anon,
          app_key: appKey,
          table,
          canonical,
          column,
          saved_at: new Date().toISOString(),
          source: found ? ('migrated:'+found.k) : 'bootstrap'
        };
        // write to all known keys so read-path always finds it
        for(const k of CFG_KEYS){
          localStorage.setItem(k, JSON.stringify(normalized));
        }
        // also persist the components for any legacy readers
        localStorage.setItem('OPS_CLOUD_URL', url);
        localStorage.setItem('OPS_CLOUD_ANON_KEY', anon);
        localStorage.setItem('OPS_CLOUD_APPKEY', appKey);
        localStorage.setItem('OPS_CLOUD_TABLE', table);
        localStorage.setItem('OPS_CLOUD_CANONICAL', canonical);
        localStorage.setItem('OPS_CLOUD_COLUMN', column);
      }
    }catch(_e){}
  })();


    const el = $("payoutSearch");
    if(!el) return;
    const run = debounce((q)=>{
      if(q && q.length>=6){
        const list = payoutFilteredOrders();
        for(const o of list){
          const oid = (o.orderId||"");
          if(oid.startsWith(q)) UI.payoutSelected.add(o.id);
        }
      }
      renderPayout(); // 仅刷新返款区域
    }, 220);

    el.addEventListener("input", (e)=>{
      let v = (el.value || "");
      // 兼容粘贴“订单号+其它文字”的情况：优先提取首个订单号格式；否则截断前 19 位
      const m = v.match(/\b\d{3}-\d{7}-\d{7}\b/);
      if(m) v = m[0];
      if(v.length > 19) v = v.slice(0,19);
      if(el.value !== v) el.value = v;
      run(v.trim());
    });
  })();



  $("btnResetFilters").onclick = ()=>{
    $("filterSeller").value="ALL";
    $("filterPrincipal").value="ALL";
    $("filterCommission").value="ALL";
    $("filterSearch").value="";
    $("pasteSelectBox").value="";
    $("pasteSelectHint").textContent="";
    $("pasteLinkBox").value="";
    $("pasteLinkHint").textContent="";
    UI.selected.clear();
    UI.page=1;
    renderOrders();
  };

  // paste select
  $("btnParseSelect").onclick = async ()=>{
    const btn = $("btnParseSelect");
    const raw = ($("pasteSelectBox").value||"").trim();
    const ids = U.extractOrderIds(raw);
    if(!ids.length){ $("pasteSelectHint").textContent="未识别到订单号"; return; }

    btn.disabled = true;
    const startTs = performance.now();
    const idx = getOrderIdIndex();

    let hit=0;
    const added = [];
    const total = ids.length;
    let i=0;

    $("pasteSelectHint").textContent = `解析中… 0/${total}`;

    const chunk = ()=>{
      const end = Math.min(i+300, total); // chunk size
      for(; i<end; i++){
        const oid = ids[i];
        const o = idx.get(oid);
        if(o){
          if(!UI.selected.has(oid)){
            UI.selected.add(oid);
            added.push(oid);
          }
          hit++;
        }
      }
      if(i < total){
        if((i % 600) === 0) $("pasteSelectHint").textContent = `解析中… ${i}/${total}`;
        requestAnimationFrame(chunk);
      }else{
        // DOM updates in one batch
        appendSelectedTagsBatch(added);
        syncVisibleCheckboxesBatch(added, true);
        updateSelectionUI();

        const ms = Math.round(performance.now() - startTs);
        $("pasteSelectHint").textContent = `识别 ${total} 个，命中 ${hit} 个（新增勾选 ${added.length} 个），耗时 ${ms}ms`;
        btn.disabled = false;
      }
    };
    requestAnimationFrame(chunk);
  };
  $("btnClearSelected").onclick = ()=>{
    // perf: clear without full re-render
    const prev = Array.from(UI.selected);
    UI.selected.clear();
    $("selectedTags").innerHTML = "";
    // uncheck only visible rows
    prev.forEach(oid=> updateOrderCheckbox(oid, false));
    updateSelectionUI();
  };

  // link product by paste
  $("btnLinkProduct").onclick = linkProductByPaste;
  $("btnBatchReviewDone").onclick = batchMarkReviewDone;

  // check all
  $("chkAll").onchange = (e)=>{
    const checked = e.target.checked;
    // 只全选“当前页”订单（避免一键全选所有页）
    const list = filteredOrders().slice().sort((a,b)=>{
      const ta=(a.createdAt||0), tb=(b.createdAt||0);
      if(tb!==ta) return tb-ta;
      const na = Number(String(a.id||'').replace(/\D+/g,''))||0;
      const nb = Number(String(b.id||'').replace(/\D+/g,''))||0;
      return nb-na;
    });
    const total = list.length;
    const pageSize = Number($("pageSize").value || 100);
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    UI.page = Math.min(Math.max(1, UI.page), totalPages);
    const start = (UI.page-1)*pageSize;
    const pageList = list.slice(start, start+pageSize);

    pageList.forEach(o=>{
      if(checked) UI.selected.add(o.orderId);
      else UI.selected.delete(o.orderId);
    });
    renderOrders();
  };

  // settlement buttons
  $("btnSettlePrincipal").onclick = ()=> openSettle("PRINCIPAL");
  $("btnSettleCommission").onclick = ()=> openSettle("COMMISSION");
  $("btnSettleBoth").onclick = ()=> openSettle("BOTH");

  // settlement modal
  $("btnCloseSettle").onclick = closeSettle;
  $("btnSaveSettleEdits").onclick = ()=> applySettleAmountEditsToOrders(true);

  // settle meta toggle (batch info + FX)
  const toggleMeta = ()=>{
    const meta = $("settleMeta");
    const btn = $("btnToggleSettleMeta");
    if(!meta || !btn) return;
    const isOpen = meta.style.display !== "none";
    meta.style.display = isOpen ? "none" : "block";
    btn.textContent = isOpen ? "展开" : "隐藏";
  };
  if($("btnToggleSettleMeta")) $("btnToggleSettleMeta").onclick = toggleMeta;

  $("btnCancelSettle").onclick = closeSettle;
  $("btnConfirmSettle").onclick = confirmSettle;
  $("btnExportSettleCsv").onclick = exportCurrentSettleCsv;
  ["fx_usd","fx_eur","fx_gbp","fx_cad","fx_jpy"].forEach(id=>{
    $(id).addEventListener("input", syncSettleFxFromInputs);
  });

  // review modal
  $("btnCloseReview").onclick = Actions.closeReview;
  $("btnCancelReview").onclick = Actions.closeReview;
  $("btnSaveReview").onclick = Actions.saveReview;

  // export orders csv
  $("btnExportOrdersCsv").onclick = exportOrdersCsv;

  // pagination
  $("pageSize").onchange = ()=>{ UI.page=1; renderOrders(); };
  $("btnPrevPage").onclick = ()=> gotoPage(UI.page-1);
  $("btnNextPage").onclick = ()=> gotoPage(UI.page+1);
  $("btnGoto").onclick = ()=>{
    const n = Number(($("gotoPage").value||"").trim());
    if(!n) return;
    gotoPage(n);
  };

  // focus select all for fast paste
  ["filterSearch","pasteSelectBox","pasteLinkBox"].forEach(id=>{
    const el = $(id); if(!el) return;
    el.addEventListener("focus", ()=>{ try{ el.select(); }catch(e){} });
  });
  // 新增：返款模块绑定
  try{ bindPayout(); }catch(e){ console.warn('bindPayout failed', e); }
}


/* ===================== Render All ===================== */
function renderAll(){
  renderSelects();
  renderSellerGrids();
  if(!$("orderDate").value) $("orderDate").value = U.today();
  if(!$("batchDate").value) $("batchDate").value = U.today();
  renderKPI();
  renderSellers();
  renderProducts();
  renderOrders();
  renderBatches();
  renderPayout();
  updateProductPreview();
}

/* ===================== Render Scheduler (perf) ===================== 
   目标：大数据量（产品/订单）场景下，避免任何“小操作”触发全站 renderAll()。
   仅对“需要刷新”的模块做增量渲染，显著降低点击回评/保存等操作的卡顿。 */
const __R = {
  scheduled:false,
  dirty:{
    full:true,   // 首屏/导入后用全渲染
    selects:false, sellerGrids:false, kpi:false,
    sellers:false, products:false, orders:false,
    batches:false, payout:false,
    productPreview:false
  }
};
function markDirty(keys){
  (keys||[]).forEach(k=>{
    if(k==="full") __R.dirty.full = true;
    else if(__R.dirty.hasOwnProperty(k)) __R.dirty[k]=true;
  });
}
function scheduleRender(){
  if(__R.scheduled) return;
  __R.scheduled = true;
  requestAnimationFrame(()=>{
    __R.scheduled = false;
    flushRender();
  });
}
function flushRender(){
  const d = __R.dirty;
  if(d.full){
    // 全量刷新：重置所有 dirty，并执行原 renderAll()
    __R.dirty = {full:false,selects:false,sellerGrids:false,kpi:false,sellers:false,products:false,orders:false,batches:false,payout:false,productPreview:false};
    renderAll();
    return;
  }
  // 仅渲染必要模块（注意顺序：selects -> grids -> lists -> derived views）
  if(d.selects){ d.selects=false; renderSelects(); }
  if(d.sellerGrids){ d.sellerGrids=false; renderSellerGrids(); }
  if(d.kpi){ d.kpi=false; renderKPI(); }
  if(d.sellers){ d.sellers=false; renderSellers(); }
  if(d.products){ d.products=false; renderProducts(); }
  if(d.orders){ d.orders=false; renderOrders(); }
  if(d.batches){ d.batches=false; renderBatches(); }
  if(d.payout){ d.payout=false; renderPayout(); }
  if(d.productPreview){ d.productPreview=false; updateProductPreview(); }
}
function refreshAfterReviewChange(){
  // 回评影响：订单列表显示、KPI、返款列表、结算可用性（通过订单状态间接影响）
  // 返款列表要求“最新更新置顶”，因此每次回评变更后将返款页重置到第1页，确保用户立刻看到最新订单
  try{ UI.payoutPage = 1; }catch(e){}
  markDirty(["orders","kpi","payout"]);
  scheduleRender();
}
function refreshAfterOrderChange(){
  markDirty(["orders","kpi","batches","payout"]);
  scheduleRender();
}
function refreshAfterProductChange(){
  // 产品变更会影响：产品列表、下单联动选择项、订单列表展示、预览
  markDirty(["selects","products","orders","kpi","productPreview"]);
  scheduleRender();
}
function refreshAfterSellerChange(){
  // 卖家变更会影响：卖家列表、产品卖家下拉、订单列表展示、KPI
  markDirty(["selects","sellerGrids","sellers","products","orders","kpi"]);
  scheduleRender();
}
/* ===================== End Render Scheduler ===================== */



/* ===================== Payout Module (新增返款模块，不影响原有功能) ===================== */
function ensurePayoutSettings(){
  if(!S.settings || typeof S.settings!=="object") S.settings = {};
  if(!S.settings.payoutFxDefault) S.settings.payoutFxDefault = {usd:0,eur:0,gbp:0,cad:0,jpy:0};
  if(!("payoutCommDefault" in S.settings)) S.settings.payoutCommDefault = null;
  if(!Array.isArray(S.payoutBatches)) S.payoutBatches = [];
  if(!S.seq) S.seq = {seller:1,product:1,order:1,batch:1,payoutBatch:1};
  if(!("payoutBatch" in S.seq)) S.seq.payoutBatch = 1;
}


function payoutFxFor(currency, market){
  const c = String(currency||"").trim().toUpperCase();
  const fxObj = (S.settings && S.settings.payoutFxDefault) ? S.settings.payoutFxDefault : null;
  const pick = (k)=> fxObj && fxObj[k]!=null ? U.num(fxObj[k]) : 0;
  if(c==="USD") return pick("usd") || 0;
  if(c==="EUR") return pick("eur") || 0;
  if(c==="GBP") return pick("gbp") || 0;
  if(c==="CAD") return pick("cad") || 0;
  if(c==="JPY") return pick("jpy") || 0;
  // fallback by market if currency missing
  const m = String(market||"").trim().toUpperCase();
  if(m==="US") return pick("usd") || 0;
  if(m==="DE"||m==="FR"||m==="IT"||m==="ES") return pick("eur") || 0;
  if(m==="UK") return pick("gbp") || 0;
  if(m==="CA") return pick("cad") || 0;
  if(m==="JP") return pick("jpy") || 0;
  return 0;
}

function fxKeyByCurrency(cur){
  cur = String(cur||"").toUpperCase();
  if(cur==="USD") return "usd";
  if(cur==="EUR") return "eur";
  if(cur==="GBP") return "gbp";
  if(cur==="CAD") return "cad";
  if(cur==="JPY") return "jpy";
  return null;
}
function getFxForOrder(order, fxObj){
  const k = fxKeyByCurrency(order.currency);
  if(k && fxObj && fxObj[k]) return U.num(fxObj[k]);
  // fallback：用卖家 FX（原币→CNY）
  const seller = U.sellerById(order.sellerId);
  if(seller && seller.fx && order.market && seller.fx[order.market]) return U.num(seller.fx[order.market]);
  return 0;
}


// ===== Payout helpers (missing in some merged versions) =====
function getBatchFxMapForOrder(order){
  // 若批量返款弹窗已打开，优先使用弹窗内 FX（仅影响本批次预览/计算）
  try{
    const modal = $("payoutModal");
    if(modal && modal.style && modal.style.display && modal.style.display !== "none"){
      if(typeof payoutModalGetFxObj === "function") return payoutModalGetFxObj();
    }
  }catch(e){/* ignore */}
  // 否则使用返款默认 FX
  const fx = (S.settings && S.settings.payoutFxDefault) ? S.settings.payoutFxDefault : {};
  return {
    usd: U.num(fx.usd),
    eur: U.num(fx.eur),
    gbp: U.num(fx.gbp),
    cad: U.num(fx.cad),
    jpy: U.num(fx.jpy),
  };
}

function calcPrincipalCNY(order, fxObj){
  if(!order) return 0;
  const amount = U.num(order.amount ?? order.amountOrig ?? order.amount_original ?? order.amount_fc ?? 0);
  const discount = U.num(order.discount ?? order.discountOrig ?? order.discount_original ?? 0);
  const buyerComm = U.num((order.buyerCommission!=null?order.buyerCommission:order.buyerFee) ?? order.buyer_commission ?? 0);
  const principalOrig = (amount - discount + buyerComm);
  const fxv = getFxForOrder(Object.assign({}, order, {amount, discount, buyerCommission: buyerComm}), fxObj || getBatchFxMapForOrder(order));
  return principalOrig * (isFinite(fxv) ? fxv : 0);
}

function getCommissionCNY(order){
  try{
    const dt = order?.review?.doneType || order?.review_done_type || "";
    if(dt === "UNABLE" || dt === "无法上评") return 0;
  }catch(e){}

  // 返款的“佣金(CNY)”：优先用订单/批次编辑后的值，其次用默认设置 payoutCommDefault，
  // 若默认留空则按卖家回评类型佣金（commissionShould）回退。
  try{
    if(!order) return 0;
    const p = order.payout || order.payout_info || null;
    // 订单级别覆盖（批量弹窗写回时可能写在 payout 里）
    const override = (p && (p.commission_settle_cny ?? p.commissionSettleCny ?? p.commission_cny ?? p.commissionCny)) 
                     ?? (order.commission_settle_cny ?? order.commissionSettleCny ?? order.commission_cny ?? order.commissionCny);
    if(override!=null && override!=="" && !isNaN(Number(override))) return U.num(override);
    // 全局默认
    if(S && S.settings && S.settings.payoutCommDefault!=null && S.settings.payoutCommDefault!==""){
      return U.num(S.settings.payoutCommDefault);
    }
    // 回退：卖家回评类型佣金（CNY）
    return U.num(commissionShould(order));
  }catch(e){
    return 0;
  }
}

// ============================================================

function payoutSellerName2(o){
  if(!o) return "";
  const direct = o.sellerName || o.seller || o.seller_name || "";
  const s = o.sellerId ? U.sellerById(o.sellerId) : null;
  return (s && (s.name||s.sellerName)) || direct || (o.sellerId||"");
}
function payoutProductName(order){
  if(!order) return "";
  // 1) 订单自身可能已有字段（不同版本字段名兼容）
  const direct = order.productName || order.product_title || order.productTitle || order.product_name || order.itemName || order.title || order.name || "";
  // 2) productId 反查
  const p = order.productId ? U.productById(order.productId) : null;
  const name = (p && (p.name||p.productName||p.title||p.product_title)) || direct || "";
  return name;
}
function payoutReviewType(order){
  // 优先订单回评要求(reviewReq)，其次产品回评类型
  if(order?.reviewReq) return String(order.reviewReq);
  const p = order && order.productId ? U.productById(order.productId) : null;
  return (p && p.reviewType) ? String(p.reviewType) : "";
}
function normReviewStatus(order){
  // 兼容历史字段/中文状态，统一映射到：DONE / PENDING / WAIVED
  const raw0 =
    (order && order.review && order.review.status) ??
    order?.reviewStatus ??
    order?.review_status ??
    order?.review_state ??
    order?.review_done ??
    order?.review;
  const raw = (raw0==null ? "" : String(raw0)).trim();
  const up = raw.toUpperCase();

  // 英文/代码态
  if(up==="DONE" || up==="FINISHED" || up==="COMPLETE" || up==="COMPLETED") return "DONE";
  if(up==="PENDING") return "PENDING";
  if(up==="WAIVED") return "WAIVED";

  // 中文态（兼容你历史数据里常见写法）
  if(raw==="完成" || raw==="已上评" || raw==="已回评" || raw==="已留评" || raw==="已评价") return "DONE";
  if(raw==="待上评" || raw==="未上评" || raw==="未回评" || raw==="未评价") return "PENDING";
  if(raw==="免评" || raw==="无需上评" || raw==="无法上评" || raw.startsWith("免")) return "WAIVED";

  // 兜底：尽量不让未知值把订单“吞掉”
  return up || raw || "PENDING";
}

function getPayoutStatus(order){
  // 统一返款状态为内部码：payout_pending / paid / refunded / not_ready
  const raw =
    order?.payout?.status ??
    order?.payout_status ??
    order?.payoutStatus ??
    order?.payout_state ??
    "";
  const st = String(raw||"").trim();

  // 1) 已是内部码：paid 需做一次证据校验，避免误标导致“待打款”被吞
  if(st==="payout_pending" || st==="refunded" || st==="not_ready") return st;
  if(st==="paid"){
    const p = order && order.payout ? order.payout : {};
    const hasEvidence = !!(
      p.batch_id || p.batchId || p.payoutBatchId ||
      p.paid_at || p.paidAt ||
      p.screenshot || p.payout_screenshot ||
      order?.payout_batch_id || order?.payout_batch ||
      order?.payout_proof || order?.payoutScreenshot
    );
    if(hasEvidence) return "paid";
    // 没证据：若回评完成则降级为待打款，否则 not_ready
    const rs0 = normReviewStatus(order);
    return (rs0==="DONE") ? "payout_pending" : "not_ready";
  }

  // 2) 兼容历史中文/近似表达
  if(st){
    const s = st.replace(/\s+/g,"");
    if(["已回评待打款","待打款","待返款","未返款","待付款","待打款中","已回评待返款"].includes(s)) return "payout_pending";
    if(["已返款","已打款","已付款","已发款","已支付"].includes(s)) return "paid";
    if(["已退款","已退还","退款","已退回"].includes(s)) return "refunded";
    return st; // 未知：透传
  }

  // 3) 未记录：仅当回评= DONE 才进入“待打款”
  const rs = normReviewStatus(order);
  return (rs==="DONE") ? "payout_pending" : "not_ready";
}

function setPayoutStatus(order, status){
  if(!order.payout) order.payout = {};
  // 标记为“买手返款”命名空间，避免与其它模块字段冲突
  order.payout._ns = "buyer";
  order.payout.status = status;
}

function readPayoutCfgInputs(){
  return {
    usd: U.num($("payoutFxUsd")?.value),
    gbp: U.num($("payoutFxGbp")?.value),
    eur: U.num($("payoutFxEur")?.value),
    cad: U.num($("payoutFxCad")?.value),
    jpy: U.num($("payoutFxJpy")?.value),
    commDefault: ($("payoutCommDefault")?.value==="" ? null : U.num($("payoutCommDefault")?.value)),
  };
}
function applyPayoutCfgToInputs(){
  ensurePayoutSettings();
  const fx = S.settings.payoutFxDefault || {usd:0,eur:0,gbp:0,cad:0,jpy:0};
  if($("payoutFxUsd")) $("payoutFxUsd").value = fx.usd || "";
  if($("payoutFxGbp")) $("payoutFxGbp").value = fx.gbp || "";
  if($("payoutFxEur")) $("payoutFxEur").value = fx.eur || "";
  if($("payoutFxCad")) $("payoutFxCad").value = fx.cad || "";
  if($("payoutFxJpy")) $("payoutFxJpy").value = fx.jpy || "";
  if($("payoutCommDefault")) $("payoutCommDefault").value = (S.settings.payoutCommDefault==null ? "" : S.settings.payoutCommDefault);
}

function payoutFilteredOrders(){
  UI.__cache = UI.__cache || {};
  const q = (($("payoutSearch")?.value)||"").trim().toLowerCase();
  const seller = ($("payoutSellerFilter")?.value)||"";
  const st = ($("payoutStatusFilter")?.value)||"";
  const mk = ($("payoutMarketFilter")?.value)||"";
  const rev = (S && S.__rev) ? S.__rev : 0;
  const sig = ["payout", rev, q, seller, st, mk].join("|");
  if(UI.__cache.payoutSig === sig && Array.isArray(UI.__cache.payoutArr)) return UI.__cache.payoutArr;

  const sellerById = getSellerById();
  const productById = getProductById();
  let list = (S.orders||[]).filter(o=>{
    // 关键修复：历史数据里“已回评/完成/已上评”等中文状态，也应视为 DONE
    const rs = normReviewStatus(o);
    if(rs!=="DONE") return false;

    if(seller && o.sellerId!==seller) return false;
    if(mk && o.market!==mk) return false;

    const ps = getPayoutStatus(o);
    if(st && ps!==st) return false;

    if(q){
      const p = o.productId ? U.productById(o.productId) : null;
      const hay = [
        o.orderId||"", o.asin||"", p?.name||"", o.note||""
      ].join("\n").toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  // 默认：待打款置顶
  list.sort((a,b)=>{
    const sa = getPayoutStatus(a)==="payout_pending" ? 0 : 1;
    const sb = getPayoutStatus(b)==="payout_pending" ? 0 : 1;
    if(sa!==sb) return sa-sb;
    return ((b.updatedAt||b.createdAt||0) - (a.updatedAt||a.createdAt||0));
  });

  UI.__cache.payoutSig = sig;
  UI.__cache.payoutArr = list;
  return list;
}

function renderPayout(){
  // 没有返款 DOM 时直接跳过（避免影响原页面）
  if(!$("tab-payout") || !$("payoutRows")) return;

  ensurePayoutSettings();

  // seller options (keep in sync with search box)
  if($('payoutSellerSearch') && $('payoutSellerFilter')){ try{ applySellerFilter(); }catch(e){} }


  applyPayoutCfgToInputs();

  const all = payoutFilteredOrders();
  const ps = UI.payoutPageSize || 100;
  const totalPages = Math.max(1, Math.ceil(all.length/ps));
  if(UI.payoutPage>totalPages) UI.payoutPage = totalPages;
  const start = (UI.payoutPage-1)*ps;
  const pageList = all.slice(start, start+ps);

  const rows = pageList.map(o=>{
    const checked = UI.payoutSelected.has(o.id) ? "checked" : "";
    const ps = getPayoutStatus(o);
    const psText = ps==="paid" ? "已返款" : (ps==="payout_pending" ? "已回评待打款" : "未满足条件");
    const commCny = getCommissionCNY(o);
    return `<tr>
      <td><input type="checkbox" data-payout-sel="${U.esc(o.id)}" ${checked}/></td>
      <td class="mono"><span class="copy-order" data-copy="${U.esc(o.orderId||"")}">${U.esc(o.orderId||"")}</span></td>
      <td>${U.esc(payoutProductName(o))}</td>
      <td>${U.esc(payoutReviewType(o))}</td>
      <td>${U.esc(o.market||"")}</td>
      <td>${U.esc(o.currency||"")}</td>
      <td class="mono">${U.num(o.amount).toFixed(2)}</td>
      <td class="mono">${U.num(o.discount).toFixed(2)}</td>
      <td class="mono">${commCny.toFixed(2)}</td>
      <td>${psText}</td>
      <td>${U.esc(o.review?.status||"")}</td>
      <td>${ps==="payout_pending" ? `<button type="button" class="btn sm" data-payout-view="${U.esc(o.id)}" data-payout-view="${o.id}">查看</button>` : `<button type="button" class="btn sm" data-payout-one="${U.esc(o.id)}" data-payout-single="${o.id}">单笔返款</button>`}</td>
    </tr>`;
  }).join("\n");

  $("payoutRows").innerHTML = rows || `<tr><td colspan="99" class="muted">无符合条件的订单</td></tr>`;

  // bind row selection
  document.querySelectorAll('[data-payout-sel]').forEach(cb=>{
    cb.onchange = ()=>{
      const id = cb.getAttribute("data-payout-sel");
      if(cb.checked) UI.payoutSelected.add(id); else UI.payoutSelected.delete(id);
      renderPayoutSelHint();
    };
  });

  // payout row actions are handled via event delegation (bindPayout)

  if($("payoutPageInfo")) $("payoutPageInfo").textContent = `第 ${UI.payoutPage}/${totalPages} 页，合计 ${all.length} 单`;
  renderPayoutSelHint();
  renderPayoutBatches();
}


function buildPayoutSelectedTagEl(oid, label){
  const t = document.createElement("span");
  t.className = "tag";
  t.dataset.oid = oid;
  const text = (label==null ? oid : label);
  t.innerHTML = `<span class="mono">${esc(String(text))}</span><span class="x">×</span>`;
  t.title = "点击取消选择";
  t.onclick = ()=>{ payoutToggleSelect(oid); };
  return t;
}
function payoutToggleSelect(oid){
  if(!UI.payoutSelected) UI.payoutSelected = new Set();
  const has = UI.payoutSelected.has(oid);
  if(has) UI.payoutSelected.delete(oid); else UI.payoutSelected.add(oid);
  try{
    const el = document.querySelector(`input[type="checkbox"][data-payout-sel="${oid}"]`);
    if(el) el.checked = !has;
  }catch(e){}
  renderPayoutSelHint();
}
function payoutGetOrderIndex(){
  const orders = Array.isArray(S.orders) ? S.orders : [];
  // 仅用 length 做轻量缓存键；本系统大多数变更会改变 orders 引用/长度，足够用于 tag 展示。
  if(!UI._orderIndex || UI._orderIndexLen !== orders.length){
    const map = new Map();
    for(const o of orders){
      if(o && o.id!=null) map.set(String(o.id), o);
    }
    UI._orderIndex = map;
    UI._orderIndexLen = orders.length;
  }
  return UI._orderIndex;
}
function payoutGetOrderNoById(oid){
  const map = payoutGetOrderIndex();
  const o = map && map.get(String(oid));
  if(!o) return "";
  return String(o.orderId || o.order_no || o.orderNo || o.order_id || "").trim();
}

function renderPayoutSelectedTags(){
  const box = $("payoutSelectedTags");
  if(!box) return;
  const ids = UI.payoutSelected ? Array.from(UI.payoutSelected) : [];

  // 显示为“订单号（111-xxxx-xxxxxxx）”，而不是内部 id/序号
  const items = ids.map(oid=>{
    const orderNo = payoutGetOrderNoById(oid);
    return { oid:String(oid), label: (orderNo || String(oid)) };
  });

  // 保持稳定顺序：按“显示的订单号”排序（不依赖表格排序）
  items.sort((a,b)=> a.label.localeCompare(b.label, "zh-Hans-CN", {numeric:true}));

  const CAP = 120; // 避免一次渲染几千个 tag 卡顿
  const show = items.slice(0, CAP);
  box.innerHTML = "";
  for(const it of show){
    box.appendChild(buildPayoutSelectedTagEl(it.oid, it.label));
  }
  if(items.length > CAP){
    const more = document.createElement("span");
    more.className = "muted";
    more.style.marginLeft = "6px";
    more.textContent = `… 还有 ${items.length - CAP} 单已勾选未显示`;
    box.appendChild(more);
  }
}
function renderPayoutSelHint(){
  const n = UI.payoutSelected ? UI.payoutSelected.size : 0;
  const el = $("payoutSelectedHint");
  if(el) el.textContent = n ? ("已选择 " + n + " 单") : "已选择 0 单";
  renderPayoutSelectedTags(); // 同步显示已勾选订单号（带上限）
}


function renderPayoutBatches(){
  if(!$("payoutBatchRows")) return;
  let list = Array.isArray(S.payoutBatches) ? S.payoutBatches.slice() : [];
  const q = String(UI.payoutBatchQuery||"").trim();
  if(q){ list = list.filter(b=>String(b?.id||"").includes(q)); }
  // 新的排在前
  list.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));

  const ps = UI.payoutBatchPageSize || 10;
  const totalPages = Math.max(1, Math.ceil(list.length/ps));
  if(UI.payoutBatchPage>totalPages) UI.payoutBatchPage = totalPages;
  if(UI.payoutBatchPage<1) UI.payoutBatchPage = 1;

  const start = (UI.payoutBatchPage-1)*ps;
  const pageList = list.slice(start, start+ps);

  const rows = pageList.map(b=>{
    const ids = (b.orderIds||[]);
    const cnt = ids.length;
    const total = U.num(b.totalCny).toFixed(2);
    return `<tr>
      <td class="mono">${U.esc(b.id||"")}</td>
      <td class="mono">${U.esc(b.date||"")}</td>
      <td>${U.esc(b.method||"")}</td>
      <td class="mono">${cnt}</td>
      <td class="mono">${total}</td>
      <td>
        <button class="btn sm" data-payout-detail="${U.esc(b.id)}">明细</button>
        <button class="btn sm" data-payout-copy="${U.esc(b.id)}">复制ID</button>
        <button class="btn sm" data-payout-export="${U.esc(b.id)}">导出CSV</button>
        <button class="btn sm danger" data-payout-del="${U.esc(b.id)}">删除回滚</button>
      </td>
    </tr>`;
  }).join("\n");

  $("payoutBatchRows").innerHTML = rows || `<tr><td colspan="6" class="muted">暂无返款批次</td></tr>`;

  if($("payoutBatchPageInfo")) $("payoutBatchPageInfo").textContent = `第 ${UI.payoutBatchPage}/${totalPages} 页（共 ${list.length} 条）`;

  document.querySelectorAll("[data-payout-export]").forEach(btn=>{
    btn.onclick = ()=> exportPayoutBatchCSV(btn.getAttribute("data-payout-export"));
  });
  document.querySelectorAll("[data-payout-del]").forEach(btn=>{
    btn.onclick = ()=> deletePayoutBatch(btn.getAttribute("data-payout-del"));
  });
  document.querySelectorAll("[data-payout-detail]").forEach(btn=>{
    btn.onclick = ()=> openPayoutBatchDetail(btn.getAttribute("data-payout-detail"));
  });
  document.querySelectorAll("[data-payout-copy]").forEach(btn=>{
    btn.onclick = ()=> copyText(btn.getAttribute("data-payout-copy")||"");
  });


  if($("payoutBatchPrev")) $("payoutBatchPrev").disabled = (UI.payoutBatchPage<=1);
  if($("payoutBatchNext")) $("payoutBatchNext").disabled = (UI.payoutBatchPage>=totalPages);
}



function copyText(txt){
  const s = String(txt||"");
  if(!s){ return; }
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(s).then(()=>toast?.ok?toast.ok("已复制"):alert("已复制")).catch(()=>prompt("复制批次ID：", s));
    }else{
      prompt("复制批次ID：", s);
    }
  }catch(e){
    prompt("复制批次ID：", s);
  }
}

function openPayoutBatchDetail(batchId){
  try{
    const id = String(batchId||"");
    const list = Array.isArray(S.payoutBatches) ? S.payoutBatches : [];
    const b = list.find(x=>String(x.id)===id);
    if(!b){ alert("未找到该返款批次"); return; }

    // 构建明细行
    let lines = Array.isArray(b.lines) ? b.lines : [];
    if(!lines.length && Array.isArray(b.orderIds)){
      const map = new Map((Array.isArray(S.orders)?S.orders:[]).map(o=>[String(o.id), o]));
      lines = b.orderIds.map(oid=>{
        const o = map.get(String(oid));
        if(!o) return null;
        // 尽量沿用弹窗明细口径字段
        const orderNo = (U.orderNo?U.orderNo(o):(o.orderNo||o.order_no||o.orderId||o.order_id||""));
        return {
          order_id: String(o.id),
          order_no: orderNo,
          product_name: o.productName||o.product_name||"",
          asin: o.asin||"",
          seller: o.sellerName||o.seller||"",
          market: o.market||o.country||"",
          currency: o.currency||"",
          amount: U.num(o.amount||o.amount_orig||0),
          discount: U.num(o.discount||o.discount_orig||0),
          buyer_commission_orig: U.num(o.buyerCommissionOrig||o.buyer_commission_orig||o.buyerCommission||0),
          fx: U.num(o.fx||o.batchFx||o.fxUsed||1),
          principal_cny: U.num(o.principalCny||o.principal_cny||0),
          commission_cny: U.num(o.commissionCny||o.commission_cny||0),
          total_cny: U.num(o.totalCny||o.total_cny||0),
        };
      }).filter(Boolean);
    }

    // meta
    const meta = `批次ID：${b.id||""} ｜ 日期：${b.date||""} ｜ 方式：${b.method||""}${b.note?(" ｜ 备注："+b.note):""}`;
    if($("payoutBatchDetailMeta")) $("payoutBatchDetailMeta").textContent = meta;

    // totals
    const principal = U.num(b.principalCny || b.principal_cny || 0);
    const comm = U.num(b.commissionCny || b.commission_cny || 0);
    const total = U.num(b.totalCny || b.total_cny || 0);
    if($("payoutBatchDetailPrincipal")) $("payoutBatchDetailPrincipal").textContent = principal.toFixed(2);
    if($("payoutBatchDetailCommission")) $("payoutBatchDetailCommission").textContent = comm.toFixed(2);
    if($("payoutBatchDetailTotal")) $("payoutBatchDetailTotal").textContent = total.toFixed(2);

    // rows
    const rows = lines.map(l=>{
      const principal2 = U.num(l.principal_cny);
      const comm2 = U.num(l.commission_cny);
      const total2 = U.num(l.total_cny);
      return `<tr>
        <td class="mono">${U.esc(l.order_no||l.orderNo||"")}</td>
        <td>${U.esc(l.product_name||l.productName||"")}</td>
        <td class="mono">${U.esc(l.asin||"")}</td>
        <td>${U.esc(l.seller||"")}</td>
        <td class="mono">${U.esc(l.market||"")}</td>
        <td class="mono">${U.esc(l.currency||"")}</td>
        <td class="mono right">${U.num(l.amount).toFixed(2)}</td>
        <td class="mono right">${U.num(l.discount).toFixed(2)}</td>
        <td class="mono right">${U.num(l.buyer_commission_orig).toFixed(2)}</td>
        <td class="mono right">${U.num(l.fx).toString()}</td>
        <td class="mono right">${principal2.toFixed(2)}</td>
        <td class="mono right">${comm2.toFixed(2)}</td>
        <td class="mono right">${total2.toFixed(2)}</td>
      </tr>`;
    }).join("\n") || `<tr><td colspan="99" class="muted">无明细</td></tr>`;
    if($("payoutBatchDetailRows")) $("payoutBatchDetailRows").innerHTML = rows;

    if($("payoutBatchDetailModal")) $("payoutBatchDetailModal").style.display = "";
  }catch(e){
    console.error(e);
    alert("打开批次明细失败：" + (e&&e.message?e.message:e));
  }
}

function closePayoutBatchDetail(){
  if($("payoutBatchDetailModal")) $("payoutBatchDetailModal").style.display = "none";
}


function exportPayoutBatchCSV(batchId){
  try{
    const id = String(batchId||"");
    const list = Array.isArray(S.payoutBatches) ? S.payoutBatches : [];
    const b = list.find(x=>String(x.id)===id);
    if(!b){ alert("未找到该返款批次"); return; }

    const lines = Array.isArray(b.lines) ? b.lines : [];
    // 兼容：若没有 lines，则尝试从 orderIds 现查
    let useLines = lines;
    if(!useLines.length && Array.isArray(b.orderIds)){
      const map = new Map((Array.isArray(S.orders)?S.orders:[]).map(o=>[String(o.id), o]));
      useLines = b.orderIds.map(oid=>{
        const o = map.get(String(oid));
        if(!o) return null;
        return {
          order_id: String(o.id),
          order_no: U.orderNo?U.orderNo(o):(o.orderId||o.order_no||o.orderNo||o.order_id||""),
          product_name: o.productName||o.product_name||"",
          asin: o.asin||"",
          seller: o.sellerName||o.seller||o.seller_name||"",
          market: o.market||o.country||"",
          currency: o.currency||"",
          amount: U.num(o.amount),
          discount: U.num(o.discount),
          buyer_commission_orig: U.num(o.buyerCommission||o.buyer_commission||0),
          fx: U.num(o.fx||1),
          principal_cny: U.num(o.principalCny||0),
          commission_cny: U.num(o.commissionCny||0),
          total_cny: U.num(o.totalCny||0)
        };
      }).filter(Boolean);
    }

    const headers = [
      "批次ID","结算日期","方式","备注",
      "订单号","产品名","ASIN","卖家","Market","币种",
      "金额(原币)","折扣(原币)","买手佣金(原币)","FX",
      "本金(CNY)","佣金(CNY)","本佣(CNY)"
    ];

    const rows = useLines.map(l=>{
      const total = U.num(l.total_cny);
      const principal = U.num(l.principal_cny);
      const comm = U.num(l.commission_cny);
      return [
        b.id||"", b.date||"", b.method||"", b.note||"",
        l.order_no||l.orderNo||l.order_id||"",
        l.product_name||l.productName||"",
        l.asin||"",
        l.seller||"",
        l.market||"",
        l.currency||"",
        U.num(l.amount).toFixed(2),
        U.num(l.discount).toFixed(2),
        U.num(l.buyer_commission_orig).toFixed(2),
        U.num(l.fx).toString(),
        principal.toFixed(2),
        comm.toFixed(2),
        total.toFixed(2)
      ].map(U.csvEscape);
    });

    const csv = [headers.map(U.csvEscape).join(","), ...rows.map(r=>r.join(","))].join("\n");
    U.download(`payout_batch_${String(b.id||"batch").replace(/[\\/:*?"<>|]+/g,"_")}_${U.today()}.csv`, csv, "text/csv");
  }catch(e){
    console.error(e);
    alert("导出失败：" + (e&&e.message?e.message:e));
  }
}

function deletePayoutBatch(batchId){
  try{
    const id = String(batchId||"");
    const list = Array.isArray(S.payoutBatches) ? S.payoutBatches : [];
    const idx = list.findIndex(x=>String(x.id)===id);
    if(idx<0){ alert("未找到该返款批次"); return; }
    const b = list[idx];
    const ok = confirm(`确定删除并回滚该返款批次？\n批次：${b.id||""}\n订单数：${(b.orderIds||[]).length}`);
    if(!ok) return;

    // rollback orders payout status
    const orders = Array.isArray(S.orders)?S.orders:[];
    const map = new Map(orders.map(o=>[String(o.id), o]));
    const ids = Array.isArray(b.orderIds)?b.orderIds:[];
    ids.forEach(oid=>{
      const o = map.get(String(oid));
      if(!o) return;
      // 清除返款记录（兼容字段）
      if(o.payout && typeof o.payout==="object"){
        o.payout.status = "payout_pending";
        delete o.payout.batch_id;
        delete o.payout.paid_at;
        delete o.payout.principal_cny;
        delete o.payout.commission_cny;
        delete o.payout.total_cny;
        delete o.payout.fx_used;
      }
      o.payout_status = "payout_pending";
      o.payoutBatchId = "";
      o.payout_batch_id = "";
      o.payoutPaidAt = "";
      o.payout_paid_at = "";
      // 若系统用“返款状态”中文字段，也一并回滚
      if(o.payoutStatusName) o.payoutStatusName = "已回评待打款";
    });

    // remove batch
    list.splice(idx,1);
    S.payoutBatches = list;

    save();
    if(typeof persistPayoutSnapshot==="function") persistPayoutSnapshot();
    renderPayout();
    renderPayoutBatches();
  }catch(e){
    console.error(e);
    alert("删除回滚失败：" + (e&&e.message?e.message:e));
  }
}

function payoutSelectPageAll(){
  // 性能优化：全选本页不再触发 renderPayout() + 全量过滤（10k+订单会卡）
  // 直接基于当前页 DOM 勾选，并写入内存选中集合
  if(!UI.payoutSelected) UI.payoutSelected = new Set();
  const boxWrap = $("payoutRows");
  if(!boxWrap){ return; }
  // 暂停 change 事件带来的额外刷新
  UI._payoutBulkSelecting = true;
  const boxes = boxWrap.querySelectorAll('input[type="checkbox"][data-payout-sel]');
  boxes.forEach(b=>{
    const id = String(b.getAttribute("data-payout-sel")||"");
    if(id){ UI.payoutSelected.add(id); b.checked = true; }
  });
  UI._payoutBulkSelecting = false;
  renderPayoutSelHint();
}

function payoutResetView(){
  // 恢复默认页面：筛选与搜索回到初始值，清空选择与粘贴框
  if($("payoutSellerFilter")) $("payoutSellerFilter").value = "";
  if($("payoutStatusFilter")) $("payoutStatusFilter").value = "payout_pending";
  if($("payoutMarketFilter")) $("payoutMarketFilter").value = "";
  if($("payoutSearch")) $("payoutSearch").value = "";
  if($("payoutPasteBox")) $("payoutPasteBox").value = "";
  UI.payoutSelected.clear();
  UI.payoutPage = 1;
  renderPayout();
}
function payoutClearSelection(){
  if(!UI.payoutSelected) UI.payoutSelected = new Set();
  UI.payoutSelected.clear();
  // 直接清空当前页勾选，不触发全量重渲染
  const boxWrap = $("payoutRows");
  if(boxWrap){
    UI._payoutBulkSelecting = true;
    boxWrap.querySelectorAll('input[type="checkbox"][data-payout-sel]').forEach(b=>{ b.checked = false; });
    UI._payoutBulkSelecting = false;
  }
  renderPayoutSelHint();
}

function payoutParseAndSelect(){
  const raw = ($("payoutPaste") && $("payoutPaste").value) ? $("payoutPaste").value : "";
  const orderNos = U.extractOrderIds(raw); // 订单号形如 111-2222222-3333333
  if(!orderNos.length){
    if($("payoutPasteHint")) $("payoutPasteHint").textContent = "未识别到订单号";
    return;
  }

  let hit = 0;
  const newly = [];

  // 构建索引：orderNo -> [orderId,...] + id -> order（一次 O(n)，避免 O(ids*n) 爆炸）
  const idx = new Map();
  const byId = new Map();
  (S.orders||[]).forEach(o=>{
    const ono = String(o?.orderNo || o?.order_no || o?.order_id || o?.orderId || "").trim();
    if(!ono) return;
    byId.set(String(o.id), o);
    const arr = idx.get(ono);
    if(arr) arr.push(String(o.id));
    else idx.set(ono, [String(o.id)]);
  });

  orderNos.forEach(ono=>{
    const ids = idx.get(ono);
    if(!ids || !ids.length) return;
    ids.forEach(id=>{
      const o = byId.get(String(id));
      if(!o) return;
      // 仅勾选“已回评待打款”的订单（与列表一致）
      if(normReviewStatus(o)==="DONE" && getPayoutStatus(o)==="payout_pending"){
        const sid = String(o.id);
        if(!UI.payoutSelected.has(sid)){
          UI.payoutSelected.add(sid);
          newly.push(sid);
        }
        hit++;
      }
    });
  });

  // 仅同步当前可见行的 checkbox（不触发全量渲染）
  if($("payoutRows") && newly.length){
    const esc = (window.CSS && CSS.escape) ? CSS.escape : (s)=>String(s).replace(/["\\]/g,"\\$&");
    newly.forEach(id=>{
      const el = $("payoutRows").querySelector(`input[type="checkbox"][data-payout-sel="${esc(id)}"]`);
      if(el) el.checked = true;
    });
  }

  if($("payoutPasteHint")) $("payoutPasteHint").textContent = `识别 ${orderNos.length} 个订单号，命中可返款 ${hit} 个`;
  renderPayoutSelHint();
}

function payoutParseMarkDone(){
  // 解析粘贴框中的订单号（支持整行文本），将命中的订单快速标记为已回评 DONE
  // 仅影响本地数据（S.orders），不会触碰其它模块结构
  const box = $("payoutPaste");
  const raw = box ? (box.value||"") : "";
  const ids = U.extractOrderIds(raw);
  if(!ids.length){
    alert("未识别到订单号（请粘贴包含 111-2222222-3333333 的文本，每行一个或混合文本）。");
    return;
  }
  let changed = 0;
  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth()+1).padStart(2,'0');
  const d = String(today.getDate()).padStart(2,'0');
  const doneDate = `${y}/${m}/${d}`;
  (S.orders||[]).forEach(o=>{
    const oid = String(o?.id||"");
    const ono = String(o?.orderNo||o?.order_no||o?.order_id||"");
    if(ids.includes(oid) || (ono && ids.includes(ono))){
      // 兼容旧结构：review/status/doneType
      if(!o.review) o.review = {};
      o.review.status = "DONE";
      // doneType 若已存在则保留，否则给一个默认“自动”
      if(!o.review.doneType) o.review.doneType = "自动";
      if(!o.review.doneDate) o.review.doneDate = doneDate;
      changed++;
    }
  });
  if(changed===0){
    alert(`识别 ${ids.length} 个订单号，但未命中任何订单。`);
    return;
  }
  // 持久化（复用系统已有保存）
  try{ saveState(); }catch(e){}
  alert(`已标记 DONE：${changed} 单`);
  // 性能：避免全量重渲染
  renderOrders();
  renderPayout();
}


function openPayoutModal(){
  ensurePayoutSettings();

  // 先立即打开弹窗，避免在准备阶段阻塞导致“无弹窗/页面无响应”
  if($("payoutModal")) $("payoutModal").style.display = "flex";
  if($("payoutModalConfirm")) $("payoutModalConfirm").disabled = true;
  if($("payoutModalExport")) $("payoutModalExport").disabled = true;

  if($("payoutModalRows")) {
    $("payoutModalRows").innerHTML =
      `<tr><td colspan="99" style="padding:14px 10px">正在准备返款批次，请稍候…</td></tr>`;
  }

  // 将“快照已选ID + 准备筛选”放到下一帧，保证弹窗先渲染出来
  setTimeout(()=>{
    const ids = Array.from(UI.payoutSelected||[]).map(String);
    // fallback: if UI has no selection (e.g. after parse/select or large list), read checked boxes from DOM
    if(!ids.length){
      const domIds = Array.from(document.querySelectorAll('#payoutTable tbody input[data-payout-sel]:checked'))
        .map(el=>String(el.getAttribute('data-payout-sel')||'')).filter(Boolean);
      domIds.forEach(x=>ids.push(x));
      UI.payoutSelected = new Set(ids);
      renderPayoutSelHint();
    }
    if($("payoutModalRows")) {
      $("payoutModalRows").innerHTML =
        `<tr><td colspan="99" style="padding:14px 10px">正在准备返款批次，请稍候…（已选 ${ids.length} 单）</td></tr>`;
    }
    preparePayoutModal(ids);
  }, 0);
}


function closePayoutModal(){
  try{
    // hide modal
    if($("payoutModal")) $("payoutModal").style.display = "none";
    // reset modal state (keep object to avoid undefined access)
    if(typeof state!=="undefined"){
      state._payoutModal = state._payoutModal || {};
      state._payoutModal.rows = [];
      state._payoutModal.page = 1;
      state._payoutModal.pageSize = state._payoutModal.pageSize || 20;
      state._payoutModal.pass = false;
      state._payoutModal.issues = [];
    }
    // reset UI pieces
    if($("payoutModalRows")) $("payoutModalRows").innerHTML = "";
    if($("payoutPrecheckSummary")) $("payoutPrecheckSummary").textContent = "";
    if($("payoutPrecheckList")) $("payoutPrecheckList").innerHTML = "";
    if($("payoutModalConfirm")) $("payoutModalConfirm").disabled = true;
    if($("payoutModalExport")) $("payoutModalExport").disabled = true;
  }catch(e){
    console.error(e);
  }
}


// 返款可选规则（兼容旧字段/新字段）
// 目标：回评= DONE 且 返款未完成（仍处于待返款/已回评待打款）
// 注意：历史版本可能存在 camelCase / snake_case / Name 字段并存。
function isPayoutEligible(o){
  // 唯一可信口径：回评状态 DONE 且 返款状态 = payout_pending
  // 说明：本项目订单结构为 o.review.status 与 o.payout.status（可能为空/中文/旧字段）
  const rs = normReviewStatus(o);
  if(rs!=="DONE") return false;

  const ps = getPayoutStatus(o);
  if(ps!=="payout_pending") return false;

  // 二次兜底：若存在任何“已返款证据”，即使 status 写错，也不允许再次返款
  const p = o && o.payout ? o.payout : {};
  const hasEvidence = !!(
    p.batch_id || p.batchId || p.payoutBatchId ||
    p.paid_at || p.paidAt ||
    p.screenshot || p.payout_screenshot ||
    o?.payout_batch_id || o?.payout_batch ||
    o?.payout_proof || o?.payoutScreenshot
  );
  if(hasEvidence) return false;

  return true;
}


function buildOrderIndex(){
  const ver = String((S.orders||[]).length) + "|" + String(S._lastSaveTs||"");
  if(UI._orderIndex && UI._orderIndexVer === ver) return UI._orderIndex;
  const map = new Map();
  (S.orders||[]).forEach(o=>{ if(o && o.id!=null) map.set(String(o.id), o); });
  UI._orderIndex = map;
  UI._orderIndexVer = ver;
  return map;
}

function preparePayoutModal(ids){
  try{
    // 预填批次字段（轻量）
    const now = new Date();
    const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
    if($("payoutBatchDate")) $("payoutBatchDate").value = `${y}-${m}-${d}`;
    if($("payoutBatchId") && !$("payoutBatchId").value){
      $("payoutBatchId").value = `PB${y}${m}${d}-${String(S.seq.payoutBatch||1).padStart(3,'0')}`;
    }

    const fxDefault = Object.assign({}, S.settings.payoutFxDefault);
    if($("payoutBatchFxUsd")) $("payoutBatchFxUsd").value = fxDefault.usd || "";
    if($("payoutBatchFxEur")) $("payoutBatchFxEur").value = fxDefault.eur || "";
    if($("payoutBatchFxGbp")) $("payoutBatchFxGbp").value = fxDefault.gbp || "";
    if($("payoutBatchFxCad")) $("payoutBatchFxCad").value = fxDefault.cad || "";
    if($("payoutBatchFxJpy")) $("payoutBatchFxJpy").value = fxDefault.jpy || "";

    // 返款筛选：扫描 orders，用 Set 命中筛选
    const sel = new Set((ids||[]).map(String));
    const eligible = [];
    const orders = (S.orders||[]);
    for(let k=0;k<orders.length;k++){
      const o = orders[k];
      if(!o) continue;
      const oid = String(o.id||"");
      if(!oid) continue;
      if(!sel.has(oid)) continue;
      if(normReviewStatus(o)==="DONE" && getPayoutStatus(o)==="payout_pending"){
        eligible.push(o);
      }
    }

    // 建立弹窗主状态：大批量也要显示数据（分页+快速模式）
    const fastMode = (eligible.length > 200);
    state._payoutModal = {
      orders: eligible,
      page: 1,
      pageSize: fastMode ? 80 : 150,
      fastMode: fastMode
    };

    // 绑定按钮（确保永远可用）
    if($("payoutModalCancel")) $("payoutModalCancel").onclick = ()=> closePayoutModal();
    if($("payoutModalExport")) $("payoutModalExport").onclick = ()=> payoutModalExportCsv && payoutModalExportCsv();
    if($("payoutModalConfirm")) $("payoutModalConfirm").onclick = ()=> confirmPayoutModal();

    payoutModalBindPagerOnce();
    payoutModalRenderPage(1);

  }catch(e){
    console.error(e);
    alert("打开返款弹窗失败：" + (e && e.message ? e.message : String(e)));
  }
}
function openPayoutModalLegacy(){
  try{
    // 1) 读取勾选
    var ids = Array.from(state.payoutSelected || []);
    if(!ids.length){ alert('请先勾选要返款的订单'); return; }

    // 2) 过滤出“可返款”的订单（回评= DONE 且 返款状态!=已返款/已退还）
    var eligible = [];
    for(var i=0;i<ids.length;i++){
      var o = state.ordersById[ids[i]];
      if(!o) continue;
      var rs = String(o.review_status||o.reviewStatus||'').toUpperCase();
      if(rs!=='DONE') continue;
      var ps = String(o.payout_status||o.payoutStatus||o.payout_state||'').toLowerCase();
      // 允许：payout_pending / 待返款 / 已回评待打款 等（归一化由其它逻辑处理）
      if(ps==='paid' || ps==='payout_paid' || ps==='已返款' || ps==='refunded' || ps==='已退还') continue;
      eligible.push(o);
    }
    if(!eligible.length){ alert('所选订单均不符合返款条件（需要回评= DONE 且未返款）。'); return; }

    // 3) 初始化弹窗状态（避免一次性渲染上千行导致卡死）
    state._payoutModal = {
      ids: eligible.map(function(x){return x.id;}),
      orders: eligible,
      overrides: {},       // {orderId: {amount,discount,buyer_commission_orig,commission_pay_cny}}
      page: 1,
      pageSize: 100,
      fastMode: eligible.length > 300
    };

    // 4) 先秒开弹窗，再异步（无 async/await）渲染当页
    var info = document.getElementById('payoutModalInfo');
    if(info) info.textContent = '已选择 ' + eligible.length + ' 单。正在准备返款窗口...';
    var rows = document.getElementById('payoutModalRows');
    if(rows) rows.innerHTML = '<tr><td colspan="10" class="muted">正在准备数据，请稍候...</td></tr>';

    showModal('payoutModal');

    // 5) 绑定分页按钮（只绑定一次）
    payoutModalBindPagerOnce();

    // 6) 渲染第 1 页
    setTimeout(async function(){ payoutModalRenderPage(1); }, 0);
  }catch(e){
    console.error(e);
    alert('打开返款弹窗失败：' + (e && e.message ? e.message : e));
  }
}

/** 返款弹窗：仅渲染当前页（默认 100 行），避免大批量卡顿 */
function payoutModalRenderPage(page){
  var pm = state._payoutModal;
  if(!pm) return;

  var total = pm.orders.length;
  var ps = pm.pageSize || 150;
  var maxPage = Math.max(1, Math.ceil(total / ps));
  pm.page = Math.min(Math.max(1, page||1), maxPage);

  var start = (pm.page - 1) * ps;
  var end = Math.min(total, start + ps);
  var slice = pm.orders.slice(start, end);

  // 顶部信息 & 分页
  var tip = pm.fastMode ? '（快速模式：只渲染当前页以避免卡顿；确认返款仍包含全部 ' + total + ' 单）' : '';
  var info = document.getElementById('payoutModalInfo');
  if(info) info.textContent = '已选择 ' + total + ' 单。当前显示第 ' + pm.page + '/' + maxPage + ' 页 ' + tip;

  var rowsEl = document.getElementById('payoutModalRows');
  if(!rowsEl) return;

  // 读取本批次 FX + 默认佣金
  var fx = payoutModalReadBatchFx ? payoutModalReadBatchFx() : {};
  var commDefault = (S.settings && S.settings.payoutCommDefault!=null) ? U.num(S.settings.payoutCommDefault) : null;

  // 逐行渲染（字段对齐你原来的返款弹窗）
  var html = '';
  for(var i=0;i<slice.length;i++){
    var o = slice[i];
    if(!o) continue;

    var amount = U.num(o.amount);
    var discount = U.num(o.discount);
    var buyerCommOrig = U.num(o.buyerCommission); if(!isFinite(buyerCommOrig)) buyerCommOrig = 0;

    var principalOrig = amount - discount + buyerCommOrig;
    var fxv = getFxForOrder(o, fx);
    var principalCny = principalOrig * fxv;

    var commCny = (commDefault!=null) ? commDefault : commissionShould(o);
    var principalPay = principalCny;
    var commPay = commCny;

    var prodFull = payoutProductName(o) || (o.productName||o.product_title||o.title||o.product||"");
    var sellerFull = payoutSellerName2(o);
    var prodShort = (String(prodFull||'').slice(0,4) || '-');
    var sellerShort = (String(sellerFull||'').slice(0,4) || '-');
    var reviewFull = payoutReviewType(o) || ((o.review && (o.review.type||o.review.reviewType)) || o.reviewType || o.review_type || "");
    var reviewShort = String(reviewFull||"").slice(0,4);

    var ordNo = (o.orderNo||o.orderId||o.order_no||o.order_id||"");

    html += '<tr data-payout-row="'+U.esc(o.id)+'">';
    html += '<td class="mono copyable" data-copy="'+U.esc(ordNo)+'">'+U.esc(ordNo)+'</td>';
    html += '<td class="clip clip4l" title="'+U.esc(prodFull)+'">'+U.esc(prodShort)+'</td>';
    html += '<td class="clip clip4l" title="'+U.esc(sellerFull)+'">'+U.esc(sellerShort)+'</td>';
    html += '<td class="mono clip4" title="'+U.esc(reviewFull)+'">'+U.esc(reviewShort)+'</td>';
    html += '<td class="mono">'+U.esc(o.market||o.country||"")+'</td>';

    html += '<td><input data-f="amount" type="number" step="0.01" value="'+amount.toFixed(2)+'"/></td>';
    html += '<td><input data-f="discount" type="number" step="0.01" value="'+discount.toFixed(2)+'"/></td>';
    html += '<td><input data-f="buyerCommOrig" type="number" step="0.01" value="'+buyerCommOrig.toFixed(2)+'"/></td>';

    html += '<td class="mono" data-v="fx">'+(fxv.toFixed(6).replace(/0+$/,"").replace(/\.$/,""))+'</td>';
    html += '<td><input data-f="principalPay" type="number" step="0.01" value="'+principalPay.toFixed(2)+'"/></td>';
    html += '<td><input data-f="commPay" type="number" step="0.01" value="'+commPay.toFixed(2)+'"/><input type="hidden" data-f="commCny" value="'+commCny.toFixed(2)+'"/></td>';

    html += '<td class="payout-sticky-right mono" data-v="rowTotal">= '+fmtMoney(principalPay + commPay, 2)+'</td>';
    html += '<td class="col-hide mono" data-v="principalOrig">'+principalOrig.toFixed(2)+'</td>';
    html += '<td class="col-hide mono" data-v="principalCny">'+principalCny.toFixed(2)+'</td>';
    html += '</tr>';
  }
  rowsEl.innerHTML = html || '<tr><td colspan="99" style="padding:14px 10px">没有可显示的数据。</td></tr>';

  // 行内输入变更：自动重算 + 预检
  document.querySelectorAll("#payoutModalRows input").forEach(function(inp){
    inp.oninput = function(){
      payoutModalRecalcTotal();
      payoutModalRunPrecheck();
    };
  });

  // FX 输入：变更后重渲染当页（FX/本金/合计联动）
  ["payoutBatchFxUsd","payoutBatchFxEur","payoutBatchFxGbp","payoutBatchFxCad","payoutBatchFxJpy"].forEach(function(id){
    var el = document.getElementById(id);
    if(!el) return;
    el.oninput = function(){
      payoutModalRenderPage(pm.page||1);
    };
  });

  // copy 绑定（点订单号复制）
  document.querySelectorAll("#payoutModalRows .copyable").forEach(function(td){
    td.onclick = function(){
      var v = td.getAttribute("data-copy") || "";
      if(v) U.copyText(v);
      toast && toast("已复制订单号：" + v);
    };
  });

  payoutModalRecalcTotal();
  payoutModalRunPrecheck();
  payoutModalUpdatePagerUI && payoutModalUpdatePagerUI();
}
function payoutModalOnRowInput(ev){
  var tr = ev && ev.target ? ev.target.closest('tr[data-oid]') : null;
  if(!tr) return;
  var oid = tr.getAttribute('data-oid');
  var pm = state._payoutModal; if(!pm) return;
  var ov = pm.overrides[oid] || (pm.overrides[oid] = {});
  var amount = parseFloat(tr.querySelector('.pm-amount').value||'0')||0;
  var discount = parseFloat(tr.querySelector('.pm-discount').value||'0')||0;
  var bc = parseFloat(tr.querySelector('.pm-bc').value||'0')||0;
  var pay = parseFloat(tr.querySelector('.pm-pay').value||'0')||0;
  ov.amount = amount; ov.discount = discount; ov.buyer_commission_orig = bc; ov.commission_pay_cny = pay;

  // 更新本行的派生值（不全表重算）
  var fx = parseFloat((tr.querySelector('.pm-fx')||{}).textContent||'1')||1;
  var pcny = round2((amount - discount) * fx);
  var total = round2(pcny + pay);
  var c1 = tr.querySelector('.pm-principal'); if(c1) c1.textContent = String(pcny);
  var c2 = tr.querySelector('.pm-total'); if(c2) c2.textContent = String(total);

  payoutModalRecalcTotalVisible();
}


function payoutModalRecalcTotal(){
  // Backward-compatible alias: older code calls payoutModalRecalcTotal()
  return payoutModalRecalcTotalVisible();
}

function payoutModalRecalcAll(){
  // Recalculate all derived fields in the payout modal (row values + totals + precheck)
  try{
    if(typeof payoutModalRecalcTotalVisible==='function') payoutModalRecalcTotalVisible();
    else if(typeof payoutModalRecalcTotal==='function') payoutModalRecalcTotal();
  }catch(e){}
  try{
    if(typeof payoutModalRunPrecheck==='function') payoutModalRunPrecheck();
  }catch(e){}
}


function payoutModalRecalcTotalVisible(){
  var pm = state._payoutModal; if(!pm) return;
  var rowsEl = document.getElementById('payoutModalRows'); if(!rowsEl) return;
  var sum = 0;
  var trs = rowsEl.querySelectorAll('tr[data-oid]');
  for(var i=0;i<trs.length;i++){
    var total = parseFloat((trs[i].querySelector('.pm-total')||{}).textContent||'0')||0;
    sum += total;
  }
  var totalEl = document.getElementById('payoutModalTotal');
  if(totalEl) totalEl.textContent = '当页合计：' + round2(sum) + ' CNY';
}


function payoutEscapeHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function payoutModalReadBatchFx(){
  return {
    usd: parseFloat((document.getElementById('payoutBatchFxUsd')||{}).value)||0,
    eur: parseFloat((document.getElementById('payoutBatchFxEur')||{}).value)||0,
    gbp: parseFloat((document.getElementById('payoutBatchFxGbp')||{}).value)||0,
    cad: parseFloat((document.getElementById('payoutBatchFxCad')||{}).value)||0,
    jpy: parseFloat((document.getElementById('payoutBatchFxJpy')||{}).value)||0
  };
}

function payoutModalRunPrecheck(){
  var pm = state._payoutModal;
  var summaryEl = document.getElementById('payoutPrecheckSummary');
  var listEl = document.getElementById('payoutPrecheckList');
  var btn = document.getElementById('payoutModalConfirm');

  if(!pm || !pm.orders){
    if(summaryEl) summaryEl.textContent = '—';
    if(listEl) listEl.innerHTML = '';
    if(btn) btn.disabled = true;
    return { ok:false, issues:['no_modal'] };
  }

  var fxObj = payoutModalReadBatchFx();
  var issues = [];
  var shown = 0;

  // Basic validations. Keep it deterministic and aligned with eligibility.
  for(var i=0;i<pm.orders.length;i++){
    var o = pm.orders[i] || {};
    var oid = o.orderNo || o.order_no || o.order_number || o.id || ('#'+i);

    // Review must be DONE
    var rv = (o.review && o.review.status) ? String(o.review.status).toUpperCase() : String(o.reviewStatus||o.review_status||o.review_done||'').toUpperCase();
    if(rv !== 'DONE'){
      issues.push({oid:oid, msg:'回评状态不是 DONE（实际='+ (rv||'空') +'）'});
      continue;
    }

    // Must not be already paid/refunded
    var ps = getPayoutStatus ? getPayoutStatus(o) : '';
    if(ps && ps !== 'payout_pending'){
      issues.push({oid:oid, msg:'返款状态不允许（实际='+ps+'）'});
      continue;
    }

    // FX must exist and be > 0 (unless currency is already CNY)
    var fx = 0;
    try{ fx = getFxForOrder ? getFxForOrder(o, fxObj) : 0; }catch(e){ fx = 0; }
    if(!(fx>0)){
      issues.push({oid:oid, msg:'缺少 FX（请填写本批次 FX 或卖家 FX）'});
      continue;
    }

    // Amount sanity (avoid NaN)
    var amt = (typeof o.amount==='number') ? o.amount : parseFloat(o.amount||0);
    if(!(amt>=0)){
      issues.push({oid:oid, msg:'金额异常（'+ (o.amount===undefined?'空':o.amount) +'）'});
      continue;
    }
  }

  var ok = issues.length === 0;
  if(summaryEl) summaryEl.textContent = ok ? ('通过（'+ pm.orders.length +' 单）') : ('发现问题：'+ issues.length +' 条');
  if(listEl){
    if(ok){
      listEl.innerHTML = '<div style="color:var(--ok);font-weight:700">无问题，可确认返款。</div>';
    }else{
      var html = '';
      for(var j=0;j<issues.length && j<200;j++){
        html += '<div style="padding:4px 6px;border-bottom:1px dashed var(--line);color:var(--bad)"><b>'+ payoutEscapeHtml(String(issues[j].oid)) +'</b>：'+ payoutEscapeHtml(String(issues[j].msg)) +'</div>';
      }
      if(issues.length>200) html += '<div class="mini">仅显示前 200 条问题。</div>';
      listEl.innerHTML = html;
    }
  }
  if(btn) btn.disabled = !ok;

  return { ok: ok, issues: issues };
}


function payoutModalBindPagerOnce(){
  if(state._payoutPagerBound) return;
  state._payoutPagerBound = true;
  var prev = document.getElementById('payoutModalPrevPage');
  var next = document.getElementById('payoutModalNextPage');
  if(prev) prev.onclick = function(){ var pm=state._payoutModal; if(!pm) return; payoutModalRenderPage((pm.page||1)-1); };
  if(next) next.onclick = function(){ var pm=state._payoutModal; if(!pm) return; payoutModalRenderPage((pm.page||1)+1); };
}

function payoutModalUpdatePagerUI(){
  var pm = state._payoutModal;
  var pagerInfo = document.getElementById('payoutModalPagerInfo');
  var prev = document.getElementById('payoutModalPrevPage');
  var next = document.getElementById('payoutModalNextPage');
  if(!pm){
    if(pagerInfo) pagerInfo.textContent = '';
    if(prev) prev.disabled = true;
    if(next) next.disabled = true;
    return;
  }
  var total = pm.orders.length;
  var ps = pm.pageSize || 100;
  var maxPage = Math.max(1, Math.ceil(total / ps));
  if(pagerInfo) pagerInfo.textContent = '第 ' + pm.page + ' / ' + maxPage + ' 页（每页 ' + ps + '）';
  if(prev) prev.disabled = (pm.page<=1);
  if(next) next.disabled = (pm.page>=maxPage);
}

function collectPayoutModalLines(){
  const fxObj = payoutModalGetFxObj();
  const batchId = ($("payoutBatchId").value||"").trim();
  const date = $("payoutBatchDate").value || U.today();
  const method = ($("payoutBatchMethod").value||"").trim();
  const note = ($("payoutBatchNote").value||"").trim();

  const lines = [];
  document.querySelectorAll("#payoutModalRows tr").forEach(tr=>{
    const id = tr.getAttribute("data-payout-row");
    const o = (S.orders||[]).find(x=>x.id===id);
    if(!o) return;

    const amount = U.num(tr.querySelector('input[data-f="amount"]').value);
    const discount = U.num(tr.querySelector('input[data-f="discount"]').value);
    const buyerCommOrig = U.num(tr.querySelector('input[data-f="buyerCommOrig"]')?.value); if(!isFinite(buyerCommOrig)) buyerCommOrig = 0;
    const principalOrig = U.num(tr.querySelector('[data-v="principalOrig"]').textContent);
    const fxv = U.num(tr.querySelector('[data-v="fx"]').textContent);
    const principalCny = U.num(tr.querySelector('[data-v="principalCny"]').textContent);

    const principalPayCny = U.num(tr.querySelector('input[data-f="principalPay"]').value);
    let commShouldCny = U.num(tr.querySelector('input[data-f="commCny"]').value);
    let commPayCny = U.num(tr.querySelector('input[data-f="commPay"]').value);
    // 无法上评：不收佣也不返佣（强制佣金=0，避免被默认佣金覆盖）
    try{
      const dt = String(o?.review?.doneType||"").trim();
      if(dt==="UNABLE" || dt==="无法上评"){
        commShouldCny = 0;
        commPayCny = 0;
      }
    }catch(e){}
    const totalPayCny = principalPayCny + commPayCny;

    lines.push({
      id:o.id, orderId:o.orderId, market:o.market, currency:o.currency,
      amount:amount.toFixed(2), discount:discount.toFixed(2), buyerCommOrig:buyerCommOrig.toFixed(2),
      principalOrig:principalOrig.toFixed(2),
      fx: fxv,
      principalCny: principalCny.toFixed(2),
      principalPayCny: principalPayCny.toFixed(2),
      commShouldCny: commShouldCny.toFixed(2),
      commPayCny: commPayCny.toFixed(2),
      totalPayCny: totalPayCny.toFixed(2),
      sellerId:o.sellerId, productId:o.productId
    });
  });

  return {batchId,date,method,note,fx:fxObj,lines};
}

function bindPayout(){
  if(!$("tab-payout")) return; // 没有返款 DOM 时跳过

  $("payoutCfgToggle").onclick = ()=>{
    const box = $("payoutCfgBox");
    const hidden = box.style.display==="none";
    box.style.display = hidden ? "" : "none";
    $("payoutCfgToggle").textContent = hidden ? "隐藏" : "展开";
  };

  
  // 批次列表（收款/结算）：默认隐藏
  if($("batchToggle")){
    $("batchToggle").onclick = ()=>{
      const box = $("batchBox");
      const hidden = box.style.display==="none";
      box.style.display = hidden ? "" : "none";
      $("batchToggle").textContent = hidden ? "隐藏" : "展开";
    };
  }

// 返款批次列表：默认隐藏 + 分页
  if($("payoutBatchToggle")){
    $("payoutBatchToggle").onclick = ()=>{
      const box = $("payoutBatchBox");
      const hidden = box.style.display==="none";
      box.style.display = hidden ? "" : "none";
      $("payoutBatchToggle").textContent = hidden ? "隐藏" : "展开";
    };
  }
  if($("payoutBatchPrev")) $("payoutBatchPrev").onclick = ()=>{ UI.payoutBatchPage = Math.max(1,(UI.payoutBatchPage||1)-1); renderPayoutBatches(); };
  if($("payoutBatchNext")) $("payoutBatchNext").onclick = ()=>{ UI.payoutBatchPage = (UI.payoutBatchPage||1)+1; renderPayoutBatches(); };
  // 批次搜索（按ID模糊）
  if($("payoutBatchSearch")){
    $("payoutBatchSearch").oninput = ()=>{
      UI.payoutBatchQuery = $("payoutBatchSearch").value;
      UI.payoutBatchPage = 1;
      renderPayoutBatches();
    };
  }
  if($("payoutBatchClearSearch")){
    $("payoutBatchClearSearch").onclick = ()=>{
      UI.payoutBatchQuery = "";
      if($("payoutBatchSearch")) $("payoutBatchSearch").value = "";
      UI.payoutBatchPage = 1;
      renderPayoutBatches();
    };
  }

  // 批次明细弹窗
  if($("payoutBatchDetailClose")) $("payoutBatchDetailClose").onclick = ()=> closePayoutBatchDetail();


  $("payoutCfgSave").onclick = ()=>{
    ensurePayoutSettings();
    const v = readPayoutCfgInputs();
    S.settings.payoutFxDefault = {usd:v.usd, gbp:v.gbp, eur:v.eur, cad:v.cad, jpy:v.jpy};
    S.settings.payoutCommDefault = v.commDefault;
    save();
    if($("payoutCfgHint")) $("payoutCfgHint").textContent = "已保存为默认（后续返款弹窗自动使用）";
    renderPayout();
  };

  $("payoutCfgReset").onclick = ()=>{
    ensurePayoutSettings();
    S.settings.payoutFxDefault = {usd:0,eur:0,gbp:0,cad:0,jpy:0};
    S.settings.payoutCommDefault = null;
    save();
    applyPayoutCfgToInputs();
    if($("payoutCfgHint")) $("payoutCfgHint").textContent = "已恢复默认（空值）";
    renderPayout();
  };

  ["payoutSellerFilter","payoutStatusFilter","payoutMarketFilter"].forEach(id=>{
    if($(id)) $(id).onchange = ()=>{ UI.payoutPage=1; renderPayout(); };
  });
  // 快捷：只看待返款 / 显示全部
  if($("payoutQuickPending")) $("payoutQuickPending").onclick = ()=>{ if($("payoutStatusFilter")) $("payoutStatusFilter").value="payout_pending"; UI.payoutPage=1; renderPayout(); };
  if($("payoutQuickAll")) $("payoutQuickAll").onclick = ()=>{ if($("payoutStatusFilter")) $("payoutStatusFilter").value=""; UI.payoutPage=1; renderPayout(); };
  if($("payoutSearch")) $("payoutSearch").oninput = ()=>{
    UI.payoutPage=1;
    // 自动勾选：当输入为订单号(前19位)且命中唯一订单时自动勾选
    const q = ($("payoutSearch").value||"").trim();
    if(q){
      const all = payoutFilteredOrders();
      // exact by orderId (前19位) or full
      const exact = all.filter(o=> (o.orderId||"").startsWith(q) && q.length>=6 );
      if(exact.length===1){
        UI.payoutSelected.add(exact[0].id);
      }
    }
    renderPayout();
  };
  if($('payoutSellerSearch')) $('payoutSellerSearch').oninput = ()=>{ UI.payoutPage=1; renderPayout(); };

  $("payoutSelectAll").onclick = payoutSelectPageAll;
  $("payoutClearSel").onclick = payoutClearSelection;
  if($("payoutResetView")) $("payoutResetView").onclick = payoutResetView;
  $("payoutPrev").onclick = ()=>{ UI.payoutPage=Math.max(1, UI.payoutPage-1); renderPayout(); };
  $("payoutNext").onclick = ()=>{ UI.payoutPage=UI.payoutPage+1; renderPayout(); };

  $("payoutParseSelect").onclick = payoutParseAndSelect;
  $("payoutParseMarkDone").onclick = payoutParseMarkDone;

  $("payoutOpenModal").onclick = openPayoutModal;

  // 性能优化：返款列表使用事件委托，避免每次渲染都逐个绑定按钮/checkbox（大数据量更稳定）
  if(!$("payoutRows")) return;
  if(!UI._payoutDelegated){
    UI._payoutDelegated = true;

    // checkbox 选择：同步到内存 Set（不扫 DOM）
    $("payoutRows").addEventListener("change", (ev)=>{
      if(UI._payoutBulkSelecting) return;
      const t = ev.target;
      if(t && t.matches && t.matches('input[type="checkbox"][data-payout-sel]')){
        const id = t.getAttribute("data-payout-sel");
        if(!id) return;
        if(t.checked) UI.payoutSelected.add(String(id));
        else UI.payoutSelected.delete(String(id));
        // 仅更新提示，不触发全量刷新
        renderPayoutSelHint();
      }
    });

    // 行内按钮：单笔返款 / 查看返款
    $("payoutRows").addEventListener("click", (ev)=>{
      const el = ev.target && ev.target.closest ? ev.target.closest("[data-payout-one],[data-payout-view]") : null;
      if(!el) return;
      const one = el.getAttribute("data-payout-one");
      const view = el.getAttribute("data-payout-view");
      if(one) openSinglePayoutModal(one);
      else if(view) openPayoutViewModal(view);
    });
  }

}

/* ===================== UI Enhancements (Searchable Select + Collapse Memory) ===================== */
function ensureWrapWithSearch(selectEl, placeholder, wrapClass){
  if(!selectEl) return;
  // prevent double-init per element
  if(selectEl.dataset.searchInit==="1") return;
  selectEl.dataset.searchInit="1";

  // Create wrapper row: [input][select]
  const wrap = document.createElement("div");
  wrap.className = wrapClass || "";
  wrap.style.display="flex";
  wrap.style.gap="8px";
  wrap.style.alignItems="center";
  wrap.style.maxWidth="520px";

  const input = document.createElement("input");
  input.id = selectEl.id + "__search";
  input.type="text";
  input.className="input";
  input.placeholder = placeholder || "搜索...";

  // insert wrapper into DOM, keeping layout stable
  const parent = selectEl.parentNode;
  parent.insertBefore(wrap, selectEl);
  wrap.appendChild(input);
  wrap.appendChild(selectEl);

  // Build cache from current options (excluding placeholder)
  function buildCache(){
    const opts = Array.from(selectEl.options||[]);
    const placeholderOpt = (opts[0] && (opts[0].value==="" || opts[0].value==="ALL")) ? {value:opts[0].value, text:opts[0].textContent||""} : null;
    const list = opts
      .filter((o,i)=>!(placeholderOpt && i===0))
      .map(o=>({value:o.value, text:o.textContent||""}));
    selectEl._opsAllOptions = list;
    selectEl._opsPlaceholder = placeholderOpt;
  }

  function applyFilter(){
    const q = (input.value||"").trim().toLowerCase();
    const all = selectEl._opsAllOptions || [];
    const ph = selectEl._opsPlaceholder;
    const prev = selectEl.value;

    // rebuild options to guarantee filtering works across browsers
    selectEl.innerHTML = "";
    if(ph){
      const o=document.createElement("option");
      o.value=""; o.textContent=ph.text;
      selectEl.appendChild(o);
    }
    const filtered = !q ? all : all.filter(x=> (x.text||"").toLowerCase().includes(q) || String(x.value||"").toLowerCase().includes(q));
    filtered.forEach(x=>{
      const o=document.createElement("option");
      o.value=x.value; o.textContent=x.text;
      selectEl.appendChild(o);
    });

    // selection policy:
    // - if user is searching (q not empty) and there is at least one match, auto-select the first match
    //   (without stealing focus), and trigger change so dependent fields auto-fill.
    // - otherwise keep previous selection if still present; else blank.
    const hasPrev = prev && Array.from(selectEl.options).some(o=>o.value===prev);
    if(q){
      const opts = Array.from(selectEl.options).filter(o=>o.value!=="" && o.value!=="ALL");
      if(opts.length){
        const first = opts[0].value;
        if(selectEl.value!==first){
          selectEl.value = first;
          // guard against re-entrant rebuild loops
          if(!selectEl._opsAutoSel){
            selectEl._opsAutoSel = true;
            try{
              selectEl.dispatchEvent(new Event("change", { bubbles: true }));
            }finally{
              setTimeout(()=>{ selectEl._opsAutoSel = false; }, 0);
            }
          }
        }
      }else{
        selectEl.value = "";
      }
    }else if(hasPrev){
      selectEl.value = prev;
    }else{
      selectEl.value = "";
    }
  }

  // initial cache + filter
  buildCache();
  applyFilter();

  input.addEventListener("input", ()=>{ applyFilter(); if(selectEl.id==="filterSeller"){ try{ UI.page=1; }catch(e){}; try{ renderOrders(); }catch(e){} } if(selectEl.id==="payoutSellerFilter"){ try{ UI.payoutPage=1; }catch(e){}; try{ renderPayout(); }catch(e){} } });

  // when options are rebuilt by renderSelects/setOptions, refresh cache and re-apply current query
  selectEl.addEventListener("ops:options-updated", ()=>{
    buildCache();
    applyFilter();
  });
}

function initSearchableSelects(){
  // 新增/编辑订单
  ensureWrapWithSearch(document.getElementById("orderSeller"), "搜索卖家...");
  ensureWrapWithSearch(document.getElementById("orderProduct"), "搜索产品...");
  // 批量解析登记
  ensureWrapWithSearch(document.getElementById("batchSeller"), "搜索卖家...");
  ensureWrapWithSearch(document.getElementById("batchProduct"), "搜索产品...");
  // 筛选区
  ensureWrapWithSearch(document.getElementById("filterSeller"), "搜索卖家...");
  // 产品页卖家
  ensureWrapWithSearch(document.getElementById("productSeller"), "搜索卖家...");
}

function initCollapseMemory(){
  const KEY="ops_ui_collapses_v1";
  let saved={};
  try{ saved = JSON.parse(localStorage.getItem(KEY)||"{}")||{}; }catch(e){ saved={}; }

  const details = Array.from(document.querySelectorAll("details"));
  details.forEach((d, idx)=>{
    const k = d.getAttribute("data-ui") || d.id || ("d"+idx);
    d.setAttribute("data-ui", k);

    if(saved.hasOwnProperty(k)){
      d.open = !!saved[k];
    }

    d.addEventListener("toggle", ()=>{
      try{
        saved[k]=!!d.open;
        localStorage.setItem(KEY, JSON.stringify(saved));
      }catch(e){
        // ignore storage errors
      }
    });
  });
}



/* ===================== Init ===================== */
const __loadPromise = load();
document.addEventListener("DOMContentLoaded", ()=>{
  __loadPromise.then(()=>{
    bind();
    renderTabs();
    renderAll();
    initCollapseMemory();
    initSearchableSelects();
  }).catch((e)=>{
    console.error(e);
    // 即使加载失败，也允许进入页面（内存态可用）
    try{ bind(); renderTabs(); renderAll(); initCollapseMemory(); initSearchableSelects(); }catch(_e){}
  });
});

</script>

<!-- Modal Overlay (for Order Edit) -->
<div id="modalOverlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.55);">
  <div style="background:#fff;max-width:1100px;margin:4vh auto;max-height:92vh;overflow:auto;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;background:#fff;z-index:1;">
      <div style="font-weight:800;">编辑订单</div>
      <button class="btn" id="btnModalClose">×</button>
    </div>
    <div id="modalBody" style="padding:14px 16px;"></div>
  </div>
</div>


<script>
(async function(){
  // --- Modal helpers ---
  const overlay = document.getElementById('modalOverlay');
  const body = document.getElementById('modalBody');
  const btnClose = document.getElementById('btnModalClose');

  let movedEl = null;
  let restoreParent = null;
  let restoreNext = null;

  function findOrderEditDetails(){
    const ordersTab = document.getElementById('tab-orders');
    if(!ordersTab) return null;
    const ds = Array.from(ordersTab.querySelectorAll('details'));
    // pick the one whose summary contains '新建/编辑订单'
    return ds.find(d=>{
      const s = d.querySelector('summary');
      return s && (s.textContent||'').includes('新建/编辑订单');
    }) || null;
  }

  function openModal(){
    const el = findOrderEditDetails();
    if(!el) { alert('未找到订单编辑区域（details）'); return; }

    // ensure it's open
    try { el.open = true; } catch(e){}

    // move into modal
    if(!movedEl){
      movedEl = el;
      restoreParent = el.parentNode;
      restoreNext = el.nextSibling;
    }
    body.innerHTML = '';
    body.appendChild(el);

    overlay.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  function closeModal(){
    overlay.style.display = 'none';
    document.body.style.overflow = '';
    // move back
    if(movedEl && restoreParent){
      if(restoreNext && restoreNext.parentNode === restoreParent){
        restoreParent.insertBefore(movedEl, restoreNext);
      }else{
        restoreParent.appendChild(movedEl);
      }
    }
  }

  btnClose && (btnClose.onclick = closeModal);
  overlay && (overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); }));
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && overlay.style.display==='block') closeModal(); });

  // --- Patch Actions.editOrder to open modal after filling form ---
  if(window.Actions && typeof window.Actions.editOrder === 'function'){
    const _editOrder = window.Actions.editOrder.bind(window.Actions);
    window.Actions.editOrder = function(id){
      _editOrder(id);
      openModal();
    };
  } else {
    // Actions is defined as const in script; expose if present
    try{
      if(typeof Actions !== 'undefined'){
        window.Actions = Actions;
        const _editOrder = window.Actions.editOrder.bind(window.Actions);
        window.Actions.editOrder = function(id){ _editOrder(id); openModal(); };
        const _q = window.Actions.quickOrderFromProduct && window.Actions.quickOrderFromProduct.bind(window.Actions);
        if(_q){
          window.Actions.quickOrderFromProduct = function(pid){
            // do not force tab switch; just prefill order form and open modal
            try{ document.getElementById("orderProduct").value = pid; }catch(e){}
            try{ if(typeof applyProductToOrder==="function") applyProductToOrder(); }catch(e){}
            try{ document.getElementById("orderId").focus(); }catch(e){}
            openModal();
          };
        }
      }
    }catch(e){}
  }

  // Ensure cancel button closes modal too
  function hookCloseButtons(){
    const cancelBtn = document.getElementById('btnCancelOrderEdit');
    if(cancelBtn && !cancelBtn.__modalHooked){
      cancelBtn.__modalHooked = true;
      cancelBtn.addEventListener('click', ()=>{ setTimeout(closeModal, 0); });
    }
    const saveBtn = document.getElementById('btnSaveOrder');
    if(saveBtn && !saveBtn.__modalHooked){
      saveBtn.__modalHooked = true;
      saveBtn.addEventListener('click', ()=>{ 
        // save logic runs in existing handler; close a tick later if edit was active
        setTimeout(()=>{
          // if edit hint cleared or cancel button hidden, close
          const hint = document.getElementById('orderEditHint');
          const cancel = document.getElementById('btnCancelOrderEdit');
          if(cancel && cancel.style.display === 'none') closeModal();
          if(hint && (hint.textContent||'')==='') closeModal();
        }, 50);
      });
    }
  }
  // run now and after tab switches (simple interval, lightweight)
  hookCloseButtons();
  setInterval(hookCloseButtons, 800);
})();

/* ================== 收款草稿箱（结算草稿） ================== */
const SettleDrafts = (()=> {
  const DB_NAME = "ops_v642_settle_drafts";
  const STORE = "drafts";
  let _db = null;

  function id() { return "SD" + Date.now() + "-" + Math.floor(Math.random()*900+100); }
  function nowISO(){ return new Date().toISOString(); }
  function safeJsonClone(obj){
    return JSON.parse(JSON.stringify(obj));
  }

  function openDB(){
    return new Promise((resolve, reject)=>{
      if(_db) return resolve(_db);
      if(!("indexedDB" in window)) return reject(new Error("IndexedDB 不可用"));
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = (e)=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE)){
          const os = db.createObjectStore(STORE, {keyPath:"id"});
          os.createIndex("updatedAt","updatedAt",{unique:false});
        }
      };
      req.onsuccess = ()=>{ _db=req.result; resolve(_db); };
      req.onerror = ()=>reject(req.error||new Error("打开 IndexedDB 失败"));
    });
  }

  async function putDraft(draft){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction(STORE,"readwrite");
      tx.oncomplete=()=>resolve(true);
      tx.onerror=()=>reject(tx.error||new Error("保存草稿失败"));
      tx.objectStore(STORE).put(draft);
    });
  }
  async function getDraft(id){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction(STORE,"readonly");
      const req=tx.objectStore(STORE).get(id);
      req.onsuccess=()=>resolve(req.result||null);
      req.onerror=()=>reject(req.error||new Error("读取草稿失败"));
    });
  }
  async function listDrafts(){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction(STORE,"readonly");
      const os=tx.objectStore(STORE);
      const idx=os.index("updatedAt");
      const out=[];
      idx.openCursor(null,"prev").onsuccess=(e)=>{
        const cur=e.target.result;
        if(cur){ out.push(cur.value); cur.continue(); }
        else resolve(out);
      };
      tx.onerror=()=>reject(tx.error||new Error("读取草稿列表失败"));
    });
  }
  async function delDraft(id){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction(STORE,"readwrite");
      tx.oncomplete=()=>resolve(true);
      tx.onerror=()=>reject(tx.error||new Error("删除草稿失败"));
      tx.objectStore(STORE).delete(id);
    });
  }
  async function clearAll(){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx=db.transaction(STORE,"readwrite");
      tx.oncomplete=()=>resolve(true);
      tx.onerror=()=>reject(tx.error||new Error("清空失败"));
      tx.objectStore(STORE).clear();
    });
  }

  function modeLabel(m){ return m==="PRINCIPAL"?"本金":m==="COMMISSION"?"佣金":"本佣一起"; }

  async function saveCurrentSettleAsDraft(){
    if(!UI.settle){ alert("请先打开结算窗口，再保存草稿。"); return; }
    // enforce single seller already (openSettle does) but draft could be saved after
    const sellerIds = Array.from(new Set(UI.settle.orderIds.map(oid=>S.orders.find(o=>o.orderId===oid)?.sellerId).filter(Boolean)));
    if(sellerIds.length>1){ alert("不同卖家的订单不能保存为同一份收款草稿。"); return; }
    const sellerId = sellerIds[0] || "";
    const seller = sellerId ? U.sellerById(sellerId) : null;

    // sync latest inputs into UI.settle
    UI.settle.batchId = ($("settleBatchId").value||"").trim() || UI.settle.batchId;
    UI.settle.date = $("settleBatchDate").value || UI.settle.date;
    UI.settle.method = ($("settleMethod").value||"").trim();
    UI.settle.note = ($("settleNote").value||"").trim();
    UI.settle.fx = {
      usd: U.num($("fx_usd").value),
      eur: U.num($("fx_eur").value),
      gbp: U.num($("fx_gbp").value),
      cad: U.num($("fx_cad").value),
      jpy: U.num($("fx_jpy").value),
    };

    const totalCny = U.num(($("settleTotalTop")?.textContent||"0").replace(/[^\d\.\-]/g,""));
    const draft = {
      id: id(),
      type: "SELLER_SETTLE_DRAFT",
      createdAt: nowISO(),
      updatedAt: nowISO(),
      sellerId,
      sellerName: seller ? seller.name : "",
      mode: UI.settle.mode,
      totalCny,
      batchId: UI.settle.batchId,
      settleSnapshot: safeJsonClone(UI.settle),
    };

    await putDraft(draft);
    showNotice("已保存：收款草稿（可在「收款草稿箱」中恢复）");
  }

  function openDraftModal(){
    $("settleDraftModal").style.display="flex";
    renderDraftList().catch(e=>alert("草稿箱读取失败："+(e?.message||e)));
  }
  function closeDraftModal(){
    $("settleDraftModal").style.display="none";
  }

  async function renderDraftList(){
    const tbody = $("settleDraftTbody");
    const list = await listDrafts();
    if(!list.length){
      tbody.innerHTML = '<tr><td colspan="7" class="muted" style="padding:16px">暂无草稿</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(d=>{
      const t = d.updatedAt ? d.updatedAt.replace("T"," ").slice(0,19) : "";
      const seller = d.sellerName || d.sellerId || "-";
      const mode = modeLabel(d.mode);
      const cnt = d.settleSnapshot?.orderIds?.length || 0;
      const total = (d.totalCny==null?0:d.totalCny).toFixed(2);
      const bid = d.batchId || (d.settleSnapshot?.batchId||"");
      return `<tr>
        <td>${escHtml(t)}</td>
        <td>${escHtml(seller)}</td>
        <td>${escHtml(mode)}</td>
        <td>${cnt}</td>
        <td style="text-align:right">${total}</td>
        <td>${escHtml(bid)}</td>
        <td>
          <button class="btn small" data-act="open" data-id="${d.id}">打开结算</button>
          <button class="btn small" data-act="export" data-id="${d.id}">导出</button>
          <button class="btn small danger" data-act="del" data-id="${d.id}">删除</button>
        </td>
      </tr>`;
    }).join("\n");
  }

  async function openDraft(id){
    window.__settleDraftOpenedId = id;
    const d = await getDraft(id);
    if(!d || !d.settleSnapshot){ alert("草稿不存在或已损坏"); return; }
    const snap = d.settleSnapshot;

    // restore selection
    UI.selected = new Set(snap.orderIds || []);
    renderOrders(); // refresh checkbox state + chips

    // open settle in same mode then apply snapshot
    openSettle(snap.mode || "BOTH");
    applySettleSnapshot(snap);
    closeDraftModal();
    showNotice("已恢复草稿：结算窗口已打开。");
  }

  function applySettleSnapshot(snap){
    // deep clone into UI.settle to avoid accidental ref
    UI.settle = JSON.parse(JSON.stringify(snap));

    $("settleTitle").textContent = (UI.settle.mode==="PRINCIPAL" ? "批量结算：本金" : UI.settle.mode==="COMMISSION" ? "批量结算：佣金" : "批量结算：本佣一起");
    $("settleBatchId").value = UI.settle.batchId || "";
    $("settleBatchDate").value = UI.settle.date || U.today();
    $("settleMethod").value = UI.settle.method || "";
    $("settleNote").value = UI.settle.note || "";
    $("fx_usd").value = U.num(UI.settle.fx?.usd||0);
    $("fx_eur").value = U.num(UI.settle.fx?.eur||0);
    $("fx_gbp").value = U.num(UI.settle.fx?.gbp||0);
    $("fx_cad").value = U.num(UI.settle.fx?.cad||0);
    $("fx_jpy").value = U.num(UI.settle.fx?.jpy||0);

    // ensure edits entries exist
    (UI.settle.orderIds||[]).forEach(oid=>{
      if(!UI.settle.edits) UI.settle.edits = {};
      if(!UI.settle.edits[oid]) UI.settle.edits[oid] = {p:null,c:null,amount:null,discount:null,buyerCommission:null};
    });

    renderSettleRows();
  }

  async function exportDraft(id){
    const d = await getDraft(id);
    if(!d){ showNotice("草稿不存在"); return; }
    const snap = d.settleSnapshot || {};
    const orderIds = (snap.orderIds || []).slice();
    const fxMap = snap.fxMap || snap.fxByMarket || {};
    const edits = snap.edits || {};
    const batchId = d.batchId || snap.batchId || "";
    const sellerName = d.sellerName || snap.sellerName || "";
    const mode = d.mode || snap.mode || "";
    const createdAt = d.createdAt || "";
    const rows = [];
    rows.push([
      "batch_id","created_at","seller","mode",
      "order_id","market",
      "amount","discount","buyer_commission",
      "fx","principal_cny","commission_cny",
      "principal_settle_cny","commission_settle_cny"
    ]);
    orderIds.forEach(oid=>{
      const o = (S.orders||[]).find(x=>x.order_id===oid);
      const market = (o && (o.market || o.country)) || "";
      const fx = num(fxMap[market] ?? fxMap[(market||"").toUpperCase()] ?? 0);
      const e = edits[oid] || {};
      const amount = num(e.amount ?? o?.amount ?? o?.order_amount ?? 0);
      const discount = num(e.discount ?? o?.discount ?? 0);
      const bc = num(e.buyerCommission ?? e.buyer_commission ?? o?.buyer_commission ?? o?.buyerCommission ?? 0);
      const principal_cny = (amount - discount) * fx;
      const commission_cny = bc * fx;
      const principal_settle = num(e.principal_settle_cny ?? e.principalSettleCny ?? 0);
      const commission_settle = num(e.commission_settle_cny ?? e.commissionSettleCny ?? 0);
      rows.push([
        batchId,createdAt,sellerName,mode,
        oid,market,
        amount,discount,bc,
        fx,round2(principal_cny),round2(commission_cny),
        principal_settle,commission_settle
      ]);
    });
    const csv = rows.map(r=>r.map(U.csvEscape).join(",")).join("\n");
    U.download(`settle_draft_${batchId||id}.csv`, csv, "text/csv;charset=utf-8");
    showNotice("已导出CSV");
  }

  async function importDraftFromFile(file){
    const txt = await file.text();
    const obj = JSON.parse(txt);
    if(!obj || !obj.id || !obj.settleSnapshot){ throw new Error("JSON 格式不正确"); }
    obj.updatedAt = nowISO();
    await putDraft(obj);
  }

  function bind(){
    // Order list toolbar entry
    const btn = $("btnSettleDrafts");
    if(btn) btn.onclick = ()=>openDraftModal();

    // Settle modal save draft
    const saveBtn = $("btnSaveSettleDraft");
    if(saveBtn) saveBtn.onclick = ()=>saveCurrentSettleAsDraft().catch(e=>alert("保存草稿失败："+(e?.message||e)));

    // Draft modal
    const __el_btnCloseSettleDraftModal = $("btnCloseSettleDraftModal");
    if(__el_btnCloseSettleDraftModal) __el_btnCloseSettleDraftModal.onclick = closeDraftModal;
    const __el_btnClearSettleDrafts = $("btnClearSettleDrafts");
    if(__el_btnClearSettleDrafts) __el_btnClearSettleDrafts.onclick = async ()=>{
      if(!confirm("确认清空草稿箱？此操作不可恢复")) return;
      try{ await clearAll(); await renderDraftList(); showNotice("已清空草稿箱"); }catch(e){ alert("清空失败："+(e?.message||e)); }
    };
    const __el_btnExportSettleDraftListCSV = $("btnExportSettleDraftListCSV");
    if(__el_btnExportSettleDraftListCSV) __el_btnExportSettleDraftListCSV.onclick = async ()=>{
      try{ await exportSettleDraftListCSV(); }catch(e){ alert("导出失败："+(e?.message||e)); }
    };
    const __el_btnExportAllSettleDraftDetailsCSV = $("btnExportAllSettleDraftDetailsCSV");
    if(__el_btnExportAllSettleDraftDetailsCSV) __el_btnExportAllSettleDraftDetailsCSV.onclick = async ()=>{
      try{ await exportAllSettleDraftDetailsCSV(); }catch(e){ alert("导出失败："+(e?.message||e)); }
    };
    const __el_btnImportSettleDraftJson = $("btnImportSettleDraftJson");
    const __el_fileImportSettleDraft = $("fileImportSettleDraft");
    if(__el_btnImportSettleDraftJson && __el_fileImportSettleDraft){
      __el_btnImportSettleDraftJson.onclick = ()=>__el_fileImportSettleDraft.click();
    }

    if(__el_fileImportSettleDraft) __el_fileImportSettleDraft.addEventListener("change", async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{ await importDraftFromFile(f); await renderDraftList(); showNotice("已导入草稿"); }
      catch(err){ alert("导入失败："+(err?.message||err)); }
      finally{ e.target.value=""; }
    });

    const __el_settleDraftTbody = $("settleDraftTbody");
    if(__el_settleDraftTbody) __el_settleDraftTbody.addEventListener("click", async (e)=>{
      const b = e.target.closest("button"); if(!b) return;
      const act=b.dataset.act, id=b.dataset.id;
      try{
        if(act==="open") await openDraft(id);
        else if(act==="export") await exportDraft(id);
        else if(act==="del"){
          if(!confirm("确认删除该草稿？")) return;
          await delDraft(id); await renderDraftList();
        }
      }catch(err){
        alert("操作失败："+(err?.message||err));
      }
    });

    // ESC close modal
    document.addEventListener("keydown", (e)=>{
      if(e.key==="Escape"||e.key==="Esc"){
        if($("settleDraftModal").style.display==="flex") closeDraftModal();
      }
    });
  }

  return { bind, openDraftModal, saveCurrentSettleAsDraft };

  // expose minimal API for other modules (e.g. 结算确认后自动删除草稿)
  window.__settleDrafts = window.__settleDrafts || {};
  window.__settleDrafts.del = function(id){ return idbDel(DRAFTS_STORE, id); };
  window.__settleDrafts.refreshOpen = function(){
    const modal = qs('#dlgSettleDrafts');
    if(modal && modal.style.display==='flex'){
      try{ return Promise.resolve(renderDrafts()).catch(()=>{}); }catch(e){}
    }
  };
})();

try{ SettleDrafts.bind(); }catch(e){ console.warn("SettleDrafts init failed", e); }


// =======================
// 单笔返款（用于排查/先跑通）
// =======================
function ensurePayoutSingleModal(){
  if($("payoutSingleModal")) return;
  // 如果 HTML 没插入（极少数情况下用户手动复制遗漏），这里兜底动态创建
  const wrap = document.createElement("div");
  wrap.innerHTML = `
  <div class="modal" id="payoutSingleModal" style="display:none">
    <div class="modal-content" style="max-width:900px">
      <div class="modal-header">
        <div>
          <div class="modal-title">单笔返款（测试）</div>
          <div class="help">用于先跑通：勾选/搜索/批量导致的问题先放一边，先把单笔返款弹窗走通。</div>
        </div>
        <button type="button" class="btn" id="payoutSingleClose">关闭</button>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:240px">
            <label class="lbl">订单号</label>
            <input id="payoutSingleOrderId" class="input mono" disabled />
          </div>
          <div style="flex:1;min-width:240px">
            <label class="lbl">产品名称</label>
            <input id="payoutSingleProduct" class="input" disabled />
          </div>
          <div style="flex:1;min-width:160px">
            <label class="lbl">币种</label>
            <input id="payoutSingleCurrency" class="input mono" disabled />
          </div>
        </div>

        <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:10px">
          <div style="flex:1;min-width:160px">
            <label class="lbl">金额(原币)</label>
            <input id="payoutSingleAmount" class="input mono" />
          </div>
          <div style="flex:1;min-width:160px">
            <label class="lbl">折扣(原币)</label>
            <input id="payoutSingleDiscount" class="input mono" />
          </div>
          <div style="flex:1;min-width:160px">
            <label class="lbl">买手佣金(原币)</label>
            <input id="payoutSingleBuyerFee" class="input mono" />
          </div>
          <div style="flex:1;min-width:160px">
            <label class="lbl">FX</label>
            <input id="payoutSingleFx" class="input mono" />
          </div>
          <div style="flex:1;min-width:160px">
            <label class="lbl">佣金(CNY)</label>
            <input id="payoutSingleCommCny" class="input mono" />
          </div>
        </div>

        <div class="row" style="justify-content:space-between;align-items:center;margin-top:12px">
          <div class="help" id="payoutSingleFormula"></div>
          <div style="font-weight:700" id="payoutSingleTotal"></div>
        </div>

        <div class="row" style="justify-content:flex-end;gap:10px;margin-top:12px">
          <button type="button" class="btn" id="payoutSingleCalc">重新计算</button>
          <button type="button" class="btn primary" id="payoutSingleConfirm">确认单笔返款（生成批次并标记已返款）</button>
        </div>
      </div>
    </div>
  </div>`;
  document.body.appendChild(wrap.firstElementChild);

  $("payoutSingleClose").onclick = ()=>{ $("payoutSingleModal").style.display="none"; };
  $("payoutSingleCalc").onclick = ()=>{ payoutSingleRecalc(); };
  // 自动计算：修改任意字段立即更新合计（无需点“重新计算”）
  ["payoutSingleAmount","payoutSingleDiscount","payoutSingleBuyerFee","payoutSingleFx","payoutSingleCommCny"].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.oninput = ()=>{ payoutSingleRecalc(); };
    el.onchange = ()=>{ payoutSingleRecalc(); };
  });
  // “重新计算”按钮保留兜底，但默认弱化
  $("payoutSingleCalc").style.opacity = 0.6;
  $("payoutSingleConfirm").onclick = ()=>{ payoutSingleConfirm(); };
}


function ensurePayoutViewModal(){
  if($("payoutViewModal")) return;
  const wrap = document.createElement("div");
  wrap.innerHTML = `
  <div class="modal" id="payoutViewModal" style="display:none">
    <div class="modal-content" style="max-width:900px">
      <div class="modal-hd">
        <div class="modal-title">返款详情（查看）</div>
        <button class="btn sm" id="payoutViewClose">关闭</button>
      </div>
      <div class="modal-bd">
        <div class="grid cols-3 gap-12">
          <div class="field"><label>批次ID</label><div class="mono" id="pv_batch"></div></div>
          <div class="field"><label>日期</label><div class="mono" id="pv_date"></div></div>
          <div class="field"><label>方式</label><div class="mono" id="pv_method"></div></div>

          <div class="field"><label>订单号</label><div class="mono" id="pv_order"></div></div>
          <div class="field"><label>产品名称</label><div id="pv_title"></div></div>
          <div class="field"><label>Market/币种</label><div class="mono" id="pv_market"></div></div>

          <div class="field"><label>金额(原币)</label><div class="mono" id="pv_amount"></div></div>
          <div class="field"><label>折扣(原币)</label><div class="mono" id="pv_discount"></div></div>
          <div class="field"><label>买手佣金(原币)</label><div class="mono" id="pv_fee"></div></div>

          <div class="field"><label>FX</label><div class="mono" id="pv_fx"></div></div>
          <div class="field"><label>佣金(CNY)</label><div class="mono" id="pv_comm"></div></div>
          <div class="field"><label>合计(CNY)</label><div class="mono" id="pv_total"></div></div>
        </div>
        <div class="muted" style="margin-top:10px">公式：(金额-折扣+买手佣金)×FX + 佣金(CNY)</div>
      </div>
    </div>
  </div>`;
  document.body.appendChild(wrap.firstElementChild);
  $("payoutViewClose").onclick = ()=>{ $("payoutViewModal").style.display="none"; };
  $("payoutViewModal").addEventListener("click", (e)=>{ if(e.target===$("payoutViewModal")) $("payoutViewModal").style.display="none"; }); // backdrop click
}

function openPayoutViewModal(orderUuid){
  try{
    ensurePayoutViewModal();
    const o = (S.orders||[]).find(x=>x.id===orderUuid);
    if(!o){ alert("未找到订单：" + orderUuid); return; }
    const ps = getPayoutStatus(o);
    if(ps!=="paid"){ alert("该订单尚未返款，无法查看详情。"); return; }
    const p = o.payout||{};
    const batchId = p.batch_id || "";
    const b = (S.payoutBatches||[]).find(x=>String(x.id)===String(batchId));
    const method = p.method || (b?.method||"manual");
    const date = p.paid_at || (b?.date||"");
    const market = (o.market||"") + " / " + (o.currency||"");
    const amount = U.num(o.amount);
    const discount = U.num(o.discount);
    const fee = U.num(o.buyerFee||o.buyerCommission||0);
    const fx = U.num(p.fx||0);
    const comm = U.num(p.commission_cny||0);
    const base = (amount - discount + fee);
    const total = (p.total_cny!=null) ? U.num(p.total_cny) : (base*fx + comm);

    $("pv_batch").textContent = batchId || "-";
    $("pv_date").textContent = date || "-";
    $("pv_method").textContent = method || "-";
    $("pv_order").textContent = o.orderId||"";
    $("pv_title").textContent = payoutProductName(o)||"";
    $("pv_market").textContent = market;
    $("pv_amount").textContent = amount.toFixed(2);
    $("pv_discount").textContent = discount.toFixed(2);
    $("pv_fee").textContent = fee.toFixed(2);
    $("pv_fx").textContent = fx.toFixed(6).replace(/0+$/,"").replace(/\.$/,"");
    $("pv_comm").textContent = comm.toFixed(2);
    $("pv_total").textContent = total.toFixed(2);

    $("payoutViewModal").style.display = "flex";
  }catch(e){
    alert("打开返款详情失败：" + (e?.message||e));
  }
}
let _payoutSingleOrderId = null;

function openSinglePayoutModal(orderUuid){
  try{
    ensurePayoutSingleModal();
    const o = (S.orders||[]).find(x=>x.id===orderUuid);
    if(!o){ alert("未找到订单：" + orderUuid); return; }

    // 必须 DONE 且待打款
    const rs = String(o.review?.status||"");
    if(rs!=="DONE"){ alert("该订单回评状态不是 DONE，不能返款。"); return; }
    const ps = getPayoutStatus(o);
    if(ps==="paid"){ alert("该订单已返款，无需重复返款。"); return; }

    _payoutSingleOrderId = orderUuid;

    $("payoutSingleOrderId").value = o.orderId||"";
    $("payoutSingleProduct").value = payoutProductName(o);
    $("payoutSingleCurrency").value = o.currency||"";

    $("payoutSingleAmount").value = U.num(o.amount).toFixed(2);
    $("payoutSingleDiscount").value = U.num(o.discount).toFixed(2);
    $("payoutSingleBuyerFee").value = U.num((o.buyerCommission!=null?o.buyerCommission:o.buyerFee)||0).toFixed(2);

    const fx = payoutFxFor(o.currency||"", o.market||"");
    $("payoutSingleFx").value = U.num(fx).toFixed(4).replace(/0+$/,"").replace(/\.$/,"");
    const commCny = getCommissionCNY(o);
    $("payoutSingleCommCny").value = U.num(commCny).toFixed(2);
    try{ $("payoutSingleCommCny").disabled = (String(o?.review?.doneType||"").trim()==="UNABLE"); }catch(e){}

    payoutSingleRecalc();
    ["payoutSingleAmount","payoutSingleDiscount","payoutSingleBuyerFee","payoutSingleFx","payoutSingleCommCny"].forEach(id=>{ const el=$(id); if(el) el.oninput = payoutSingleRecalc; });
    $("payoutSingleModal").style.display = "flex";
  }catch(e){
    alert("打开单笔返款弹窗失败：" + (e?.message||e));
  }
}

function payoutSingleRecalc(){
  if(!_payoutSingleOrderId) return;
  const amount = U.num($("payoutSingleAmount").value);
  const discount = U.num($("payoutSingleDiscount").value);
  const buyerFee = U.num($("payoutSingleBuyerFee").value);
  const fx = U.num($("payoutSingleFx").value);
  const commCny = U.num($("payoutSingleCommCny").value);
  const base = (amount - discount + buyerFee);
  const total = base * fx + commCny;

  $("payoutSingleFormula").textContent = `公式：(金额-折扣+买手佣金)×FX + 佣金(CNY) = (${base.toFixed(2)})×${fx} + ${commCny.toFixed(2)}`;
  $("payoutSingleTotal").textContent = `合计：${total.toFixed(2)} CNY`;
}

async function payoutSingleConfirm(){
  try{
    if(!_payoutSingleOrderId) return;
    const o = (S.orders||[]).find(x=>x.id===_payoutSingleOrderId);
    if(!o){ alert("订单不存在"); return; }

    const amount = U.num($("payoutSingleAmount").value);
    const discount = U.num($("payoutSingleDiscount").value);
    const buyerFee = U.num($("payoutSingleBuyerFee").value);
    const fx = U.num($("payoutSingleFx").value);
    const commCny = U.num($("payoutSingleCommCny").value);
    const base = (amount - discount + buyerFee);
    const total = base * fx + commCny;

    // 写回订单（只写返款相关字段，不影响其它模块）
    o.amount = amount;
    o.discount = discount;
    o.buyerCommission = buyerFee;
    o.buyerFee = buyerFee;

    o.payout = o.payout || {};
    o.payout.status = "paid";
    o.payout.fx = fx;
    o.payout.commission_cny = commCny;
    o.payout.total_cny = total;
    o.payout.paid_at = new Date().toISOString().slice(0,10);
    o.payout.method = "manual";

    // 生成单笔批次
    S.payoutBatches = S.payoutBatches || [];
    const batchId = `PB${(Date.now()).toString().slice(-8)}`;

    // 关联批次到订单
    o.payout.batch_id = batchId;
    S.payoutBatches.unshift({
      id: batchId,
      date: new Date().toISOString().slice(0,10),
      method: "manual",
      note: "single payout",
      fx: fx,
      orders: [{
        order_uuid: o.id,
        order_id: o.orderId||"",
        market: o.market||"",
        currency: o.currency||"",
        amount: amount, discount: discount, buyerFee: buyerFee,
        base: base, totalCny: total,
      total_cny: total, commission_cny: commCny
      }],
      lines: [{
        order_uuid: o.id,
        order_id: o.orderId||"",
        market: o.market||"",
        currency: o.currency||"",
        amount: amount, discount: discount, buyerFee: buyerFee,
        base: base, totalCny: total,
      total_cny: total, commission_cny: commCny
      }],
      total_cny: total
    });

    await saveNow();
    $("payoutSingleModal").style.display = "none";
    _payoutSingleOrderId = null;

    // 重新渲染返款页（不影响订单页）
    if($("tab-payout")) renderPayout();
    await saveNow();
    alert(`已完成单笔返款：${batchId}，并标记订单为已返款。`);
  }catch(e){
    alert("确认单笔返款失败：" + (e?.message||e));
  }
}



// --- Payout Core: bulk confirm/export (stable, guarded) ---
if(typeof window.confirmPayoutModal !== "function"){
  window.confirmPayoutModal = function confirmPayoutModal(){
    try{
      // ensure modal state exists
      const M = (state && state._payoutModal) ? state._payoutModal : (state._payoutModal = {});
      // run precheck (will also toggle confirm btn)
      if(typeof payoutModalRunPrecheck === "function"){
        payoutModalRunPrecheck();
        if(M.issues && M.issues.length){
          alert("预检未通过：\n" + M.issues.slice(0,20).map(x=>`- ${x}`).join("\n") + (M.issues.length>20?`\n…共 ${M.issues.length} 条`:""));
          return;
        }
      }

      // read meta
      const batchIdEl = $("payoutBatchId");
      const dateEl = $("payoutBatchDate");
      const methodEl = $("payoutBatchMethod");
      const noteEl = $("payoutBatchNote");

      let batchId = batchIdEl ? String(batchIdEl.value||"").trim() : "";
      const date = dateEl ? String(dateEl.value||"").trim() : (new Date().toISOString().slice(0,10));
      const method = methodEl ? String(methodEl.value||"").trim() : "";
      const note = noteEl ? String(noteEl.value||"").trim() : "";

      if(!batchId){
        // PB + yyyymmdd + 6 rand
        const d = date.replaceAll("-","");
        const rnd = Math.random().toString(36).slice(2,8).toUpperCase();
        batchId = `PB${d}-${rnd}`;
        if(batchIdEl) batchIdEl.value = batchId;
      }

      // fx snapshot
      const fx = (typeof payoutModalReadBatchFx==="function") ? payoutModalReadBatchFx() : {};

      // collect rows from modal state; fallback compute from selected orders
      let rows = Array.isArray(M.rows) ? M.rows.slice() : null;
      if(!rows){
        const ids = UI.payoutSelected ? Array.from(UI.payoutSelected) : [];
        const orders = Array.isArray(S.orders)?S.orders:[];
        const map = new Map(orders.map(o=>[String(o.id), o]));
        rows = ids.map(id=>{
          const o = map.get(String(id));
          if(!o) return null;
          const amount = U.num(o.amount);
          const discount = U.num(o.discount);
          let buyerCommOrig = U.num(o.buyerCommission); if(!isFinite(buyerCommOrig)) buyerCommOrig = 0;
          const principalOrig = amount - discount + buyerCommOrig;
          const fxv = (typeof getFxForOrder==="function") ? getFxForOrder(o, fx) : U.num(o.fx||1);
          const principalCny = principalOrig * fxv;
          const commCny = (typeof commissionShould==="function") ? U.num(commissionShould(o)) : 0;
          const totalCny = principalCny + commCny;
          return { oid:String(o.id), order:o, amount, discount, buyerCommOrig, principalOrig, fx:fxv, principalCny, commCny, totalCny };
        }).filter(Boolean);
      }

      if(!rows.length){
        alert("无可返款订单。");
        return;
      }

      // totals
      const totalPrincipal = rows.reduce((s,r)=>s+U.num(r.principalCny),0);
      const totalComm = rows.reduce((s,r)=>s+U.num(r.commCny),0);
      const totalCny = totalPrincipal + totalComm;

      // write back orders + build batch orders payload
      const orderIds = [];
      const batchOrders = [];
      for(const r of rows){
        const o = r.order || r.o || r;
        if(!o || o.id==null) continue;
        orderIds.push(String(o.id));

        if(!o.payout) o.payout = {};
        o.payout.status = "paid";
        o.payout.batch_id = batchId;
        o.payout.paid_at = date;
        o.payout.principal_cny = U.round2 ? U.round2(r.principalCny) : U.num(r.principalCny);
        o.payout.commission_cny = U.round2 ? U.round2(r.commCny) : U.num(r.commCny);
        o.payout.total_cny = U.round2 ? U.round2(r.totalCny) : U.num(r.totalCny);
        o.payout.fx_used = r.fx;

        // keep some legacy mirrors (best-effort)
        o.payout_status = "paid";
        o.payout_batch_id = batchId;

        batchOrders.push({
          order_uuid: String(o.id),
          order_no: (o.orderId||o.order_no||o.orderNo||o.order_id||""),
          market: o.market||"",
          currency: o.currency||"",
          amount: U.num(r.amount),
          discount: U.num(r.discount),
          buyer_fee_orig: U.num(r.buyerCommOrig),
          fx: U.num(r.fx),
          principal_cny: U.num(r.principalCny),
          commission_cny: U.num(r.commCny),
          total_cny: U.num(r.totalCny)
        });
      }

      // create batch record for list/export/delete rollback
      S.payoutBatches = S.payoutBatches || [];
      const batch = {
        id: batchId,
        date,
        method,
        note,
        createdAt: Date.now(),
        orderIds,
        totalCny: U.round2 ? U.round2(totalCny) : totalCny,
        principalCny: U.round2 ? U.round2(totalPrincipal) : totalPrincipal,
        commissionCny: U.round2 ? U.round2(totalComm) : totalComm,
        fx,
        orders: batchOrders
      };
      S.payoutBatches.unshift(batch);

      // persist payout snapshot (small, safe)
      if(typeof persistPayoutSnapshot==="function") persistPayoutSnapshot();

      // cleanup UI selection + close
      UI.payoutSelected = new Set();
      renderPayoutSelectedTags();
      if(typeof closePayoutModal==="function") closePayoutModal();

      // re-render payout page/batch list if present
      try{
        if(typeof renderPayoutPage==="function") renderPayoutPage();
        if(typeof renderPayoutBatches==="function") renderPayoutBatches();
      }catch(e){}

      // feedback
      if(typeof toast==="function") toast(`已确认返款：${batchId}（${orderIds.length} 单）`);
      else alert(`已确认返款：${batchId}（${orderIds.length} 单）`);

    }catch(e){
      console.error(e);
      alert("确认返款失败：" + (e?.message||e));
    }
  };
}

if(typeof window.exportPayoutModalCSV !== "function"){
  window.exportPayoutModalCSV = function exportPayoutModalCSV(){
    try{
      const M = (state && state._payoutModal) ? state._payoutModal : {};
      const rows = Array.isArray(M.rows) ? M.rows : [];
      if(!rows.length){
        alert("无可导出的明细。");
        return;
      }
      const headers = ["订单号","产品名称","卖家","回评类型","国家","币种","金额(原币)","折扣(原币)","买手佣金(原币)","FX","本金(CNY)","佣金(CNY)","本佣(CNY)"];
      const lines = [headers.join(",")];
      for(const r of rows){
        const o = r.order || r.o || {};
        const orderNo = (o.orderId||o.order_no||o.orderNo||o.order_id||"");
        const productName = (o.productName||o.product_name||o.name||"");
        const seller = (o.sellerName||o.seller||"");
        const reviewType = (o.reviewType||o.review_type||"");
        const country = (o.market||o.country||"");
        const currency = (o.currency||"");
        const vals = [
          orderNo,
          productName,
          seller,
          reviewType,
          country,
          currency,
          U.num(r.amount).toFixed(2),
          U.num(r.discount).toFixed(2),
          U.num(r.buyerCommOrig).toFixed(2),
          U.num(r.fx).toFixed(6),
          U.num(r.principalCny).toFixed(2),
          U.num(r.commCny).toFixed(2),
          U.num(r.totalCny).toFixed(2)
        ].map(x=>`"${String(x).replaceAll('"','""')}"`);
        lines.push(vals.join(","));
      }
      const csv = "\ufeff" + lines.join("\n");
      const fn = `payout_modal_${new Date().toISOString().slice(0,10)}.csv`;
      U.download(fn, csv, "text/csv");
    }catch(e){
      console.error(e);
      alert("导出失败：" + (e?.message||e));
    }
  };
}

// --- PATCH v6: delegated handlers for payout buttons (prevents 'no reaction' when binding missed)
(async function(){
  document.addEventListener('click', function(ev){
    const t = ev.target;
    const bulk = t && t.closest ? t.closest('#payoutOpenModal') : null;
    if(bulk){
      ev.preventDefault();
      try{ openPayoutModal(); }catch(e){ alert("打开返款弹窗失败：" + (e?.message||e)); }
      return;
    }
    const singleBtn = t && t.closest ? t.closest('[data-payout-single]') : null;
    if(singleBtn){
      ev.preventDefault();
      const oid = singleBtn.getAttribute('data-payout-single');
      try{ openSinglePayoutModal(oid); }catch(e){ alert("打开单笔返款弹窗失败：" + (e?.message||e)); }
      return;
    }
    const viewBtn = t && t.closest ? t.closest('[data-payout-view]') : null;
    if(viewBtn){
      ev.preventDefault();
      const oid = viewBtn.getAttribute('data-payout-view');
      try{ openPayoutViewModal(oid); }catch(e){ alert("打开返款详情失败：" + (e?.message||e)); }
      return;
    }
  }, true);
})();

</script>


<!-- Delete confirm modal (safer delete) -->
<div class="modal" id="delModal" style="display:none;z-index:9999">
  <div class="modal-card" style="max-width:520px">
    <div class="modal-head">
      <div class="modal-title">确认删除</div>
      <button class="btn" id="delCloseBtn">关闭</button>
    </div>
    <div class="small" style="margin-top:8px;line-height:1.6">
      该操作不可恢复。为避免误删，请勾选确认后再删除。
    </div>
    <div style="margin-top:12px;border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--soft)">
      <div class="row" style="align-items:flex-start">
        <input type="checkbox" id="delAck" style="width:16px;height:16px;margin-top:2px"/>
        <label for="delAck" style="color:var(--text);font-size:13px">我确认要删除该订单（不可恢复）</label>
      </div>
      <div class="small" id="delInfo" style="margin-top:8px;color:var(--muted)"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="delCancelBtn">取消</button>
      <button class="btn danger" id="delOkBtn" disabled>确认删除</button>
    </div>
  </div>
</div>


<script>
(async function(){
  function setTopbarHeight(){
    var el=document.querySelector('.topbar');
    if(!el) return;
    var h=Math.ceil(el.getBoundingClientRect().height||0);
    if(h>0) document.documentElement.style.setProperty('--topbarH', h+'px');
  }
  window.addEventListener('load', setTopbarHeight);
  window.addEventListener('resize', function(){ setTimeout(setTopbarHeight, 50); });
})();
</script>


<script>
(async function(){
  function adjustTopbarSpacer(){
    var tb = document.querySelector('.topbar');
    if(!tb) return;
    var h = tb.getBoundingClientRect().height || tb.offsetHeight || 0;
    if(h<40) h = 40;
    document.documentElement.style.setProperty('--topbar-h', h+'px');
    document.body.style.paddingTop = h+'px';
  }
  window.addEventListener('resize', adjustTopbarSpacer);
  document.addEventListener('DOMContentLoaded', adjustTopbarSpacer);
  // also run soon after any tab switch that may change topbar height
  window.addEventListener('hashchange', function(){ setTimeout(adjustTopbarSpacer, 0); });
  setTimeout(adjustTopbarSpacer, 0);
})();

// ===== v9m: 计算置顶栏高度，避免遮挡/留白 =====
function applyTopbarOffset(){
  const tb = document.querySelector('.topbar');
  if(!tb) return;
  const h = tb.getBoundingClientRect().height || tb.offsetHeight || 0;
  document.documentElement.style.setProperty('--topbar-h', Math.ceil(h) + 'px');
}
window.addEventListener('resize', ()=>{ try{ applyTopbarOffset(); }catch(e){} });

</script>


<script>
/* ===== Cloud Snapshot Stable Module (v15) ===== */
(async function(){
  const CFG_KEY = "OPS_CLOUD_CFG_V1";
  function toast(msg){ try{ if(window.toast) return window.toast(msg); }catch(e){} try{ alert(msg); }catch(e){} }
  // 兼容历史字段：app_key / appKey
  function loadCfg(){
    try{
      const raw = localStorage.getItem(CFG_KEY);
      if(!raw) return null;
      const o = JSON.parse(raw);
      if(!o || !o.url || !o.anon) return null;
      const appKey = (o.appKey || o.app_key || o.appkey || o.app || "").toString().trim();
      if(!appKey) return null;
      return { url: (o.url||"").toString().trim(), anon: (o.anon||"").toString().trim(), appKey };
    }catch(e){ return null; }
  }
  function saveCfg(cfg){
    // 同时写入 appKey 与 app_key，避免其它旧模块读取不到
    const appKey = (cfg && (cfg.appKey || cfg.app_key) || "").toString().trim();
    const out = { url: (cfg.url||"").toString().trim(), anon: (cfg.anon||"").toString().trim(), appKey, app_key: appKey };
    localStorage.setItem(CFG_KEY, JSON.stringify(out));
  }
  function ensureClient(){
    const cfg = loadCfg();
    if(!cfg){ toast("请先设置云端（Supabase URL / anon key / app_key）"); return null; }
    // reuse singleton for same url/anon
    if(window.__OPS_SB_SINGLETON__ && window.__OPS_SB_SINGLETON__.cfg &&
       window.__OPS_SB_SINGLETON__.cfg.url===cfg.url && window.__OPS_SB_SINGLETON__.cfg.anon===cfg.anon){
      return { client: window.__OPS_SB_SINGLETON__.client, cfg };
    }
    const supa = window.supabase;
    if(!supa || !supa.createClient){ toast("Supabase SDK 未加载"); return null; }
    const client = supa.createClient(cfg.url, cfg.anon, {
      auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
    });
    window.__OPS_SB_SINGLETON__ = { client, cfg: { url: cfg.url, anon: cfg.anon } };
    return { client, cfg };
  }
  function countAny(payload, keys){
    for(const k of keys){
      const v = payload ? payload[k] : null;
      if(Array.isArray(v)) return v.length;
      if(v && typeof v === "object") return Object.keys(v).length;
    }
    return 0;
  }
    function _extractMainStateFromPayload(payload){
    // 支持多种形态：
    // 1) 直接是 state：{sellers, products, orders, batches...}
    // 2) 包裹形态：{payload:{...}} 或 {v, state:{ok, items:[{key:'main_state_v1', value:{key, value:STATE}}]}}
    if(!payload) return null;

    // payload.payload 递归
    if(payload.payload && typeof payload.payload === "object"){
      const inner = _extractMainStateFromPayload(payload.payload);
      if(inner) return inner;
    }

    // Supabase 存储的 v/state/items 结构
    const st = payload.state;
    if(st && Array.isArray(st.items)){
      // 期望 items: [{key:'main_state_v1', value:{key:'main_state_v1', value: STATE}}]
      const hit = st.items.find(it => it && (it.key === "main_state_v1" || it.key === "main_state" || it.key === "main_state_v1 "));
      if(hit){
        const v = hit.value;
        if(v && typeof v === "object"){
          // value 可能是 {key, value:STATE} 或直接 STATE
          if(v.value && typeof v.value === "object") return v.value;
          return v;
        }
      }
      // 如果没命中，也可能直接把 STATE 放到了 state 上
      if(st.data && typeof st.data === "object") return st.data;
    }

    // 直接是 STATE
    if(typeof payload === "object" && (payload.sellers || payload.products || payload.orders || payload.batches)){
      return payload;
    }

    // 兜底：常见嵌套字段
    for(const k of ["main","data","state","snapshot","doc"]){
      if(payload[k] && typeof payload[k] === "object"){
        const inner = _extractMainStateFromPayload(payload[k]);
        if(inner) return inner;
      }
    }

    return null;
  }

  function counts(payload){
    const state = _extractMainStateFromPayload(payload) || payload || {};
    return {
      sellers: countAny(state, ["sellers","sellerList","sellerRows","vendors"]),
      products: countAny(state, ["products","productList","productRows","items"]),
      orders: countAny(state, ["orders","orderList","orderRows"]),
      batches: countAny(state, ["batches","batchList","settleBatches","settlementBatches","payoutBatches"])
    };
  }

  async function cloudPromptAndSave(){
    const cur = loadCfg() || { url:"", anon:"", appKey:"dalemy" };
    const url = prompt("Supabase Project URL（形如 https://xxxx.supabase.co ）", cur.url||"");
    if(url===null) return;
    const anon = prompt("Supabase anon key（Project Settings → API）", cur.anon||"");
    if(anon===null) return;
    const appKey = prompt("app_key（你自己定义的唯一标识，同一项目多设备要一致）", cur.appKey||"dalemy");
    if(appKey===null) return;
    saveCfg({ url:url.trim(), anon:anon.trim(), appKey:appKey.trim() });
    toast("已保存云端设置");
  }

  async function cloudStatus(){
    const wrap = ensureClient();
    if(!wrap) return;
    const { client, cfg } = wrap;
    try{
      const { data, error } = await client.from("ops_cloud_snapshots_v1")
        .select("payload,hash,updated_at,created_at")
        .eq("app_key", cfg.appKey)
        .maybeSingle();
      if(error) throw error;
      if(!data){ alert("云端暂无快照（app_key="+cfg.appKey+"）"); return; }
      const p = data.payload || {};
      const c = counts(p);
      alert(
        "云端快照状态\n\n"
        + "app_key: " + cfg.appKey + "\n"
        + "hash: " + (data.hash||"") + "\n"
        + "updated_at: " + (data.updated_at||"") + "\n"
        + "created_at: " + (data.created_at||"") + "\n\n"
        + "内容统计：卖家" + c.sellers + " 产品" + c.products + " 订单" + c.orders + " 批次" + c.batches
      );
    }catch(e){
      alert("云端状态失败：\n" + (e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPush(){
    const wrap = ensureClient();
    if(!wrap) return;
    const { client, cfg } = wrap;

    // Our local state is global S in this system.
    const payload = window.S || {};
    const c = counts(payload);
    if(c.sellers===0 && c.products===0 && c.orders===0 && c.batches===0){
      const ok = confirm("警告：当前本地数据为 0（卖家/产品/订单/批次均为空）。\n\n继续“云端推送”会覆盖云端快照为“空”，可能导致无法恢复。\n\n仍要继续推送吗？");
      if(!ok) return;
    }

    const hash = String(Date.now());
    const row = { app_key: cfg.appKey, payload, hash, updated_at: new Date().toISOString() };
    try{
      const { error } = await client.from("ops_cloud_snapshots_v1").upsert(row, { onConflict:"app_key" });
      if(error) throw error;

      // history copy (best effort)
      try{
        const histKey = cfg.appKey + "__H__" + new Date().toISOString().replace(/[:.]/g,"-");
        await client.from("ops_cloud_snapshots_v1").insert({ app_key: histKey, payload, hash, updated_at: row.updated_at });
      }catch(_e){}

      toast("云端推送成功：卖家"+c.sellers+" 产品"+c.products+" 订单"+c.orders+" 批次"+c.batches+"（hash="+hash+"）");
    }catch(e){
      alert("云端推送失败：\n" + (e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPull(){
    const wrap = ensureClient();
    if(!wrap) return;
    const { client, cfg } = wrap;
    try{
      const { data, error } = await client.from("ops_cloud_snapshots_v1")
        .select("payload,hash,updated_at,created_at")
        .eq("app_key", cfg.appKey)
        .maybeSingle();
      if(error) throw error;
      if(!data || !data.payload){ alert("云端暂无可用快照（app_key="+cfg.appKey+"）"); return; }

      // backup current local snapshot (best effort)
      try{ localStorage.setItem("OPS_LOCAL_BEFORE_CLOUD_PULL_"+Date.now(), JSON.stringify(window.S||{}, null, 0)); }catch(e){}

      // restore
      window.S = data.payload;
      // persist + rerender using existing system hooks if available
      try{ if(window.saveNow) window.saveNow(); }catch(e){}
      try{ if(window.scheduleRender) window.scheduleRender(); }catch(e){}
      try{ if(window.renderAll) window.renderAll(); }catch(e){}
      // fallbacks: reload
      try{ if(!window.renderAll) location.reload(); }catch(e){}

      const c = counts(window.S||{});
      toast("云端拉取完成：卖家"+c.sellers+" 产品"+c.products+" 订单"+c.orders+" 批次"+c.batches+"（hash="+(data.hash||"") +"）");
    }catch(e){
      alert("云端拉取失败：\n" + (e && e.message ? e.message : String(e)));
    }
  }

  // Expose and bind
  window.cloudPromptAndSave = cloudPromptAndSave;
  window.cloudStatus = cloudStatus;
  window.cloudPush = cloudPush;
  window.cloudPull = cloudPull;

  window.addEventListener("load", ()=>{
    const cfgBtn = document.getElementById("btnCloudCfg");
    const pushBtn = document.getElementById("btnCloudPush");
    const pullBtn = document.getElementById("btnCloudPull");
    const statusBtn = document.getElementById("btnCloudStatus");
    if(cfgBtn) cfgBtn.onclick = cloudPromptAndSave;
    if(pushBtn) pushBtn.onclick = ()=> cloudPush();
    if(pullBtn) pullBtn.onclick = ()=> cloudPull();
    if(statusBtn) statusBtn.onclick = ()=> cloudStatus();
  });
})();

// ===================== DOM -> Main Snapshot Sync (V20) =====================
// Goal: When UI shows orders but canonical snapshot is empty, extract rows from the orders table
// and write them into localStorage key `ops_rebuild_v6_4_2_state` to align with cloud push/pull.

function _findOrdersTable(){
  const tab = document.getElementById("tab-orders") || document.querySelector('[data-tab="orders"]') || document.body;
  // Prefer the table that has a header containing '订单号'
  const tables = Array.from(tab.querySelectorAll("table"));
  for(const t of tables){
    const ths = Array.from(t.querySelectorAll("thead th")).map(x => (x.innerText||"").trim());
    if(ths.some(h => h.includes("订单号"))) return t;
  }
  return tables[0] || null;
}

function _extractOrdersFromOrdersTable(){
  const table = _findOrdersTable();
  if(!table) return { ok:false, reason:"no_table", orders:[], meta:{} };

  const headers = Array.from(table.querySelectorAll("thead th")).map(x => (x.innerText||"").trim());
  const idx = (name)=>{
    const i = headers.findIndex(h => h === name || h.includes(name));
    return i;
  };

  // Determine column indices by header labels (robust against checkbox column shifts)
  const iDate = idx("日期");
  const iOrder = idx("订单号");
  const iSeller = idx("卖家");
  const iCountry = idx("国家");
  const iProduct = idx("产品");
  const iAsin = idx("ASIN");
  const iReview = idx("回评"); // optional

  const rows = Array.from(table.querySelectorAll("tbody tr")).filter(tr => tr.querySelectorAll("td").length >= 3);

  const orders = [];
  for(const tr of rows){
    const tds = Array.from(tr.querySelectorAll("td")).map(td => (td.innerText||"").trim());
    // Guard: placeholder
    if(tds.join("").includes("暂无订单")) continue;

    const orderNo = (iOrder>=0 && tds[iOrder]) ? tds[iOrder] : "";
    if(!orderNo) continue;

    const date = (iDate>=0 && tds[iDate]) ? tds[iDate] : "";
    const sellerName = (iSeller>=0 && tds[iSeller]) ? tds[iSeller] : "";
    const country = (iCountry>=0 && tds[iCountry]) ? tds[iCountry] : "";
    const productName = (iProduct>=0 && tds[iProduct]) ? tds[iProduct] : "";
    const asin = (iAsin>=0 && tds[iAsin]) ? tds[iAsin] : "";
    const reviewStatus = (iReview>=0 && tds[iReview]) ? tds[iReview] : "";

    orders.push({
      id: "dom_" + orderNo,
      orderNo,
      date,
      sellerName,
      country,
      productName,
      asin,
      reviewStatus,
      created_at: Date.now()
    });
  }

  return { ok:true, orders, meta:{ headers, iDate, iOrder, iSeller, iCountry, iProduct, iAsin, iReview } };
}

function _readCanonicalSnapshot(){
  try{
    const raw = localStorage.getItem("ops_rebuild_v6_4_2_state");
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(_e){ return null; }
}

function _writeCanonicalSnapshot(obj){
  localStorage.setItem("ops_rebuild_v6_4_2_state", JSON.stringify(obj));
}

function syncMainStateFromDOM(){
  try{
    const ex = _extractOrdersFromOrdersTable();
    if(!ex.ok){
      alert("同步主数据失败：未找到订单表格（请先切到【订单】页并滚动到订单列表区域）。");
      return null;
    }
    if(ex.orders.length === 0){
      alert("同步主数据失败：订单表格未解析到任何订单行。");
      return null;
    }

    const cur = _readCanonicalSnapshot() || {};
    // Preserve other modules if present; only replace orders with extracted ones.
    const next = Object.assign({}, cur, { orders: ex.orders });
    _writeCanonicalSnapshot(next);

    // Best-effort: keep in-memory references consistent if this build uses S/state
    try{ if(typeof window!=="undefined" && window.S){ window.S.orders = ex.orders; } }catch(_e){}
    try{ if(typeof window!=="undefined" && window.state){ window.state.orders = ex.orders; } }catch(_e){}

    toast(`主数据已同步：订单${ex.orders.length}（已写入主快照 ops_rebuild_v6_4_2_state）`);
    return { orders: ex.orders.length, meta: ex.meta };
  }catch(e){
    console.error(e);
    alert("同步主数据失败：\n" + (e && e.message ? e.message : String(e)));
    return null;
  }
}

// Bind the button (override any previous binding)
(async function(){
  const bind = ()=>{
    const btn = document.getElementById("btnSyncMainState");
    if(btn){
      btn.onclick = ()=>syncMainStateFromDOM();
    }
  };
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bind);
  }else{
    bind();
  }
})();

</script>


<script>
/* ===================== CLOUD_V23 (final, snapshot-first) =====================
   - Always builds push payload from canonical snapshot key `ops_rebuild_v6_4_2_state` if present.
   - Normalizes keys and counts.
   - Cloud status shows both remote counts and which local source would be used for push.
============================================================================= */

(async function(){
  function _pickCount(v){
    if(Array.isArray(v)) return v.length;
    if(v && typeof v==="object") return Object.keys(v).length;
    return 0;
  }

  function _readLS(key){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(_e){ return null; }
  }

  function _normalizePayload(src){
    const p = (src && typeof src==="object") ? JSON.parse(JSON.stringify(src)) : {};
    // normalize arrays
    const sellers = p.sellers ?? p.sellerList ?? p.sellerRows ?? p.seller_items ?? p.sellerItems ?? p.vendors;
    const products = p.products ?? p.productList ?? p.productRows ?? p.product_items ?? p.productItems ?? p.items;
    const orders = p.orders ?? p.orderList ?? p.orderRows ?? p.order_items ?? p.orderItems;
    const batches = p.batches ?? p.batchList ?? p.settleBatches ?? p.settlementBatches ?? p.payoutBatches ?? p.payout_batches;

    p.sellers = Array.isArray(sellers) ? sellers : (sellers && typeof sellers==="object" ? Object.values(sellers) : []);
    p.products = Array.isArray(products) ? products : (products && typeof products==="object" ? Object.values(products) : []);
    p.orders = Array.isArray(orders) ? orders : (orders && typeof orders==="object" ? Object.values(orders) : []);
    p.batches = Array.isArray(batches) ? batches : (batches && typeof batches==="object" ? Object.values(batches) : []);
    return p;
  }

  function _localSourceForPush(){
    const ls = _readLS("ops_rebuild_v6_4_2_state");
    const mem = (window.state && typeof window.state==="object") ? window.state : (window.S && typeof window.S==="object" ? window.S : null);

    const nLS = _normalizePayload(ls);
    const nMem = _normalizePayload(mem);

    const sLS = _pickCount(nLS.orders)+_pickCount(nLS.sellers)+_pickCount(nLS.products)+_pickCount(nLS.batches);
    const sMem = _pickCount(nMem.orders)+_pickCount(nMem.sellers)+_pickCount(nMem.products)+_pickCount(nMem.batches);

    if(sLS >= sMem && sLS > 0) return { name:`localStorage ops_rebuild_v6_4_2_state (score=${sLS})`, payload:nLS };
    if(sMem > 0) return { name:`memory state/S (score=${sMem})`, payload:nMem };
    return { name:"none (score=0)", payload:_normalizePayload({}) };
  }

  function _getCloudWrap(){
    // Reuse existing helper if present
    try{
      if(typeof getCloudClientOrNull === "function"){
        const w = getCloudClientOrNull();
        // Some builds return client directly; normalize.
        if(w && typeof w.from === "function") return { client:w, cfg:(typeof getCloudCfgOrNull==="function"?getCloudCfgOrNull():null) };
        if(w && w.client) return w;
      }
    }catch(_e){}
    if(!quiet) alert("云端未配置：请先点【云端设置】填写 Supabase URL/AnonKey/app_key。");
    return null;
  }

  async function cloudStatusV23(){
    const wrap = _getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){
      alert("云端未配置：缺少 app_key（请点【云端设置】）。");
      return;
    }
    try{
      const { data, error } = await client.from("ops_cloud_snapshots_v1").select("*").eq("app_key", cfg.app_key).maybeSingle();
      if(error) throw error;
      if(!data){
        alert("云端暂无快照（app_key="+cfg.app_key+"）。");
        return;
      }
      let p = null;
      try{ p = (typeof data.payload === "string") ? JSON.parse(data.payload) : data.payload; }catch(_e){ p = null; }
      const np = _normalizePayload(p||{});
      const rc = { sellers:_pickCount(np.sellers), products:_pickCount(np.products), orders:_pickCount(np.orders), batches:_pickCount(np.batches) };

      const local = _localSourceForPush();
      const lc = { sellers:_pickCount(local.payload.sellers), products:_pickCount(local.payload.products), orders:_pickCount(local.payload.orders), batches:_pickCount(local.payload.batches) };

      alert(
        "云端快照状态\n\n"+
        "app_key: "+cfg.app_key+"\n"+
        "hash: "+(data.hash||"")+"\n"+
        "updated_at: "+(data.updated_at||"")+"\n"+
        "created_at: "+(data.created_at||"")+"\n\n"+
        "云端内容统计：卖家"+rc.sellers+" 产品"+rc.products+" 订单"+rc.orders+" 批次"+rc.batches+"\n\n"+
        "本地将用于推送的数据源：\n"+local.name+"\n"+
        "本地内容统计：卖家"+lc.sellers+" 产品"+lc.products+" 订单"+lc.orders+" 批次"+lc.batches
      );
    }catch(e){
      console.error(e);
      alert("云端状态失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPushV23(){
    const wrap = _getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){
      alert("云端未配置：缺少 app_key（请点【云端设置】）。");
      return;
    }

    const local = _localSourceForPush();
    const p = local.payload;
    const sc=_pickCount(p.sellers), pc=_pickCount(p.products), oc=_pickCount(p.orders), bc=_pickCount(p.batches);

    if(sc===0 && pc===0 && oc===0 && bc===0){
      const ok = confirm("警告：当前本地数据为 0（卖家/产品/订单/批次均为空）。\n数据源："+local.name+"\n\n继续“云端推送”会覆盖云端快照为“空”，可能导致无法恢复。\n\n仍要继续推送吗？");
      if(!ok) return;
    }

    try{
      const payloadStr = JSON.stringify(p);
      // hash: reuse existing simple hash if present
      const hash = String(Date.now());
      const row = { app_key: cfg.app_key, payload: payloadStr, hash };
      const { error } = await client.from("ops_cloud_snapshots_v1").upsert(row, { onConflict:"app_key" });
      if(error) throw error;
      toast(`云端推送成功：卖家${sc} 产品${pc} 订单${oc} 批次${bc}（hash=${hash}）`);
    }catch(e){
      console.error(e);
      alert("云端推送失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPullV23(){
    const wrap = _getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){
      alert("云端未配置：缺少 app_key（请点【云端设置】）。");
      return;
    }
    try{
      const { data, error } = await client.from("ops_cloud_snapshots_v1").select("*").eq("app_key", cfg.app_key).maybeSingle();
      if(error) throw error;
      if(!data){ alert("云端暂无快照（app_key="+cfg.app_key+"）。"); return; }
      let p = null;
      try{ p = (typeof data.payload === "string") ? JSON.parse(data.payload) : data.payload; }catch(_e){ p = null; }
      if(!p){ alert("云端快照 payload 为空或解析失败。"); return; }
      localStorage.setItem("ops_rebuild_v6_4_2_state", JSON.stringify(p));
      toast("云端拉取完成：已写入主快照 ops_rebuild_v6_4_2_state");
      // Best-effort reload
      try{ location.reload(); }catch(_e){}
    }catch(e){
      console.error(e);
      alert("云端拉取失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  // Rebind buttons to V23 handlers
  function _rebind(){
    const bPush = document.getElementById("btnCloudPush");
    const bPull = document.getElementById("btnCloudPull");
    const bStatus = document.getElementById("btnCloudStatus");
    if(bPush) bPush.onclick = ()=>cloudPushV23();
    if(bPull) bPull.onclick = ()=>cloudPullV23();
    if(bStatus) bStatus.onclick = ()=>cloudStatusV23();
  }
  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", _rebind);
  else _rebind();

  // Expose for debugging
  window.__cloudV23__ = { cloudStatusV23, cloudPushV23, cloudPullV23, _localSourceForPush };
})();
</script>


<script>
/* ===================== CLOUD_V25 (IndexedDB-first + optional gzip) =====================
   Problem fixed:
   - Your real data (15k+ orders) is stored in IndexedDB (ops_v642_main / key main_state_v1),
     not in localStorage ops_rebuild_v6_4_2_state. Previous cloud code read the wrong source,
     so it always pushed 0.
   What V25 does:
   - Read local payload from IndexedDB main_state_v1 (idbGet) as the single source of truth.
   - Push/pull writes back to IndexedDB, then refresh.
   - Optional gzip+base64 packaging to reduce payload size when pushing large snapshots.
======================================================================================== */

(async function(){
  function _pickCount(v){
    if(Array.isArray(v)) return v.length;
    if(v && typeof v==="object") return Object.keys(v).length;
    return 0;
  }
  function _normState(s){
    const p = (s && typeof s==="object") ? s : {};
    return {
      sellers: Array.isArray(p.sellers) ? p.sellers : [],
      products: Array.isArray(p.products) ? p.products : [],
      orders: Array.isArray(p.orders) ? p.orders : [],
      batches: Array.isArray(p.batches) ? p.batches : []
    };
  }
  function _bytesOf(str){
    try{ return new Blob([str]).size; }catch(_e){ return str.length; }
  }

  async function _getLocalStateFromIDB(){
    // Uses functions already in your system: idbGet/openMainDB
    try{
      if(typeof idbGet === "function" && typeof MAIN_STATE_KEY !== "undefined"){
        const s = await idbGet(MAIN_STATE_KEY);
        return { src: `IndexedDB ${MAIN_DB_NAME}/${MAIN_STATE_KEY}`, state: s || null };
      }
    }catch(e){ console.error(e); }
    // Fallbacks (should not be used in your dataset scale)
    try{
      const raw = localStorage.getItem("ops_rebuild_v6_4_2_state");
      if(raw) return { src:"localStorage ops_rebuild_v6_4_2_state", state: JSON.parse(raw) };
    }catch(_e){}
    if(window.state) return { src:"memory window.state", state: window.state };
    if(window.S) return { src:"memory window.S", state: window.S };
    return { src:"none", state: null };
  }

  async function _encodePayload(obj){
    const json = JSON.stringify(obj);
    const bytes = _bytesOf(json);

    // Use gzip if available and payload is large
    const canGzip = (typeof CompressionStream !== "undefined") && (typeof DecompressionStream !== "undefined");
    if(canGzip && bytes > 1024*1024){ // > 1MB
      const cs = new CompressionStream("gzip");
      const ab = await new Response(new Blob([json]).stream().pipeThrough(cs)).arrayBuffer();
      const u8 = new Uint8Array(ab);
      let bin = "";
      const chunk = 0x8000;
      for(let i=0;i<u8.length;i+=chunk){
        bin += String.fromCharCode.apply(null, u8.subarray(i, i+chunk));
      }
      const b64 = btoa(bin);
      const env = { enc:"gzip-base64", raw_bytes: bytes, data: b64 };
      return { env, bytes_before: bytes, bytes_after: _bytesOf(JSON.stringify(env)) };
    }
    return { env:{ enc:"json", data: json }, bytes_before: bytes, bytes_after: bytes };
  }

  async function _decodePayload(payloadField){
    // payloadField is whatever stored in ops_cloud_snapshots_v1.payload (string)
    if(!payloadField) return null;
    let env = null;
    try{ env = JSON.parse(payloadField); }catch(_e){ env = null; }
    if(!env || !env.enc){
      // old format: raw json string
      try{ return JSON.parse(payloadField); }catch(_e){ return null; }
    }
    if(env.enc === "json"){
      try{ return JSON.parse(env.data); }catch(_e){ return null; }
    }
    if(env.enc === "gzip-base64"){
      try{
        const bin = atob(env.data);
        const u8 = new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
        const ds = new DecompressionStream("gzip");
        const text = await new Response(new Blob([u8]).stream().pipeThrough(ds)).text();
        return JSON.parse(text);
      }catch(e){
        console.error(e);
        return null;
      }
    }
    return null;
  }

  function _getCloudWrap(){
    try{
      if(typeof getCloudClientOrNull === "function"){
        const w = getCloudClientOrNull();
        if(w && typeof w.from === "function"){
          const cfg = (typeof getCloudCfgOrNull==="function") ? getCloudCfgOrNull() : null;
          return { client:w, cfg };
        }
        if(w && w.client) return w;
      }
    }catch(_e){}
    if(!quiet) alert("云端未配置：请先点【云端设置】填写 Supabase URL/AnonKey/app_key。");
    return null;
  }

  async function cloudStatusV25(){
    const wrap = _getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    // Local
    const loc = await _getLocalStateFromIDB();
    const ns = _normState(loc.state);
    const lc = { sellers:_pickCount(ns.sellers), products:_pickCount(ns.products), orders:_pickCount(ns.orders), batches:_pickCount(ns.batches) };

    // Remote
    try{
      const { data, error } = await client.from("ops_cloud_snapshots_v1").select("*").eq("app_key", cfg.app_key).maybeSingle();
      if(error) throw error;
      if(!data){
        alert(
          "云端快照状态（无快照）\n\n"+
          "app_key: "+cfg.app_key+"\n\n"+
          "本地数据源："+loc.src+"\n"+
          "本地内容统计：卖家"+lc.sellers+" 产品"+lc.products+" 订单"+lc.orders+" 批次"+lc.batches+"\n\n"+
          "提示：可直接点【云端推送】上传当前 IndexedDB 主库数据。"
        );
        return;
      }
      const remoteObj = await _decodePayload(data.payload);
      const rn = _normState(remoteObj);
      const rc = { sellers:_pickCount(rn.sellers), products:_pickCount(rn.products), orders:_pickCount(rn.orders), batches:_pickCount(rn.batches) };

      alert(
        "云端快照状态\n\n"+
        "app_key: "+cfg.app_key+"\n"+
        "hash: "+(data.hash||"")+"\n"+
        "updated_at: "+(data.updated_at||"")+"\n"+
        "created_at: "+(data.created_at||"")+"\n\n"+
        "云端内容统计：卖家"+rc.sellers+" 产品"+rc.products+" 订单"+rc.orders+" 批次"+rc.batches+"\n\n"+
        "本地数据源："+loc.src+"\n"+
        "本地内容统计：卖家"+lc.sellers+" 产品"+lc.products+" 订单"+lc.orders+" 批次"+lc.batches
      );
    }catch(e){
      console.error(e);
      alert("云端状态失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPushV25(){
    const wrap = _getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    const loc = await _getLocalStateFromIDB();
    const ns = _normState(loc.state);
    const sc=_pickCount(ns.sellers), pc=_pickCount(ns.products), oc=_pickCount(ns.orders), bc=_pickCount(ns.batches);

    if(sc===0 && pc===0 && oc===0 && bc===0){
      const ok = confirm("警告：当前本地数据为 0（卖家/产品/订单/批次均为空）。\n数据源："+loc.src+"\n\n继续“云端推送”会覆盖云端快照为“空”，可能导致无法恢复。\n\n仍要继续推送吗？");
      if(!ok) return;
    }

    try{
      const pack = await _encodePayload(ns);
      const hash = String(Date.now());
      const row = { app_key: cfg.app_key, payload: JSON.stringify(pack.env), hash };
      const { error } = await client.from("ops_cloud_snapshots_v1").upsert(row, { onConflict:"app_key" });
      if(error) throw error;

      toast(`云端推送成功：卖家${sc} 产品${pc} 订单${oc} 批次${bc}（hash=${hash}）`);
    }catch(e){
      console.error(e);
      alert("云端推送失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPullV25(){
    const wrap = _getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    try{
      const { data, error } = await client.from("ops_cloud_snapshots_v1").select("*").eq("app_key", cfg.app_key).maybeSingle();
      if(error) throw error;
      if(!data){ alert("云端暂无快照（app_key="+cfg.app_key+"）。"); return; }

      const obj = await _decodePayload(data.payload);
      if(!obj){ alert("云端快照 payload 为空或解析失败。"); return; }

      if(typeof idbSet === "function" && typeof MAIN_STATE_KEY !== "undefined"){
        await idbSet(MAIN_STATE_KEY, obj);
        toast("云端拉取完成：已写入 IndexedDB 主库（main_state_v1），即将刷新。");
        try{ location.reload(); }catch(_e){}
        return;
      }
      // fallback
      localStorage.setItem("ops_rebuild_v6_4_2_state", JSON.stringify(obj));
      toast("云端拉取完成：已写入 localStorage 主快照（兜底），即将刷新。");
      try{ location.reload(); }catch(_e){}
    }catch(e){
      console.error(e);
      alert("云端拉取失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  // Rebind UI buttons to V25
  function _rebind(){
    const bPush = document.getElementById("btnCloudPush");
    const bPull = document.getElementById("btnCloudPull");
    const bStatus = document.getElementById("btnCloudStatus");
    if(bPush) bPush.onclick = ()=>cloudPushV25();
    if(bPull) bPull.onclick = ()=>cloudPullV25();
    if(bStatus) bStatus.onclick = ()=>cloudStatusV25();
  }
  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", _rebind);
  else _rebind();

  window.__cloudV25__ = { cloudStatusV25, cloudPushV25, cloudPullV25, _getLocalStateFromIDB };
})();
</script>


<script>
/* ===================== CLOUD_V30 (IDB diagnose + split-store assemble) =====================
Fix target:
- Your real dataset is NOT in one "main_state_v1" object. It is likely split across stores
  (orders/products/sellers/batches), so prior "read one state object" returns empty -> push 0.
What V30 does:
1) Add a "诊断本地库" button to show IndexedDB databases/stores and record counts.
2) When pushing, it tries to auto-assemble a snapshot from split stores in the best-matching DB.
   - It picks the DB where stores matching keywords have the largest total record count.
   - Then reads all records from those stores and builds {sellers,products,orders,batches}.
3) Rebind 云端状态/推送/拉取 to V30.
=========================================================================================== */
(async function(){
  function toastSafe(msg){
    try{ if(typeof toast==="function") return toast(msg); }catch(e){}
    try{ console.log("[TOAST]", msg); }catch(e){}
    alert(msg);
  }
  function pickCount(v){
    if(Array.isArray(v)) return v.length;
    if(v && typeof v === "object") return Object.keys(v).length;
    return 0;
  }
  function isObj(x){ return x && typeof x==="object"; }

  function kwType(storeName){
    var n = (storeName||"").toLowerCase();
    if(/seller|vendor/.test(n)) return "sellers";
    if(/product|item/.test(n)) return "products";
    if(/order/.test(n)) return "orders";
    if(/batch|payout|settle/.test(n)) return "batches";
    return null;
  }

  async function idbOpen(name){
    return await new Promise(function(resolve){
      try{
        var req = indexedDB.open(name);
        req.onsuccess = function(){ resolve(req.result); };
        req.onerror = function(){ resolve(null); };
        req.onupgradeneeded = function(){
          try{ req.transaction.abort(); }catch(e){}
          resolve(null);
        };
      }catch(e){ resolve(null); }
    });
  }

  async function storeCount(db, storeName){
    return await new Promise(function(resolve){
      try{
        var tx = db.transaction(storeName, "readonly");
        var st = tx.objectStore(storeName);
        var r = st.count();
        r.onsuccess = function(){ resolve(r.result || 0); };
        r.onerror = function(){ resolve(0); };
      }catch(e){ resolve(0); }
    });
  }

  async function storeGetAll(db, storeName, limit){
    limit = limit || 50000;
    return await new Promise(function(resolve){
      try{
        var tx = db.transaction(storeName, "readonly");
        var st = tx.objectStore(storeName);
        if(st.getAll){
          var r = st.getAll();
          r.onsuccess = function(){ resolve(r.result || []); };
          r.onerror = function(){ resolve([]); };
          return;
        }
        var out = [];
        var curReq = st.openCursor();
        curReq.onsuccess = function(ev){
          var cur = ev.target.result;
          if(cur){
            out.push(cur.value);
            if(out.length >= limit){
              resolve(out);
              try{ tx.abort(); }catch(e){}
              return;
            }
            cur.continue();
          }else resolve(out);
        };
        curReq.onerror = function(){ resolve([]); };
      }catch(e){ resolve([]); }
    });
  }

  async function listDBs(){
    var names = [];
    if(indexedDB.databases){
      try{
        var dbs = await indexedDB.databases();
        for(var i=0;i<dbs.length;i++){
          if(dbs[i] && dbs[i].name) names.push(dbs[i].name);
        }
      }catch(e){}
    }
    // add common fallbacks
    var fallback = ["ops_v642_main","ops_main","ops_v6_4_2_main","ops_v642","ops_rebuild","ops_v642_settle_drafts"];
    for(var j=0;j<fallback.length;j++){
      if(names.indexOf(fallback[j])===-1) names.push(fallback[j]);
    }
    return names;
  }

  async function diagnoseIDB(){
    var names = await listDBs();
    var lines = [];
    lines.push("IndexedDB 诊断（仅统计，不读全量）");
    lines.push("================================");
    var totalDbs = 0;
    for(var nidx=0;nidx<names.length;nidx++){
      var dbname = names[nidx];
      var db = await idbOpen(dbname);
      if(!db) continue;
      totalDbs++;
      lines.push("");
      lines.push("DB: "+dbname);
      try{
        var stores = [];
        for(var s=0;s<db.objectStoreNames.length;s++) stores.push(db.objectStoreNames[s]);
        if(!stores.length){ lines.push("  (no stores)"); db.close(); continue; }
        // count each store
        for(var k=0;k<stores.length;k++){
          var st = stores[k];
          var c = await storeCount(db, st);
          var t = kwType(st);
          lines.push("  - "+st+" : "+c+(t?("  [type="+t+"]"):""));
        }
      }catch(e){
        lines.push("  (error reading stores)");
      }
      try{ db.close(); }catch(e){}
    }
    if(!totalDbs) lines.push("\n未发现可打开的 IndexedDB 数据库（可能被浏览器策略限制）。");
    alert(lines.join("\n"));
  }

  async function pickBestSplitDB(){
    var names = await listDBs();
    var best = null;
    for(var i=0;i<names.length;i++){
      var dbname = names[i];
      var db = await idbOpen(dbname);
      if(!db) continue;

      try{
        var stores = [];
        for(var s=0;s<db.objectStoreNames.length;s++) stores.push(db.objectStoreNames[s]);

        var score = 0;
        var map = { sellers:null, products:null, orders:null, batches:null };
        for(var k=0;k<stores.length;k++){
          var st = stores[k];
          var t = kwType(st);
          if(!t) continue;
          var c = await storeCount(db, st);
          // Heavily prioritize orders; then products; then sellers; then batches
          if(t==="orders") score += c*1000;
          else if(t==="products") score += c*10;
          else if(t==="sellers") score += c;
          else if(t==="batches") score += c;
          // keep the largest-count store per type
          if(!map[t] || c > map[t].count){
            map[t] = { name: st, count: c };
          }
        }

        if(score>0 && (!best || score>best.score)){
          best = { dbname: dbname, score: score, stores: map };
        }
      }catch(e){}
      try{ db.close(); }catch(e){}
    }
    return best;
  }

  async function loadLocalSnapshot(){
    // 1) Try split-store DB assembly (best effort)
    try{
      var pick = await pickBestSplitDB();
      if(pick){
        var db = await idbOpen(pick.dbname);
        if(db){
          var snap = { sellers:[], products:[], orders:[], batches:[] };
          var used = [];
          if(pick.stores.sellers && pick.stores.sellers.count>0){
            snap.sellers = await storeGetAll(db, pick.stores.sellers.name, 200000);
            used.push("sellers="+pick.stores.sellers.name+"("+pick.stores.sellers.count+")");
          }
          if(pick.stores.products && pick.stores.products.count>0){
            snap.products = await storeGetAll(db, pick.stores.products.name, 500000);
            used.push("products="+pick.stores.products.name+"("+pick.stores.products.count+")");
          }
          if(pick.stores.orders && pick.stores.orders.count>0){
            snap.orders = await storeGetAll(db, pick.stores.orders.name, 1000000);
            used.push("orders="+pick.stores.orders.name+"("+pick.stores.orders.count+")");
          }
          if(pick.stores.batches && pick.stores.batches.count>0){
            snap.batches = await storeGetAll(db, pick.stores.batches.name, 200000);
            used.push("batches="+pick.stores.batches.name+"("+pick.stores.batches.count+")");
          }
          try{ db.close(); }catch(e){}
          return { src: "IndexedDB(split) "+pick.dbname+" | "+used.join(", "), state: snap };
        }
      }
    }catch(e){ console.error(e); }

    // 2) Fallback to single-state key if present
    try{
      if(typeof idbGet === "function" && typeof MAIN_STATE_KEY !== "undefined"){
        var s = await idbGet(MAIN_STATE_KEY);
        if(s) return { src: "IndexedDB(main) "+(typeof MAIN_DB_NAME!=="undefined"?MAIN_DB_NAME:"")+"/"+MAIN_STATE_KEY, state: s };
      }
    }catch(e){}

    // 3) localStorage fallback
    try{
      var raw = localStorage.getItem("ops_rebuild_v6_4_2_state");
      if(raw) return { src:"localStorage ops_rebuild_v6_4_2_state", state: JSON.parse(raw) };
    }catch(e){}
    return { src:"none", state:null };
  }

  async function encodePayload(obj){
    var json = JSON.stringify(obj || {});
    var bytes = 0;
    try{ bytes = new Blob([json]).size; }catch(e){ bytes = json.length; }
    var canGzip = (typeof CompressionStream !== "undefined") && (typeof DecompressionStream !== "undefined");
    if(canGzip && bytes > 1024*1024){
      try{
        var cs = new CompressionStream("gzip");
        var ab = await new Response(new Blob([json]).stream().pipeThrough(cs)).arrayBuffer();
        var u8 = new Uint8Array(ab);
        var bin = "";
        var chunk = 0x8000;
        for(var i=0;i<u8.length;i+=chunk){
          bin += String.fromCharCode.apply(null, u8.subarray(i, i+chunk));
        }
        return { enc:"gzip-base64", raw_bytes: bytes, data: btoa(bin) };
      }catch(e){}
    }
    return { enc:"json", data: json };
  }

  async function decodePayload(payloadStr){
    if(!payloadStr) return null;
    var env = null;
    try{ env = JSON.parse(payloadStr); }catch(e){ env = null; }
    if(!env || !env.enc){
      try{ return JSON.parse(payloadStr); }catch(e){ return null; }
    }
    if(env.enc==="json"){
      try{ return JSON.parse(env.data); }catch(e){ return null; }
    }
    if(env.enc==="gzip-base64"){
      try{
        var bin = atob(env.data);
        var u8 = new Uint8Array(bin.length);
        for(var i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
        var ds = new DecompressionStream("gzip");
        var text = await new Response(new Blob([u8]).stream().pipeThrough(ds)).text();
        return JSON.parse(text);
      }catch(e){ console.error(e); return null; }
    }
    return null;
  }

  function normForCount(state){
    if(!isObj(state)) return { sellers:[], products:[], orders:[], batches:[] };
    // allow both array and object maps
    var sellers = state.sellers || state.vendors || state.sellerList || state.sellerRows;
    var products = state.products || state.items || state.productList || state.productRows;
    var orders = state.orders || state.orderList || state.orderRows;
    var batches = state.batches || state.batchList || state.settleBatches || state.settlementBatches || state.payoutBatches;

    function toArr(x){
      if(Array.isArray(x)) return x;
      if(isObj(x)) return Object.values(x);
      return [];
    }
    return { sellers: toArr(sellers), products: toArr(products), orders: toArr(orders), batches: toArr(batches) };
  }

  function getCloudWrap(opts){
    opts = opts||{};
    const quiet = !!opts.quiet;
    try{
      if(typeof getCloudClientOrNull === "function"){
        var w = getCloudClientOrNull();
        if(w && typeof w.from === "function"){
          var cfg = (typeof getCloudCfgOrNull==="function") ? getCloudCfgOrNull() : null;
          return { client:w, cfg:cfg };
        }
        if(w && w.client) return w;
      }
    }catch(e){}
    if(!quiet) alert("云端未配置：请先点【云端设置】填写 Supabase URL/AnonKey/app_key。");
    return null;
  }

  async function cloudStatusV30(){
    var wrap = getCloudWrap(); if(!wrap) return;
    var client = wrap.client, cfg = wrap.cfg;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    var loc = await loadLocalSnapshot();
    var ln = normForCount(loc.state);
    var lc = { sellers: pickCount(ln.sellers), products: pickCount(ln.products), orders: pickCount(ln.orders), batches: pickCount(ln.batches) };

    try{
      var res = await client.from("ops_cloud_snapshots_v1").select("*").eq("app_key", cfg.app_key).maybeSingle();
      if(res.error) throw res.error;
      if(!res.data){
        alert("云端暂无快照（app_key="+cfg.app_key+"）。\n\n本地数据源："+loc.src+"\n本地内容统计：卖家"+lc.sellers+" 产品"+lc.products+" 订单"+lc.orders+" 批次"+lc.batches);
        return;
      }
      var remoteObj = await decodePayload(res.data.payload);
      var rn = normForCount(remoteObj);
      var rc = { sellers: pickCount(rn.sellers), products: pickCount(rn.products), orders: pickCount(rn.orders), batches: pickCount(rn.batches) };

      alert(
        "云端快照状态\n\n"+
        "app_key: "+cfg.app_key+"\n"+
        "hash: "+(res.data.hash||"")+"\n"+
        "updated_at: "+(res.data.updated_at||"")+"\n"+
        "created_at: "+(res.data.created_at||"")+"\n\n"+
        "云端内容统计：卖家"+rc.sellers+" 产品"+rc.products+" 订单"+rc.orders+" 批次"+rc.batches+"\n\n"+
        "本地数据源："+loc.src+"\n"+
        "本地内容统计：卖家"+lc.sellers+" 产品"+lc.products+" 订单"+lc.orders+" 批次"+lc.batches
      );
    }catch(e){
      console.error(e);
      alert("云端状态失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPushV30(){
    var wrap = getCloudWrap(); if(!wrap) return;
    var client = wrap.client, cfg = wrap.cfg;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    var loc = await loadLocalSnapshot();
    var ln = normForCount(loc.state);
    var sc = pickCount(ln.sellers), pc = pickCount(ln.products), oc = pickCount(ln.orders), bc = pickCount(ln.batches);

    if(sc===0 && pc===0 && oc===0 && bc===0){
      var ok = confirm("警告：当前本地数据为 0（卖家/产品/订单/批次均为空）。\n数据源："+loc.src+"\n\n继续“云端推送”会覆盖云端快照为“空”，可能导致无法恢复。\n\n仍要继续推送吗？");
      if(!ok) return;
    }

    try{
      var env = await encodePayload(loc.state || {});
      var hash = String(Date.now());
      var row = { app_key: cfg.app_key, payload: JSON.stringify(env), hash: hash };
      var up = await client.from("ops_cloud_snapshots_v1").upsert(row, { onConflict:"app_key" });
      if(up.error) throw up.error;
      toastSafe("云端推送成功：卖家"+sc+" 产品"+pc+" 订单"+oc+" 批次"+bc+"（hash="+hash+"）");
    }catch(e){
      console.error(e);
      alert("云端推送失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPullV30(){
    var wrap = getCloudWrap(); if(!wrap) return;
    var client = wrap.client, cfg = wrap.cfg;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    try{
      var res = await client.from("ops_cloud_snapshots_v1").select("*").eq("app_key", cfg.app_key).maybeSingle();
      if(res.error) throw res.error;
      if(!res.data){ alert("云端暂无快照（app_key="+cfg.app_key+"）。"); return; }

      var obj = await decodePayload(res.data.payload);
      if(!obj){ alert("云端快照 payload 为空或解析失败。"); return; }

      // If your app provides idbSet+MAIN_STATE_KEY, write there; otherwise keep a safe localStorage copy.
      if(typeof idbSet === "function" && typeof MAIN_STATE_KEY !== "undefined"){
        await idbSet(MAIN_STATE_KEY, obj);
        toastSafe("云端拉取完成：已写入 IndexedDB 主库（"+MAIN_STATE_KEY+"），即将刷新。");
        try{ location.reload(); }catch(e){}
        return;
      }
      localStorage.setItem("ops_rebuild_v6_4_2_state", JSON.stringify(obj));
      toastSafe("云端拉取完成：已写入 localStorage 主快照（兜底），即将刷新。");
      try{ location.reload(); }catch(e){}
    }catch(e){
      console.error(e);
      alert("云端拉取失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  function rebind(){
    var bPush = document.getElementById("btnCloudPush");
    var bPull = document.getElementById("btnCloudPull");
    var bStatus = document.getElementById("btnCloudStatus");
    if(bPush) bPush.onclick = function(){ cloudPushV30(); };
    if(bPull) bPull.onclick = function(){ cloudPullV30(); };
    if(bStatus) bStatus.onclick = function(){ cloudStatusV30(); };
  }

  function addDiagButton(){
    // Try place near existing cloud buttons
    try{
      var existing = document.getElementById("btnCloudStatus") || document.getElementById("btnCloudPush");
      var parent = existing ? existing.parentElement : null;
      if(!parent) parent = document.querySelector("header") || document.body;
      if(document.getElementById("btnLocalDiagnose")) return;

      var b = document.createElement("button");
      b.id = "btnLocalDiagnose";
      b.textContent = "诊断本地库";
      b.className = existing ? existing.className : "";
      b.style.marginLeft = "8px";
      b.onclick = function(){ diagnoseIDB(); };
      parent.appendChild(b);
    }catch(e){}
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", function(){ rebind(); addDiagButton(); });
  }else{
    rebind(); addDiagButton();
  }

  window.__cloudV30__ = { diagnoseIDB: diagnoseIDB, loadLocalSnapshot: loadLocalSnapshot, cloudPushV30: cloudPushV30, cloudStatusV30: cloudStatusV30 };
})();
</script>


<script>
/* ===== Cloud Sync Override (v34-override) =====
   Fix: cloud counts always 0 due to reading wrong source.
   Strategy: always load snapshot from IndexedDB ops_v642_main/kv/main_state_v1 first.
*/
(async function(){
  async function idbGet(dbName, storeName, key){
    return await new Promise((resolve, reject)=>{
      try{
        const req = indexedDB.open(dbName);
        req.onerror = ()=>reject(req.error || new Error("indexedDB.open failed"));
        req.onsuccess = ()=>{
          const db = req.result;
          try{
            const tx = db.transaction([storeName], "readonly");
            const st = tx.objectStore(storeName);
            const g = st.get(key);
            g.onerror = ()=>reject(g.error || new Error("idb get failed"));
            g.onsuccess = ()=>resolve(g.result);
          }catch(e){ reject(e); }
        };
      }catch(e){ reject(e); }
    });
  }
  function safeParseJSON(s){ try{return JSON.parse(s);}catch(_){return null;} }
  function _countAny(x){
  if(Array.isArray(x)) return x.length;
  if(x && typeof x === "object") return Object.keys(x).length;
  return 0;
}
function _unwrapMaybeKv(x){
  if(x && typeof x === "object" && x.value && typeof x.value === "object" && !x.orders && !x.sellers && !x.products){
    return x.value;
  }
  return x;
}
function normalizeMainState(payload){
  const s0 = _unwrapMaybeKv(payload) || {};
  const sellers =
    s0.sellers ?? s0.sellerList ?? s0.sellersList ??
    (s0.sellersById ? Object.values(s0.sellersById) : null) ??
    [];
  const products =
    s0.products ?? s0.productList ?? s0.productsList ??
    (s0.productsById ? Object.values(s0.productsById) : null) ??
    [];
  const orders =
    s0.orders ?? s0.orderList ?? s0.ordersList ??
    (s0.ordersById ? Object.values(s0.ordersById) : null) ??
    [];
  const batches =
    s0.batches ?? s0.payoutBatches ?? s0.settlementBatches ?? s0.payBatches ?? s0.settleBatches ??
    [];
  return { raw:s0, sellers, products, orders, batches };
}
function countPayload(payload){
  const n = normalizeMainState(payload);
  return {
    sellers: _countAny(n.sellers),
    products: _countAny(n.products),
    orders: _countAny(n.orders),
    batches: _countAny(n.batches)
  };
}
async function loadMainSnapshot(){
  const sources = [];
  try{
    const ls1 = safeParseJSON(localStorage.getItem("ops_rebuild_v6_4_2_state"));
    if(ls1) sources.push({ source:"localStorage", key:"ops_rebuild_v6_4_2_state", payload: ls1 });
  }catch(e){}
  try{
    const ls2 = safeParseJSON(localStorage.getItem("OPS_MAIN_STATE_V1"));
    if(ls2) sources.push({ source:"localStorage", key:"OPS_MAIN_STATE_V1", payload: ls2 });
  }catch(e){}
  try{
    const a = await idbGetAnyKv("ops_v642_main","kv",["main_state_v1","OPS_MAIN_STATE_V1","ops_rebuild_v6_4_2_state","ops_v642_products_lite_v1"]);
    for(const it of a){
      if(it && it.value) sources.push({ source:"indexedDB", key: it.key, payload: it.value });
    }
  }catch(e){}

  let best = null;
  for(const s of sources){
    const c = countPayload(s.payload);
    const total = (c.sellers||0)+(c.products||0)+(c.orders||0)+(c.batches||0);
    if(total<=0) continue;
    if(!best || total>best.total) best = { ok:true, source:s.source, sourceKey:s.key, payload:s.payload, counts:c, total };
  }
  if(best) return best;

  for(const s of sources){
    if(s.key==="ops_rebuild_v6_4_2_state"){
      return { ok:true, source:s.source, sourceKey:s.key, payload:s.payload, counts:countPayload(s.payload), total:0 };
    }
  }
  return { ok:false, source:"none", payload:null };
}

async function cloudStatusFixed(){
    const sb = (typeof window.getCloudClientOrNull==="function") ? window.getCloudClientOrNull() : null;
    if(!sb){
      if(typeof window.cloudPromptAndSave==="function") window.cloudPromptAndSave();
      return;
    }
    const { client, cfg } = sb;
    try{
      const { data, error } = await client
        .from("ops_cloud_snapshots")
        .select("app_key,hash,updated_at,created_at,payload")
        .eq("app_key", cfg.appKey)
        .maybeSingle();
      if(error) throw error;
      if(!data){
        alert("云端快照状态：未找到快照（app_key="+cfg.appKey+"）");
        return;
      }
      const cnt = countPayload(data.payload || {});
      alert(
        "云端快照状态\n\n" +
        "app_key: " + (data.app_key||"") + "\n" +
        "hash: " + (data.hash||"") + "\n" +
        "updated_at: " + (data.updated_at||"") + "\n" +
        "created_at: " + (data.created_at||"") + "\n\n" +
        "内容统计：卖家" + cnt.sc + " 产品" + cnt.pc + " 订单" + cnt.oc + " 批次" + cnt.bc
      );
    }catch(e){
      console.error(e);
      alert("云端状态失败：" + (e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPushFixed(){
    const sb = (typeof window.getCloudClientOrNull==="function") ? window.getCloudClientOrNull() : null;
    if(!sb){
      if(typeof window.cloudPromptAndSave==="function") window.cloudPromptAndSave();
      return;
    }
    const { client, cfg } = sb;
    try{
      const local = await loadMainSnapshot();
      if(!local.ok || !local.payload){
        alert("无法获取本地数据快照（未找到 IndexedDB 主快照 / localStorage 主快照）。");
        return;
      }
      const cnt = countPayload(local.payload);

      if(cnt.sc===0 && cnt.pc===0 && cnt.oc===0 && cnt.bc===0){
        const ok = confirm(
          "警告：当前本地数据为 0（卖家/产品/订单/批次均为空）。\n\n" +
          "来源：" + local.source + "\n\n" +
          "继续“云端推送”会覆盖云端快照为“空”，可能导致无法恢复。\n\n" +
          "仍要继续推送吗？"
        );
        if(!ok) return;
      }

      const hash = String(Date.now());
      const row = { app_key: cfg.appKey, hash, payload: local.payload, payload_str: JSON.stringify(local.payload) };
      const { error } = await client.from("ops_cloud_snapshots").upsert(row, { onConflict:"app_key" });
      if(error) throw error;

      const msg = "云端推送成功：卖家"+cnt.sc+" 产品"+cnt.pc+" 订单"+cnt.oc+" 批次"+cnt.bc+"（hash="+hash+"）";
      if(typeof window.toast==="function") window.toast(msg); else alert(msg);
    }catch(e){
      console.error(e);
      alert("云端推送失败：" + (e && e.message ? e.message : String(e)));
    }
  }

  // Override globals + rebind buttons
  window.cloudStatus = cloudStatusFixed;
  window.cloudPush = cloudPushFixed;

  document.addEventListener("DOMContentLoaded", ()=>{
    const bCfg = document.getElementById("btnCloudCfg");
    const bPush = document.getElementById("btnCloudPush");
    const bPull = document.getElementById("btnCloudPull");
    const bStatus = document.getElementById("btnCloudStatus");

    if(bPush) bPush.onclick = ()=>{ cloudPushFixed(); };
    if(bStatus) bStatus.onclick = ()=>{ cloudStatusFixed(); };

    // Keep original pull/cfg if already wired by main app
    if(bCfg && !bCfg.onclick && typeof window.cloudPromptAndSave==="function") bCfg.onclick = ()=>window.cloudPromptAndSave();
    if(bPull && !bPull.onclick && typeof window.cloudPull==="function") bPull.onclick = ()=>window.cloudPull();
  }, { once:true });
})();

// ===== Cloud Sync Override (Plan A): Read primary state from IndexedDB kv (ops_v642_main/main_state_v1) or localStorage (ops_rebuild_v6_4_2_state) =====
(async function(){
  const LS_MAIN_KEY = 'ops_rebuild_v6_4_2_state';
  const IDB_MAIN_DB = 'ops_v642_main';
  const IDB_MAIN_STORE = 'kv';
  const IDB_MAIN_KEY = 'main_state_v1';

  function _safeJsonParse(s){
    try{ return JSON.parse(s); }catch(e){ return null; }
  }
  function _normalizeState(any){
    // unwrap {key, value} record
    if(any && typeof any === 'object' && 'value' in any && ('key' in any)) any = any.value;
    if(any == null) return null;
    if(typeof any === 'string'){
      const j = _safeJsonParse(any);
      return j && typeof j === 'object' ? j : null;
    }
    if(typeof any === 'object') return any;
    return null;
  }

  async function _readMainFromIDB(){
    try{
      if(typeof _idbGetAnyKv !== 'function') return null;
      const rec = await _idbGetAnyKv(IDB_MAIN_DB, IDB_MAIN_STORE, IDB_MAIN_KEY);
      return _normalizeState(rec);
    }catch(e){
      return null;
    }
  }
  function _readMainFromLS(){
    try{
      const raw = localStorage.getItem(LS_MAIN_KEY);
      return _normalizeState(raw);
    }catch(e){
      return null;
    }
  }
  async function _readPrimaryState(){
    // Prefer IDB (v6.4.2-next5 uses ops_v642_main kv), fallback to localStorage legacy key.
    const idb = await _readMainFromIDB();
    if(idb) return { state:idb, source:'idb' };
    const ls = _readMainFromLS();
    if(ls) return { state:ls, source:'ls' };
    return { state:null, source:'none' };
  }

  async function _writePrimaryState(state){
    // Best-effort write to both: keep compatibility and make debugging easier.
    try{
      if(typeof _idbSetAnyKv === 'function'){
        await _idbSetAnyKv(IDB_MAIN_DB, IDB_MAIN_STORE, IDB_MAIN_KEY, state);
      }else if(typeof _idbOpen === 'function'){
        // fallback minimal IDB put
        const db = await _idbOpen(IDB_MAIN_DB, 1, (upgradeDb)=>{
          if(!upgradeDb.objectStoreNames.contains(IDB_MAIN_STORE)) upgradeDb.createObjectStore(IDB_MAIN_STORE,{keyPath:'key'});
        });
        await new Promise((resolve,reject)=>{
          const tx=db.transaction(IDB_MAIN_STORE,'readwrite');
          tx.oncomplete=()=>resolve();
          tx.onerror=()=>reject(tx.error||new Error('tx error'));
          tx.objectStore(IDB_MAIN_STORE).put({key:IDB_MAIN_KEY, value:state});
        });
      }
    }catch(e){}
    try{ localStorage.setItem(LS_MAIN_KEY, JSON.stringify(state||{})); }catch(e){}
  }

  async function getLocalSnapshotPreferIDB(){
    const { state, source } = await _readPrimaryState();
    const data = state || {};
    const counts = (typeof _countSnapshot === 'function') ? _countSnapshot(data) : {sellers:0,products:0,orders:0,batches:0};
    return { ok:true, data, counts, source };
  }

  // override global
  window.getLocalSnapshotPreferIDB = getLocalSnapshotPreferIDB;

  function _hashNow(){ return Date.now(); }

  async function cloudStatus(){
    const cloud = (typeof getCloudClientOrNull === 'function') ? getCloudClientOrNull() : null;
    if(!cloud) return alert('未设置云端（请先点“云端设置”）。');
    const { client: sb, cfg } = cloud;
    try{
      const { data, error } = await sb.from('ops_cloud_snapshots_v1').select('app_key,hash,updated_at,created_at,payload').eq('app_key', cfg.app_key).maybeSingle();
      if(error) throw error;
      if(!data) return alert('云端无快照（该 app_key 尚未推送过）。');
      const payload = data.payload || {};
      const state = _normalizeState(payload.state || payload) || {};
      const c = (typeof _countSnapshot === 'function') ? _countSnapshot(state) : {sellers:0,products:0,orders:0,batches:0};
      alert(
        '云端快照状态\n\n' +
        'app_key: ' + data.app_key + '\n' +
        'hash: ' + data.hash + '\n' +
        'updated_at: ' + data.updated_at + '\n' +
        'created_at: ' + data.created_at + '\n\n' +
        '内容统计：卖家' + c.sellers + ' 产品' + c.products + ' 订单' + c.orders + ' 批次' + c.batches
      );
    }catch(e){
      alert('云端状态失败：' + (e && (e.message||e.toString()) ));
    }
  }

  async function cloudPush(){
    const cloud = (typeof getCloudClientOrNull === 'function') ? getCloudClientOrNull() : null;
    if(!cloud) return alert('未设置云端（请先点“云端设置”）。');
    const { client: sb, cfg } = cloud;

    const local = await getLocalSnapshotPreferIDB();
    const c = local.counts || {sellers:0,products:0,orders:0,batches:0};

    if((c.sellers+c.products+c.orders+c.batches) === 0){
      const ok = confirm(
        '警告：当前本地数据为 0（卖家/产品/订单/批次均为空）。\n\n' +
        '继续“云端推送”会覆盖云端快照为“空”，可能导致无法恢复。\n\n仍要继续推送吗？'
      );
      if(!ok) return;
    }

    const hash = _hashNow();
    const payload = { v:1, state: local.data || {}, meta:{ source: local.source || 'unknown', pushed_at: new Date().toISOString() } };

    try{
      const { error } = await sb.from('ops_cloud_snapshots_v1').upsert(
        { app_key: cfg.app_key, hash, payload },
        { onConflict:'app_key' }
      );
      if(error) throw error;
      if(typeof toast === 'function'){
        toast('云端推送成功：卖家'+c.sellers+' 产品'+c.products+' 订单'+c.orders+' 批次'+c.batches+'（hash='+hash+'）');
      }else{
        alert('云端推送成功：卖家'+c.sellers+' 产品'+c.products+' 订单'+c.orders+' 批次'+c.batches+'（hash='+hash+'）');
      }
    }catch(e){
      alert('云端推送失败：' + (e && (e.message||e.toString()) ));
    }
  }

  async function cloudPull(){
    const cloud = (typeof getCloudClientOrNull === 'function') ? getCloudClientOrNull() : null;
    if(!cloud) return alert('未设置云端（请先点“云端设置”）。');
    const { client: sb, cfg } = cloud;

    try{
      const { data, error } = await sb.from('ops_cloud_snapshots_v1').select('app_key,hash,updated_at,created_at,payload').eq('app_key', cfg.app_key).maybeSingle();
      if(error) throw error;
      if(!data) return alert('云端无快照（该 app_key 尚未推送过）。');
      const payload = data.payload || {};
      const state = _normalizeState(payload.state || payload);
      if(!state) return alert('云端快照 payload 为空或无法解析。');
      const c = (typeof _countSnapshot === 'function') ? _countSnapshot(state) : {sellers:0,products:0,orders:0,batches:0};

      const ok = confirm(
        '将云端快照覆盖到本地（IndexedDB/LocalStorage）。\n\n' +
        '云端内容统计：卖家'+c.sellers+' 产品'+c.products+' 订单'+c.orders+' 批次'+c.batches+'\n' +
        'hash='+data.hash+'\n\n继续吗？'
      );
      if(!ok) return;

      await _writePrimaryState(state);

      if(typeof toast === 'function') toast('云端拉取完成：卖家'+c.sellers+' 产品'+c.products+' 订单'+c.orders+' 批次'+c.batches+'（hash='+data.hash+'）');
      // Reload to let the app rehydrate from primary storage
      setTimeout(()=>{ location.reload(); }, 400);
    }catch(e){
      alert('云端拉取失败：' + (e && (e.message||e.toString()) ));
    }
  }

  // Export overrides
  window.cloudStatus = cloudStatus;
  window.cloudPush = cloudPush;
  window.cloudPull = cloudPull;

  // Ensure buttons are bound (some builds bind earlier before overrides)
  function _rebind(){
    try{
      const byText = (t)=>Array.from(document.querySelectorAll('button')).find(b=>(b.textContent||'').trim()===t);
      const bStatus = byText('云端状态'); if(bStatus) bStatus.onclick = ()=>cloudStatusFixed();
      const bPush   = byText('云端推送'); if(bPush) bPush.onclick = ()=>cloudPushFixed();
      const bPull   = byText('云端拉取'); if(bPull) bPull.onclick = ()=>cloudPull();
    }catch(e){}
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', _rebind);
  }else{
    _rebind();
  }
})();
</script>



<script>
/* ===================== CLOUD_FINAL_BIND (force fixed datasource + capture click) =====================
Goal:
- No matter how many legacy scripts rebind onclick (V23/V25/V30/...), cloud buttons always use ONE logic:
  Read IndexedDB main DB (ops_v642_main/kv/main_state_v1) -> push/pull/status with Supabase ops_cloud_snapshots_v1.
- Use capture-phase listeners + stopImmediatePropagation to prevent later handlers from running.
====================================================================================================== */
(async function(){
  const FINAL = {};
  const MAIN_DB = "ops_v642_main";
  const MAIN_STORE = "kv";
  const MAIN_KEY = "main_state_v1";
  const LS_FALLBACK_KEY = "ops_rebuild_v6_4_2_state";

  function toastSafe(msg){
    try{ if(typeof toast==="function") return toast(msg); }catch(e){}
    try{ console.log("[TOAST]", msg); }catch(e){}
    try{ alert(msg); }catch(e){}
  }
  function pickCount(v){
    if(Array.isArray(v)) return v.length;
    if(v && typeof v==="object") return Object.keys(v).length;
    return 0;
  }
  function normState(obj){
    obj = obj && typeof obj==="object" ? obj : {};
    const out = {};
    out.sellers = Array.isArray(obj.sellers) ? obj.sellers : (Array.isArray(obj.sellerList)?obj.sellerList:[]);
    out.products = Array.isArray(obj.products) ? obj.products : (Array.isArray(obj.productList)?obj.productList:[]);
    out.orders = Array.isArray(obj.orders) ? obj.orders : (Array.isArray(obj.orderList)?obj.orderList:[]);
    out.batches = Array.isArray(obj.batches) ? obj.batches : (Array.isArray(obj.batchList)?obj.batchList:[]);
    // keep other fields (payout, settings...) for compatibility
    for(const k in obj){ if(!(k in out)) out[k]=obj[k]; }
    return out;
  }

  async function readMainFromIDB(){
    // Prefer existing idbGet if present
    try{
      if(typeof idbGet === "function"){
        const v = await idbGet(MAIN_KEY);
        if(v) return { src: "IndexedDB(idbGet): "+MAIN_DB+"/"+MAIN_STORE+"/"+MAIN_KEY, state: v };
      }
    }catch(e){}

    // Raw IndexedDB open fallback
    return await new Promise((resolve)=>{
      try{
        const req = indexedDB.open(MAIN_DB);
        req.onerror = ()=>resolve({ src:"IndexedDB(open error): "+(req.error?req.error.message:""), state:null });
        req.onsuccess = ()=>{
          const db = req.result;
          try{
            const tx = db.transaction(MAIN_STORE, "readonly");
            const st = tx.objectStore(MAIN_STORE);
            const g = st.get(MAIN_KEY);
            g.onerror = ()=>resolve({ src:"IndexedDB(get error): "+(g.error?g.error.message:""), state:null });
            g.onsuccess = ()=>resolve({ src:"IndexedDB: "+MAIN_DB+"/"+MAIN_STORE+"/"+MAIN_KEY, state:g.result||null });
          }catch(e){
            resolve({ src:"IndexedDB(tx error): "+(e && e.message?e.message:String(e)), state:null });
          }
        };
      }catch(e){
        resolve({ src:"IndexedDB exception: "+(e && e.message?e.message:String(e)), state:null });
      }
    });
  }

  async function readLocalState(){
    const a = await readMainFromIDB();
    if(a && a.state) return { src:a.src, state: normState(a.state) };

    // fallback: global S
    try{
      if(typeof S !== "undefined" && S){
        return { src:"Memory(S)", state: normState(S) };
      }
    }catch(e){}

    // fallback: localStorage
    try{
      const raw = localStorage.getItem(LS_FALLBACK_KEY);
      if(raw){
        const obj = JSON.parse(raw);
        return { src:"localStorage("+LS_FALLBACK_KEY+")", state: normState(obj) };
      }
    }catch(e){}

    return { src:"(none)", state: normState(null) };
  }

  function getCloudWrap(opts){
    opts = opts||{};
    const quiet = !!opts.quiet;
    try{
      if(typeof getCloudClientOrNull === "function"){
        const w = getCloudClientOrNull();
        if(w && typeof w.from === "function"){
          const cfg = (typeof getCloudCfgOrNull==="function") ? getCloudCfgOrNull() : null;
          return { client:w, cfg };
        }
        if(w && w.client) return w;
      }
    }catch(e){}
    if(!quiet) alert("云端未配置：请先点【云端设置】填写 Supabase URL/AnonKey/app_key。");
    return null;
  }

  async function cloudStatusFINAL(){
    const wrap = getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    const loc = await readLocalState();
    const lc = {
      sellers: pickCount(loc.state.sellers),
      products: pickCount(loc.state.products),
      orders: pickCount(loc.state.orders),
      batches: pickCount(loc.state.batches)
    };

    try{
      const { data, error } = await client.from("ops_cloud_snapshots_v1").select("*").eq("app_key", cfg.app_key).maybeSingle();
      if(error) throw error;

      if(!data){
        alert(
          "云端快照状态（无快照）\n\n"+
          "app_key: "+cfg.app_key+"\n\n"+
          "本地数据源："+loc.src+"\n"+
          "本地内容统计：卖家"+lc.sellers+" 产品"+lc.products+" 订单"+lc.orders+" 批次"+lc.batches+"\n\n"+
          "提示：点【云端推送】可上传本地数据到云端。"
        );
        return;
      }

      let remoteObj = null;
      try{
        remoteObj = data.payload ? JSON.parse(data.payload) : null;
      }catch(e){ remoteObj = null; }
      // V25 可能存 pack.env（带编码壳），这里做最宽松兼容
      if(remoteObj && remoteObj.env) remoteObj = remoteObj.env;
      const rn = normState(remoteObj||{});
      const rc = {
        sellers: pickCount(rn.sellers),
        products: pickCount(rn.products),
        orders: pickCount(rn.orders),
        batches: pickCount(rn.batches)
      };

      alert(
        "云端快照状态\n\n"+
        "app_key: "+cfg.app_key+"\n"+
        "hash: "+(data.hash||"")+"\n"+
        "updated_at: "+(data.updated_at||"")+"\n"+
        "created_at: "+(data.created_at||"")+"\n\n"+
        "云端内容统计：卖家"+rc.sellers+" 产品"+rc.products+" 订单"+rc.orders+" 批次"+rc.batches+"\n\n"+
        "本地数据源："+loc.src+"\n"+
        "本地内容统计：卖家"+lc.sellers+" 产品"+lc.products+" 订单"+lc.orders+" 批次"+lc.batches
      );
    }catch(e){
      console.error(e);
      alert("云端状态失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPushFINAL(){
    const wrap = getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    const loc = await readLocalState();
    const s = loc.state || {};
    const sc = pickCount(s.sellers), pc = pickCount(s.products), oc = pickCount(s.orders), bc = pickCount(s.batches);

    if(sc===0 && pc===0 && oc===0 && bc===0){
      const ok = confirm(
        "警告：当前本地数据为 0（卖家/产品/订单/批次均为空）。\n"+
        "数据源："+loc.src+"\n\n"+
        "继续“云端推送”会覆盖云端快照为“空”，可能导致无法恢复。\n\n仍要继续推送吗？"
      );
      if(!ok) return;
    }

    try{
      const hash = String(Date.now());
      const row = { app_key: cfg.app_key, payload: JSON.stringify(s), hash };
      const { error } = await client.from("ops_cloud_snapshots_v1").upsert(row, { onConflict:"app_key" });
      if(error) throw error;

      toastSafe("云端推送成功：卖家"+sc+" 产品"+pc+" 订单"+oc+" 批次"+bc+"（hash="+hash+"）");
    }catch(e){
      console.error(e);
      alert("云端推送失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  async function cloudPullFINAL(){
    const wrap = getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    if(!cfg || !cfg.app_key){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }

    try{
      const { data, error } = await client.from("ops_cloud_snapshots_v1").select("*").eq("app_key", cfg.app_key).maybeSingle();
      if(error) throw error;
      if(!data){ alert("云端暂无快照（app_key="+cfg.app_key+"）。"); return; }

      let obj = null;
      try{ obj = data.payload ? JSON.parse(data.payload) : null; }catch(e){ obj = null; }
      if(obj && obj.env) obj = obj.env; //兼容旧封装

      if(!obj){ alert("云端快照 payload 为空或解析失败。"); return; }

      // Write to IDB main
      try{
        if(typeof idbSet === "function"){
          await idbSet(MAIN_KEY, obj);
          toastSafe("云端拉取完成：已写入 IndexedDB 主库（main_state_v1），即将刷新。");
          location.reload();
          return;
        }
      }catch(e){}

      // raw IDB set
      await new Promise((resolve, reject)=>{
        const req = indexedDB.open(MAIN_DB);
        req.onerror = ()=>reject(req.error||new Error("open idb failed"));
        req.onsuccess = ()=>{
          const db = req.result;
          try{
            const tx = db.transaction(MAIN_STORE, "readwrite");
            const st = tx.objectStore(MAIN_STORE);
            const put = st.put(obj, MAIN_KEY);
            put.onerror = ()=>reject(put.error||new Error("put failed"));
            put.onsuccess = ()=>resolve();
          }catch(e){ reject(e); }
        };
      });
      toastSafe("云端拉取完成：已写入 IndexedDB 主库（raw put），即将刷新。");
      location.reload();
    }catch(e){
      console.error(e);
      alert("云端拉取失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  function bindBtn(id, fn){
    const el = document.getElementById(id);
    if(!el) return;
    // capture listener wins, and blocks other handlers
    el.addEventListener("click", function(ev){
      try{ ev.preventDefault(); ev.stopImmediatePropagation(); }catch(e){}
      fn();
    }, true);
    // also set onclick for visual tools that rely on it
    el.onclick = fn;
  }

  function bindAll(){
    bindBtn("btnCloudStatus", cloudStatusFINAL);
    bindBtn("btnCloudPush", cloudPushFINAL);
    bindBtn("btnCloudPull", cloudPullFINAL);
    // expose for debugging
    window.__cloudFINAL__ = { cloudStatusFINAL, cloudPushFINAL, cloudPullFINAL, readLocalState };
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", bindAll);
  else bindAll();
})();
</script>


<script>
/* ======================================================================================
  FINAL SYNC (Plan A): single-source local snapshot + safe merge + auto-push
  - HTML <script> environment (NO top-level await)
  - Never deletes cloud data; never forces overwrite with empty local snapshot
  - Manual Push uses: local -> pull cloud -> merge -> push merged
  - Auto-Push runs periodically with the same safety gates
====================================================================================== */
(async function(){
  const LOGP = "[AUTO-PUSH]";
  const TABLE = "ops_cloud_snapshots_v1";
  const MAIN_DB = "ops_v642_main";
  const MAIN_STORE = "kv";
  const MAIN_KEY = "main_state_v1";
  const LS_FALLBACK_KEY = "ops_rebuild_v6_4_2_state";

  const AUTO_INTERVAL_MS = 60 * 1000;   // 1 min
  const AUTO_START_DELAY_MS = 2500;
  const AUTO_ENABLED_DEFAULT = false;    // enable by default, but guarded

  let _running = false;
  let _lastPushedHash = null;
  let _autoEnabled = AUTO_ENABLED_DEFAULT;

  function nowIso(){ try{ return new Date().toISOString(); }catch(e){ return ""; } }
  function log(msg){ try{ console.log(`${LOGP} [${nowIso()}] ${msg}`); }catch(e){} }
  function warn(msg){ try{ console.warn(`${LOGP} [${nowIso()}] ${msg}`); }catch(e){} }
  function err(msg, e){
    try{ console.error(`${LOGP} [${nowIso()}] ${msg}`, e); }catch(_){}
  }
  function toastSafe(msg, kind){
    try{ if(typeof toast==="function") return toast(msg, kind); }catch(e){}
    try{ console.log("[TOAST]", msg); }catch(e){}
  }

  function pickCount(v){
    if(Array.isArray(v)) return v.length;
    if(v && typeof v==="object") return Object.keys(v).length;
    return 0;
  }

  function normArray(v){
    if(Array.isArray(v)) return v;
    if(v && typeof v==="object") return Object.values(v);
    return [];
  }

  function normState(s){
    const p = (s && typeof s==="object") ? s : {};
    return {
      sellers: normArray(p.sellers),
      products: normArray(p.products),
      orders: normArray(p.orders),
      batches: normArray(p.batches || p.batchList || p.settleBatches || p.settlementBatches || p.payoutBatches || p.payout_batches)
    };
  }

  function fnv1a(str){
    // 32-bit FNV-1a
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
    }
    return ("00000000" + h.toString(16)).slice(-8);
  }

  async function readMainFromIDB(){
    // Prefer project helpers if present
    try{
      if(typeof idbGet==="function"){
        const v = await idbGet(MAIN_KEY);
        if(v) return { src:"IndexedDB("+MAIN_DB+"/"+MAIN_STORE+"/"+MAIN_KEY+") via idbGet", state:v };
      }
    }catch(e){}
    // Raw open
    try{
      const obj = await new Promise((resolve, reject)=>{
        const req = indexedDB.open(MAIN_DB);
        req.onerror = ()=>reject(req.error || new Error("open failed"));
        req.onsuccess = ()=>{
          try{
            const db = req.result;
            const tx = db.transaction(MAIN_STORE, "readonly");
            const st = tx.objectStore(MAIN_STORE);
            const g = st.get(MAIN_KEY);
            g.onerror = ()=>reject(g.error || new Error("get failed"));
            g.onsuccess = ()=>resolve(g.result || null);
          }catch(e){ reject(e); }
        };
      });
      if(obj) return { src:"IndexedDB("+MAIN_DB+"/"+MAIN_STORE+"/"+MAIN_KEY+") raw", state:obj };
    }catch(e){}
    return null;
  }

  async function readSplitFromIDB(){
    // Use existing assembler if present
    try{
      if(typeof loadLocalSnapshot==="function"){
        const snap = await loadLocalSnapshot();
        if(!snap) return null;
        const s = normState(snap);
        const sc=pickCount(s.sellers), pc=pickCount(s.products), oc=pickCount(s.orders), bc=pickCount(s.batches);
        if(sc||pc||oc||bc){
          return { src:"IndexedDB(split-store) via loadLocalSnapshot", state:s };
        }
      }
    }catch(e){}
    return null;
  }

  function readFromLocalStorage(){
    try{
      const raw = localStorage.getItem(LS_FALLBACK_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      return { src:"localStorage("+LS_FALLBACK_KEY+")", state: obj };
    }catch(e){ return null; }
  }

  async function getLocalSnapshot(){
    // Priority: main IDB -> split-store -> memory S -> localStorage
    const a = await readMainFromIDB();
    if(a && a.state) return { src:a.src, state: normState(a.state) };

    const b = await readSplitFromIDB();
    if(b && b.state) return { src:b.src, state: normState(b.state) };

    try{
      if(typeof S!=="undefined" && S){
        return { src:"Memory(S)", state: normState(S) };
      }
    }catch(e){}

    const c = readFromLocalStorage();
    if(c && c.state) return { src:c.src, state: normState(c.state) };

    return { src:"(none)", state: normState(null) };
  }

  function getCloudWrap(opts){
    opts = opts||{};
    const quiet = !!opts.quiet;
    try{
      if(typeof getCloudClientOrNull==="function"){
        const w = getCloudClientOrNull();
        if(w && w.client && typeof w.client.from==="function" && w.cfg){
          return { client:w.client, cfg:w.cfg };
        }
      }
    }catch(e){}
    // Fallback if older signature
    try{
      const w = getCloudClientOrNull && getCloudClientOrNull();
      if(w && typeof w.from==="function"){
        const cfg = (typeof getCloudCfgOrNull==="function") ? getCloudCfgOrNull() : (typeof getCloudCfg==="function"?getCloudCfg():null);
        return { client:w, cfg:cfg };
      }
    }catch(e){}
    return null;
  }

  
  // ===== Supabase REST fallback (when supabase-js client is unavailable) =====
  function _restBase(cfg){
    return String(cfg.url||"").replace(/\/+$/,'') + "/rest/v1/";
  }
  function _restHeaders(cfg, extra){
    const h = {
      "apikey": String(cfg.anon||""),
      "Authorization": "Bearer " + String(cfg.anon||""),
      "Content-Type": "application/json"
    };
    if(extra) for(const k in extra) h[k]=extra[k];
    return h;
  }
  async function _restSelectOne(cfg, table, appKey){
    const url = _restBase(cfg) + encodeURIComponent(table)
      + "?select=app_key,payload,hash,updated_at"
      + "&app_key=eq." + encodeURIComponent(appKey)
      + "&limit=1";
    const r = await fetch(url, { method:"GET", headers:_restHeaders(cfg) });
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error("rest_select_failed " + r.status + " " + t);
    }
    const arr = await r.json().catch(()=> []);
    const row = Array.isArray(arr) ? (arr[0]||null) : (arr||null);
    return row;
  }
  async function _restUpsert(cfg, table, row){
    const url = _restBase(cfg) + encodeURIComponent(table) + "?on_conflict=app_key";
    const r = await fetch(url, {
      method:"POST",
      headers:_restHeaders(cfg, {"Prefer":"resolution=merge-duplicates,return=minimal"}),
      body: JSON.stringify(row)
    });
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error("rest_upsert_failed " + r.status + " " + t);
    }
    return true;
  }
  function _clientHasFrom(x){ return !!(x && typeof x.from==="function"); }
async function fetchCloudSnapshot(client, appKey, cfgFallback){
    // If supabase-js client is missing, fall back to PostgREST directly
    if(!_clientHasFrom(client)){
      const cfg = cfgFallback || (client && client.cfg) || null;
      if(!cfg || !cfg.url || !cfg.anon) throw new Error("cloud_cfg_missing_for_rest");
      const data = await _restSelectOne(cfg, TABLE, appKey);
      if(!data) return { exists:false, state:normState(null), hash:null, updated_at:null };
      let obj = null;
      if(data.payload==null){
        obj = null;
      }else if(typeof data.payload==="string"){
        try{ obj = JSON.parse(data.payload); }catch(e){ obj = null; }
      }else if(typeof data.payload==="object"){
        obj = data.payload;
      }else{ obj = null; }
      if(obj && obj.env) obj = obj.env;
      const st = normState(obj);
      return { exists:true, state: st, hash: data.hash || null, updated_at: data.updated_at || null };
    }

    const { data, error } = await client.from(TABLE).select("*").eq("app_key", appKey).maybeSingle();
    if(error) throw error;
    if(!data) return { exists:false, state:normState(null), hash:null, updated_at:null };
    let obj = null;
    // payload may be stored as jsonb (object) or as historical stringified JSON
    if(data.payload==null){
      obj = null;
    }else if(typeof data.payload==="string"){
      try{ obj = JSON.parse(data.payload); }catch(e){ obj = null; }
    }else if(typeof data.payload==="object"){
      obj = data.payload;
    }else{
      obj = null;
    }
    if(obj && obj.env) obj = obj.env; // compat wrapper
    return { exists:true, state: normState(obj), hash: data.hash || null, updated_at: data.updated_at || null };
  }

  function pickUpdatedAt(x){
    const v = x && (x.updatedAt || x.updated_at || x.modifiedAt || x.modified_at);
    const n = v ? Date.parse(v) : NaN;
    return isNaN(n) ? 0 : n;
  }

  function mergeById(aList, bList){
    const map = new Map();
    const put = (o)=>{
      if(!o || typeof o!=="object") return;
      const id = o.id || o._id;
      if(!id) return;
      if(!map.has(id)){ map.set(id, o); return; }
      const cur = map.get(id);
      const ta = pickUpdatedAt(cur);
      const tb = pickUpdatedAt(o);
      if(tb > ta) map.set(id, o);
      // If timestamps equal or missing: keep existing (cloud-first or local-first decided by call order)
    };
    aList.forEach(put);
    bList.forEach(put);
    return Array.from(map.values());
  }

  function mergeStates(localState, cloudState){
    const L = normState(localState);
    const C = normState(cloudState);
    // Conflict rule: prefer newer updatedAt; if missing, prefer local by ordering (cloud first then local)
    const sellers  = mergeById(C.sellers,  L.sellers);
    const products = mergeById(C.products, L.products);
    const orders   = mergeById(C.orders,   L.orders);
    const batches  = mergeById(C.batches,  L.batches);
    return { sellers, products, orders, batches };
  }

  async function pushSnapshot(client, appKey, state, note, cfgFallback){
    // If supabase-js client is missing, fall back to PostgREST directly
    const __cfg_for_rest = cfgFallback || (client && client.cfg) || null;

    const env = normState(state);
    const payloadObj = { env };
    const payload = JSON.stringify(payloadObj);
    const hash = fnv1a(payload);

    const row = {
      app_key: appKey,
      payload: payload,
      hash: hash,
      updated_at: nowIso()
    };

    if(_clientHasFrom(client)){
      const { error } = await client.from(TABLE).upsert(row, { onConflict: "app_key" });
      if(error) throw error;
    }else{
      if(!__cfg_for_rest || !__cfg_for_rest.url || !__cfg_for_rest.anon) throw new Error("cloud_cfg_missing_for_rest");
      await _restUpsert(__cfg_for_rest, TABLE, row);
    }

    _lastPushedHash = hash;
    const counts = { sellers: pickCount(env.sellers), products: pickCount(env.products), orders: pickCount(env.orders), batches: pickCount(env.batches) };
    return { hash, counts };
  }


  async function safeMergeAndPush(opts){
    const force = !!(opts && opts.force);
    if(typeof window.cloudPush!=="function"){
      warn("cloudPush 未就绪，跳过。");
      return;
    }
    try{
      const res = await window.cloudPush({ force, quiet: !force });
      if(res && res.ok){
        if(res.hash) _lastPushedHash = res.hash;
        if(res.skipped){
          log(`无需推送：合并后 hash 未变化（hash=${res.hash}）`);
        }else{
          log(`推送成功：卖家${res.counts.sc} 产品${res.counts.pc} 订单${res.counts.oc} 批次${res.counts.bc}（hash=${res.hash}）`);
        }
      }else{
        warn("推送失败或被安全策略拦截。");
      }
    }catch(e){
      err("推送异常", e);
    }
  }


  async function cloudStatus(){
    const wrap = getCloudWrap(); if(!wrap) return;
    const { client, cfg } = wrap;
    const cfg2 = (typeof getCloudCfgOrNull==="function") ? getCloudCfgOrNull() : (wrap && wrap.cfg) || cfg || null;
    const appKey = (cfg && (cfg.appKey || cfg.app_key)) ? String(cfg.appKey || cfg.app_key).trim() : "";
    if(!appKey){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }
    try{
      const loc = await getLocalSnapshot();
      const ls = loc.state || {};
      const cloud = await fetchCloudSnapshot(client, appKey, cfg2);

      const lc = { sellers:pickCount(ls.sellers), products:pickCount(ls.products), orders:pickCount(ls.orders), batches:pickCount(ls.batches) };
      const cc = { sellers:pickCount(cloud.state.sellers), products:pickCount(cloud.state.products), orders:pickCount(cloud.state.orders), batches:pickCount(cloud.state.batches) };

      const msg =
        "云端快照状态（Plan A）\n\n"+
        "app_key: " + appKey + "\n\n"+
        "本地来源: " + loc.src + "\n"+
        "本地统计：卖家"+lc.sellers+" 产品"+lc.products+" 订单"+lc.orders+" 批次"+lc.batches + "\n\n"+
        "云端存在: " + (cloud.exists ? "YES" : "NO") + "\n"+
        (cloud.exists ? ("云端 hash: "+cloud.hash+"\n云端 updated_at: "+cloud.updated_at+"\n云端统计：卖家"+cc.sellers+" 产品"+cc.products+" 订单"+cc.orders+" 批次"+cc.batches+"\n") : "");
      alert(msg);
    }catch(e){
      alert("云端状态失败：\n"+(e && e.message ? e.message : String(e)));
    }
  }

  function bindButtons(){
    const q = (id)=>document.getElementById(id);
    const bCfg = q("btnCloudCfg");
    const bPush = q("btnCloudPush");
    const bPull = q("btnCloudPull");
    const bStatus = q("btnCloudStatus");

    // Use capture-phase to suppress older handlers
    if(bStatus){
      bStatus.addEventListener("click", function(ev){
        try{ ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation(); }catch(e){}
        cloudStatus();
      }, true);
    }
    if(bPush){
      bPush.addEventListener("click", function(ev){
        try{ ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation(); }catch(e){}
        safeMergeAndPush({ force:false });
      }, true);
      // Shift+Click = force push (allow local empty overwrite)
      bPush.addEventListener("click", function(ev){
        if(!ev || !ev.shiftKey) return;
        try{ ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation(); }catch(e){}
        safeMergeAndPush({ force:true });
      }, true);
    }
    // Pull: prefer existing FINAL pull if present, else basic pull->write main->reload
    if(bPull){
      bPull.addEventListener("click", function(ev){
        try{ ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation(); }catch(e){}
        if(typeof cloudPullFINAL==="function"){
          cloudPullFINAL();
          return;
        }
        (async function(){
          const wrap = getCloudWrap(); if(!wrap) return;
          const { client, cfg } = wrap;
          const cfg2 = (typeof getCloudCfgOrNull==="function") ? getCloudCfgOrNull() : (wrap && wrap.cfg) || cfg || null;
          const appKey = (cfg && (cfg.appKey || cfg.app_key)) ? String(cfg.appKey || cfg.app_key).trim() : "";
          if(!appKey){ alert("云端未配置：缺少 app_key（请点【云端设置】）。"); return; }
          const cloud = await fetchCloudSnapshot(client, appKey, cfg2);
          if(!cloud.exists){ alert("云端无快照。"); return; }
          // write to main IDB
          if(typeof idbSet==="function"){
            await idbSet(MAIN_KEY, cloud.state);
            toastSafe("云端拉取完成：已写入 IndexedDB 主库（main_state_v1），即将刷新。");
            location.reload();
            return;
          }
          // raw put
          await new Promise((resolve, reject)=>{
            const req = indexedDB.open(MAIN_DB);
            req.onerror = ()=>reject(req.error||new Error("open failed"));
            req.onsuccess = ()=>{
              const db = req.result;
              try{
                const tx = db.transaction(MAIN_STORE, "readwrite");
                const st = tx.objectStore(MAIN_STORE);
                const put = st.put(cloud.state, MAIN_KEY);
                put.onerror = ()=>reject(put.error||new Error("put failed"));
                put.onsuccess = ()=>resolve();
              }catch(e){ reject(e); }
            };
          });
          toastSafe("云端拉取完成：已写入 IndexedDB 主库（raw put），即将刷新。");
          location.reload();
        })().catch(e=>alert("云端拉取失败：\n"+(e && e.message?e.message:String(e))));
      }, true);
    }
    // cfg button: do not override; keep existing open dialog behavior
    if(bCfg){
      // no-op
    }
  }

  async function autoTick(){
    if(!_autoEnabled) return;
    if(_running) return;
    _running = true;
    try{
      await safeMergeAndPush({ force:false });
    }catch(e){
      err("自动推送异常", e);
    }finally{
      _running = false;
    }
  }

  function startAuto(){
    // Allow users to disable via localStorage if needed
    try{
      const v = localStorage.getItem("OPS_CLOUD_AUTOPUSH");
      if(v === "0" || v === "false"){ _autoEnabled = false; }
      if(v === "1" || v === "true"){ _autoEnabled = true; }
    }catch(e){}
    if(!_autoEnabled){
      log("自动推送已禁用（localStorage: OPS_CLOUD_AUTOPUSH=0）。");
      return;
    }
    setTimeout(()=>{ autoTick(); }, AUTO_START_DELAY_MS);
    setInterval(()=>{ autoTick(); }, AUTO_INTERVAL_MS);
    log("自动推送已启动（Plan A，安全合并推送；间隔 "+Math.round(AUTO_INTERVAL_MS/1000)+"s）。");
  }

  // boot
  try{
    bindButtons();
    startAuto();
  }catch(e){
    err("FINAL SYNC 初始化失败", e);
  }
})();
</script>
<script>
(function(){
  'use strict';

  // =========================
  // Sync Patch (Single-file) — Plan A Safe Merge Push
  // Goals:
  // 1) One button binding set (override old handlers)
  // 2) Canonical local snapshot first: localStorage['ops_rebuild_v6_4_2_state']
  // 3) One cloud table: ops_cloud_snapshots_v1 (onConflict: app_key)
  // 4) Optional same-origin proxy: /api/sync/*
  // =========================

  var CANONICAL_LS_KEY = 'ops_rebuild_v6_4_2_state';
  var CLOUD_TABLE = 'ops_cloud_snapshots_v1';

  // Legacy/compat keys (read)
  var LS_KEYS = {
    url: ['OPS_CLOUD_URL','OPS_SYNC_CLOUD_URL'],
    anon: ['OPS_CLOUD_ANON_KEY','OPS_SYNC_ANON_KEY'],
    app: ['OPS_CLOUD_APP_KEY','OPS_SYNC_APP_KEY','OPS_APP_KEY']
  };

  function nowIso(){ return new Date().toISOString(); }

  function getLSFirst(keys){
    for(var i=0;i<keys.length;i++){
      var v = localStorage.getItem(keys[i]);
      if(v && String(v).trim()) return String(v).trim();
    }
    return '';
  }
  function setLSPrimary(key, val){
    try{ localStorage.setItem(key, val); }catch(_){}
  }

  function toast(msg){
    try{
      if(typeof window.toast === 'function') return window.toast(msg);
      if(window.UI && typeof window.UI.toast === 'function') return window.UI.toast(msg);
    }catch(_){}
    try{ console.log('[SYNC]', msg); }catch(_){}
    try{ alert(msg); }catch(_){}
  }
  function log(){
    try{ console.log.apply(console, arguments); }catch(_){}
  }
  function warn(){
    try{ console.warn.apply(console, arguments); }catch(_){}
  }
  function err(){
    try{ console.error.apply(console, arguments); }catch(_){}
  }

  function safeParseJSON(s, fallback){
    try{ return JSON.parse(s); }catch(_){ return fallback; }
  }

  function stableStringify(obj){
    // deterministic-ish stringify for hashing
    var seen = new WeakSet();
    return JSON.stringify(obj, function(k,v){
      if(v && typeof v === 'object'){
        if(seen.has(v)) return;
        seen.add(v);
        if(!Array.isArray(v)){
          var out = {};
          Object.keys(v).sort().forEach(function(kk){ out[kk]=v[kk]; });
          return out;
        }
      }
      return v;
    });
  }

  function djb2(str){
    var h=5381, i=str.length;
    while(i){ h = ((h<<5)+h) ^ str.charCodeAt(--i); }
    return (h>>>0).toString(16);
  }

  function normalizeState(state){
    state = state && typeof state === 'object' ? state : {};
    // accept multiple historical shapes
    var sellers  = state.sellers  || state.sellerList  || state.sellerItems  || [];
    var products = state.products || state.productList || state.productItems || [];
    var orders   = state.orders   || state.orderList   || state.orderItems   || [];
    var batches  = state.batches  || state.settleBatches || state.payoutBatches || state.batchList || [];
    // ensure arrays
    sellers  = Array.isArray(sellers)  ? sellers  : [];
    products = Array.isArray(products) ? products : [];
    orders   = Array.isArray(orders)   ? orders   : [];
    batches  = Array.isArray(batches)  ? batches  : [];
    // re-pack into canonical keys but keep originals too
    return {
      _raw: state,
      sellers: sellers,
      products: products,
      orders: orders,
      batches: batches
    };
  }

  function getLocalCanonical(){
    var raw = localStorage.getItem(CANONICAL_LS_KEY);
    var obj = safeParseJSON(raw || '', null);
    if(!obj) return { ok:false, source: 'localStorage:'+CANONICAL_LS_KEY, state:null, counts:{sc:0,pc:0,oc:0,bc:0} };
    var n = normalizeState(obj);
    var counts = { sc:n.sellers.length, pc:n.products.length, oc:n.orders.length, bc:n.batches.length };
    return { ok:true, source:'localStorage:'+CANONICAL_LS_KEY, state:obj, norm:n, counts:counts };
  }

  function mergeById(localArr, remoteArr){
    localArr = Array.isArray(localArr)? localArr : [];
    remoteArr = Array.isArray(remoteArr)? remoteArr : [];
    // Determine best id field
    var idFields = ['id','uuid','order_id','seller_id','product_id','asin','orderNo','order_no','batch_id'];
    function getId(x){
      if(!x || typeof x!=='object') return '';
      for(var i=0;i<idFields.length;i++){
        var f=idFields[i];
        if(x[f]!=null && String(x[f]).trim()!=='') return String(x[f]);
      }
      return '';
    }
    function getUpd(x){
      if(!x || typeof x!=='object') return 0;
      var t = x.updated_at || x.updatedAt || x.updated || x.ts || x.time;
      var d = Date.parse(t);
      return isFinite(d)? d : 0;
    }
    var map = new Map();
    for(var i=0;i<remoteArr.length;i++){
      var r=remoteArr[i]; var rid=getId(r);
      if(rid) map.set(rid, r);
    }
    for(var j=0;j<localArr.length;j++){
      var l=localArr[j]; var lid=getId(l);
      if(!lid){ continue; }
      if(!map.has(lid)){ map.set(lid, l); continue; }
      var cur = map.get(lid);
      map.set(lid, getUpd(l) >= getUpd(cur) ? l : cur);
    }
    // keep items without id: append (local wins by ordering)
    var out = Array.from(map.values());
    for(var a=0;a<remoteArr.length;a++){
      var rr=remoteArr[a]; if(!getId(rr)) out.push(rr);
    }
    for(var b=0;b<localArr.length;b++){
      var ll=localArr[b]; if(!getId(ll)) out.push(ll);
    }
    return out;
  }

  function mergePayload(localState, remoteState){
    var L = normalizeState(localState || {});
    var R = normalizeState(remoteState || {});
    var mergedRaw = Object.assign({}, R._raw || {}, L._raw || {});
    // merge canonical arrays by id
    mergedRaw.sellers  = mergeById(L.sellers,  R.sellers);
    mergedRaw.products = mergeById(L.products, R.products);
    mergedRaw.orders   = mergeById(L.orders,   R.orders);
    mergedRaw.batches  = mergeById(L.batches,  R.batches);
    // also try to keep historical key aliases consistent
    mergedRaw.sellerList = mergedRaw.sellers;
    mergedRaw.productList = mergedRaw.products;
    mergedRaw.orderList = mergedRaw.orders;
    mergedRaw.batchList = mergedRaw.batches;
    return mergedRaw;
  }

  function computeCounts(state){
    var n = normalizeState(state || {});
    return { sc:n.sellers.length, pc:n.products.length, oc:n.orders.length, bc:n.batches.length };
  }

  function getCfg(){
    var url = getLSFirst(LS_KEYS.url);
    var anon = getLSFirst(LS_KEYS.anon);
    var appKey = getLSFirst(LS_KEYS.app);
    return { url:url, anon:anon, appKey:appKey };
  }

  function assertCfg(cfg){
    if(!cfg.url || !cfg.anon || !cfg.appKey) return false;
    return true;
  }

  function openCloudSettings(){
    var cfg = getCfg();
    var url = prompt('Supabase URL（例如 https://xxxx.supabase.co ）', cfg.url || '');
    if(url===null) return;
    var anon = prompt('Supabase anon key', cfg.anon || '');
    if(anon===null) return;
    var app = prompt('app_key（同一套系统建议固定，例如 ops_v642）', cfg.appKey || 'ops_v642');
    if(app===null) return;

    setLSPrimary('OPS_CLOUD_URL', String(url).trim());
    setLSPrimary('OPS_CLOUD_ANON_KEY', String(anon).trim());
    setLSPrimary('OPS_CLOUD_APP_KEY', String(app).trim());

    
    // legacy兼容：同时写入 OPS_CLOUD_CFG_V1 供旧逻辑读取
    try{
      const legacyCfg = { url: String(url||'').trim(), anonKey: String(anon||'').trim(), appKey: String(app||'').trim(), updated_at: new Date().toISOString() };
      setLSPrimary('OPS_CLOUD_CFG_V1', JSON.stringify(legacyCfg));
    }catch(e){}
toast('云端设置已保存。');
  }

  // ---------- Cloud API (proxy-first, then direct REST) ----------
  function hasSameOriginProxy(){
    // If your Vercel project provides /api/sync/ping, we prefer it.
    return true;
  }

  function apiFetchProxy(path, body){
    return fetch(path, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body || {})
    }).then(function(r){ return r.json().then(function(j){ return { ok:r.ok, status:r.status, json:j }; }); });
  }

  function restHeaders(cfg){
    return {
      'Content-Type':'application/json',
      'apikey': cfg.anon,
      'Authorization': 'Bearer ' + cfg.anon
    };
  }

  function restFetch(cfg, method, path, body){
    return fetch(cfg.url.replace(/\/+$/,'') + path, {
      method: method,
      headers: restHeaders(cfg),
      body: body==null ? undefined : JSON.stringify(body)
    }).then(function(r){
      return r.text().then(function(t){
        var j = safeParseJSON(t, null);
        return { ok:r.ok, status:r.status, text:t, json:j };
      });
    });
  }

  function cloudPullDirect(cfg){
    var qs = '?select=app_key,hash,counts,updated_at,payload&app_key=eq.' + encodeURIComponent(cfg.appKey) + '&limit=1';
    return restFetch(cfg, 'GET', '/rest/v1/' + CLOUD_TABLE + qs, null).then(function(res){
      if(!res.ok) throw new Error('cloud_pull_failed status=' + res.status + ' ' + (res.text||''));
      var rows = Array.isArray(res.json) ? res.json : [];
      if(!rows.length) return { ok:true, row:null };
      return { ok:true, row:rows[0] };
    });
  }

  function cloudUpsertDirect(cfg, row){
    // Upsert via REST
    var path = '/rest/v1/' + CLOUD_TABLE + '?on_conflict=app_key';
    var headers = restHeaders(cfg);
    headers['Prefer'] = 'resolution=merge-duplicates,return=representation';
    return fetch(cfg.url.replace(/\/+$/,'') + path, {
      method:'POST',
      headers: headers,
      body: JSON.stringify([row])
    }).then(function(r){
      return r.text().then(function(t){
        var j = safeParseJSON(t, null);
        return { ok:r.ok, status:r.status, text:t, json:j };
      });
    }).then(function(res){
      if(!res.ok) throw new Error('cloud_push_failed status=' + res.status + ' ' + (res.text||''));
      return res;
    });
  }

  function cloudPull(cfg){
    // Try proxy first if present, else direct.
    if(hasSameOriginProxy()){
      return apiFetchProxy('/api/sync/pull', { app_key: cfg.appKey }).then(function(r){
        if(r.ok && r.json && r.json.ok){
          return { ok:true, row:r.json.row || null, via:'proxy' };
        }
        // fallback to direct
        return cloudPullDirect(cfg).then(function(x){ x.via='direct'; return x; });
      }).catch(function(){
        return cloudPullDirect(cfg).then(function(x){ x.via='direct'; return x; });
      });
    }
    return cloudPullDirect(cfg).then(function(x){ x.via='direct'; return x; });
  }

  function cloudPushMerged(cfg, localState, force){
    // Plan A: pull remote, merge, upsert
    return cloudPull(cfg).then(function(remote){
      var remoteState = remote && remote.row ? (remote.row.payload || {}) : {};
      var merged = mergePayload(localState, remoteState);
      var mergedCounts = computeCounts(merged);
      var mergedHash = djb2(stableStringify({ payload: merged, counts: mergedCounts, app_key: cfg.appKey }));
      var row = {
        app_key: cfg.appKey,
        hash: mergedHash,
        payload: merged,
        counts: mergedCounts,
        updated_at: nowIso()
      };
      return Promise.resolve().then(function(){
        if(hasSameOriginProxy()){
          return apiFetchProxy('/api/sync/push', { app_key: cfg.appKey, row: row, force: !!force }).then(function(r){
            if(r.ok && r.json && r.json.ok){
              return { ok:true, via:'proxy', row: row, remote: remote };
            }
            // fallback to direct
            return cloudUpsertDirect(cfg, row).then(function(){ return { ok:true, via:'direct', row: row, remote: remote }; });
          }).catch(function(){
            return cloudUpsertDirect(cfg, row).then(function(){ return { ok:true, via:'direct', row: row, remote: remote }; });
          });
        }
        return cloudUpsertDirect(cfg, row).then(function(){ return { ok:true, via:'direct', row: row, remote: remote }; });
      });
    });
  }

  function cloudStatus(){
    var cfg = getCfg();
    if(!assertCfg(cfg)){
      toast('云端未配置：请先点“云端设置”。');
      return Promise.resolve({ ok:false, reason:'cloud_not_configured' });
    }
    var local = getLocalCanonical();
    return cloudPull(cfg).then(function(remote){
      var remoteRow = remote && remote.row ? remote.row : null;
      var remoteCounts = remoteRow && remoteRow.counts ? remoteRow.counts : null;
      var lines = [];
      lines.push('【本地】来源：' + local.source);
      lines.push('  sellers=' + local.counts.sc + ' products=' + local.counts.pc + ' orders=' + local.counts.oc + ' batches=' + local.counts.bc);
      lines.push('【云端】表：' + CLOUD_TABLE + '（via=' + (remote.via||'unknown') + '）');
      if(remoteRow){
        lines.push('  updated_at=' + (remoteRow.updated_at||''));
        lines.push('  hash=' + (remoteRow.hash||''));
        if(remoteCounts){
          lines.push('  sellers=' + (remoteCounts.sc||0) + ' products=' + (remoteCounts.pc||0) + ' orders=' + (remoteCounts.oc||0) + ' batches=' + (remoteCounts.bc||0));
        }
      }else{
        lines.push('  （云端暂无该 app_key 的快照）');
      }
      alert(lines.join('\n'));
      return { ok:true, cfg:cfg, local:local, remote:remoteRow };
    }).catch(function(e){
      err(e);
      toast('云端状态读取失败：' + (e && e.message ? e.message : String(e)));
      return { ok:false, error:String(e) };
    });
  }

  function cloudPullToLocal(){
    var cfg = getCfg();
    if(!assertCfg(cfg)){
      toast('云端未配置：请先点“云端设置”。');
      return Promise.resolve({ ok:false, reason:'cloud_not_configured' });
    }
    return cloudPull(cfg).then(function(remote){
      if(!remote || !remote.row || !remote.row.payload){
        toast('云端暂无快照可拉取。');
        return { ok:true, applied:false };
      }
      var payload = remote.row.payload;
      setLSPrimary(CANONICAL_LS_KEY, JSON.stringify(payload));
      toast('云端拉取完成：已写入本地主快照（建议刷新页面）。');
      return { ok:true, applied:true };
    }).catch(function(e){
      err(e);
      toast('云端拉取失败：' + (e && e.message ? e.message : String(e)));
      return { ok:false, error:String(e) };
    });
  }

  function cloudPush(force){
    var cfg = getCfg();
    if(!assertCfg(cfg)){
      toast('云端未配置：请先点“云端设置”。');
      return Promise.resolve({ ok:false, reason:'cloud_not_configured' });
    }
    var local = getLocalCanonical();
    if(!local.ok){
      toast('本地主快照为空：请先点“同步主数据”，再推送。');
      return Promise.resolve({ ok:false, reason:'local_snapshot_missing' });
    }
    var total = (local.counts.sc||0)+(local.counts.pc||0)+(local.counts.oc||0)+(local.counts.bc||0);
    if(total<=0 && !force){
      toast('安全策略：本地统计为 0，已阻止推送。若确认要覆盖云端，请按住 Shift 再点“云端推送”。');
      return Promise.resolve({ ok:false, reason:'local_snapshot_empty' });
    }

    return cloudPushMerged(cfg, local.state, !!force).then(function(res){
      var c = res.row.counts;
      toast('云端推送成功：卖家'+c.sc+' 产品'+c.pc+' 订单'+c.oc+' 批次'+c.bc+'（'+(res.via||'')+'）');
      return { ok:true, result:res };
    }).catch(function(e){
      err(e);
      toast('云端推送失败：' + (e && e.message ? e.message : String(e)));
      return { ok:false, error:String(e) };
    });
  }

  // ---------- Button wiring (capture to override old handlers) ----------
  function bindByText(btnText, handler){
    var nodes = Array.prototype.slice.call(
      document.querySelectorAll('button,a,[role="button"],input[type="button"],input[type="submit"]')
    );
    for(var i=0;i<nodes.length;i++){
      var el = nodes[i];
      var t = (el.textContent || el.value || '').trim();
      if(t === btnText){
        el.addEventListener('click', function(ev){
          try{
            ev.preventDefault();
            ev.stopPropagation();
            if(ev.stopImmediatePropagation) ev.stopImmediatePropagation();
          }catch(_){}
          handler(ev);
        }, true);
      }
    }
  }

  function initBindings(){
    bindByText('云端设置', function(){ openCloudSettings(); });
    bindByText('云端状态', function(){ cloudStatus(); });
    bindByText('云端拉取', function(){ cloudPullToLocal(); });
    bindByText('云端推送', function(ev){ cloudPush(ev && ev.shiftKey); });
  }

  // ---------- Auto push ----------
  var AUTO_INTERVAL_MS = 60 * 1000;
  var autoTimer = null;
  function startAutoPush(){
    var flag = (localStorage.getItem('OPS_CLOUD_AUTOPUSH') || '').trim();
    if(flag !== '1') return; // default off
    if(autoTimer) return;
    autoTimer = setInterval(function(){
      try{
        cloudPush(false).then(function(){ /* noop */ });
      }catch(_){}
    }, AUTO_INTERVAL_MS);
    log('[AUTO-PUSH] enabled, interval=' + Math.round(AUTO_INTERVAL_MS/1000) + 's');
  }

  function boot(){
    try{
      initBindings();
      startAutoPush();
      log('[SYNC PATCH] loaded. canonical=' + CANONICAL_LS_KEY + ', table=' + CLOUD_TABLE);
    }catch(e){
      err('sync patch boot failed', e);
    }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  }else{
    boot();
  }

})();
</script>


<script>
/* ====== CLOUD SYNC OVERRIDE (single-file, stable) ======
   - Forces table: ops_cloud_snapshots_v1
   - Uses REST fetch (no schema cache surprises)
   - Writes columns: payload, hash, updated_at, app_key
   - Button binding uses capture + stopImmediatePropagation to override old handlers
======================================================== */
(function(){
  const TABLE = "ops_cloud_snapshots_v1";
  const LS_URL_KEYS  = ["OPS_SUPABASE_URL","SUPABASE_URL","supabase_url","SUPABASE_URL_V2"];
  const LS_ANON_KEYS = ["OPS_SUPABASE_ANON","SUPABASE_ANON_KEY","SUPABASE_ANON","supabase_anon","supabase_anon_key"];
  const LS_APP_KEYS  = ["OPS_APP_KEY","OPS_SUPABASE_APP","APP_KEY","app_key","ops_app_key"];
  const CANONICAL_LS_KEY = "ops_rebuild_v6_4_2_state";

  function lsGetFirst(keys){
    for(const k of keys){
      try{ const v = localStorage.getItem(k); if(v && String(v).trim()) return String(v).trim(); }catch(_){}
    }
    return "";
  }
  function getCfg(){
    return { url: lsGetFirst(LS_URL_KEYS), anon: lsGetFirst(LS_ANON_KEYS), app_key: lsGetFirst(LS_APP_KEYS) };
  }
  function okCfg(c){ return !!(c && c.url && c.anon && c.app_key); }

  function jparse(s, fallback){ try{ return JSON.parse(s); }catch(_){ return fallback; } }
  function normalizeState(state){
    state = state && typeof state === "object" ? state : {};
    const sellers  = Array.isArray(state.sellers)  ? state.sellers  : (Array.isArray(state.sellerList)?state.sellerList:[]);
    const products = Array.isArray(state.products) ? state.products : (Array.isArray(state.productList)?state.productList:[]);
    const orders   = Array.isArray(state.orders)   ? state.orders   : (Array.isArray(state.orderList)?state.orderList:[]);
    const batches  = Array.isArray(state.batches)  ? state.batches  : (Array.isArray(state.batchList)?state.batchList:[]);
    return { sellers, products, orders, batches, _raw: state };
  }
  function countSnap(payload){
    const n = normalizeState(payload||{});
    return { sc:n.sellers.length, pc:n.products.length, oc:n.orders.length, bc:n.batches.length };
  }

  function toast(msg){
    // prefer existing toast if present
    try{
      if(typeof window.toast === "function") return window.toast(msg);
    }catch(_){}
    alert(msg);
  }

  function bindByText(text, handler){
    const nodes = Array.from(document.querySelectorAll("button,a,[role='button'],input[type='button'],input[type='submit']"));
    nodes.forEach(el=>{
      const t = (el.textContent || el.value || "").trim();
      if(t === text){
        el.addEventListener("click", function(ev){
          try{ ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation && ev.stopImmediatePropagation(); }catch(_){}
          handler(ev);
        }, true);
      }
    });
  }

  async function rest(method, path, cfg, body){
    const url = cfg.url.replace(/\/+$/,"") + "/rest/v1/" + path.replace(/^\/+/,"");
    const headers = {
      "apikey": cfg.anon,
      "Authorization": "Bearer " + cfg.anon,
      "Content-Type": "application/json",
      "Accept": "application/json"
    };
    const opt = { method, headers };
    if(body !== undefined){
      opt.body = JSON.stringify(body);
      headers["Prefer"] = "return=representation,resolution=merge-duplicates";
    }
    const res = await fetch(url, opt);
    const txt = await res.text();
    let json = null;
    try{ json = txt ? JSON.parse(txt) : null; }catch(_){ json = txt; }
    if(!res.ok){
      const err = (json && (json.message||json.error)) ? (json.message||json.error) : (txt||res.statusText);
      throw new Error(err);
    }
    return json;
  }

  async function cloudGet(cfg){
    const q = `${TABLE}?select=*&app_key=eq.${encodeURIComponent(cfg.app_key)}`;
    const rows = await rest("GET", q, cfg);
    const row = Array.isArray(rows) && rows.length ? rows[0] : null;
    return row;
  }

  function getLocalPayloadPrefer(){
    // Prefer canonical localStorage snapshot if present; else fall back to window.state/S if present
    const raw = localStorage.getItem(CANONICAL_LS_KEY);
    const obj = raw ? jparse(raw, null) : null;
    if(obj && typeof obj === "object") return { payload: obj, source: "localStorage("+CANONICAL_LS_KEY+")" };
    // fallbacks
    try{
      if(window.S && typeof window.S === "object") return { payload: window.S, source:"window.S" };
      if(window.state && typeof window.state === "object") return { payload: window.state, source:"window.state" };
    }catch(_){}
    return { payload: null, source: "none" };
  }

  async function pushOnce(force){
    const cfg = getCfg();
    if(!okCfg(cfg)){
      toast("云端未配置：请先点“云端设置”填写 Supabase URL / anon key / app_key。");
      return;
    }
    const local = getLocalPayloadPrefer();
    if(!local.payload){
      toast("本地快照为空：请先点“同步主数据”，再推送。");
      return;
    }
    const localCounts = countSnap(local.payload);
    if(!force && (localCounts.sc+localCounts.pc+localCounts.oc+localCounts.bc) === 0){
      toast("安全策略：本地统计为 0，已阻止覆盖云端。若确认要推空覆盖，请按住 Shift 再点“云端推送”。");
      return;
    }

    const remote = await cloudGet(cfg);
    const remotePayload = remote && (remote.payload || remote.data) ? (remote.payload || remote.data) : null;

    // merge: prefer local if remote missing; otherwise basic union by arrays of objects with id (fallback)
    let merged = local.payload;
    if(remotePayload && typeof remotePayload === "object"){
      // use existing merge if present
      if(typeof window.mergeSnapshotsPlanA === "function"){
        merged = window.mergeSnapshotsPlanA(local.payload, remotePayload);
      }else{
        const nL = normalizeState(local.payload);
        const nR = normalizeState(remotePayload);
        const byId = (arr)=> {
          const m = new Map();
          arr.forEach(x=>{ if(x && x.id!=null) m.set(String(x.id), x); });
          return m;
        };
        const mergeArr = (a,b)=>{
          const ma = byId(a), mb = byId(b);
          const out = new Map(mb); // start cloud
          for(const [k,v] of ma) out.set(k,v); // local overrides
          // include no-id rows
          const noId = [].concat(b.filter(x=>!(x&&x.id!=null)), a.filter(x=>!(x&&x.id!=null)));
          return Array.from(out.values()).concat(noId);
        };
        merged = {
          sellers: mergeArr(nL.sellers, nR.sellers),
          products: mergeArr(nL.products, nR.products),
          orders: mergeArr(nL.orders, nR.orders),
          batches: mergeArr(nL.batches, nR.batches)
        };
      }
    }

    const mergedCounts = countSnap(merged);
    const hash = String(Date.now());

    const row = {
      app_key: cfg.app_key,
      payload: merged,
      hash: hash,
      updated_at: new Date().toISOString()
    };
    await rest("POST", `${TABLE}?on_conflict=app_key`, cfg, row);

    toast(`云端推送成功：卖家${mergedCounts.sc} 产品${mergedCounts.pc} 订单${mergedCounts.oc} 批次${mergedCounts.bc}（hash=${hash}）`);
  }

  async function status(){
    const cfg = getCfg();
    if(!okCfg(cfg)){
      toast("云端未配置：请先点“云端设置”。");
      return;
    }
    const local = getLocalPayloadPrefer();
    const lc = local.payload ? countSnap(local.payload) : {sc:0,pc:0,oc:0,bc:0};
    const remote = await cloudGet(cfg);
    const rp = remote && (remote.payload || remote.data) ? (remote.payload || remote.data) : null;
    const rc = rp ? countSnap(rp) : {sc:0,pc:0,oc:0,bc:0};
    const msg = [
      `本地来源：${local.source}`,
      `本地统计：卖家${lc.sc} 产品${lc.pc} 订单${lc.oc} 批次${lc.bc}`,
      "",
      `云端存在：${remote ? "YES" : "NO"}`,
      `云端 hash: ${remote && remote.hash ? remote.hash : ""}`,
      `云端 updated_at: ${remote && remote.updated_at ? remote.updated_at : ""}`,
      `云端统计：卖家${rc.sc} 产品${rc.pc} 订单${rc.oc} 批次${rc.bc}`,
      "",
      `表：${TABLE}  app_key=${cfg.app_key}`
    ].join("\n");
    alert(msg);
  }

  async function pullToLocal(){
    const cfg = getCfg();
    if(!okCfg(cfg)){
      toast("云端未配置：请先点“云端设置”。");
      return;
    }
    const remote = await cloudGet(cfg);
    const rp = remote && (remote.payload || remote.data) ? (remote.payload || remote.data) : null;
    if(!rp){
      toast("云端暂无快照可拉取。");
      return;
    }
    localStorage.setItem(CANONICAL_LS_KEY, JSON.stringify(rp));
    toast("云端拉取完成：已写入本地主快照（ops_rebuild_v6_4_2_state）。刷新页面后生效。");
  }

  function openSettings(){
    const cfg = getCfg();
    const url = prompt("Supabase URL（例如 https://xxxx.supabase.co ）", cfg.url || "");
    if(url===null) return;
    const anon = prompt("Supabase anon key（Project Settings → API → anon）", cfg.anon || "");
    if(anon===null) return;
    const app = prompt("app_key（用于区分你的数据集，例如 dalemy）", cfg.app_key || "dalemy");
    if(app===null) return;
    localStorage.setItem(LS_URL_KEYS[0], String(url).trim());
    localStorage.setItem(LS_ANON_KEYS[0], String(anon).trim());
    localStorage.setItem(LS_APP_KEYS[0], String(app).trim());
    toast("云端配置已保存。");
  }

  function init(){
    bindByText("云端设置", openSettings);
    bindByText("云端推送", (ev)=>pushOnce(!!(ev && ev.shiftKey)));
    bindByText("云端状态", status);
    bindByText("云端拉取", pullToLocal);

    // hard-disable old auto push unless explicitly enabled
    try{
      const v = (localStorage.getItem("OPS_CLOUD_AUTOPUSH")||"").trim();
      if(v !== "1" && v !== "true"){
        localStorage.setItem("OPS_CLOUD_AUTOPUSH","0");
      }
    }catch(_){}
    console.log("[SYNC OVERRIDE] loaded. table="+TABLE);
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", init);
  }else{
    init();
  }
})();
</script>


<script>
/* ===== Plan A FINAL OVERRIDE (single-file) =====
   Purpose: force all Push/Status to use the same payload schema (env:{sellers,products,orders,batches})
   and the same Supabase client instance (getCloudWrap()).
*/
(function(){
  function n(x){ return (x==null) ? 0 : (Array.isArray(x)?x.length: (typeof x==="object"?Object.keys(x).length:0)); }
  function totalCounts(st){
    return (n(st.sellers)+n(st.products)+n(st.orders)+n(st.batches));
  }
  function getAppKey(cfg){
    return (cfg && (cfg.appKey || cfg.app_key)) ? String(cfg.appKey || cfg.app_key).trim() : "";
  }
  async function planACloudPush(opts){
    opts = opts||{};
    const force = !!opts.force;
    const quiet = !!opts.quiet;

    // Preflight: ensure SDK + config are ready
    if(typeof ensureSupabaseSDK==="function"){
      const ok = await ensureSupabaseSDK();
      if(!ok) throw new Error("云端未就绪：Supabase SDK 未加载（可能被网络/插件拦截）");
    }
    const wrap = (typeof getCloudWrap==="function") ? getCloudWrap({quiet, forceRebuild:true}) : null;
    const cfg2 = (typeof getCloudCfgOrNull==="function") ? getCloudCfgOrNull() : (wrap && wrap.cfg) || null;

        // Allow REST fallback even if supabase-js client is unavailable
    const client = (wrap && wrap.client) ? wrap.client : null;
    const cfg = (wrap && wrap.cfg) || cfg2 || null;
    if(!cfg || !cfg.url || !cfg.anon){
      throw new Error("云端未配置：请先点【云端设置】并保存 URL / anon / app_key");
    }

    const appKey = getAppKey(cfg);
    if(!appKey) throw new Error("云端未配置：缺少 app_key（请点【云端设置】）");

    const loc = (typeof getLocalSnapshot==="function") ? await getLocalSnapshot() : {state:null,src:"(unknown)"};
    const localState = (typeof normState==="function") ? normState(loc.state) : (loc.state||{});
    const cloud = await fetchCloudSnapshot(client, appKey, cfg2);
    const cloudState = cloud.state || { sellers:[], products:[], orders:[], batches:[] };

    // Safety: prevent empty local from overwriting non-empty cloud unless force
    const localEmpty = totalCounts(localState)===0;
    const cloudNonEmpty = totalCounts(cloudState)>0;
    if(!force && localEmpty && cloudNonEmpty){
      if(!quiet && typeof toastSafe==="function"){
        toastSafe("自动推送已按安全策略跳过：本地为空，云端非空（Shift+点击可强制覆盖）");
      }
      return { ok:false, skipped:true, reason:"local_empty_safety", hash: cloud.hash||null, counts:{sc:0,pc:0,oc:0,bc:0} };
    }

    // Plan A: merge (cloud-first then local) => local updates win when newer, otherwise keep cloud
    const merged = (typeof mergeStates==="function") ? mergeStates(localState, cloudState) : localState;

    const counts = {
      sc: (merged.sellers||[]).length,
      pc: (merged.products||[]).length,
      oc: (merged.orders||[]).length,
      bc: (merged.batches||[]).length
    };

    const out = await pushSnapshot(client, appKey, merged, "planA_push", cfg2);
    return { ok:true, skipped:false, hash: out.hash || null, counts };
  }

  // Hard override: ensure the button handler always hits Plan A implementation
  window.cloudPush = planACloudPush;

  // Expose a lightweight debug helper
  window.__planA_debug = async function(){
    const wrap = getCloudWrap(); if(!wrap) return null;
    const appKey = getAppKey(wrap.cfg);
    const cloud = await fetchCloudSnapshot(wrap.client, appKey, wrap.cfg);
    return { appKey, hash: cloud.hash, updated_at: cloud.updated_at, counts:{
      sellers:(cloud.state.sellers||[]).length,
      products:(cloud.state.products||[]).length,
      orders:(cloud.state.orders||[]).length,
      batches:(cloud.state.batches||[]).length
    }};
  };
})();
</script>

</body>
</html>